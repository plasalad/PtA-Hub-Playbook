<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PtA Migration Playbook</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- PDF.js for PDF processing -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    *{font-family:'Inter',-apple-system,sans-serif;box-sizing:border-box}
    body{background:#f8fafc;margin:0}
    .sidebar{width:64px;background:linear-gradient(180deg,#1e3a8a,#1e40af)}
    .sidebar-item{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:rgba(255,255,255,.6);transition:all .15s}
    .sidebar-item:hover{background:rgba(255,255,255,.1);color:#fff}
    .sidebar-item.active{background:rgba(255,255,255,.2);color:#fff}
    .card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.05);padding:20px}
    .btn{padding:8px 16px;border-radius:8px;font-weight:500;font-size:14px;cursor:pointer;border:none;transition:all .15s}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-primary:hover{background:#1d4ed8}
    .btn-secondary{background:#f1f5f9;color:#475569}
    .btn-success{background:#22c55e;color:#fff}
    .btn-sm{padding:6px 12px;font-size:13px}
    .input{width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px}
    .input:focus{outline:none;border-color:#2563eb}
    .badge{padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .badge-blue{background:#dbeafe;color:#1e40af}
    .badge-green{background:#dcfce7;color:#166534}
    .badge-amber{background:#fef3c7;color:#92400e}
    .badge-red{background:#fee2e2;color:#991b1b}
    .badge-purple{background:#f3e8ff;color:#7c3aed}
    .badge-slate{background:#f1f5f9;color:#475569}
    .value-pill{background:#eff6ff;color:#1e40af;padding:4px 10px;border-radius:6px;font-family:monospace;font-size:13px}
    .step-dot{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px;flex-shrink:0}
    .step-pending{background:#f1f5f9;color:#64748b}
    .step-done{background:#22c55e;color:#fff}
    .advisor-panel{width:320px;background:#fff;border-left:1px solid #e2e8f0;display:flex;flex-direction:column}
    .chat-bubble{max-width:90%;padding:10px 14px;border-radius:12px;font-size:14px;line-height:1.6}
    .chat-bubble strong{font-weight:600}
    .chat-bubble code{background:#e2e8f0;padding:1px 4px;border-radius:3px;font-family:monospace;font-size:12px}
    .chat-bubble pre{background:#1e293b;color:#e2e8f0;padding:8px;border-radius:6px;overflow-x:auto;margin:8px 0;font-size:12px}
    .chat-ai{background:#f1f5f9;color:#1e293b}
    .chat-ai strong{color:#1e40af}
    .chat-user{background:#2563eb;color:#fff;border-bottom-right-radius:4px;margin-left:auto}
    .chat-ai{background:#f1f5f9;color:#1e293b;border-bottom-left-radius:4px}
    .tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;font-weight:500;color:#64748b}
    .tab.active{border-color:#2563eb;color:#2563eb}
    .section{background:#f8fafc;border-radius:12px;padding:16px;margin-bottom:16px}
    .fade-in{animation:fadeIn .2s ease-out}
    .label{display:block;font-size:12px;color:#64748b;margin-bottom:4px;font-weight:500}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @media(max-width:1024px){.advisor-panel{display:none}}
    
    /* ========== RETRO GAME STYLES ========== */
    .pixel-font{font-family:'Press Start 2P',monospace!important}
    .pixel-border{border:4px solid;image-rendering:pixelated}
    .retro-btn{
      position:relative;
      padding:12px 24px;
      font-family:'Press Start 2P',monospace;
      font-size:12px;
      border:none;
      cursor:pointer;
      transition:all 0.1s;
      box-shadow:inset -4px -4px 0 0 rgba(0,0,0,0.3);
    }
    .retro-btn:active{
      transform:translateY(2px);
      box-shadow:inset -2px -2px 0 0 rgba(0,0,0,0.3);
    }
    .retro-panel{
      background:linear-gradient(180deg,#2d1b69 0%,#1a1040 100%);
      border:4px solid #fbbf24;
      box-shadow:0 0 20px rgba(251,191,36,0.3),inset 0 0 60px rgba(0,0,0,0.5);
    }
    .xp-bar{
      background:linear-gradient(90deg,#fbbf24,#f59e0b,#fbbf24);
      background-size:20px 100%;
      animation:xpShine 1s linear infinite;
    }
    @keyframes xpShine{
      0%{background-position:0 0}
      100%{background-position:20px 0}
    }
    .coin-spin{animation:coinSpin 0.5s ease-out}
    @keyframes coinSpin{
      0%{transform:rotateY(0deg) scale(1)}
      50%{transform:rotateY(180deg) scale(1.2)}
      100%{transform:rotateY(360deg) scale(1)}
    }
    .level-up{animation:levelUp 0.8s ease-out}
    @keyframes levelUp{
      0%{transform:scale(1);filter:brightness(1)}
      50%{transform:scale(1.3);filter:brightness(1.5)}
      100%{transform:scale(1);filter:brightness(1)}
    }
    .pulse-glow{animation:pulseGlow 2s ease-in-out infinite}
    @keyframes pulseGlow{
      0%,100%{box-shadow:0 0 5px rgba(251,191,36,0.5)}
      50%{box-shadow:0 0 20px rgba(251,191,36,0.8),0 0 40px rgba(251,191,36,0.4)}
    }
    .pixel-card{
      background:#1e1e2e;
      border:3px solid #44475a;
      box-shadow:4px 4px 0 #000;
    }
    .correct-answer{animation:correctPulse 0.5s ease-out;background:#22c55e!important}
    .wrong-answer{animation:wrongShake 0.5s ease-out;background:#ef4444!important}
    @keyframes correctPulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.05)}
    }
    @keyframes wrongShake{
      0%,100%{transform:translateX(0)}
      25%{transform:translateX(-10px)}
      75%{transform:translateX(10px)}
    }
    .floating{animation:floating 3s ease-in-out infinite}
    @keyframes floating{
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-10px)}
    }
    
    /* ========== FEATURE 2: CONTEXTUAL TOOLTIPS ========== */
    .tooltip-container{position:relative;display:inline-flex;align-items:center}
    .tooltip-trigger{cursor:help;color:#94a3b8;margin-left:4px;transition:color .15s}
    .tooltip-trigger:hover{color:#2563eb}
    .tooltip-content{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e293b;color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;line-height:1.5;white-space:normal;width:240px;z-index:1000;opacity:0;visibility:hidden;transition:all .15s;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .tooltip-content::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:#1e293b}
    .tooltip-container:hover .tooltip-content{opacity:1;visibility:visible}
    
    /* ========== FEATURE 4: GLOBAL SEARCH ========== */
    .search-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;justify-content:center;padding-top:100px}
    .search-modal{background:#fff;border-radius:16px;width:600px;max-height:70vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .search-result{padding:12px 16px;cursor:pointer;border-bottom:1px solid #f1f5f9;transition:background .1s}
    .search-result:hover{background:#f8fafc}
    .search-result-title{font-weight:600;color:#1e293b}
    .search-result-type{font-size:11px;padding:2px 6px;border-radius:4px;background:#e0e7ff;color:#4338ca;margin-left:8px}
    .search-result-preview{font-size:13px;color:#64748b;margin-top:4px}
    .search-highlight{background:#fef08a;padding:0 2px;border-radius:2px}
    
    /* ========== FEATURE 3: VERSION HISTORY ========== */
    .version-timeline{position:relative;padding-left:24px}
    .version-timeline::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:#e2e8f0}
    .version-item{position:relative;padding:12px 0;border-bottom:1px solid #f1f5f9}
    .version-item::before{content:'';position:absolute;left:-20px;top:16px;width:12px;height:12px;border-radius:50%;background:#2563eb;border:2px solid #fff}
    .version-item.minor::before{background:#94a3b8}
    
    /* ========== FEATURE 9: FLOWCHART ========== */
    .flowchart-container{background:#f8fafc;border-radius:12px;padding:24px;overflow-x:auto}
    .flowchart-node{padding:12px 20px;border-radius:8px;text-align:center;font-size:13px;cursor:pointer;transition:all .15s;min-width:140px}
    .flowchart-node:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .flowchart-node.start{background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border-radius:24px}
    .flowchart-node.end{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border-radius:24px}
    .flowchart-node.decision{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
    .flowchart-node.process{background:#fff;border:2px solid #2563eb;color:#1e293b}
    .flowchart-node.process.active{background:#2563eb;color:#fff}
    
    /* ========== FEATURE 1: SMART CHECKLIST ========== */
    .checklist-item{display:flex;align-items:flex-start;padding:12px;border-radius:8px;margin-bottom:8px;transition:all .15s;background:#fff;border:1px solid #e2e8f0}
    .checklist-item:hover{border-color:#2563eb}
    .checklist-item.completed{background:#f0fdf4;border-color:#22c55e}
    .checklist-item.skipped{background:#f1f5f9;opacity:.6}
    .checklist-checkbox{width:20px;height:20px;border-radius:4px;border:2px solid #d1d5db;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
    .checklist-checkbox.checked{background:#22c55e;border-color:#22c55e;color:#fff}
    .checklist-checkbox.na{background:#94a3b8;border-color:#94a3b8;color:#fff}
    .checklist-auto-badge{font-size:10px;background:#dbeafe;color:#1e40af;padding:2px 6px;border-radius:4px;margin-left:8px}
    
    /* ========== FEATURE 7: FEEDBACK & RATING ========== */
    .rating-stars{display:flex;gap:4px}
    .rating-star{cursor:pointer;color:#d1d5db;transition:color .1s}
    .rating-star:hover,.rating-star.active{color:#fbbf24}
    .feedback-card{background:#fff;border-radius:12px;padding:16px;border:1px solid #e2e8f0;margin-bottom:12px}
    
    /* ========== FEATURE 8: COMPLIANCE & AUDIT ========== */
    .audit-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .audit-badge.compliant{background:#dcfce7;color:#166534}
    .audit-badge.warning{background:#fef3c7;color:#92400e}
    .audit-badge.violation{background:#fee2e2;color:#991b1b}
    .compliance-meter{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden}
    .compliance-meter-fill{height:100%;border-radius:4px;transition:width .3s}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState, useEffect, useRef, useCallback} = React;

// Icon component
const Icon = ({name, size=20, className=""}) => {
  const ref = useRef(null);
  useEffect(() => {
    if (ref.current && lucide.icons[name]) {
      ref.current.innerHTML = "";
      const svg = lucide.createElement(lucide.icons[name]);
      svg.setAttribute("width", size);
      svg.setAttribute("height", size);
      ref.current.appendChild(svg);
    }
  }, [name, size]);
  return <span ref={ref} className={`inline-flex items-center justify-center ${className}`}/>;
};

// ========== FEATURE 2: CONTEXTUAL HELP TOOLTIP ==========
const Tooltip = ({content, children}) => (
  <span className="tooltip-container">
    {children}
    <span className="tooltip-trigger"><Icon name="HelpCircle" size={14} /></span>
    <span className="tooltip-content">{content}</span>
  </span>
);

// ========== FEATURE 4: GLOBAL SEARCH ==========
const GlobalSearch = ({isOpen, onClose, searchData, onNavigate}) => {
  const [query, setQuery] = useState("");
  const inputRef = useRef(null);
  
  useEffect(() => { if (isOpen && inputRef.current) inputRef.current.focus(); }, [isOpen]);
  
  const results = React.useMemo(() => {
    if (!query.trim()) return [];
    const q = query.toLowerCase();
    return (searchData || []).filter(item => 
      item.title?.toLowerCase().includes(q) || 
      item.keywords?.some(k => k.toLowerCase().includes(q))
    ).slice(0, 8);
  }, [query, searchData]);
  
  if (!isOpen) return null;
  
  return (
    <div className="search-overlay" onClick={onClose}>
      <div className="search-modal" onClick={e => e.stopPropagation()}>
        <div className="p-4 border-b flex items-center gap-3">
          <Icon name="Search" size={20} className="text-slate-400" />
          <input ref={inputRef} type="text" className="flex-1 text-lg outline-none" placeholder="Search workflows, guides, settings..." value={query} onChange={e => setQuery(e.target.value)} />
          <kbd className="text-xs bg-slate-100 px-2 py-1 rounded">ESC</kbd>
        </div>
        <div className="max-h-96 overflow-auto">
          {results.length === 0 && query && <div className="p-8 text-center text-slate-400"><Icon name="SearchX" size={40} className="mx-auto mb-3 opacity-50" /><p>No results for "{query}"</p></div>}
          {results.map((r, i) => (
            <div key={i} className="search-result" onClick={() => { r.onSelect?.(); onNavigate?.(r); onClose(); }}>
              <div className="flex items-center gap-2">
                <span className="search-result-title">{r.title}</span>
                <span className="search-result-type">{r.type}</span>
              </div>
              {r.preview && <p className="search-result-preview">{r.preview}</p>}
            </div>
          ))}
          {!query && <div className="p-6"><p className="text-sm text-slate-500 mb-3">Quick searches:</p><div className="flex flex-wrap gap-2">{["Create Project", "Budget", "Settlement", "TECO", "Tax Review", "Decommissioning"].map(t => <button key={t} onClick={() => setQuery(t)} className="px-3 py-1 bg-slate-100 rounded-full text-sm hover:bg-slate-200">{t}</button>)}</div></div>}
        </div>
      </div>
    </div>
  );
};

// ========== FEATURE 1: SMART CHECKLIST ==========
const SmartChecklist = ({items, projectData, onItemChange}) => {
  const [checks, setChecks] = useState({});
  
  const evaluatedItems = React.useMemo(() => (items || []).map(item => {
    let skip = false, skipReason = "";
    if (item.condition === "emit_only" && projectData?.budgetClass !== "03") { skip = true; skipReason = "Only for EMIT (03)"; }
    if (item.condition === "capital_only" && projectData?.projectCategory !== "Capital") { skip = true; skipReason = "Only for Capital projects"; }
    if (item.condition === "obo_only" && projectData?.businessArea !== "6602") { skip = true; skipReason = "Only for OBO (6602)"; }
    if (item.condition === "budget_3m" && (projectData?.netBudgetAUD || 0) <= 3000000) { skip = true; skipReason = `Net ${((projectData?.netBudgetAUD||0)/1e6).toFixed(1)}M â‰¤ $3M threshold`; }
    if (item.condition === "budget_5m" && (projectData?.netBudgetAUD || 0) <= 5000000) { skip = true; skipReason = `Net ${((projectData?.netBudgetAUD||0)/1e6).toFixed(1)}M â‰¤ $5M threshold`; }
    return {...item, skip, skipReason};
  }), [items, projectData]);
  
  const progress = React.useMemo(() => {
    const active = evaluatedItems.filter(i => !i.skip);
    const done = active.filter(i => checks[i.id]);
    return active.length > 0 ? Math.round((done.length / active.length) * 100) : 0;
  }, [evaluatedItems, checks]);
  
  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <h4 className="font-semibold flex items-center gap-2"><Icon name="CheckSquare" size={18} className="text-green-600" /> Smart Checklist</h4>
        <div className="flex items-center gap-3">
          <span className="text-sm text-slate-500">{progress}% complete</span>
          <div className="w-32 h-2 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-green-500 rounded-full transition-all" style={{width:`${progress}%`}} /></div>
        </div>
      </div>
      {evaluatedItems.map(item => (
        <div key={item.id} className={`checklist-item ${checks[item.id] ? 'completed' : ''} ${item.skip ? 'skipped' : ''}`}>
          <div className={`checklist-checkbox ${checks[item.id] ? 'checked' : ''} ${item.skip ? 'na' : ''}`} onClick={() => !item.skip && setChecks({...checks, [item.id]: !checks[item.id]})}>
            {checks[item.id] && <Icon name="Check" size={14} />}
            {item.skip && <Icon name="Minus" size={14} />}
          </div>
          <div className="ml-3 flex-1">
            <div className="flex items-center gap-2">
              <span className={`font-medium ${item.skip ? 'line-through text-slate-400' : ''}`}>{item.title}</span>
              {item.skip && <span className="checklist-auto-badge">Auto-skipped</span>}
              {item.critical && !item.skip && <span className="badge badge-red">Critical</span>}
            </div>
            <p className="text-sm text-slate-500 mt-1">{item.skip ? item.skipReason : item.description}</p>
            {item.approver && !item.skip && <p className="text-xs text-blue-600 mt-1">Approver: {item.approver}</p>}
          </div>
        </div>
      ))}
    </div>
  );
};

// ========== FEATURE 3: VERSION HISTORY ==========
const VersionHistory = ({versions, currentVersion, onRestore}) => (
  <div className="card">
    <div className="flex justify-between items-center mb-4">
      <h3 className="font-semibold flex items-center gap-2"><Icon name="History" size={18} className="text-blue-600" /> Version History</h3>
      <span className="badge badge-blue">v{currentVersion}</span>
    </div>
    <div className="version-timeline">
      {(versions || []).map((v, i) => (
        <div key={i} className={`version-item ${v.type === 'minor' ? 'minor' : ''}`}>
          <div className="flex justify-between items-start">
            <div>
              <div className="flex items-center gap-2"><span className="font-semibold">v{v.version}</span><span className={`badge ${v.type === 'major' ? 'badge-blue' : 'badge-slate'}`}>{v.type}</span></div>
              <p className="text-sm text-slate-600 mt-1">{v.description}</p>
              <p className="text-xs text-slate-400 mt-1">{v.author} â€¢ {v.date}</p>
            </div>
            {i > 0 && <button onClick={() => onRestore?.(v)} className="btn btn-secondary btn-sm"><Icon name="RotateCcw" size={14} className="mr-1" /> Restore</button>}
          </div>
        </div>
      ))}
    </div>
  </div>
);

// ========== FEATURE 7: FEEDBACK & RATING ==========
const FeedbackSystem = ({itemId, itemType, onSubmit}) => {
  const [show, setShow] = useState(false);
  const [rating, setRating] = useState(0);
  const [comment, setComment] = useState("");
  const [done, setDone] = useState(false);
  
  const submit = () => { onSubmit?.({itemId, itemType, rating, comment, at: new Date().toISOString()}); setDone(true); setTimeout(() => setShow(false), 2000); };
  
  return (
    <div className="mt-4 pt-4 border-t">
      {!show ? <button onClick={() => setShow(true)} className="text-sm text-blue-600 hover:underline flex items-center gap-1"><Icon name="MessageSquarePlus" size={14} /> Rate this guide</button> : (
        <div className="space-y-3 fade-in">
          <div className="flex items-center gap-2">
            <span className="text-sm">How helpful?</span>
            <div className="rating-stars">{[1,2,3,4,5].map(s => <span key={s} className={`rating-star ${s <= rating ? 'active' : ''}`} onClick={() => setRating(s)}><Icon name="Star" size={20} /></span>)}</div>
          </div>
          <textarea className="input text-sm" placeholder="Suggestions to improve?" value={comment} onChange={e => setComment(e.target.value)} rows={2} />
          <div className="flex gap-2">
            <button onClick={submit} className="btn btn-primary btn-sm" disabled={done}>{done ? 'âœ“ Thanks!' : 'Submit'}</button>
            <button onClick={() => setShow(false)} className="btn btn-secondary btn-sm">Cancel</button>
          </div>
        </div>
      )}
    </div>
  );
};

// ========== FEATURE 8: COMPLIANCE & AUDIT ==========
const ComplianceAudit = ({score, rules, auditLog}) => (
  <div className="card">
    <div className="flex justify-between items-center mb-4">
      <h3 className="font-semibold flex items-center gap-2"><Icon name="Shield" size={18} className="text-blue-600" /> Compliance</h3>
      <div className={`audit-badge ${score >= 90 ? 'compliant' : score >= 70 ? 'warning' : 'violation'}`}>
        <Icon name={score >= 90 ? 'ShieldCheck' : 'ShieldAlert'} size={14} /> {score}%
      </div>
    </div>
    <div className="compliance-meter mb-4"><div className="compliance-meter-fill" style={{width:`${score}%`, background: score >= 90 ? '#22c55e' : score >= 70 ? '#f59e0b' : '#ef4444'}} /></div>
    <div className="space-y-2 mb-4">
      {(rules || []).map((r, i) => (
        <div key={i} className="flex items-center justify-between p-2 bg-slate-50 rounded">
          <div className="flex items-center gap-2"><Icon name={r.passed ? 'CheckCircle' : 'XCircle'} size={16} className={r.passed ? 'text-green-600' : 'text-red-600'} /><span className="text-sm">{r.name}</span></div>
          <span className={`badge ${r.passed ? 'badge-green' : 'badge-red'}`}>{r.passed ? 'OK' : 'Fail'}</span>
        </div>
      ))}
    </div>
    {auditLog && auditLog.length > 0 && (
      <div className="border-t pt-4">
        <h4 className="font-medium text-sm mb-2 flex items-center gap-2"><Icon name="FileText" size={14} /> Audit Trail</h4>
        <div className="space-y-1 max-h-40 overflow-auto text-xs">
          {auditLog.map((e, i) => <div key={i} className="flex gap-2"><span className="text-slate-400">{new Date(e.ts).toLocaleString()}</span><span className={e.type === 'approval' ? 'text-green-600' : 'text-slate-600'}>{e.action}</span><span className="text-slate-500">by {e.user}</span></div>)}
        </div>
      </div>
    )}
  </div>
);

// ========== FEATURE 9: INTERACTIVE FLOWCHART ==========
const InteractiveFlowchart = ({nodes, activeStep, onNodeClick}) => (
  <div className="flowchart-container">
    <h4 className="font-semibold mb-4 flex items-center gap-2"><Icon name="GitBranch" size={18} className="text-purple-600" /> Process Flow</h4>
    <div className="flex flex-wrap items-center gap-4 justify-center">
      {(nodes || []).map((node, i) => (
        <React.Fragment key={node.id}>
          <div className={`flowchart-node ${node.type} ${activeStep === node.id ? 'active' : ''}`} onClick={() => onNodeClick?.(node)}>
            <div className="flex items-center gap-2 justify-center">
              {node.icon && <Icon name={node.icon} size={16} />}
              <span>{node.label}</span>
            </div>
          </div>
          {i < nodes.length - 1 && <Icon name="ArrowRight" size={20} className="text-slate-400" />}
        </React.Fragment>
      ))}
    </div>
  </div>
);

// ========== FEATURE 6: AI-POWERED INSIGHTS ==========
const AIInsights = ({projectData, onSuggestion}) => {
  const [analyzing, setAnalyzing] = useState(false);
  const [insights, setInsights] = useState([]);
  const [risk, setRisk] = useState(null);
  
  const analyze = () => {
    setAnalyzing(true);
    setTimeout(() => {
      const newInsights = [], risks = [];
      if ((projectData?.grossBudget || 0) > 5000000) { newInsights.push({type:'warning',title:'High-Value Project',desc:'Consider engaging Tax Team early for >$5M'}); risks.push({level:'medium',desc:'Tax review threshold'}); }
      if ((projectData?.grossBudget || 0) > 20000000) { newInsights.push({type:'critical',title:'Executive Approval',desc:'Projects >$20M need Level 5+'}); risks.push({level:'high',desc:'Executive approval chain'}); }
      if (projectData?.budgetClass === '03') { newInsights.push({type:'info',title:'EMIT Classification',desc:'Fund.IT ruling required before SAP entry'}); }
      if (projectData?.budgetClass === 'XF') { newInsights.push({type:'critical',title:'Decommissioning',desc:'Settlement rule to 490000030 BEFORE TECO'}); risks.push({level:'high',desc:'Settlement critical path'}); }
      if ((projectData?.emShare || 100) < 100) { newInsights.push({type:'info',title:'Joint Venture',desc:`EM Share is ${projectData?.emShare}%. JV approval if >$5M`}); }
      setInsights(newInsights);
      setRisk({overall: risks.some(r => r.level === 'high') ? 'high' : risks.some(r => r.level === 'medium') ? 'medium' : 'low', items: risks});
      setAnalyzing(false);
    }, 1200);
  };
  
  return (
    <div className="card">
      <div className="flex justify-between items-center mb-4">
        <h3 className="font-semibold flex items-center gap-2"><Icon name="Sparkles" size={18} className="text-purple-600" /> AI Insights</h3>
        <button onClick={analyze} disabled={analyzing} className="btn btn-secondary btn-sm">{analyzing ? <><Icon name="Loader" size={14} className="mr-1 animate-spin" /> Analyzing...</> : <><Icon name="Zap" size={14} className="mr-1" /> Analyze</>}</button>
      </div>
      {risk && (
        <div className={`p-3 rounded-lg mb-4 ${risk.overall === 'high' ? 'bg-red-50 border border-red-200' : risk.overall === 'medium' ? 'bg-amber-50 border border-amber-200' : 'bg-green-50 border border-green-200'}`}>
          <div className="flex items-center gap-2 mb-1"><Icon name={risk.overall === 'high' ? 'AlertTriangle' : risk.overall === 'medium' ? 'AlertCircle' : 'CheckCircle'} size={16} className={risk.overall === 'high' ? 'text-red-600' : risk.overall === 'medium' ? 'text-amber-600' : 'text-green-600'} /><span className="font-medium capitalize">{risk.overall} Risk</span></div>
          {risk.items.length > 0 && <ul className="text-sm space-y-1">{risk.items.map((r, i) => <li key={i} className="flex items-center gap-2"><span className={`w-2 h-2 rounded-full ${r.level === 'high' ? 'bg-red-500' : 'bg-amber-500'}`} />{r.desc}</li>)}</ul>}
        </div>
      )}
      <div className="space-y-3">
        {insights.map((s, i) => (
          <div key={i} className={`p-3 rounded-lg border ${s.type === 'critical' ? 'bg-red-50 border-red-200' : s.type === 'warning' ? 'bg-amber-50 border-amber-200' : 'bg-blue-50 border-blue-200'}`}>
            <div className="flex items-start gap-2">
              <Icon name={s.type === 'critical' ? 'AlertTriangle' : s.type === 'warning' ? 'AlertCircle' : 'Info'} size={16} className={s.type === 'critical' ? 'text-red-600' : s.type === 'warning' ? 'text-amber-600' : 'text-blue-600'} />
              <div><p className="font-medium text-sm">{s.title}</p><p className="text-xs text-slate-600 mt-1">{s.desc}</p></div>
            </div>
          </div>
        ))}
        {insights.length === 0 && !analyzing && <div className="text-center py-6 text-slate-400"><Icon name="Sparkles" size={32} className="mx-auto mb-2 opacity-50" /><p className="text-sm">Click Analyze for AI-powered insights</p></div>}
      </div>
    </div>
  );
};

// ========== FEATURE 5: EXPORT MANAGER ==========
const ExportManager = ({data, projectData, onExport}) => {
  const [format, setFormat] = useState('pdf');
  const [exporting, setExporting] = useState(false);
  
  const doExport = async () => {
    setExporting(true);
    try {
      if (format === 'pdf') {
        const {jsPDF} = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(18); doc.text('SAP Playbook Export', 20, 20);
        doc.setFontSize(12); doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
        if (projectData) {
          doc.text(`Project: ${projectData.projectNumber || 'N/A'}`, 20, 45);
          doc.text(`Budget: ${(projectData.grossBudget||0).toLocaleString()} AUD`, 20, 55);
          doc.text(`Net: ${(projectData.netBudgetAUD||0).toLocaleString()} AUD`, 20, 65);
        }
        doc.save(`playbook-${new Date().toISOString().split('T')[0]}.pdf`);
      } else if (format === 'csv') {
        let csv = 'SAP Playbook Export\n\nProject,' + (projectData?.projectNumber || 'N/A') + '\nBudget,' + (projectData?.grossBudget || 0);
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `playbook-${new Date().toISOString().split('T')[0]}.csv`; a.click();
      } else {
        const blob = new Blob([JSON.stringify({project: projectData, data, exportedAt: new Date().toISOString()}, null, 2)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `playbook-${new Date().toISOString().split('T')[0]}.json`; a.click();
      }
      onExport?.({format});
    } catch (e) { alert('Export failed: ' + e.message); }
    setExporting(false);
  };
  
  return (
    <div className="card">
      <h3 className="font-semibold mb-4 flex items-center gap-2"><Icon name="Download" size={18} className="text-blue-600" /> Export Report</h3>
      <div className="flex gap-2 mb-4">
        {[{id:'pdf',icon:'FileText',label:'PDF'},{id:'csv',icon:'Table',label:'CSV'},{id:'json',icon:'Code',label:'JSON'}].map(f => (
          <button key={f.id} onClick={() => setFormat(f.id)} className={`flex-1 p-3 rounded-lg border-2 ${format === f.id ? 'border-blue-500 bg-blue-50' : 'border-slate-200'}`}>
            <Icon name={f.icon} size={20} className={`mx-auto mb-1 ${format === f.id ? 'text-blue-600' : 'text-slate-400'}`} /><span className="text-sm block">{f.label}</span>
          </button>
        ))}
      </div>
      <button onClick={doExport} disabled={exporting} className="btn btn-primary w-full">
        {exporting ? <><Icon name="Loader" size={16} className="mr-2 animate-spin" /> Exporting...</> : <><Icon name="Download" size={16} className="mr-2" /> Export {format.toUpperCase()}</>}
      </button>
    </div>
  );
};

// ========== SEARCHABLE DATA FOR GLOBAL SEARCH ==========
const SEARCH_DATA = [
  {title: "Create New Project", type: "Workflow", keywords: ["project", "create", "new", "CJ20N"], preview: "Step-by-step guide to create SAP project"},
  {title: "Budget Entry (ZJ40)", type: "Workflow", keywords: ["budget", "ZJ40", "funding"], preview: "Enter budget at WBS Level 1"},
  {title: "Tax Review Process", type: "Guide", keywords: ["tax", "review", "threshold", "$3M"], preview: "Required when net budget > $3M AUD"},
  {title: "JV Approval", type: "Guide", keywords: ["JV", "joint venture", "approval", "$5M"], preview: "Required when net budget > $5M AUD"},
  {title: "Settlement Rules", type: "Guide", keywords: ["settlement", "KO88", "KO02", "asset"], preview: "Configure settlement rules"},
  {title: "TECO Status", type: "Guide", keywords: ["TECO", "technically complete", "close"], preview: "Set project to technically complete"},
  {title: "Decommissioning Projects", type: "Guide", keywords: ["decommissioning", "XF", "490000030"], preview: "Special rules for decommissioning"},
  {title: "EMIT Projects", type: "Guide", keywords: ["EMIT", "03", "Fund.IT", "ruling"], preview: "EMIT projects require Fund.IT ruling"},
  {title: "Check PO Status", type: "Workflow", keywords: ["PO", "purchase order", "ME23N"], preview: "View purchase order details"},
  {title: "Cost Transfer", type: "Workflow", keywords: ["cost", "transfer", "KB61"], preview: "Transfer costs between projects"}
];

// ========== CHECKLIST ITEMS DATA ==========
const CHECKLIST_ITEMS = [
  {id: "fundit", title: "Fund.IT Ruling", description: "CAPEX/OPEX ruling required for EMIT projects", approver: "Fund.IT", critical: true, condition: "emit_only"},
  {id: "fccr", title: "FCCR Approval", description: "Required for ALL projects including Decommissioning", approver: "FCCR", critical: true},
  {id: "dataflex", title: "Dataflex TC Code", description: "Required for Capital projects", approver: "Financial Reporting", condition: "capital_only"},
  {id: "doag", title: "DOAG Approval", description: "Required for all projects", approver: "DOAG"},
  {id: "tax", title: "Tax Review", description: "Required when net budget exceeds $3M AUD", approver: "Tax Team", critical: true, condition: "budget_3m"},
  {id: "jv", title: "JV Approval", description: "Required when net budget exceeds $5M AUD", approver: "JV Partners", critical: true, condition: "budget_5m"},
  {id: "obo", title: "OBO Approval", description: "Required for OBO projects based on stage thresholds", approver: "JV/OBO Partners", critical: true, condition: "obo_only"},
  {id: "level", title: "Level Approval", description: "Approval based on net USD amount", approver: "Per threshold", critical: true}
];

// ========== FLOWCHART DATA ==========
const FLOW_NODES = [
  {id: 'start', type: 'start', label: 'Start', icon: 'Play'},
  {id: 'prereq', type: 'process', label: 'Prerequisites', icon: 'ClipboardList'},
  {id: 'fccr', type: 'decision', label: 'FCCR', icon: 'FileCheck'},
  {id: 'tax', type: 'decision', label: 'Tax Review?', icon: 'Calculator'},
  {id: 'sap', type: 'process', label: 'SAP Entry', icon: 'Database'},
  {id: 'budget', type: 'process', label: 'Budget', icon: 'DollarSign'},
  {id: 'end', type: 'end', label: 'Complete', icon: 'CheckCircle'}
];

// ========== VERSION HISTORY DATA ==========
const VERSION_HISTORY = [
  {version: "2.4.0", type: "major", description: "Added Smart Checklists, AI Insights, Flowcharts, Global Search", author: "System", date: "2025-01-15"},
  {version: "2.3.0", type: "major", description: "Compliance tracking & audit trail", author: "System", date: "2025-01-05"},
  {version: "2.2.0", type: "minor", description: "Export enhancements (PDF, CSV, JSON)", author: "Admin", date: "2024-12-20"},
  {version: "2.1.0", type: "minor", description: "UI improvements and bug fixes", author: "Admin", date: "2024-12-15"},
  {version: "2.0.0", type: "major", description: "Major redesign with gamification", author: "System", date: "2024-12-01"}
];

// Default Australia config
const DEFAULT_CONFIG = {
  id: "Australia",
  flag: "ðŸ‡¦ðŸ‡º",
  currency: "AUD",
  region: "APAC",
  
  // Exchange Rate (DOAG updates 1 Jan & 1 July)
  exchangeRate: {
    AUD_USD: 1.59,
    lastUpdated: "2025-01-01",
    nextUpdate: "2025-07-01"
  },
  
  sap: {
    system: "G3P",
    controllingArea: "AU00",
    companyCodes: [
      {code: "1230", name: "Main Entity (EMOP)", defaultBusinessArea: "6601"},
      {code: "0495", name: "Secondary Entity", defaultBusinessArea: "6601"},
      {code: "4310", name: "OBO Entity", defaultBusinessArea: "6602"}
    ],
    businessAreas: [
      {code: "6601", name: "EMOP", autoRecovery: null},
      {code: "6602", name: "OBO", autoRecovery: "NB"}
    ]
  },
  
  // JV Codes linked to Company Codes
  jvCodes: {
    "1230": [
      {code: "AU001", name: "JV Partner A", emShare: 50},
      {code: "AU002", name: "JV Partner B", emShare: 20},
      {code: "AU003", name: "EM Sole Risk", emShare: 100}
    ],
    "0495": [
      {code: "AU004", name: "EM Sole Risk", emShare: 100}
    ],
    "4310": [
      {code: "AU005", name: "OBO EM Sole Risk", emShare: 100}
    ]
  },
  
  // Project Stages (for both EMOP and OBO)
  projectStages: [
    {code: "PRE", name: "Pre-development"},
    {code: "APR", name: "Appraisal Operations"},
    {code: "DEV", name: "Development Operations"},
    {code: "PRD", name: "Production Operations"}
  ],
  
  project: {
    format: "6XX/YYNNN",
    formatDescription: "6=Country (fixed), XX=Budget Class, YY=Year, NNN=Sequence (starts 000)",
    countryCode: "6",
    budgetClasses: [
      {code: "01", name: "Drilling", category: "Capital"},
      {code: "02", name: "Facilities", category: "Capital"},
      {code: "03", name: "EMIT", category: "Capital", requiresRuling: true},
      {code: "XF", name: "Decommissioning", category: "Decommissioning"}
    ],
    recoveryIndicators: [{code: "BI", name: "Billable"}, {code: "NB", name: "Non-Billable"}]
  },
  
  // AUC Types (Asset Under Construction) - mapped to Budget Class + Stage
  aucTypes: [
    {code: "INTANG_WELL", name: "Intangible Wells", budgetClass: "01", stages: ["PRE", "APR"], glAccount: "1400100", description: "Exploration & appraisal wells"},
    {code: "TANG_WELL", name: "Tangible Wells", budgetClass: "01", stages: ["DEV", "PRD"], glAccount: "1400200", description: "Development & production wells"},
    {code: "INFRA", name: "Infrastructure", budgetClass: "02", stages: ["DEV", "PRD"], glAccount: "1400300", description: "Platforms, pipelines, facilities"},
    {code: "PPE", name: "PPE", budgetClass: "02", stages: ["DEV", "PRD"], glAccount: "1400400", description: "Plant, Property & Equipment"},
    {code: "SOFTWARE", name: "Software", budgetClass: "03", stages: [], glAccount: "1400500", description: "Software licenses and development"},
    {code: "COMPUTER", name: "Computer", budgetClass: "03", stages: [], glAccount: "1400600", description: "Hardware, servers, network"},
    {code: "VEHICLE", name: "Vehicles", budgetClass: "03", stages: [], glAccount: "1400700", description: "Transport and mobile equipment"},
    {code: "DECOM", name: "Decommissioning", budgetClass: "XF", stages: [], glAccount: "1400800", description: "Asset retirement obligations"}
  ],
  
  funding: {
    stages: [
      {code: "AC", name: "Advance Commitment"},
      {code: "FF", name: "Full Funding"},
      {code: "SUP", name: "Supplement"}
    ]
  },
  
  // Local Thresholds (AUD)
  localThresholds: {
    taxReview: 3000000,
    jvApproval: 5000000,
    obo: {PRE: 2500000, APR: 5000000, DEV: 5000000, PRD: 5000000}
  },
  
  // Level Approval (USD) - Global
  levelApproval: {
    AC: {unlimited: [1,2,3,4], 5: 50000000, 6: 20000000, 7: 5000000, 8: 1000000, 9: 500000, 10: 100000},
    FF: {unlimited: [1,2,3,4], 5: 50000000, 6: 20000000, 7: 5000000, 8: 1000000, 9: 500000, 10: 100000},
    SUP: {unlimited: [1,2,3], 4: 50000000, 5: 20000000, notAuthorized: [6,7,8,9,10]}
  },
  
  // Approvers (5 per level)
  approvers: [
    // Level 1
    {id: "APR001", firstName: "James", lastName: "Mitchell", email: "james.mitchell@company.com", country: "Global", level: 1, dept: "Executive", title: "CEO"},
    {id: "APR002", firstName: "Sarah", lastName: "Williams", email: "sarah.williams@company.com", country: "Global", level: 1, dept: "Executive", title: "CFO"},
    {id: "APR003", firstName: "Michael", lastName: "Chen", email: "michael.chen@company.com", country: "Global", level: 1, dept: "Executive", title: "COO"},
    {id: "APR004", firstName: "Emma", lastName: "Thompson", email: "emma.thompson@company.com", country: "Global", level: 1, dept: "Board", title: "Chairman"},
    {id: "APR005", firstName: "Robert", lastName: "Anderson", email: "robert.anderson@company.com", country: "Global", level: 1, dept: "Board", title: "Director"},
    // Level 2
    {id: "APR006", firstName: "David", lastName: "Kim", email: "david.kim@company.com", country: "APAC", level: 2, dept: "Operations", title: "VP APAC"},
    {id: "APR007", firstName: "Jennifer", lastName: "Smith", email: "jennifer.smith@company.com", country: "EMEA", level: 2, dept: "Operations", title: "VP EMEA"},
    {id: "APR008", firstName: "Thomas", lastName: "Brown", email: "thomas.brown@company.com", country: "Americas", level: 2, dept: "Operations", title: "VP Americas"},
    {id: "APR009", firstName: "Lisa", lastName: "Garcia", email: "lisa.garcia@company.com", country: "Global", level: 2, dept: "Finance", title: "VP Finance"},
    {id: "APR010", firstName: "William", lastName: "Taylor", email: "william.taylor@company.com", country: "Global", level: 2, dept: "Technical", title: "VP Technical"},
    // Level 3
    {id: "APR011", firstName: "Andrew", lastName: "Johnson", email: "andrew.johnson@company.com", country: "Australia", level: 3, dept: "Operations", title: "Senior Director AU"},
    {id: "APR012", firstName: "Michelle", lastName: "Lee", email: "michelle.lee@company.com", country: "Malaysia", level: 3, dept: "Operations", title: "Senior Director MY"},
    {id: "APR013", firstName: "Christopher", lastName: "White", email: "christopher.white@company.com", country: "UK", level: 3, dept: "Operations", title: "Senior Director UK"},
    {id: "APR014", firstName: "Amanda", lastName: "Davis", email: "amanda.davis@company.com", country: "APAC", level: 3, dept: "Finance", title: "Senior Director Finance APAC"},
    {id: "APR015", firstName: "Daniel", lastName: "Martinez", email: "daniel.martinez@company.com", country: "Global", level: 3, dept: "Technical", title: "Senior Director Engineering"},
    // Level 4
    {id: "APR016", firstName: "Rachel", lastName: "Wilson", email: "rachel.wilson@company.com", country: "Australia", level: 4, dept: "Operations", title: "Director Operations AU"},
    {id: "APR017", firstName: "Kevin", lastName: "Moore", email: "kevin.moore@company.com", country: "Australia", level: 4, dept: "Finance", title: "Director Finance AU"},
    {id: "APR018", firstName: "Stephanie", lastName: "Clark", email: "stephanie.clark@company.com", country: "Malaysia", level: 4, dept: "Operations", title: "Director Operations MY"},
    {id: "APR019", firstName: "Jason", lastName: "Hall", email: "jason.hall@company.com", country: "APAC", level: 4, dept: "Technical", title: "Director Engineering APAC"},
    {id: "APR020", firstName: "Nicole", lastName: "Allen", email: "nicole.allen@company.com", country: "Global", level: 4, dept: "Commercial", title: "Director Commercial"},
    // Level 5
    {id: "APR021", firstName: "Brandon", lastName: "Young", email: "brandon.young@company.com", country: "Australia", level: 5, dept: "Operations", title: "Senior Manager AU"},
    {id: "APR022", firstName: "Jessica", lastName: "King", email: "jessica.king@company.com", country: "Australia", level: 5, dept: "Finance", title: "Senior Manager Finance AU"},
    {id: "APR023", firstName: "Ryan", lastName: "Wright", email: "ryan.wright@company.com", country: "Malaysia", level: 5, dept: "Operations", title: "Senior Manager MY"},
    {id: "APR024", firstName: "Lauren", lastName: "Scott", email: "lauren.scott@company.com", country: "APAC", level: 5, dept: "Technical", title: "Senior Manager Projects"},
    {id: "APR025", firstName: "Matthew", lastName: "Green", email: "matthew.green@company.com", country: "Australia", level: 5, dept: "Commercial", title: "Senior Manager Commercial AU"},
    // Level 6
    {id: "APR026", firstName: "Emily", lastName: "Adams", email: "emily.adams@company.com", country: "Australia", level: 6, dept: "Operations", title: "Manager Operations AU"},
    {id: "APR027", firstName: "Joshua", lastName: "Baker", email: "joshua.baker@company.com", country: "Australia", level: 6, dept: "Finance", title: "Manager Finance AU"},
    {id: "APR028", firstName: "Samantha", lastName: "Nelson", email: "samantha.nelson@company.com", country: "Malaysia", level: 6, dept: "Operations", title: "Manager Operations MY"},
    {id: "APR029", firstName: "Tyler", lastName: "Carter", email: "tyler.carter@company.com", country: "APAC", level: 6, dept: "Technical", title: "Manager Engineering"},
    {id: "APR030", firstName: "Ashley", lastName: "Mitchell", email: "ashley.mitchell@company.com", country: "Australia", level: 6, dept: "Commercial", title: "Manager Commercial AU"},
    // Level 7
    {id: "APR031", firstName: "Jacob", lastName: "Roberts", email: "jacob.roberts@company.com", country: "Australia", level: 7, dept: "Operations", title: "Senior Analyst AU"},
    {id: "APR032", firstName: "Megan", lastName: "Turner", email: "megan.turner@company.com", country: "Australia", level: 7, dept: "Finance", title: "Senior Financial Analyst AU"},
    {id: "APR033", firstName: "Nathan", lastName: "Phillips", email: "nathan.phillips@company.com", country: "Malaysia", level: 7, dept: "Operations", title: "Senior Analyst MY"},
    {id: "APR034", firstName: "Kayla", lastName: "Campbell", email: "kayla.campbell@company.com", country: "APAC", level: 7, dept: "Technical", title: "Senior Project Analyst"},
    {id: "APR035", firstName: "Justin", lastName: "Parker", email: "justin.parker@company.com", country: "Australia", level: 7, dept: "Commercial", title: "Senior Commercial Analyst AU"},
    // Level 8
    {id: "APR036", firstName: "Hannah", lastName: "Evans", email: "hannah.evans@company.com", country: "Australia", level: 8, dept: "Operations", title: "Analyst AU"},
    {id: "APR037", firstName: "Austin", lastName: "Edwards", email: "austin.edwards@company.com", country: "Australia", level: 8, dept: "Finance", title: "Financial Analyst AU"},
    {id: "APR038", firstName: "Brittany", lastName: "Collins", email: "brittany.collins@company.com", country: "Malaysia", level: 8, dept: "Operations", title: "Analyst MY"},
    {id: "APR039", firstName: "Connor", lastName: "Stewart", email: "connor.stewart@company.com", country: "APAC", level: 8, dept: "Technical", title: "Project Analyst"},
    {id: "APR040", firstName: "Victoria", lastName: "Sanchez", email: "victoria.sanchez@company.com", country: "Australia", level: 8, dept: "Commercial", title: "Commercial Analyst AU"},
    // Level 9
    {id: "APR041", firstName: "Dylan", lastName: "Morris", email: "dylan.morris@company.com", country: "Australia", level: 9, dept: "Operations", title: "Junior Analyst AU"},
    {id: "APR042", firstName: "Olivia", lastName: "Rogers", email: "olivia.rogers@company.com", country: "Australia", level: 9, dept: "Finance", title: "Junior Financial Analyst AU"},
    {id: "APR043", firstName: "Ethan", lastName: "Reed", email: "ethan.reed@company.com", country: "Malaysia", level: 9, dept: "Operations", title: "Junior Analyst MY"},
    {id: "APR044", firstName: "Sophia", lastName: "Cook", email: "sophia.cook@company.com", country: "APAC", level: 9, dept: "Technical", title: "Junior Project Analyst"},
    {id: "APR045", firstName: "Alexander", lastName: "Morgan", email: "alexander.morgan@company.com", country: "Australia", level: 9, dept: "Commercial", title: "Junior Commercial Analyst AU"},
    // Level 10
    {id: "APR046", firstName: "Isabella", lastName: "Bell", email: "isabella.bell@company.com", country: "Australia", level: 10, dept: "Operations", title: "Associate AU"},
    {id: "APR047", firstName: "Benjamin", lastName: "Murphy", email: "benjamin.murphy@company.com", country: "Australia", level: 10, dept: "Finance", title: "Finance Associate AU"},
    {id: "APR048", firstName: "Chloe", lastName: "Bailey", email: "chloe.bailey@company.com", country: "Malaysia", level: 10, dept: "Operations", title: "Associate MY"},
    {id: "APR049", firstName: "Logan", lastName: "Rivera", email: "logan.rivera@company.com", country: "APAC", level: 10, dept: "Technical", title: "Project Associate"},
    {id: "APR050", firstName: "Grace", lastName: "Cooper", email: "grace.cooper@company.com", country: "Australia", level: 10, dept: "Commercial", title: "Commercial Associate AU"}
  ],
  
  tCodes: {
    // FI Module
    createProject: {code: "CJ20N", description: "Create Project"},
    addBudget: {code: "ZJ40", description: "Add Budget"},
    checkStatus: {code: "ZJ053", description: "Project Status Report"},
    // MM Module
    createSES: {code: "ML81N", description: "Create Service Entry Sheet"},
    createGR: {code: "MIGO", description: "Goods Receipt"},
    displayPO: {code: "ME23N", description: "Display Purchase Order"},
    // AA Module
    assetExplorer: {code: "AW01N", description: "Asset Explorer"},
    createAsset: {code: "AS01", description: "Create Asset Master"},
    changeAsset: {code: "AS02", description: "Change Asset Master"},
    settlement: {code: "KO88", description: "Settlement"},
    assetSale: {code: "ABAON", description: "Asset Sale with Revenue"},
    assetScrap: {code: "ABAVN", description: "Asset Scrapping"},
    assetTransfer: {code: "ABUMN", description: "Asset Transfer"}
  },
  
  // AA Module - Asset Accounting
  assetAccounting: {
    assetClasses: [
      {code: "INTANG_WELL", name: "Intangible Wells", category: "Drilling", defaultUsefulLife: 0, depKey: "NONE"},
      {code: "TANG_WELL", name: "Tangible Wells", category: "Drilling", defaultUsefulLife: 15, depKey: "LINR"},
      {code: "INFRA", name: "Infrastructure", category: "Facilities", defaultUsefulLife: 25, depKey: "LINR"},
      {code: "PPE", name: "Plant Property Equipment", category: "Facilities", defaultUsefulLife: 20, depKey: "LINR"},
      {code: "SOFTWARE", name: "Software", category: "EMIT", defaultUsefulLife: 5, depKey: "LINR"},
      {code: "COMPUTER", name: "Computer Hardware", category: "EMIT", defaultUsefulLife: 4, depKey: "LINR"},
      {code: "VEHICLE", name: "Vehicles", category: "EMIT", defaultUsefulLife: 7, depKey: "LINR"},
      {code: "DECOM", name: "Decommissioning", category: "Decommissioning", defaultUsefulLife: 0, depKey: "UNIT"},
      {code: "LAND", name: "Land", category: "Land", defaultUsefulLife: 0, depKey: "NONE"},
      {code: "BUILDING", name: "Buildings", category: "Building", defaultUsefulLife: 40, depKey: "LINR"}
    ],
    depreciationKeys: [
      {key: "LINR", name: "Straight Line", method: "Linear"},
      {key: "DECL", name: "Declining Balance", method: "Declining"},
      {key: "UNIT", name: "Units of Production", method: "Activity"},
      {key: "NONE", name: "No Depreciation", method: "None"}
    ],
    retirementTypes: [
      {code: "SALE", name: "Sale to Third Party", tCode: "ABAON", hasRevenue: true},
      {code: "SCRAP", name: "Scrapping", tCode: "ABAVN", hasRevenue: false},
      {code: "WRITEOFF", name: "Write-Off", tCode: "AR02", hasRevenue: false},
      {code: "TRANSFER_INT", name: "Internal Transfer", tCode: "ABUMN", hasRevenue: false},
      {code: "TRANSFER_IC", name: "Intercompany Transfer", tCode: "ABT1N", hasRevenue: false}
    ]
  },
  
  tips: [
    "Project number first digit (6) is FIXED for Australia",
    "All prerequisites must be completed BEFORE creating in SAP",
    "Level approval is based on Net Budget in USD (AUD Ã· 1.59)",
    "Tax Review required if Net > $3M AUD",
    "JV Approval required if Net > $5M AUD",
    "For OBO (6602): Recovery auto-selects NB",
    "For EMIT (03): Requires CAPEX/OPEX ruling from Fund.IT",
    "For Decommissioning (XF): Add settlement rule to 490000030 BEFORE status change",
    "Budget must go to WBS Level 1",
    "DOAG FX rate updates every 1 Jan and 1 July",
    "Capitalization: Verify AUC balance in AW01N before settlement",
    "Asset retirement: Always verify Net Book Value before disposal"
  ],
  
  // ========== KNOWLEDGE BASE - Issues & Ad-hoc Support ==========
  knowledgeBase: {
    categories: [
      {id: "PO", name: "Purchase Orders", icon: "ShoppingCart"},
      {id: "PROJECT", name: "Project Management", icon: "FolderKanban"},
      {id: "COST", name: "Cost Management", icon: "DollarSign"},
      {id: "SETTLEMENT", name: "Settlement & Capitalization", icon: "ArrowRightLeft"},
      {id: "ASSET", name: "Asset Management", icon: "Building"},
      {id: "BUDGET", name: "Budget Issues", icon: "Wallet"},
      {id: "INVOICE", name: "Invoice & Payment", icon: "Receipt"}
    ],
    
    articles: [
      // === PURCHASE ORDER ISSUES ===
      {
        id: "PO_CLOSE",
        category: "PO",
        title: "How to Close a Purchase Order",
        problem: "PO needs to be closed but has open items or remaining balance",
        tCodes: ["ME22N", "ME23N"],
        steps: [
          "Open ME22N (Change PO) â†’ Enter PO number",
          "Go to line item level",
          "For each line to close: Check 'Delivery Completed' indicator (or 'Final Invoice' if applicable)",
          "Alternatively, set the 'Deletion Indicator' on lines not needed",
          "Save the PO",
          "Verify in ME23N that status shows closed/completed"
        ],
        notes: [
          "Cannot close PO if goods/services received but not invoiced",
          "For partial delivery: Set 'Delivery Completed' to close remaining qty",
          "Closing PO releases any remaining commitment"
        ],
        relatedIssues: ["PO_RESIDUAL", "PO_BLOCK"]
      },
      {
        id: "PO_RESIDUAL",
        category: "PO",
        title: "How to Clear PO Residual Value",
        problem: "Small residual value remaining on PO after final invoice",
        tCodes: ["MR44", "ME22N"],
        steps: [
          "Option 1 - Write off via MR44:",
          "  â€¢ Open MR44 (Release Blocked Invoices)",
          "  â€¢ Or use automatic tolerance settings",
          "Option 2 - Manual adjustment in ME22N:",
          "  â€¢ Change PO value to match actual invoiced amount",
          "  â€¢ Or set 'Final Invoice' indicator",
          "Option 3 - Post manual clearing:",
          "  â€¢ Use F-02 to post clearing entry"
        ],
        notes: [
          "Residuals under tolerance limit can auto-clear",
          "Check company tolerance settings before manual intervention"
        ]
      },
      {
        id: "PO_BLOCK",
        category: "PO",
        title: "How to Unblock a Blocked PO",
        problem: "PO is blocked and cannot be processed",
        tCodes: ["ME28", "ME22N", "ME23N"],
        steps: [
          "First, identify why PO is blocked in ME23N",
          "Common blocks:",
          "  â€¢ Price variance â†’ Approve in ME28 or adjust price",
          "  â€¢ Quality block â†’ Release after QC in QA32",
          "  â€¢ Payment block â†’ Remove in ME22N or vendor master",
          "  â€¢ Budget exceeded â†’ Request budget transfer",
          "For release: ME28 â†’ Enter PO â†’ Select block â†’ Release"
        ],
        notes: [
          "Some blocks require specific authorization",
          "Check workflow status if approval pending"
        ]
      },
      
      // === PROJECT STATUS ISSUES ===
      {
        id: "PROJECT_STATUS_CHANGE",
        category: "PROJECT",
        title: "How to Change Project Status",
        problem: "Need to change project status (REL, TECO, CLSD)",
        tCodes: ["CJ20N", "CJ02", "BSVA"],
        steps: [
          "Open CJ20N â†’ Enter project number",
          "Select WBS element(s) to change",
          "Menu: Edit â†’ Status â†’ Set/Delete",
          "Select new status:",
          "  â€¢ REL = Released (active)",
          "  â€¢ TECO = Technically Complete",
          "  â€¢ CLSD = Closed (no more postings)",
          "For TECO: System will prompt if open commitments exist",
          "Save changes"
        ],
        notes: [
          "Cannot TECO if open POs with GR not invoiced",
          "CLSD prevents all future postings",
          "For Decommissioning: Settlement rule must exist BEFORE TECO"
        ],
        warnings: [
          "TECO/CLSD cannot be easily reversed",
          "Ensure all costs allocated before closing"
        ]
      },
      {
        id: "PROJECT_REOPEN",
        category: "PROJECT",
        title: "How to Reopen a Closed Project",
        problem: "Need to post to a TECO or CLSD project",
        tCodes: ["CJ20N", "BSVA"],
        steps: [
          "For TECO projects:",
          "  â€¢ CJ20N â†’ Select WBS â†’ Edit â†’ Status â†’ Delete TECO",
          "For CLSD projects:",
          "  â€¢ Requires special authorization",
          "  â€¢ May need basis team to remove status",
          "  â€¢ Document business justification",
          "Alternative: Post to a related open project and journal"
        ],
        notes: [
          "Reopening CLSD requires audit trail",
          "Consider creating new project instead if major changes needed"
        ]
      },
      
      // === COST MANAGEMENT ===
      {
        id: "COST_CHECK_ACTUAL",
        category: "COST",
        title: "How to Check Actual Costs",
        problem: "Need to view actual costs on a project/WBS",
        tCodes: ["CJI3", "CJ30", "S_ALR_87013543", "ZJ053"],
        steps: [
          "Option 1 - CJI3 (Line Items):",
          "  â€¢ Enter WBS element",
          "  â€¢ Select fiscal year",
          "  â€¢ Execute â†’ Shows all line items",
          "Option 2 - CJ30 (Budget vs Actual):",
          "  â€¢ Enter project",
          "  â€¢ Shows budget, actual, commitment, available",
          "Option 3 - S_ALR_87013543 (Hierarchy Report):",
          "  â€¢ Enter project",
          "  â€¢ Shows rolled-up costs by WBS level",
          "Option 4 - ZJ053 (Custom Report):",
          "  â€¢ Enter project number",
          "  â€¢ Shows status and cost summary"
        ],
        notes: [
          "CJI3 shows individual postings with document numbers",
          "CJ30 includes commitments (PO not yet invoiced)",
          "Reports can be exported to Excel"
        ]
      },
      {
        id: "COST_TRANSFER",
        category: "COST",
        title: "How to Transfer Costs Between Projects",
        problem: "Costs posted to wrong project/WBS",
        tCodes: ["KB61", "KB11", "KB21"],
        steps: [
          "For manual reposting - KB61:",
          "  â€¢ Enter document date, posting date",
          "  â€¢ Enter FROM cost object (wrong project)",
          "  â€¢ Enter TO cost object (correct project)",
          "  â€¢ Enter amount and cost element",
          "  â€¢ Save â†’ Note document number",
          "For statistical key figures - KB21",
          "For activity allocation - KB11"
        ],
        notes: [
          "Both projects must be in same controlling area",
          "Target project must have budget available",
          "Requires appropriate authorization",
          "Document reason for transfer"
        ],
        warnings: [
          "May affect JV cost recovery",
          "Check if both projects have same JV code"
        ]
      },
      {
        id: "COST_COMMITMENT",
        category: "COST",
        title: "How to View/Manage Commitments",
        problem: "Need to understand PO commitments against budget",
        tCodes: ["CJ30", "ME2M", "S_ALR_87012093"],
        steps: [
          "View commitments in CJ30:",
          "  â€¢ Enter project â†’ See 'Commitment' column",
          "To drill down to POs - ME2M:",
          "  â€¢ Enter WBS element in account assignment",
          "  â€¢ Shows all POs against that WBS",
          "For commitment report - S_ALR_87012093:",
          "  â€¢ Enter project/WBS",
          "  â€¢ Shows commitment by vendor/PO"
        ],
        notes: [
          "Commitment = PO value not yet invoiced",
          "Commitment reduces available budget",
          "Closing PO releases commitment"
        ]
      },
      
      // === SETTLEMENT ISSUES ===
      {
        id: "SETTLEMENT_ERROR_NO_RULE",
        category: "SETTLEMENT",
        title: "Settlement Error - No Settlement Rule",
        problem: "KO88 error: 'No settlement rule exists'",
        tCodes: ["KO02", "KO88"],
        steps: [
          "Check settlement rule in KO02:",
          "  â€¢ Enter WBS element",
          "  â€¢ Go to 'Settlement Rule' tab",
          "If no rule exists, create one:",
          "  â€¢ Enter receiver (Asset, Cost Center, GL Account)",
          "  â€¢ Enter percentage (usually 100%)",
          "  â€¢ Set validity dates",
          "  â€¢ Save",
          "Re-run KO88"
        ],
        notes: [
          "Every WBS must have settlement rule for KO88",
          "Decommissioning: Settle to account 490000030",
          "Capitalization: Settle to Asset number"
        ]
      },
      {
        id: "SETTLEMENT_ERROR_RECEIVER",
        category: "SETTLEMENT",
        title: "Settlement Error - Invalid Receiver",
        problem: "Settlement fails due to invalid receiver",
        tCodes: ["KO02", "AS03", "KO88"],
        steps: [
          "Check the error message for receiver type",
          "For Asset receiver - verify in AS03:",
          "  â€¢ Asset must exist and be active",
          "  â€¢ Asset class must allow settlements",
          "For Cost Center receiver:",
          "  â€¢ Cost center must be active for posting period",
          "For GL Account receiver:",
          "  â€¢ Account must exist in chart of accounts",
          "Update settlement rule in KO02 with valid receiver",
          "Re-run settlement"
        ],
        notes: [
          "Asset must be created BEFORE settlement rule points to it",
          "Check fiscal year settings for receivers"
        ]
      },
      {
        id: "SETTLEMENT_ERROR_PERIOD",
        category: "SETTLEMENT",
        title: "Settlement Error - Period Closed",
        problem: "Cannot settle - posting period closed",
        tCodes: ["OB52", "KO88"],
        steps: [
          "Check posting period in OB52:",
          "  â€¢ Verify which periods are open",
          "Options:",
          "  1. Request period reopening from Finance",
          "  2. Run settlement in next open period",
          "  3. Use special period if available",
          "Once period open, re-run KO88"
        ],
        notes: [
          "Month-end close locks posting periods",
          "Year-end requires special authorization",
          "Document business justification for reopening"
        ]
      },
      {
        id: "SETTLEMENT_PARTIAL",
        category: "SETTLEMENT",
        title: "How to Do Partial Settlement",
        problem: "Need to settle only portion of costs",
        tCodes: ["KO02", "KO88"],
        steps: [
          "In KO02, create multiple settlement rules:",
          "  â€¢ Rule 1: Receiver A = 60%",
          "  â€¢ Rule 2: Receiver B = 40%",
          "  â€¢ Total must equal 100%",
          "Or use equivalence numbers for proportional split",
          "Run KO88 - system will split automatically"
        ],
        notes: [
          "Percentages must total 100%",
          "Can have different validity periods per rule",
          "Useful for JV cost sharing"
        ]
      },
      
      // === ASSET ISSUES ===
      {
        id: "ASSET_FIND_NUMBER",
        category: "ASSET",
        title: "How to Find Asset Number",
        problem: "Need to locate asset number from project/description",
        tCodes: ["AW01N", "AS03", "S_ALR_87011990"],
        steps: [
          "Option 1 - Search by description in AW01N:",
          "  â€¢ Use * wildcard in search",
          "Option 2 - Asset list report S_ALR_87011990:",
          "  â€¢ Filter by company code, asset class",
          "  â€¢ Export to Excel and search",
          "Option 3 - If from project, check settlement rule:",
          "  â€¢ KO03 â†’ WBS â†’ Settlement Rule tab",
          "  â€¢ Shows receiving asset number"
        ],
        notes: [
          "Asset numbers are company code specific",
          "Sub-numbers exist for complex assets"
        ]
      },
      {
        id: "ASSET_CHANGE_VALUES",
        category: "ASSET",
        title: "How to Correct Asset Values",
        problem: "Asset values incorrect - need adjustment",
        tCodes: ["ABSO", "ABAA", "AB02"],
        steps: [
          "For value adjustment - ABSO:",
          "  â€¢ Enter asset, transaction type",
          "  â€¢ Enter adjustment amount",
          "  â€¢ Post",
          "For write-up - ABAA:",
          "  â€¢ Enter asset",
          "  â€¢ Enter increase amount",
          "For manual depreciation - AB02:",
          "  â€¢ Enter asset",
          "  â€¢ Enter depreciation amount"
        ],
        warnings: [
          "Asset value changes require authorization",
          "May impact tax depreciation",
          "Document reason for adjustment"
        ]
      },
      
      // === BUDGET ISSUES ===
      {
        id: "BUDGET_EXCEEDED",
        category: "BUDGET",
        title: "Budget Exceeded - Cannot Post",
        problem: "Posting rejected due to budget exceeded",
        tCodes: ["CJ30", "CJ36", "CJ40"],
        steps: [
          "Check current budget status in CJ30:",
          "  â€¢ View Budget vs Actual vs Available",
          "Options:",
          "  1. Request budget supplement (CJ36/CJ40)",
          "  2. Transfer budget from another WBS (CJ34)",
          "  3. Reduce commitment (close unused POs)",
          "  4. Request budget override (requires authorization)"
        ],
        notes: [
          "Budget supplements require approval workflow",
          "Check if tolerance exists before escalating"
        ]
      },
      {
        id: "BUDGET_TRANSFER",
        category: "BUDGET",
        title: "How to Transfer Budget Between WBS",
        problem: "Need to move budget from one WBS to another",
        tCodes: ["CJ34", "CJ36"],
        steps: [
          "Open CJ34 (Budget Transfer):",
          "  â€¢ Enter fiscal year",
          "  â€¢ Enter FROM WBS element",
          "  â€¢ Enter TO WBS element",
          "  â€¢ Enter amount to transfer",
          "  â€¢ Select budget type (Original/Supplement)",
          "  â€¢ Save",
          "Verify in CJ30 both WBS elements updated"
        ],
        notes: [
          "Both WBS must be in same project or allow cross-project",
          "Transfer does not require new approval",
          "Document reason for transfer"
        ]
      },
      
      // === INVOICE ISSUES ===
      {
        id: "INVOICE_BLOCKED",
        category: "INVOICE",
        title: "Invoice Blocked for Payment",
        problem: "Vendor invoice blocked and cannot be paid",
        tCodes: ["MRBR", "MIR4", "FBL1N"],
        steps: [
          "Identify block reason in MIR4:",
          "  â€¢ Enter invoice document",
          "  â€¢ Check 'Block' field",
          "Common blocks and resolutions:",
          "  â€¢ Price variance â†’ Approve variance or credit note",
          "  â€¢ Quantity variance â†’ Verify GR, adjust if needed",
          "  â€¢ Manual block â†’ Release in MRBR",
          "  â€¢ Payment block â†’ Remove in vendor master",
          "Release blocked invoices in MRBR"
        ],
        notes: [
          "Some blocks require manager approval",
          "Check 3-way match (PO-GR-Invoice)"
        ]
      },
      {
        id: "INVOICE_REVERSE",
        category: "INVOICE",
        title: "How to Reverse an Invoice",
        problem: "Posted invoice needs to be reversed/cancelled",
        tCodes: ["MR8M", "FB08"],
        steps: [
          "For MM invoices (MIRO) - use MR8M:",
          "  â€¢ Enter original invoice document",
          "  â€¢ Enter reversal reason",
          "  â€¢ Enter posting date",
          "  â€¢ Post reversal",
          "For FI documents - use FB08:",
          "  â€¢ Enter document number, company code, year",
          "  â€¢ Enter reversal reason",
          "  â€¢ Post"
        ],
        notes: [
          "Reversal creates new document",
          "Cannot reverse if period closed",
          "Check vendor account after reversal"
        ]
      },
      {
        id: "INVOICE_GR_MISMATCH",
        category: "INVOICE",
        title: "Invoice vs GR Quantity Mismatch",
        problem: "Invoice quantity doesn't match Goods Receipt",
        tCodes: ["MIRO", "MIGO", "ME23N"],
        steps: [
          "First, verify actual receipt in ME23N:",
          "  â€¢ Check GR history on PO",
          "  â€¢ Compare quantities",
          "If GR short:",
          "  â€¢ Post additional GR in MIGO",
          "  â€¢ Then process invoice",
          "If GR over:",
          "  â€¢ Reverse excess GR in MIGO",
          "  â€¢ Or process partial invoice"
        ],
        notes: [
          "3-way match: PO qty â‰¥ GR qty â‰¥ Invoice qty",
          "Tolerance settings may allow small variances"
        ]
      }
    ]
  }
};

// ============================================================
// BACKEND CONFIGURATION
// ============================================================
// Backend URL will be set from Admin settings and stored in localStorage

/**
 * Call the backend API
 * @param {object} data - The data to send (must include 'action')
 * @param {string} backendUrl - The backend URL (optional, uses localStorage if not provided)
 * @returns {Promise<object>} - The response from the backend
 */
const callBackendApi = async (data, backendUrl) => {
  const url = backendUrl || localStorage.getItem("sap_playbook_backend_url");
  
  // If no backend URL configured, throw error to trigger fallback
  if (!url) {
    console.warn("Backend URL not configured. Using offline mode.");
    throw new Error("Backend not configured");
  }
  
  try {
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "text/plain", // Google Apps Script works better with text/plain
      },
      body: JSON.stringify(data)
    });
    
    const text = await response.text();
    
    try {
      const result = JSON.parse(text);
      return result;
    } catch (parseError) {
      console.error("Failed to parse response:", text);
      throw new Error("Invalid response from backend");
    }
  } catch (error) {
    console.error("Backend call failed:", error);
    throw error;
  }
};

const App = () => {
  // State
  const [module, setModule] = useState("intake");
  const [countries, setCountries] = useState([{id: "Australia", flag: "ðŸ‡¦ðŸ‡º", currency: "AUD"}]);
  const [selectedCountry, setSelectedCountry] = useState({id: "Australia", flag: "ðŸ‡¦ðŸ‡º"});
  const [countryConfig, setCountryConfig] = useState(DEFAULT_CONFIG);
  
  // ========== NEW: Global Search State ==========
  const [showGlobalSearch, setShowGlobalSearch] = useState(false);
  
  // ========== NEW: Enhanced Features Tab State ==========
  const [enhancedTab, setEnhancedTab] = useState("checklist");
  const [projectDataForFeatures, setProjectDataForFeatures] = useState(null);
  
  // ========== NEW: Keyboard shortcut for Global Search (Cmd/Ctrl+K) ==========
  useEffect(() => {
    const handleKeyDown = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        setShowGlobalSearch(true);
      }
      if (e.key === 'Escape') {
        setShowGlobalSearch(false);
      }
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);
  
  const [workflows] = useState([
    // === FI MODULE (Project/Budget) ===
    {id: "CREATE_PROJECT", name: "Create New Project", icon: "FolderPlus", module: "FI", description: "Create project with WBS and initial budget", requiredInputs: [
      {id: "projectCategory", label: "Project Category", type: "select", options: ["Capital", "Decommissioning"], required: true},
      {id: "budgetClass", label: "Budget Class", type: "select", dependsOn: "projectCategory", required: true},
      {id: "projectStage", label: "Project Stage", type: "select", source: "projectStages", required: true},
      {id: "companyCode", label: "Company Code", type: "select", source: "companyCodes", required: true},
      {id: "jvCode", label: "JV Code (from AFE)", type: "select", dependsOn: "companyCode", required: true},
      {id: "businessArea", label: "Business Area", type: "select", source: "businessAreas", required: true},
      {id: "recoveryIndicator", label: "Recovery Indicator", type: "select", source: "recoveryIndicators", required: true, autoSelect: {"6602": "NB"}},
      {id: "grossBudget", label: "Gross Budget (100%)", type: "number", required: true, section: "Budget"},
      {id: "fundingStage", label: "Funding Stage", type: "select", source: "fundingStages", required: true, section: "Budget"}
    ]},
    {id: "ADD_BUDGET", name: "Add Budget (Existing Project)", icon: "Wallet", module: "FI", description: "Add budget to existing project", requiredInputs: [
      {id: "projectNumber", label: "Project Number", type: "text", required: true},
      {id: "companyCode", label: "Company Code", type: "select", source: "companyCodes", required: true},
      {id: "jvCode", label: "JV Code (from AFE)", type: "select", dependsOn: "companyCode", required: true},
      {id: "grossBudget", label: "Gross Budget (100%)", type: "number", required: true},
      {id: "fundingStage", label: "Funding Stage", type: "select", source: "fundingStages", required: true}
    ]},
    {id: "CHECK_STATUS", name: "Check Project Status", icon: "Search", module: "FI", requiredInputs: [
      {id: "projectNumber", label: "Project Number", type: "text", required: true}
    ]},
    
    // === MM MODULE (Procurement/SES/GR) ===
    {id: "CREATE_SES", name: "Create Service Entry Sheet", icon: "FileText", module: "MM", description: "Create SES for service PO", requiredInputs: [
      {id: "poNumber", label: "Purchase Order Number", type: "text", required: true},
      {id: "poLineItem", label: "PO Line Item", type: "text", required: true},
      {id: "vendorId", label: "Vendor ID", type: "text", required: true},
      {id: "serviceDescription", label: "Service Description", type: "text", required: true},
      {id: "quantity", label: "Quantity", type: "number", required: true},
      {id: "unitPrice", label: "Unit Price", type: "number", required: true},
      {id: "currency", label: "Currency", type: "select", options: ["AUD", "USD"], required: true},
      {id: "performanceDate", label: "Performance Date", type: "date", required: true},
      {id: "wbsElement", label: "WBS Element", type: "text", required: true}
    ]},
    {id: "CREATE_GR", name: "Create Goods Receipt", icon: "Package", module: "MM", description: "Create GR for material PO", requiredInputs: [
      {id: "poNumber", label: "Purchase Order Number", type: "text", required: true},
      {id: "poLineItem", label: "PO Line Item", type: "text", required: true},
      {id: "materialNumber", label: "Material Number", type: "text", required: true},
      {id: "quantity", label: "Quantity Received", type: "number", required: true},
      {id: "uom", label: "Unit of Measure", type: "select", options: ["EA", "KG", "L", "M", "HR"], required: true},
      {id: "storageLocation", label: "Storage Location", type: "text", required: true},
      {id: "deliveryNote", label: "Delivery Note Number", type: "text", required: false},
      {id: "wbsElement", label: "WBS Element", type: "text", required: true}
    ]},
    {id: "REVERSE_SES", name: "Reverse Service Entry Sheet", icon: "RotateCcw", module: "MM", description: "Reverse/Cancel SES", requiredInputs: [
      {id: "sesNumber", label: "SES Document Number", type: "text", required: true},
      {id: "reversalReason", label: "Reversal Reason", type: "select", options: ["Incorrect Quantity", "Incorrect Price", "Wrong PO", "Duplicate Entry", "Service Not Performed"], required: true},
      {id: "reversalDate", label: "Reversal Date", type: "date", required: true}
    ]},
    {id: "REVERSE_GR", name: "Reverse Goods Receipt", icon: "RotateCcw", module: "MM", description: "Reverse/Cancel GR", requiredInputs: [
      {id: "grNumber", label: "GR Document Number", type: "text", required: true},
      {id: "reversalReason", label: "Reversal Reason", type: "select", options: ["Incorrect Quantity", "Damaged Goods", "Wrong Material", "Duplicate Entry", "Goods Returned"], required: true},
      {id: "movementType", label: "Movement Type", type: "select", options: ["102 - GR Reversal", "122 - Return to Vendor"], required: true},
      {id: "reversalDate", label: "Reversal Date", type: "date", required: true}
    ]},
    {id: "CHECK_PO_STATUS", name: "Check PO Status", icon: "Search", module: "MM", requiredInputs: [
      {id: "poNumber", label: "Purchase Order Number", type: "text", required: true}
    ]},
    
    // === AA MODULE (Asset Accounting - Capitalization) ===
    {id: "EMDS_CAPITALIZE", name: "EMDS - Capitalize Asset", icon: "Building", module: "AA", description: "Capitalize AUC to final asset", requiredInputs: [
      {id: "projectNumber", label: "Project Number", type: "text", required: true},
      {id: "wbsElement", label: "WBS Element", type: "text", required: true},
      {id: "assetDescription", label: "Asset Description", type: "text", required: true},
      {id: "assetClass", label: "Asset Class", type: "select", options: ["INTANG_WELL - Intangible Wells", "TANG_WELL - Tangible Wells", "INFRA - Infrastructure", "PPE - Plant Property Equipment", "SOFTWARE - Software", "COMPUTER - Computer", "VEHICLE - Vehicles", "DECOM - Decommissioning"], required: true},
      {id: "capitalizationAmount", label: "Capitalization Amount", type: "number", required: true},
      {id: "inServiceDate", label: "In-Service Date", type: "date", required: true},
      {id: "usefulLife", label: "Useful Life (Years)", type: "number", required: true},
      {id: "location", label: "Physical Location", type: "text", required: true}
    ]},
    {id: "PTRA_TRANSFER", name: "PTRA - Transfer Asset", icon: "ArrowRightLeft", module: "AA", description: "Transfer asset between entities", requiredInputs: [
      {id: "assetNumber", label: "Asset Number", type: "text", required: true},
      {id: "transferType", label: "Transfer Type", type: "select", options: ["Within Company", "Intercompany"], required: true},
      {id: "fromCostCenter", label: "From Cost Center", type: "text", required: true},
      {id: "toCostCenter", label: "To Cost Center", type: "text", required: true},
      {id: "fromLocation", label: "From Location", type: "text", required: false},
      {id: "toLocation", label: "To Location", type: "text", required: false},
      {id: "transferDate", label: "Transfer Date", type: "date", required: true}
    ]},
    {id: "PTRA_RETIRE", name: "PTRA - Retire Asset", icon: "Trash2", module: "AA", description: "Retire/dispose of asset", requiredInputs: [
      {id: "assetNumber", label: "Asset Number", type: "text", required: true},
      {id: "retirementType", label: "Retirement Type", type: "select", options: ["Sale", "Scrapping", "Write-off"], required: true},
      {id: "retirementDate", label: "Retirement Date", type: "date", required: true},
      {id: "saleAmount", label: "Sale Amount (if sold)", type: "number", required: false},
      {id: "buyerName", label: "Buyer Name (if sold)", type: "text", required: false},
      {id: "retirementReason", label: "Reason for Retirement", type: "text", required: true}
    ]},
    {id: "CHECK_ASSET", name: "Check Asset Status", icon: "Search", module: "AA", requiredInputs: [
      {id: "assetNumber", label: "Asset Number", type: "text", required: true}
    ]}
  ]);
  
  const [currentTask, setCurrentTask] = useState(null);
  const [completedSteps, setCompletedSteps] = useState({});
  const [intakeResult, setIntakeResult] = useState(null);
  const [intakeInput, setIntakeInput] = useState({});
  const [selectedWorkflow, setSelectedWorkflow] = useState(null);
  
  // Signature tracking for forms
  const [formSignatures, setFormSignatures] = useState([]);
  const [selectedForm, setSelectedForm] = useState(null);
  const [showSignatureModal, setShowSignatureModal] = useState(false);
  const [signatureToSign, setSignatureToSign] = useState(null);
  const [signatureStyle, setSignatureStyle] = useState("style1");
  const [signaturesLoading, setSignaturesLoading] = useState(false);
  const [signatureStats, setSignatureStats] = useState(null);
  const [docFilter, setDocFilter] = useState("all");
  const [showCreateFormModal, setShowCreateFormModal] = useState(false);
  const [newFormData, setNewFormData] = useState({formType: "AFE", projectName: "", totalBudget: "", country: "Australia"});
  
  // Load signatures from backend
  const loadSignatures = async () => {
    setSignaturesLoading(true);
    try {
      const result = await callBackend({action: "GET_FORMS"});
      if (result.success) {
        setFormSignatures(result.forms || []);
      }
    } catch (err) {
      console.error("Failed to load signatures:", err);
      // Keep demo data as fallback
      if (formSignatures.length === 0) {
        setFormSignatures([
          {id: "SIG001", formId: "AFE-2024-001", formType: "AFE", projectName: "Platform Upgrade Project",
           signatures: [
             {boxId: "preparer", label: "Prepared By", required: true, status: "signed", signedBy: "John Smith", signedAt: "2024-01-15", role: "Project Manager"},
             {boxId: "reviewer", label: "Reviewed By", required: true, status: "signed", signedBy: "Sarah Lee", signedAt: "2024-01-16", role: "Finance Manager"},
             {boxId: "level6", label: "Level 6 Approval", required: true, status: "signed", signedBy: "Emily Adams", signedAt: "2024-01-17", role: "Manager Operations AU"},
             {boxId: "level5", label: "Level 5 Approval", required: true, status: "pending", signedBy: null, signedAt: null, role: "Senior Manager"},
             {boxId: "level4", label: "Level 4 Approval", required: false, status: "not_required", signedBy: null, signedAt: null, role: "Director"}
           ],
           createdAt: "2024-01-15", totalBudget: 15000000, status: "in_progress"
          },
          {id: "SIG002", formId: "AFE-2024-002", formType: "AFE", projectName: "Well Decommissioning Phase 1",
           signatures: [
             {boxId: "preparer", label: "Prepared By", required: true, status: "signed", signedBy: "Mike Chen", signedAt: "2024-01-18", role: "Project Engineer"},
             {boxId: "reviewer", label: "Reviewed By", required: true, status: "pending", signedBy: null, signedAt: null, role: "Finance Manager"},
             {boxId: "level6", label: "Level 6 Approval", required: true, status: "pending", signedBy: null, signedAt: null, role: "Manager"},
             {boxId: "level5", label: "Level 5 Approval", required: true, status: "pending", signedBy: null, signedAt: null, role: "Senior Manager"}
           ],
           createdAt: "2024-01-18", totalBudget: 8500000, status: "pending_review"
          }
        ]);
      }
    }
    setSignaturesLoading(false);
  };
  
  // Load signature stats
  const loadSignatureStats = async () => {
    try {
      const result = await callBackend({action: "GET_SIGNATURE_STATS"});
      if (result.success) {
        setSignatureStats(result.stats);
      }
    } catch (err) {
      console.error("Failed to load signature stats:", err);
    }
  };
  
  // Create new form with signatures
  const createNewForm = async () => {
    if (!newFormData.projectName || !newFormData.totalBudget) {
      alert("Please fill in project name and budget");
      return;
    }
    
    try {
      const result = await callBackend({
        action: "CREATE_FORM",
        formType: newFormData.formType,
        projectName: newFormData.projectName,
        totalBudget: parseFloat(newFormData.totalBudget),
        country: newFormData.country,
        createdBy: currentUser?.displayName || "Unknown"
      });
      
      if (result.success) {
        alert(`âœ… Form ${result.formId} created with ${result.signatures} signature boxes!`);
        setShowCreateFormModal(false);
        setNewFormData({formType: "AFE", projectName: "", totalBudget: "", country: "Australia"});
        loadSignatures(); // Reload forms
      } else {
        alert("Error: " + result.error);
      }
    } catch (err) {
      // Fallback: add to local state
      const newForm = {
        id: "SIG" + String(formSignatures.length + 1).padStart(3, "0"),
        formId: newFormData.formType + "-" + new Date().getFullYear() + "-" + String(formSignatures.length + 1).padStart(3, "0"),
        formType: newFormData.formType,
        projectName: newFormData.projectName,
        totalBudget: parseFloat(newFormData.totalBudget),
        status: "pending_review",
        createdAt: new Date().toISOString().split("T")[0],
        signatures: [
          {boxId: "preparer", label: "Prepared By", required: true, status: "pending", signedBy: null, signedAt: null, role: "Project Manager"},
          {boxId: "reviewer", label: "Reviewed By", required: true, status: "pending", signedBy: null, signedAt: null, role: "Finance Manager"},
          {boxId: "level6", label: "Level 6 Approval", required: true, status: "pending", signedBy: null, signedAt: null, role: "Manager"},
          {boxId: "level5", label: "Level 5 Approval", required: parseFloat(newFormData.totalBudget) > 1000000, status: "pending", signedBy: null, signedAt: null, role: "Senior Manager"}
        ]
      };
      setFormSignatures([...formSignatures, newForm]);
      alert(`âœ… Form ${newForm.formId} created (offline mode)`);
      setShowCreateFormModal(false);
      setNewFormData({formType: "AFE", projectName: "", totalBudget: "", country: "Australia"});
    }
  };
  
  // Sign a form via backend
  const signFormBackend = async (formId, boxId, signerName, signerEmail, comments) => {
    try {
      const result = await callBackend({
        action: "SIGN_FORM",
        formId: formId,
        boxId: boxId,
        signerName: signerName,
        signerEmail: signerEmail || currentUser?.username + "@company.com",
        comments: comments
      });
      
      if (result.success) {
        alert("âœ… Signature recorded successfully!");
        loadSignatures(); // Reload forms
        return true;
      } else {
        alert("Error: " + result.error);
        return false;
      }
    } catch (err) {
      // Fallback: update local state
      console.error("Backend sign failed, using local:", err);
      return false; // Will be handled by local state update
    }
  };
  
  // Countries tab state
  const [countryTab, setCountryTab] = useState("view");
  const [isEditing, setIsEditing] = useState(false);
  const [editConfig, setEditConfig] = useState(null);
  const [compareResult, setCompareResult] = useState(null);
  
  // Chat state
  const [chatMessages, setChatMessages] = useState([{role: "ai", content: "ðŸ‘‹ Hi! I'm your PtA Assistant.\n\nI can help you with:\nâ€¢ Migration processes & handovers\nâ€¢ App navigation & features\nâ€¢ Workflows & approvals\nâ€¢ Country configurations\nâ€¢ Troubleshooting issues\nâ€¢ Or any other questions!\n\nJust ask me anything!"}]);
  const [chatInput, setChatInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  
  const fileInputRef = useRef(null);
  const chatFileInputRef = useRef(null);
  
  // OCR State
  const [ocrProgress, setOcrProgress] = useState(0);
  const [ocrStatus, setOcrStatus] = useState("");
  const [extractedText, setExtractedText] = useState("");
  
  // Chat Upload State
  const [chatUploadFile, setChatUploadFile] = useState(null);
  const [chatUploadProgress, setChatUploadProgress] = useState(0);
  const [chatUploadStatus, setChatUploadStatus] = useState("");
  const [pendingAction, setPendingAction] = useState(null); // {type: 'create_checklist' | 'update_rules', data: {...}}
  const chatEndRef = useRef(null);

  // API mock
  const callAPI = useCallback(async (p) => {
    // CHAT action should ALWAYS go to real backend for Gemini AI
    if (p.action === "CHAT") {
      try {
        const url = localStorage.getItem("sap_playbook_backend_url");
        if (!url) {
          return {success: false, error: "Backend URL not configured. Please set it in Admin settings."};
        }
        const response = await fetch(url, {
          method: "POST",
          headers: {"Content-Type": "text/plain"},
          body: JSON.stringify(p)
        });
        const text = await response.text();
        return JSON.parse(text);
      } catch (error) {
        console.error("Chat API error:", error);
        return {success: false, error: error.message};
      }
    }
    
    // Other actions use mock data for demo
    await new Promise(r => setTimeout(r, 200));
    
    if (p.action === "GET_COUNTRY") {
      return {success: true, country: DEFAULT_CONFIG};
    }
    if (p.action === "SAVE_COUNTRY") {
      return {success: true, message: "Saved"};
    }
    if (p.action === "PROCESS_INTAKE") {
      return {
        success: true,
        extracted: {budgetAmount: "6000000", budgetClass: "01", companyCode: "1230", jvCode: "JV-001"},
        suggestedTasks: [{workflowId: "CREATE_PROJECT", reason: "New project"}],
        warnings: ["Budget >5M - Tax Review required"],
        summary: "AFE for 6M AUD project."
      };
    }
    if (p.action === "CREATE_TASK") {
      const i = p.input || {};
      const countryCode = "6"; // Fixed for Australia
      const budgetClass = i.budgetClass || "01";
      const isDecommissioning = i.projectCategory === "Decommissioning" || budgetClass === "XF";
      const isEMIT = budgetClass === "03";
      const isOBO = i.businessArea === "6602";
      
      // Generate proper sequence number (simulated - in real system would come from SAP)
      const year = new Date().getFullYear().toString().slice(-2);
      const mockSeqNum = Math.floor(Math.random() * 50); // Low numbers for demo
      const seq = String(mockSeqNum).padStart(3, '0');
      const pn = i.projectNumber || `${countryCode}${budgetClass}/${year}${seq}`;
      
      // Get JV code and calculate EM share
      const jvCodes = DEFAULT_CONFIG.jvCodes[i.companyCode] || [];
      const selectedJV = jvCodes.find(jv => jv.code === i.jvCode) || {emShare: 100, name: i.jvCode};
      const emShare = selectedJV.emShare;
      const grossBudget = parseFloat(i.grossBudget) || 0;
      const netBudgetAUD = Math.round(grossBudget * (emShare / 100));
      const jvShareAmount = grossBudget - netBudgetAUD;
      
      // Convert to USD for level approval
      const exchangeRate = DEFAULT_CONFIG.exchangeRate?.AUD_USD || 1.59;
      const netBudgetUSD = Math.round(netBudgetAUD / exchangeRate);
      
      // Calculate required level
      const fundingStage = i.fundingStage || "AC";
      const levelThresholds = DEFAULT_CONFIG.levelApproval?.[fundingStage] || {};
      let requiredLevel = {level: 4, description: "Level 1-4 (Unlimited)"};
      if (netBudgetUSD <= 100000) requiredLevel = {level: 10, description: "Level 10 ($100K USD)"};
      else if (netBudgetUSD <= 500000) requiredLevel = {level: 9, description: "Level 9 ($500K USD)"};
      else if (netBudgetUSD <= 1000000) requiredLevel = {level: 8, description: "Level 8 ($1M USD)"};
      else if (netBudgetUSD <= 5000000) requiredLevel = {level: 7, description: "Level 7 ($5M USD)"};
      else if (netBudgetUSD <= 20000000) requiredLevel = {level: 6, description: "Level 6 ($20M USD)"};
      else if (netBudgetUSD <= 50000000) requiredLevel = {level: 5, description: "Level 5 ($50M USD)"};
      
      // SUP special rules
      if (fundingStage === "SUP") {
        if (netBudgetUSD <= 20000000) requiredLevel = {level: 5, description: "Level 5 ($20M USD)"};
        else if (netBudgetUSD <= 50000000) requiredLevel = {level: 4, description: "Level 4 ($50M USD)"};
        else requiredLevel = {level: 3, description: "Level 1-3 (Unlimited)"};
      }
      
      // Calculate prerequisites
      const prerequisites = [];
      const thresholds = DEFAULT_CONFIG.localThresholds || {};
      
      // Fund.IT Ruling (EMIT only)
      if (isEMIT) {
        prerequisites.push({id: "FUNDIT", name: "Fund.IT Ruling", required: true, reason: "CAPEX/OPEX ruling required for EMIT (03)", approver: "Fund.IT"});
      }
      
      // FCCR Approval (ALL projects including Decommissioning)
      prerequisites.push({id: "FCCR", name: "FCCR Approval", required: true, reason: "Required for ALL projects", approver: "FCCR"});
      
      // Dataflex TC Code (CAPEX)
      if (i.projectCategory === "Capital") {
        prerequisites.push({id: "DATAFLEX", name: "Dataflex TC Code", required: true, reason: "Required for CAPEX projects", approver: "Financial Reporting"});
      }
      
      // DOAG Approval (always)
      prerequisites.push({id: "DOAG", name: "DOAG Approval", required: true, reason: "Required for all projects", approver: "DOAG"});
      
      // Tax Review (Net > $3M AUD)
      if (netBudgetAUD > thresholds.taxReview) {
        prerequisites.push({id: "TAX", name: "Tax Review", required: true, reason: `Net ${(netBudgetAUD/1000000).toFixed(2)}M AUD > $3M threshold`, approver: "Tax Team"});
      }
      
      // JV Approval (Net > $5M AUD)
      if (netBudgetAUD > thresholds.jvApproval) {
        prerequisites.push({id: "JV", name: "JV Approval", required: true, reason: `Net ${(netBudgetAUD/1000000).toFixed(2)}M AUD > $5M threshold`, approver: "JV Partners"});
      }
      
      // OBO Approval
      if (isOBO && i.projectStage) {
        const oboThreshold = thresholds.obo?.[i.projectStage];
        if (oboThreshold && netBudgetAUD > oboThreshold) {
          prerequisites.push({id: "OBO", name: "OBO Approval", required: true, reason: `OBO ${i.projectStage}: Net > $${(oboThreshold/1000000).toFixed(1)}M threshold`, approver: "JV/OBO Partners"});
        }
      }
      
      // Level Approval (always)
      prerequisites.push({id: "LEVEL", name: "Level Approval", required: true, reason: `Net USD ${(netBudgetUSD/1000000).toFixed(2)}M requires ${requiredLevel.description}`, approver: requiredLevel.description, level: requiredLevel.level});
      
      // Build steps - PREREQUISITES FIRST
      let steps = [];
      
      // Prerequisite steps
      steps.push({phase: "PREREQUISITE", title: "Prerequisites Checklist", content: {
        items: prerequisites.map(p => `${p.name}: ${p.reason} (Approver: ${p.approver})`)
      }, critical: true});
      
      // Fund.IT Ruling (EMIT only)
      if (isEMIT) {
        steps.push({phase: "PREREQUISITE", title: "âš ï¸ Fund.IT Ruling (EMIT)", content: {
          action: "Obtain CAPEX/OPEX ruling from Fund.IT",
          warning: "Must determine if project is CAPEX or OPEX before proceeding"
        }, critical: true});
      }
      
      // FCCR Approval (ALL projects)
      steps.push({phase: "PREREQUISITE", title: "FCCR Approval", content: {
        action: "Obtain FCCR approval (required for ALL projects including Decommissioning)"
      }, critical: true});
      
      if (i.projectCategory === "Capital") {
        steps.push({phase: "PREREQUISITE", title: "Dataflex TC Code", content: {
          action: "Obtain TC Code from Financial Reporting (CBI report)"
        }});
      }
      
      if (netBudgetAUD > thresholds.taxReview) {
        steps.push({phase: "PREREQUISITE", title: "âš ï¸ Tax Review Required", content: {
          action: "Submit Tax Review to Tax Team",
          warning: `Net budget ${(netBudgetAUD/1000000).toFixed(2)}M AUD exceeds $3M threshold`
        }, critical: true});
      }
      
      if (netBudgetAUD > thresholds.jvApproval) {
        steps.push({phase: "PREREQUISITE", title: "âš ï¸ JV Approval Required", content: {
          action: "Obtain approval from JV Partners",
          warning: `Net budget ${(netBudgetAUD/1000000).toFixed(2)}M AUD exceeds $5M threshold`
        }, critical: true});
      }
      
      steps.push({phase: "PREREQUISITE", title: `Level Approval: ${requiredLevel.description}`, content: {
        action: `Obtain approval from ${requiredLevel.description} or above`,
        fields: [
          {n: "Net Budget (AUD)", v: `${netBudgetAUD.toLocaleString()} AUD`},
          {n: "Net Budget (USD)", v: `${netBudgetUSD.toLocaleString()} USD`},
          {n: "Exchange Rate", v: `1 AUD = ${(1/exchangeRate).toFixed(4)} USD`},
          {n: "Required Level", v: requiredLevel.description}
        ]
      }});
      
      // Execute steps
      steps.push(
        {phase: "EXECUTE", title: "Open CJ20N", content: {action: "Enter CJ20N â†’ Press Enter"}},
        {phase: "EXECUTE", title: "Get Project Number", content: {action: "Click 'Open Number'", note: `First digit "${countryCode}" is fixed for Australia. Format: ${countryCode}${budgetClass}/${year}XXX`}},
        {phase: "EXECUTE", title: "Enter Company Data", content: {fields: [{n: "Company Code", v: i.companyCode || "1230"}, {n: "Ctrl Area", v: "AU00"}, {n: "Business Area", v: i.businessArea || "6601"}]}},
        {phase: "EXECUTE", title: "Create WBS L1", content: {action: `Create ${pn}.1`, note: "Select: Planning Element (PE)"}},
        {phase: "EXECUTE", title: "Create WBS L2", content: {action: `Create ${pn}.1.01`, note: "Select: PE + Account Assignment (ACCT)", warning: "Must select BOTH checkboxes"}},
        {phase: "EXECUTE", title: "Enter WBS Details", content: {fields: [{n: "JV Code", v: i.jvCode || "___"}, {n: "Recovery", v: isOBO ? "NB (auto)" : (i.recoveryIndicator || "BI")}]}}
      );
      
      // Settlement rule for Decommissioning
      if (isDecommissioning) {
        steps.push({
          phase: "EXECUTE", 
          title: "âš ï¸ Settlement Rule (REQUIRED)", 
          content: {
            action: "Add settlement rule to reserve account: 490000030",
            warning: "CRITICAL: Must be done BEFORE changing project status!",
            fields: [{n: "Settlement Account", v: "490000030"}]
          },
          critical: true
        });
      }
      
      steps.push(
        {phase: "EXECUTE", title: "Set Status", content: {action: "NARP â†’ BARP, CRTD â†’ REL", warning: isDecommissioning ? "Ensure settlement rule is set FIRST!" : "Only after all approvals confirmed"}},
        {phase: "EXECUTE", title: "Save Project", content: {action: "Ctrl+S or Save button"}},
        {phase: "VERIFY", title: "Verify Project in ZJ053", content: {action: `ZJ053 â†’ ${pn} â†’ Check status = REL`}}
      );
      
      // Budget steps
      steps.push(
        {phase: "BUDGET", title: "Open ZJ40", content: {action: "Enter ZJ40 â†’ Press Enter"}},
        {phase: "BUDGET", title: "Enter Project", content: {action: `Project: ${pn}`}},
        {phase: "BUDGET", title: "Select Funding Stage", content: {action: `Stage: ${fundingStage}`}},
        {phase: "BUDGET", title: "Select WBS Level 1", content: {action: `WBS: ${pn}.1`, warning: "Budget MUST go to Level 1"}},
        {phase: "BUDGET", title: "Enter Budget Amounts", content: {
          fields: [
            {n: "Gross (100%)", v: `${grossBudget.toLocaleString()} AUD`},
            {n: `Net (EM ${emShare}%)`, v: `${netBudgetAUD.toLocaleString()} AUD`},
            {n: `JV Share (${100-emShare}%)`, v: `${jvShareAmount.toLocaleString()} AUD`}
          ],
          note: `JV: ${selectedJV.name} - EM Share ${emShare}%`
        }},
        {phase: "BUDGET", title: "Verify Exchange Rate", content: {action: "Check exchange rate", warning: "DOAG FX updates 1 Jan & 1 July. Edit manually if incorrect"}},
        {phase: "BUDGET", title: "Save Budget", content: {action: "Click Save"}},
        {phase: "VERIFY", title: "Verify Budget in ZJ053", content: {action: `ZJ053 â†’ ${pn} â†’ Check budget`}}
      );
      
      // Completion
      steps.push({phase: "COMPLETE", title: "Done", content: {items: [
        `Project: ${pn}`,
        `Gross Budget: ${grossBudget.toLocaleString()} AUD`,
        `Net Budget (EM ${emShare}%): ${netBudgetAUD.toLocaleString()} AUD`,
        `Net Budget (USD): ${netBudgetUSD.toLocaleString()} USD`,
        `Approval Level: ${requiredLevel.description}`,
        "Notify requestor"
      ]}});
      
      return {
        success: true,
        task: {
          id: "T" + Date.now(),
          title: `${isDecommissioning ? "Decommissioning" : isEMIT ? "EMIT" : "Capital"} Project: ${pn}`,
          output: {
            projectNumber: pn, 
            wbsLevel1: pn + ".1", 
            wbsLevel2: pn + ".1.01",
            countryCode: countryCode,
            projectStage: i.projectStage,
            isDecommissioning: isDecommissioning,
            isEMIT: isEMIT,
            isOBO: isOBO,
            settlementAccount: isDecommissioning ? "490000030" : null,
            // Budget info
            grossBudget: grossBudget,
            netBudgetAUD: netBudgetAUD,
            netBudgetUSD: netBudgetUSD,
            jvShare: jvShareAmount,
            emShare: emShare,
            jvCode: i.jvCode,
            jvName: selectedJV.name,
            exchangeRate: exchangeRate,
            // Approval info
            requiredLevel: requiredLevel,
            prerequisites: prerequisites
          },
          input: i,
          rules: {blocking: prerequisites.filter(p => p.required)},
          steps: steps,
          isDecommissioning: isDecommissioning
        }
      };
    }
    
    // === MM MODULE HANDLERS ===
    
    // CREATE SES (Service Entry Sheet)
    if (p.action === "CREATE_SES_TASK") {
      const i = p.input || {};
      const sesNum = "10" + String(Math.floor(Math.random() * 10000000)).padStart(7, '0');
      const totalValue = (parseFloat(i.quantity) || 0) * (parseFloat(i.unitPrice) || 0);
      
      const steps = [
        {phase: "PREREQUISITE", title: "Prerequisites Checklist", content: {
          items: [
            "PO is approved and released",
            "Service has been performed",
            "Timesheet/Work confirmation received from vendor",
            "WBS Element has sufficient budget"
          ]
        }, critical: true},
        {phase: "EXECUTE", title: "Open ML81N", content: {action: "Enter ML81N â†’ Press Enter", tCode: "ML81N"}},
        {phase: "EXECUTE", title: "Enter PO Details", content: {fields: [
          {n: "Purchase Order", v: i.poNumber || "45XXXXXXXX"},
          {n: "Line Item", v: i.poLineItem || "10"}
        ]}},
        {phase: "EXECUTE", title: "Create Service Line", content: {action: "Click 'Service Selection' â†’ Enter service details", fields: [
          {n: "Service Description", v: i.serviceDescription || "Service performed"},
          {n: "Quantity", v: i.quantity || "1"},
          {n: "Unit Price", v: `${(i.unitPrice || 0).toLocaleString()} ${i.currency || "AUD"}`},
          {n: "Total Value", v: `${totalValue.toLocaleString()} ${i.currency || "AUD"}`}
        ]}},
        {phase: "EXECUTE", title: "Enter Account Assignment", content: {fields: [
          {n: "WBS Element", v: i.wbsElement || "601/25001.1"},
          {n: "Cost Center", v: "Auto from WBS"}
        ]}},
        {phase: "EXECUTE", title: "Enter Performance Date", content: {fields: [
          {n: "Performance Date", v: i.performanceDate || new Date().toISOString().split('T')[0]},
          {n: "Posting Date", v: new Date().toISOString().split('T')[0]}
        ]}},
        {phase: "EXECUTE", title: "Accept Service Entry", content: {action: "Click 'Accept' button (green checkmark)", warning: "This sets acceptance indicator - cannot be undone easily"}},
        {phase: "EXECUTE", title: "Save SES", content: {action: "Ctrl+S or Save button", note: `SES Number will be generated: ${sesNum}`}},
        {phase: "VERIFY", title: "Verify in ME23N", content: {action: `Enter ME23N â†’ PO ${i.poNumber} â†’ Check SES tab`, tCode: "ME23N"}}
      ];
      
      return {
        success: true,
        task: {
          id: "SES-" + Date.now(),
          workflowId: "CREATE_SES",
          workflowName: "Create Service Entry Sheet",
          module: "MM",
          status: "In Progress",
          created: new Date().toISOString(),
          generated: {
            sesNumber: sesNum,
            poNumber: i.poNumber,
            poLineItem: i.poLineItem,
            vendorId: i.vendorId,
            totalValue: totalValue,
            currency: i.currency || "AUD",
            wbsElement: i.wbsElement
          },
          input: i,
          steps: steps
        }
      };
    }
    
    // CREATE GR (Goods Receipt)
    if (p.action === "CREATE_GR_TASK") {
      const i = p.input || {};
      const grNum = "50" + String(Math.floor(Math.random() * 10000000)).padStart(7, '0');
      const matDocNum = "49" + String(Math.floor(Math.random() * 10000000)).padStart(7, '0');
      
      const steps = [
        {phase: "PREREQUISITE", title: "Prerequisites Checklist", content: {
          items: [
            "PO is approved and released",
            "Goods physically received at site",
            "Delivery note verified against PO",
            "Quality inspection passed (if required)",
            "Storage location available"
          ]
        }, critical: true},
        {phase: "EXECUTE", title: "Open MIGO", content: {action: "Enter MIGO â†’ Press Enter", tCode: "MIGO"}},
        {phase: "EXECUTE", title: "Select Transaction Type", content: {action: "Select 'Goods Receipt' â†’ 'Purchase Order'", fields: [
          {n: "Transaction", v: "A01 - Goods Receipt"},
          {n: "Reference", v: "R01 - Purchase Order"}
        ]}},
        {phase: "EXECUTE", title: "Enter PO Details", content: {fields: [
          {n: "Purchase Order", v: i.poNumber || "45XXXXXXXX"},
          {n: "Line Item", v: i.poLineItem || "10"}
        ]}},
        {phase: "EXECUTE", title: "Verify Material Details", content: {fields: [
          {n: "Material Number", v: i.materialNumber || "MAT-XXXXXX"},
          {n: "Quantity", v: i.quantity || "1"},
          {n: "UoM", v: i.uom || "EA"},
          {n: "Storage Location", v: i.storageLocation || "0001"}
        ]}},
        {phase: "EXECUTE", title: "Enter Delivery Note", content: {fields: [
          {n: "Delivery Note", v: i.deliveryNote || "DN-XXXXXX"},
          {n: "Bill of Lading", v: ""}
        ], note: "Reference for tracking"}},
        {phase: "EXECUTE", title: "Check Account Assignment", content: {fields: [
          {n: "WBS Element", v: i.wbsElement || "601/25001.1"},
          {n: "Movement Type", v: "101 - GR to Warehouse"}
        ]}},
        {phase: "EXECUTE", title: "Check Item OK", content: {action: "Click 'Item OK' checkbox for each line", warning: "Ensure all lines are marked OK before posting"}},
        {phase: "EXECUTE", title: "Post GR", content: {action: "Click 'Post' button (green checkmark)", note: `Material Doc: ${matDocNum}, GR Doc: ${grNum}`}},
        {phase: "VERIFY", title: "Verify in ME23N", content: {action: `Enter ME23N â†’ PO ${i.poNumber} â†’ Check GR tab`, tCode: "ME23N"}},
        {phase: "VERIFY", title: "Check Stock in MMBE", content: {action: `Enter MMBE â†’ Material ${i.materialNumber} â†’ Verify stock quantity`, tCode: "MMBE"}}
      ];
      
      return {
        success: true,
        task: {
          id: "GR-" + Date.now(),
          workflowId: "CREATE_GR",
          workflowName: "Create Goods Receipt",
          module: "MM",
          status: "In Progress",
          created: new Date().toISOString(),
          generated: {
            grNumber: grNum,
            materialDocNumber: matDocNum,
            poNumber: i.poNumber,
            poLineItem: i.poLineItem,
            materialNumber: i.materialNumber,
            quantity: i.quantity,
            storageLocation: i.storageLocation,
            wbsElement: i.wbsElement,
            movementType: "101"
          },
          input: i,
          steps: steps
        }
      };
    }
    
    // REVERSE SES
    if (p.action === "REVERSE_SES_TASK") {
      const i = p.input || {};
      const cancelDocNum = "10" + String(Math.floor(Math.random() * 10000000)).padStart(7, '0');
      
      const steps = [
        {phase: "PREREQUISITE", title: "Prerequisites Checklist", content: {
          items: [
            "SES has not been invoiced yet",
            "Reversal approved by manager",
            "Reason documented for audit trail"
          ]
        }, critical: true},
        {phase: "EXECUTE", title: "Open ML81N", content: {action: "Enter ML81N â†’ Press Enter", tCode: "ML81N"}},
        {phase: "EXECUTE", title: "Display SES", content: {action: "Menu: Service Entry Sheet â†’ Display", fields: [
          {n: "SES Number", v: i.sesNumber || "10XXXXXXXX"}
        ]}},
        {phase: "EXECUTE", title: "Reset Acceptance", content: {action: "Click 'Reset Acceptance' button (if accepted)", warning: "Must reset acceptance before deletion"}},
        {phase: "EXECUTE", title: "Delete/Reverse", content: {action: "Menu: Service Entry Sheet â†’ Delete", fields: [
          {n: "Reversal Reason", v: i.reversalReason || "Incorrect Entry"},
          {n: "Reversal Date", v: i.reversalDate || new Date().toISOString().split('T')[0]}
        ]}},
        {phase: "EXECUTE", title: "Confirm Deletion", content: {action: "Confirm deletion in popup", note: `Cancellation Doc: ${cancelDocNum}`}},
        {phase: "VERIFY", title: "Verify Reversal", content: {action: `Enter ML81N â†’ Display SES ${i.sesNumber} â†’ Should show 'Deleted'`}}
      ];
      
      return {
        success: true,
        task: {
          id: "SES-REV-" + Date.now(),
          workflowId: "REVERSE_SES",
          workflowName: "Reverse Service Entry Sheet",
          module: "MM",
          status: "In Progress",
          created: new Date().toISOString(),
          generated: {
            originalSES: i.sesNumber,
            cancellationDoc: cancelDocNum,
            reversalReason: i.reversalReason,
            reversalDate: i.reversalDate
          },
          input: i,
          steps: steps
        }
      };
    }
    
    // REVERSE GR
    if (p.action === "REVERSE_GR_TASK") {
      const i = p.input || {};
      const reversalDocNum = "50" + String(Math.floor(Math.random() * 10000000)).padStart(7, '0');
      const movementType = i.movementType?.includes("102") ? "102" : "122";
      
      const steps = [
        {phase: "PREREQUISITE", title: "Prerequisites Checklist", content: {
          items: [
            "GR has not been invoiced yet",
            movementType === "122" ? "Return delivery created for vendor" : "Stock still available in storage location",
            "Reversal approved by manager",
            "Reason documented for audit trail"
          ]
        }, critical: true},
        {phase: "EXECUTE", title: "Open MIGO", content: {action: "Enter MIGO â†’ Press Enter", tCode: "MIGO"}},
        {phase: "EXECUTE", title: "Select Cancellation", content: {action: "Select 'Cancellation' â†’ 'Material Document'", fields: [
          {n: "Transaction", v: "A02 - Goods Issue (Reversal)"},
          {n: "Reference", v: "R02 - Material Document"}
        ]}},
        {phase: "EXECUTE", title: "Enter GR Document", content: {fields: [
          {n: "Material Document", v: i.grNumber || "50XXXXXXXX"},
          {n: "Year", v: new Date().getFullYear()}
        ]}},
        {phase: "EXECUTE", title: "Select Movement Type", content: {fields: [
          {n: "Movement Type", v: movementType === "102" ? "102 - GR Reversal" : "122 - Return to Vendor"},
          {n: "Reversal Reason", v: i.reversalReason || "Incorrect Entry"}
        ], warning: movementType === "122" ? "Ensure vendor return PO exists" : null}},
        {phase: "EXECUTE", title: "Check Item OK", content: {action: "Click 'Item OK' checkbox for reversal lines"}},
        {phase: "EXECUTE", title: "Post Reversal", content: {action: "Click 'Post' button", note: `Reversal Doc: ${reversalDocNum}`}},
        {phase: "VERIFY", title: "Verify in ME23N", content: {action: `Enter ME23N â†’ PO â†’ Check GR history shows reversal`}},
        {phase: "VERIFY", title: "Check Stock in MMBE", content: {action: "Enter MMBE â†’ Verify stock reduced", tCode: "MMBE"}}
      ];
      
      return {
        success: true,
        task: {
          id: "GR-REV-" + Date.now(),
          workflowId: "REVERSE_GR",
          workflowName: "Reverse Goods Receipt",
          module: "MM",
          status: "In Progress",
          created: new Date().toISOString(),
          generated: {
            originalGR: i.grNumber,
            reversalDoc: reversalDocNum,
            movementType: movementType,
            reversalReason: i.reversalReason,
            reversalDate: i.reversalDate
          },
          input: i,
          steps: steps
        }
      };
    }
    
    // CHECK PO STATUS
    if (p.action === "CHECK_PO_STATUS_TASK") {
      const i = p.input || {};
      
      // Mock PO data
      const mockPO = {
        poNumber: i.poNumber || "4500001234",
        vendor: "VENDOR-001 - ABC Services Pty Ltd",
        totalValue: 150000,
        currency: "AUD",
        status: "Released",
        lines: [
          {item: "10", material: "Service", description: "Engineering Services", qty: 100, unit: "HR", price: 1500, value: 150000, grQty: 60, sesQty: 60, invoicedQty: 40}
        ],
        grHistory: [
          {doc: "5000012345", date: "2025-01-10", qty: 30, value: 45000},
          {doc: "5000012456", date: "2025-01-12", qty: 30, value: 45000}
        ],
        sesHistory: [
          {doc: "1000012345", date: "2025-01-10", qty: 30, value: 45000, accepted: true},
          {doc: "1000012456", date: "2025-01-12", qty: 30, value: 45000, accepted: true}
        ],
        invoiceHistory: [
          {doc: "5100001234", date: "2025-01-15", value: 60000, status: "Posted"}
        ]
      };
      
      const steps = [
        {phase: "EXECUTE", title: "Open ME23N", content: {action: "Enter ME23N â†’ Press Enter", tCode: "ME23N"}},
        {phase: "EXECUTE", title: "Enter PO Number", content: {fields: [{n: "Purchase Order", v: i.poNumber}]}},
        {phase: "RESULT", title: "PO Header", content: {fields: [
          {n: "PO Number", v: mockPO.poNumber},
          {n: "Vendor", v: mockPO.vendor},
          {n: "Total Value", v: `${mockPO.totalValue.toLocaleString()} ${mockPO.currency}`},
          {n: "Status", v: mockPO.status}
        ]}},
        {phase: "RESULT", title: "Line Items", content: {
          table: mockPO.lines.map(l => ({
            "Item": l.item,
            "Description": l.description,
            "Ordered": `${l.qty} ${l.unit}`,
            "GR Qty": l.grQty,
            "SES Qty": l.sesQty,
            "Invoiced": l.invoicedQty,
            "Open": l.qty - l.grQty
          }))
        }},
        {phase: "RESULT", title: "GR/SES History", content: {fields: [
          {n: "Total GR'd", v: `${mockPO.grHistory.reduce((s, g) => s + g.qty, 0)} units`},
          {n: "Total SES'd", v: `${mockPO.sesHistory.reduce((s, s2) => s + s2.qty, 0)} units`},
          {n: "Total Invoiced", v: `${mockPO.invoiceHistory.reduce((s, i2) => s + i2.value, 0).toLocaleString()} ${mockPO.currency}`}
        ]}}
      ];
      
      return {
        success: true,
        task: {
          id: "PO-CHK-" + Date.now(),
          workflowId: "CHECK_PO_STATUS",
          workflowName: "Check PO Status",
          module: "MM",
          status: "Completed",
          created: new Date().toISOString(),
          generated: mockPO,
          input: i,
          steps: steps
        }
      };
    }
    
    // === AA MODULE HANDLERS (Asset Accounting) ===
    
    // EMDS - Capitalize Asset
    if (p.action === "EMDS_CAPITALIZE_TASK") {
      const i = p.input || {};
      const assetNum = "1000" + String(Math.floor(Math.random() * 100000)).padStart(5, '0');
      const settlementDoc = "90" + String(Math.floor(Math.random() * 10000000)).padStart(7, '0');
      
      const steps = [
        {phase: "PREREQUISITE", title: "Prerequisites Checklist", content: {
          items: [
            "Project is complete (status REL or TECO)",
            "All costs allocated to project WBS",
            "Business approval (EMDS form) received",
            "Asset is in service and operational",
            "AUC balance verified in AW01N"
          ]
        }, critical: true},
        {phase: "EXECUTE", title: "Verify AUC Balance (AW01N)", content: {action: "Enter AW01N â†’ Enter WBS Element", tCode: "AW01N", fields: [
          {n: "WBS Element", v: i.wbsElement || "601/25XXX.1"},
          {n: "Check AUC Balance", v: `${(parseFloat(i.capitalizationAmount) || 0).toLocaleString()} AUD`}
        ]}},
        {phase: "EXECUTE", title: "Create Asset Master (AS01)", content: {action: "Enter AS01 â†’ Press Enter", tCode: "AS01", fields: [
          {n: "Asset Class", v: i.assetClass?.split(" - ")[0] || "INFRA"},
          {n: "Company Code", v: "1230"},
          {n: "Description", v: i.assetDescription || "Asset Description"}
        ]}},
        {phase: "EXECUTE", title: "Enter General Data", content: {fields: [
          {n: "Asset Description", v: i.assetDescription},
          {n: "Serial Number", v: "(if applicable)"},
          {n: "Inventory Number", v: "(if applicable)"},
          {n: "Quantity", v: "1"}
        ]}},
        {phase: "EXECUTE", title: "Enter Time-Dependent Data", content: {fields: [
          {n: "Cost Center", v: "Auto from WBS"},
          {n: "Location", v: i.location || "Site Location"}
        ]}},
        {phase: "EXECUTE", title: "Enter Depreciation Areas", content: {fields: [
          {n: "Depreciation Key", v: "LINR (Straight Line)"},
          {n: "Useful Life", v: `${i.usefulLife || 10} years`},
          {n: "Depreciation Start", v: i.inServiceDate || new Date().toISOString().split('T')[0]}
        ]}},
        {phase: "EXECUTE", title: "Save Asset Master", content: {action: "Ctrl+S â†’ Note Asset Number", note: `Asset Number: ${assetNum}`}},
        {phase: "EXECUTE", title: "Verify Settlement Rule (KO02)", content: {action: "Enter KO02 â†’ WBS Element", tCode: "KO02", fields: [
          {n: "WBS Element", v: i.wbsElement},
          {n: "Settlement Receiver", v: `Asset ${assetNum}`},
          {n: "Percentage", v: "100%"}
        ]}},
        {phase: "EXECUTE", title: "Execute Settlement (KO88)", content: {action: "Enter KO88 â†’ Execute", tCode: "KO88", fields: [
          {n: "WBS Element", v: i.wbsElement},
          {n: "Period", v: "Current Period"},
          {n: "Fiscal Year", v: new Date().getFullYear()}
        ], note: `Settlement Doc: ${settlementDoc}`}},
        {phase: "VERIFY", title: "Verify in AW01N", content: {action: "Enter AW01N â†’ Asset Number â†’ Verify values", tCode: "AW01N", fields: [
          {n: "Asset Number", v: assetNum},
          {n: "Acquisition Value", v: `${(parseFloat(i.capitalizationAmount) || 0).toLocaleString()} AUD`}
        ]}}
      ];
      
      return {
        success: true,
        task: {
          id: "EMDS-" + Date.now(),
          workflowId: "EMDS_CAPITALIZE",
          workflowName: "EMDS - Capitalize Asset",
          module: "AA",
          status: "In Progress",
          created: new Date().toISOString(),
          generated: {
            assetNumber: assetNum,
            settlementDoc: settlementDoc,
            projectNumber: i.projectNumber,
            wbsElement: i.wbsElement,
            assetClass: i.assetClass,
            capitalizationAmount: i.capitalizationAmount,
            inServiceDate: i.inServiceDate
          },
          input: i,
          steps: steps
        }
      };
    }
    
    // PTRA - Transfer Asset
    if (p.action === "PTRA_TRANSFER_TASK") {
      const i = p.input || {};
      const transferDoc = "10" + String(Math.floor(Math.random() * 10000000)).padStart(7, '0');
      const newAssetNum = i.transferType === "Intercompany" ? "2000" + String(Math.floor(Math.random() * 100000)).padStart(5, '0') : null;
      const tCode = i.transferType === "Intercompany" ? "ABT1N" : "ABUMN";
      
      const steps = [
        {phase: "PREREQUISITE", title: "Prerequisites Checklist", content: {
          items: [
            "PTRA form approved by business",
            "Asset verified in AW01N",
            "Receiving cost center/company notified",
            i.transferType === "Intercompany" ? "Intercompany agreement in place" : "Transfer within same company code"
          ]
        }, critical: true},
        {phase: "EXECUTE", title: "Verify Current Asset (AW01N)", content: {action: "Enter AW01N â†’ Enter Asset Number", tCode: "AW01N", fields: [
          {n: "Asset Number", v: i.assetNumber || "100XXXXXXX"},
          {n: "Current Cost Center", v: i.fromCostCenter},
          {n: "Current Location", v: i.fromLocation || ""}
        ]}},
        {phase: "EXECUTE", title: `Open ${tCode}`, content: {action: `Enter ${tCode} â†’ Press Enter`, tCode: tCode}},
        {phase: "EXECUTE", title: "Enter Transfer Details", content: {fields: [
          {n: "Asset to Transfer", v: i.assetNumber},
          {n: "Company Code", v: "1230"},
          {n: "Document Date", v: i.transferDate || new Date().toISOString().split('T')[0]},
          {n: "Posting Date", v: i.transferDate || new Date().toISOString().split('T')[0]}
        ]}},
        {phase: "EXECUTE", title: "Enter Receiving Details", content: {fields: [
          {n: "To Cost Center", v: i.toCostCenter},
          {n: "To Location", v: i.toLocation || ""},
          ...(i.transferType === "Intercompany" ? [{n: "To Company Code", v: "(Enter receiving company)"}] : [])
        ]}},
        {phase: "EXECUTE", title: "Post Transfer", content: {action: "Click Post (green checkmark)", note: `Transfer Doc: ${transferDoc}${newAssetNum ? `, New Asset: ${newAssetNum}` : ""}`}},
        {phase: "VERIFY", title: "Verify in AW01N", content: {action: "Verify old asset shows transfer out, new location shows in receiving", tCode: "AW01N"}}
      ];
      
      return {
        success: true,
        task: {
          id: "PTRA-TRF-" + Date.now(),
          workflowId: "PTRA_TRANSFER",
          workflowName: "PTRA - Transfer Asset",
          module: "AA",
          status: "In Progress",
          created: new Date().toISOString(),
          generated: {
            transferDoc: transferDoc,
            originalAsset: i.assetNumber,
            newAssetNumber: newAssetNum,
            transferType: i.transferType,
            fromCostCenter: i.fromCostCenter,
            toCostCenter: i.toCostCenter,
            transferDate: i.transferDate
          },
          input: i,
          steps: steps
        }
      };
    }
    
    // PTRA - Retire Asset
    if (p.action === "PTRA_RETIRE_TASK") {
      const i = p.input || {};
      const retireDoc = "20" + String(Math.floor(Math.random() * 10000000)).padStart(7, '0');
      const tCode = i.retirementType === "Sale" ? "ABAON" : i.retirementType === "Scrapping" ? "ABAVN" : "AR02";
      
      // Mock asset data
      const mockAsset = {
        acquisitionValue: 500000,
        accumDepreciation: 150000,
        netBookValue: 350000
      };
      
      const saleAmount = parseFloat(i.saleAmount) || 0;
      const gainLoss = saleAmount - mockAsset.netBookValue;
      
      const steps = [
        {phase: "PREREQUISITE", title: "Prerequisites Checklist", content: {
          items: [
            "PTRA form approved by business and finance",
            "Asset verified in AW01N",
            "Physical inspection completed",
            i.retirementType === "Sale" ? "Sale agreement attached" : "",
            i.retirementType === "Scrapping" ? "Scrapping certificate attached" : ""
          ].filter(Boolean)
        }, critical: true},
        {phase: "EXECUTE", title: "Verify Asset Values (AW01N)", content: {action: "Enter AW01N â†’ Enter Asset Number", tCode: "AW01N", fields: [
          {n: "Asset Number", v: i.assetNumber || "100XXXXXXX"},
          {n: "Acquisition Value", v: `${mockAsset.acquisitionValue.toLocaleString()} AUD`},
          {n: "Accumulated Depreciation", v: `${mockAsset.accumDepreciation.toLocaleString()} AUD`},
          {n: "Net Book Value", v: `${mockAsset.netBookValue.toLocaleString()} AUD`}
        ]}},
        {phase: "EXECUTE", title: `Open ${tCode}`, content: {action: `Enter ${tCode} â†’ Press Enter`, tCode: tCode}},
        {phase: "EXECUTE", title: "Enter Retirement Details", content: {fields: [
          {n: "Asset Number", v: i.assetNumber},
          {n: "Company Code", v: "1230"},
          {n: "Document Date", v: i.retirementDate || new Date().toISOString().split('T')[0]},
          {n: "Posting Date", v: i.retirementDate || new Date().toISOString().split('T')[0]}
        ]}},
        ...(i.retirementType === "Sale" ? [
          {phase: "EXECUTE", title: "Enter Sale Details", content: {fields: [
            {n: "Revenue Amount", v: `${saleAmount.toLocaleString()} AUD`},
            {n: "Customer/Buyer", v: i.buyerName || ""},
            {n: "Clearing Account", v: "Revenue Account"}
          ]}}
        ] : []),
        {phase: "EXECUTE", title: "Enter Retirement Reason", content: {fields: [
          {n: "Reason", v: i.retirementReason || "End of useful life"}
        ]}},
        {phase: "EXECUTE", title: "Post Retirement", content: {action: "Click Post (green checkmark)", note: `Retirement Doc: ${retireDoc}`}},
        {phase: "RESULT", title: "Gain/Loss Summary", content: {fields: [
          {n: "Net Book Value", v: `${mockAsset.netBookValue.toLocaleString()} AUD`},
          {n: "Sale Proceeds", v: `${saleAmount.toLocaleString()} AUD`},
          {n: "Gain/(Loss)", v: `${gainLoss >= 0 ? "" : "("}${Math.abs(gainLoss).toLocaleString()}${gainLoss >= 0 ? "" : ")"} AUD`}
        ], warning: gainLoss < 0 ? "Loss on disposal - verify GL posting" : null}},
        {phase: "VERIFY", title: "Verify in AW01N", content: {action: "Asset should show as retired with zero values", tCode: "AW01N"}}
      ];
      
      return {
        success: true,
        task: {
          id: "PTRA-RET-" + Date.now(),
          workflowId: "PTRA_RETIRE",
          workflowName: "PTRA - Retire Asset",
          module: "AA",
          status: "In Progress",
          created: new Date().toISOString(),
          generated: {
            retireDoc: retireDoc,
            assetNumber: i.assetNumber,
            retirementType: i.retirementType,
            netBookValue: mockAsset.netBookValue,
            saleAmount: saleAmount,
            gainLoss: gainLoss,
            retirementDate: i.retirementDate
          },
          input: i,
          steps: steps
        }
      };
    }
    
    // CHECK ASSET STATUS
    if (p.action === "CHECK_ASSET_TASK") {
      const i = p.input || {};
      
      // Mock asset data
      const mockAsset = {
        assetNumber: i.assetNumber || "100000001234",
        description: "Production Well Equipment",
        assetClass: "TANG_WELL",
        companyCode: "1230",
        costCenter: "CC-AUS-001",
        location: "Perth Site A",
        acquisitionDate: "2023-01-15",
        acquisitionValue: 2500000,
        accumDepreciation: 625000,
        netBookValue: 1875000,
        usefulLife: 10,
        remainingLife: 7.5,
        depreciationKey: "LINR",
        status: "Active"
      };
      
      const steps = [
        {phase: "EXECUTE", title: "Open AW01N", content: {action: "Enter AW01N â†’ Press Enter", tCode: "AW01N"}},
        {phase: "EXECUTE", title: "Enter Asset Number", content: {fields: [{n: "Asset Number", v: i.assetNumber}, {n: "Company Code", v: "1230"}]}},
        {phase: "RESULT", title: "Asset Master Data", content: {fields: [
          {n: "Asset Number", v: mockAsset.assetNumber},
          {n: "Description", v: mockAsset.description},
          {n: "Asset Class", v: mockAsset.assetClass},
          {n: "Cost Center", v: mockAsset.costCenter},
          {n: "Location", v: mockAsset.location},
          {n: "Status", v: mockAsset.status}
        ]}},
        {phase: "RESULT", title: "Asset Values", content: {fields: [
          {n: "Acquisition Date", v: mockAsset.acquisitionDate},
          {n: "Acquisition Value", v: `${mockAsset.acquisitionValue.toLocaleString()} AUD`},
          {n: "Accumulated Depreciation", v: `${mockAsset.accumDepreciation.toLocaleString()} AUD`},
          {n: "Net Book Value", v: `${mockAsset.netBookValue.toLocaleString()} AUD`}
        ]}},
        {phase: "RESULT", title: "Depreciation Info", content: {fields: [
          {n: "Depreciation Key", v: mockAsset.depreciationKey},
          {n: "Useful Life", v: `${mockAsset.usefulLife} years`},
          {n: "Remaining Life", v: `${mockAsset.remainingLife} years`}
        ]}}
      ];
      
      return {
        success: true,
        task: {
          id: "AST-CHK-" + Date.now(),
          workflowId: "CHECK_ASSET",
          workflowName: "Check Asset Status",
          module: "AA",
          status: "Completed",
          created: new Date().toISOString(),
          generated: mockAsset,
          input: i,
          steps: steps
        }
      };
    }
    
    // CHAT action should go to real backend - no mock here
    
    if (p.action === "COMPARE_COUNTRIES") {
      return {
        success: true,
        country1: {id: "Australia", flag: "ðŸ‡¦ðŸ‡º"},
        country2: {id: "Thailand", flag: "ðŸ‡¹ðŸ‡­"},
        differences: [
          {field: "Currency", country1: "AUD", country2: "THB"},
          {field: "Country Code", country1: "6", country2: "7"},
          {field: "Tax Review Threshold", country1: "5M", country2: "10M"}
        ]
      };
    }
    return {success: true};
  }, []);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({behavior: "smooth"});
  }, [chatMessages]);

  // Handlers
  // OCR Processing Function
  const processOCR = async (imageSource) => {
    try {
      setOcrStatus("Initializing OCR engine...");
      setOcrProgress(10);
      
      const worker = await Tesseract.createWorker('eng+tha', 1, {
        logger: m => {
          if (m.status === 'recognizing text') {
            setOcrProgress(30 + Math.round(m.progress * 60));
            setOcrStatus(`Recognizing text... ${Math.round(m.progress * 100)}%`);
          }
        }
      });
      
      setOcrStatus("Processing image...");
      setOcrProgress(30);
      
      const { data: { text } } = await worker.recognize(imageSource);
      
      setOcrProgress(95);
      setOcrStatus("Finalizing...");
      
      await worker.terminate();
      
      setOcrProgress(100);
      setOcrStatus("Complete!");
      
      return text;
    } catch (error) {
      console.error("OCR Error:", error);
      throw error;
    }
  };
  
  // Convert PDF to images for OCR
  const processPDF = async (file) => {
    try {
      setOcrStatus("Loading PDF...");
      setOcrProgress(5);
      
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      
      let fullText = "";
      const totalPages = pdf.numPages;
      
      for (let i = 1; i <= Math.min(totalPages, 5); i++) { // Process max 5 pages
        setOcrStatus(`Processing page ${i} of ${Math.min(totalPages, 5)}...`);
        setOcrProgress(10 + (i / Math.min(totalPages, 5)) * 80);
        
        const page = await pdf.getPage(i);
        const scale = 2; // Higher scale = better OCR quality
        const viewport = page.getViewport({ scale });
        
        // Create canvas
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        // Render PDF page to canvas
        await page.render({ canvasContext: context, viewport }).promise;
        
        // Convert canvas to image and run OCR
        const imageData = canvas.toDataURL('image/png');
        const pageText = await processOCR(imageData);
        fullText += `\n--- Page ${i} ---\n${pageText}`;
      }
      
      if (totalPages > 5) {
        fullText += `\n\n[Note: Only first 5 of ${totalPages} pages processed]`;
      }
      
      return fullText;
    } catch (error) {
      console.error("PDF Processing Error:", error);
      throw error;
    }
  };
  
  const handleFile = async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    
    setIsLoading(true);
    setOcrProgress(0);
    setOcrStatus("Starting...");
    setExtractedText("");
    setIntakeResult(null);
    
    try {
      let text = "";
      const fileType = f.type;
      const fileName = f.name.toLowerCase();
      
      // Handle different file types
      if (fileType.startsWith('image/') || fileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)) {
        // Image file - direct OCR
        setOcrStatus("Processing image...");
        const imageUrl = URL.createObjectURL(f);
        text = await processOCR(imageUrl);
        URL.revokeObjectURL(imageUrl);
        
      } else if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
        // PDF file - convert to images then OCR
        setOcrStatus("Processing PDF...");
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        text = await processPDF(f);
        
      } else if (fileType === 'text/plain' || fileName.endsWith('.txt')) {
        // Plain text file - read directly
        setOcrStatus("Reading text file...");
        setOcrProgress(50);
        text = await f.text();
        setOcrProgress(100);
        
      } else {
        throw new Error("Unsupported file type. Please upload an image, PDF, or text file.");
      }
      
      setExtractedText(text);
      setOcrStatus("Analyzing with AI...");
      
      // Send extracted text to AI for analysis
      const result = await callAPI({
        action: "ANALYZE_INTAKE",
        text: text,
        fileName: f.name
      });
      
      if (result.success) {
        setIntakeResult(result);
        setIntakeInput(result.extracted || {});
      } else {
        // Fallback: Create basic intake result from extracted text
        const detectedType = detectActivityType(text);
        setIntakeResult({
          success: true,
          detected: detectedType.activity,
          summary: detectedType.summary,
          confidence: detectedType.confidence,
          extracted: extractFieldsFromText(text),
          extractedText: text,
          suggestedTasks: detectedType.tasks
        });
        setIntakeInput(extractFieldsFromText(text));
      }
      
    } catch (error) {
      console.error("File processing error:", error);
      alert("Error processing file: " + error.message);
    }
    
    setIsLoading(false);
    setOcrProgress(0);
    setOcrStatus("");
    e.target.value = "";
  };
  
  // Detect activity type from extracted text
  const detectActivityType = (text) => {
    const lowerText = text.toLowerCase();
    
    if (lowerText.includes('afe') || lowerText.includes('authority for expenditure')) {
      return {
        activity: "CREATE_PROJECT",
        summary: "AFE Document - Project Creation Required",
        confidence: 90,
        tasks: [{ workflowId: "CREATE_PROJECT", name: "Create New Project" }]
      };
    } else if (lowerText.includes('fccr') || lowerText.includes('funding capital')) {
      return {
        activity: "ADD_BUDGET",
        summary: "FCCR Document - Budget Entry Required",
        confidence: 88,
        tasks: [{ workflowId: "ADD_BUDGET", name: "Enter Budget" }]
      };
    } else if (lowerText.includes('purchase order') || lowerText.includes('po number')) {
      return {
        activity: "CHECK_STATUS",
        summary: "Purchase Order - Status Check",
        confidence: 85,
        tasks: [{ workflowId: "CHECK_PO_STATUS", name: "Check PO Status" }]
      };
    } else if (lowerText.includes('service entry') || lowerText.includes('ses')) {
      return {
        activity: "CREATE_SES",
        summary: "Service Entry Sheet Required",
        confidence: 87,
        tasks: [{ workflowId: "CREATE_SES", name: "Create SES" }]
      };
    } else if (lowerText.includes('goods receipt') || lowerText.includes('migo')) {
      return {
        activity: "CREATE_GR",
        summary: "Goods Receipt Required",
        confidence: 86,
        tasks: [{ workflowId: "CREATE_GR", name: "Create Goods Receipt" }]
      };
    } else if (lowerText.includes('budget') || lowerText.includes('zj40')) {
      return {
        activity: "ADD_BUDGET",
        summary: "Budget Related Document",
        confidence: 80,
        tasks: [{ workflowId: "ADD_BUDGET", name: "Enter Budget" }]
      };
    } else if (lowerText.includes('project') || lowerText.includes('wbs') || lowerText.includes('cj20n')) {
      return {
        activity: "CREATE_PROJECT",
        summary: "Project Related Document",
        confidence: 75,
        tasks: [{ workflowId: "CREATE_PROJECT", name: "Create New Project" }]
      };
    }
    
    return {
      activity: "UNKNOWN",
      summary: "Document requires manual review",
      confidence: 50,
      tasks: []
    };
  };
  
  // Extract fields from text using patterns
  const extractFieldsFromText = (text) => {
    const extracted = {};
    
    // WBS Number pattern: 6XX/YYNNN or similar
    const wbsMatch = text.match(/\b(6\d{2}\/\d{5}(?:\.\d{2})?)\b/);
    if (wbsMatch) extracted.wbs = wbsMatch[1];
    
    // Company Code pattern
    const ccMatch = text.match(/company\s*code[:\s]*(\d{4})/i) || text.match(/\b(1230|0495|4310)\b/);
    if (ccMatch) extracted.companyCode = ccMatch[1];
    
    // Budget/Amount pattern
    const amountMatch = text.match(/\$\s*([\d,]+(?:\.\d{2})?)/);
    if (amountMatch) extracted.amount = amountMatch[1].replace(/,/g, '');
    
    // Project name - look for common patterns
    const projectMatch = text.match(/project[:\s]+([^\n]+)/i);
    if (projectMatch) extracted.projectName = projectMatch[1].trim().substring(0, 50);
    
    // AFE number
    const afeMatch = text.match(/afe[:\s#-]*(\w+-?\d+)/i);
    if (afeMatch) extracted.afeNumber = afeMatch[1];
    
    // PO Number
    const poMatch = text.match(/p\.?o\.?[:\s#-]*(\d+)/i);
    if (poMatch) extracted.poNumber = poMatch[1];
    
    // Date patterns
    const dateMatch = text.match(/\b(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})\b/);
    if (dateMatch) extracted.date = dateMatch[1];
    
    return extracted;
  };

  const createTask = async (wfId) => {
    setIsLoading(true);
    // Map workflow ID to appropriate action
    let action = "CREATE_TASK";
    if (wfId === "CREATE_SES") action = "CREATE_SES_TASK";
    else if (wfId === "CREATE_GR") action = "CREATE_GR_TASK";
    else if (wfId === "REVERSE_SES") action = "REVERSE_SES_TASK";
    else if (wfId === "REVERSE_GR") action = "REVERSE_GR_TASK";
    else if (wfId === "CHECK_PO_STATUS") action = "CHECK_PO_STATUS_TASK";
    else if (wfId === "EMDS_CAPITALIZE") action = "EMDS_CAPITALIZE_TASK";
    else if (wfId === "PTRA_TRANSFER") action = "PTRA_TRANSFER_TASK";
    else if (wfId === "PTRA_RETIRE") action = "PTRA_RETIRE_TASK";
    else if (wfId === "CHECK_ASSET") action = "CHECK_ASSET_TASK";
    
    const r = await callAPI({action: action, workflowId: wfId, input: intakeInput});
    if (r.success) {
      setCurrentTask(r.task);
      setCompletedSteps({});
      setModule("tasks");
    }
    setIsLoading(false);
  };

  // Handle chat file upload
  const handleChatFileUpload = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    setChatUploadFile(file);
    setChatUploadProgress(0);
    setChatUploadStatus("Processing...");
    
    // Add user message showing file upload
    setChatMessages(p => [...p, {
      role: "user", 
      content: `ðŸ“Ž Uploaded: ${file.name}`,
      attachment: { name: file.name, type: file.type, size: file.size }
    }]);
    
    // Show thinking indicator
    setChatMessages(p => [...p, {role: "ai", content: "ðŸ“„ Analyzing document...", isLoading: true}]);
    
    try {
      let extractedText = "";
      const fileType = file.type;
      const fileName = file.name.toLowerCase();
      
      // Process file based on type
      if (fileType.startsWith('image/') || fileName.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)) {
        setChatUploadStatus("Running OCR on image...");
        const imageUrl = URL.createObjectURL(file);
        extractedText = await processOCR(imageUrl);
        URL.revokeObjectURL(imageUrl);
      } else if (fileType === 'application/pdf' || fileName.endsWith('.pdf')) {
        setChatUploadStatus("Processing PDF...");
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
        extractedText = await processPDF(file);
      } else if (fileType === 'text/plain' || fileName.endsWith('.txt')) {
        extractedText = await file.text();
      } else if (fileName.endsWith('.csv') || fileType === 'text/csv') {
        extractedText = await file.text();
      } else {
        throw new Error("Unsupported file type. Please upload an image, PDF, text, or CSV file.");
      }
      
      setChatUploadStatus("Analyzing with AI...");
      setChatUploadProgress(80);
      
      // Send to AI for intelligent analysis
      const result = await callAPI({
        action: "ANALYZE_CHAT_DOCUMENT",
        text: extractedText,
        fileName: file.name,
        fileType: file.type,
        user: currentUser?.displayName || "Unknown"
      });
      
      setChatUploadProgress(100);
      
      if (result.success) {
        // Store document reference
        const docRef = result.documentId || `DOC-${Date.now()}`;
        
        // Build response based on detected type
        let aiResponse = "";
        
        if (result.documentType === "ACTIVITY") {
          // Activity document (AFE, FCCR, PO, etc.)
          aiResponse = `ðŸ“‹ **Document Analysis Complete**

I detected this is a **${result.activityName || result.detected}** document.

**Extracted Information:**
${Object.entries(result.extracted || {}).map(([k, v]) => `â€¢ ${k}: ${v}`).join('\n')}

**Confidence:** ${result.confidence || 85}%

${result.suggestedWorkflow ? `Would you like me to create a **${result.suggestedWorkflow.name}** checklist in the Tasks module with this information?

Type **"yes"** to create the checklist, or ask me anything else.` : ''}

ðŸ“ Document saved for audit (Ref: ${docRef})`;
          
          // Store pending action
          if (result.suggestedWorkflow) {
            setPendingAction({
              type: 'create_checklist',
              data: {
                workflowId: result.suggestedWorkflow.id,
                workflowName: result.suggestedWorkflow.name,
                extracted: result.extracted,
                documentRef: docRef,
                fileName: file.name
              }
            });
          }
          
        } else if (result.documentType === "RULE_UPDATE") {
          // Rule update document (DOAG, thresholds, etc.)
          aiResponse = `ðŸ“œ **Rule Update Document Detected**

I found **${result.ruleType || "configuration changes"}** in this document.

**Changes Detected:**
${(result.changes || []).map(c => `â€¢ ${c.field}: ${c.oldValue || 'N/A'} â†’ ${c.newValue}`).join('\n')}

**Affected Area:** ${result.affectedArea || "Country Configuration"}

Would you like me to **update the playbook rules** with these changes?

Type **"yes"** to apply updates, or **"no"** to cancel.

ðŸ“ Document saved for audit (Ref: ${docRef})`;
          
          // Store pending action
          setPendingAction({
            type: 'update_rules',
            data: {
              ruleType: result.ruleType,
              changes: result.changes,
              affectedArea: result.affectedArea,
              documentRef: docRef,
              fileName: file.name,
              country: result.country || selectedCountry
            }
          });
          
        } else {
          // Unknown or informational document
          aiResponse = `ðŸ“„ **Document Processed**

I analyzed the document but couldn't determine a specific action.

**Summary:** ${result.summary || "General document"}

**Extracted Text Preview:**
${extractedText.substring(0, 500)}${extractedText.length > 500 ? '...' : ''}

ðŸ“ Document saved for reference (Ref: ${docRef})

How can I help you with this document?`;
        }
        
        // Update chat with AI response
        setChatMessages(p => {
          const updated = [...p];
          updated[updated.length - 1] = {role: "ai", content: aiResponse};
          return updated;
        });
        
      } else {
        throw new Error(result.error || "Analysis failed");
      }
      
    } catch (error) {
      console.error("Chat upload error:", error);
      setChatMessages(p => {
        const updated = [...p];
        updated[updated.length - 1] = {
          role: "ai", 
          content: `âš ï¸ Error processing document: ${error.message}

Please try again or upload a different file format.`
        };
        return updated;
      });
    }
    
    setChatUploadFile(null);
    setChatUploadProgress(0);
    setChatUploadStatus("");
    e.target.value = "";
  };
  
  // Handle pending action confirmation
  const handlePendingActionConfirm = async (confirmed) => {
    if (!pendingAction) return;
    
    if (!confirmed) {
      setChatMessages(p => [...p, {role: "user", content: "No"}]);
      setChatMessages(p => [...p, {role: "ai", content: "Okay, no changes made. The document is still saved for reference. Is there anything else I can help with?"}]);
      setPendingAction(null);
      return;
    }
    
    setChatMessages(p => [...p, {role: "user", content: "Yes"}]);
    setChatMessages(p => [...p, {role: "ai", content: "â³ Processing...", isLoading: true}]);
    
    try {
      if (pendingAction.type === 'create_checklist') {
        // Create checklist in Tasks module
        const result = await callAPI({
          action: "CREATE_CHECKLIST_FROM_DOCUMENT",
          workflowId: pendingAction.data.workflowId,
          extracted: pendingAction.data.extracted,
          documentRef: pendingAction.data.documentRef,
          fileName: pendingAction.data.fileName,
          user: currentUser?.displayName || "Unknown"
        });
        
        if (result.success) {
          // Update local state with new checklist
          setCurrentTask(result.checklist);
          setCompletedSteps({});
          
          setChatMessages(p => {
            const updated = [...p];
            updated[updated.length - 1] = {
              role: "ai", 
              content: `âœ… **Checklist Created Successfully!**

**${pendingAction.data.workflowName}** checklist has been created with:
${Object.entries(pendingAction.data.extracted || {}).map(([k, v]) => `â€¢ ${k}: ${v}`).join('\n')}

ðŸ“‹ Checklist ID: ${result.checklistId || result.checklist?.id}
ðŸ“ Document Reference: ${pendingAction.data.documentRef}

**Click "Go to Tasks"** to start working on the checklist, or I can help you with something else.`
            };
            return updated;
          });
          
          // Add action button
          setChatMessages(p => [...p, {
            role: "ai", 
            content: "GO_TO_TASKS_BUTTON",
            isButton: true,
            buttonAction: () => setModule("tasks")
          }]);
          
        } else {
          throw new Error(result.error || "Failed to create checklist");
        }
        
      } else if (pendingAction.type === 'update_rules') {
        // Update rules/configuration
        const result = await callAPI({
          action: "UPDATE_RULES_FROM_DOCUMENT",
          ruleType: pendingAction.data.ruleType,
          changes: pendingAction.data.changes,
          country: pendingAction.data.country,
          documentRef: pendingAction.data.documentRef,
          fileName: pendingAction.data.fileName,
          user: currentUser?.displayName || "Unknown"
        });
        
        if (result.success) {
          // Reload country config
          const configResult = await callAPI({action: "GET_CONFIG", country: pendingAction.data.country});
          if (configResult.success) {
            setCountryConfig(configResult.config);
          }
          
          setChatMessages(p => {
            const updated = [...p];
            updated[updated.length - 1] = {
              role: "ai", 
              content: `âœ… **Rules Updated Successfully!**

The following changes have been applied:
${(pendingAction.data.changes || []).map(c => `â€¢ ${c.field}: Updated to ${c.newValue}`).join('\n')}

ðŸ“œ Update logged in audit trail
ðŸ“ Document Reference: ${pendingAction.data.documentRef}

The playbook now reflects the new rules. Is there anything else I can help with?`
            };
            return updated;
          });
          
        } else {
          throw new Error(result.error || "Failed to update rules");
        }
      }
      
    } catch (error) {
      console.error("Pending action error:", error);
      setChatMessages(p => {
        const updated = [...p];
        updated[updated.length - 1] = {
          role: "ai", 
          content: `âš ï¸ Error: ${error.message}

The action could not be completed. Please try again or contact support.`
        };
        return updated;
      });
    }
    
    setPendingAction(null);
  };

  const sendChat = async () => {
    if (!chatInput.trim()) return;
    const userMessage = chatInput.trim();
    
    // Check if this is a confirmation for pending action
    if (pendingAction) {
      const lowerMsg = userMessage.toLowerCase();
      if (lowerMsg === 'yes' || lowerMsg === 'y' || lowerMsg === 'ok' || lowerMsg === 'confirm') {
        setChatInput("");
        await handlePendingActionConfirm(true);
        return;
      } else if (lowerMsg === 'no' || lowerMsg === 'n' || lowerMsg === 'cancel') {
        setChatInput("");
        await handlePendingActionConfirm(false);
        return;
      }
      // If not yes/no, clear pending action and process as normal message
      setPendingAction(null);
    }
    
    setChatMessages(p => [...p, {role: "user", content: userMessage}]);
    setChatInput("");
    
    // Show thinking indicator
    setChatMessages(p => [...p, {role: "ai", content: "ðŸ’­ Thinking...", isLoading: true}]);
    
    try {
      // Call backend with Gemini AI
      const result = await callAPI({
        action: "CHAT",
        message: userMessage,
        context: {
          history: chatMessages.slice(-10) // Send last 10 messages for context
        }
      });
      
      if (result.success && result.response) {
        // Replace thinking message with actual response
        setChatMessages(p => {
          const updated = [...p];
          updated[updated.length - 1] = {role: "ai", content: result.response};
          return updated;
        });
      } else {
        // If backend fails, show error but try to be helpful
        setChatMessages(p => {
          const updated = [...p];
          updated[updated.length - 1] = {
            role: "ai", 
            content: `âš ï¸ I couldn't connect to the AI service. 

**Error:** ${result.error || "Connection failed"}

**To fix this:**
1. Go to Admin â†’ Settings
2. Make sure Backend URL is configured
3. Ensure Gemini API key is set in Script Properties

Or try asking about SAP topics like:
â€¢ Project creation (CJ20N)
â€¢ Budget entry (ZJ40)
â€¢ Settlement rules
â€¢ Approval thresholds`
          };
          return updated;
        });
      }
    } catch (error) {
      console.error("Chat error:", error);
      setChatMessages(p => {
        const updated = [...p];
        updated[updated.length - 1] = {
          role: "ai", 
          content: `âš ï¸ Connection error: ${error.message}

Please check that the backend is configured in Admin settings.`
        };
        return updated;
      });
    }
  };

  // Country editing
  const startEdit = () => {
    setEditConfig(JSON.parse(JSON.stringify(countryConfig)));
    setIsEditing(true);
  };

  const cancelEdit = () => {
    setEditConfig(null);
    setIsEditing(false);
  };

  const saveConfig = async () => {
    if (!editConfig?.id) {
      alert("Country name required");
      return;
    }
    setIsLoading(true);
    const r = await callAPI({action: "SAVE_COUNTRY", config: editConfig});
    if (r.success) {
      setCountryConfig(editConfig);
      setIsEditing(false);
      setEditConfig(null);
      alert("Saved successfully!");
    }
    setIsLoading(false);
  };

  const updateField = (path, value) => {
    setEditConfig(prev => {
      const copy = JSON.parse(JSON.stringify(prev));
      const keys = path.split(".");
      let obj = copy;
      for (let i = 0; i < keys.length - 1; i++) {
        if (!obj[keys[i]]) obj[keys[i]] = {};
        obj = obj[keys[i]];
      }
      obj[keys[keys.length - 1]] = value;
      return copy;
    });
  };

  const addArrayItem = (path, template) => {
    setEditConfig(prev => {
      const copy = JSON.parse(JSON.stringify(prev));
      const keys = path.split(".");
      let obj = copy;
      for (const k of keys) {
        if (!obj[k]) obj[k] = [];
        obj = obj[k];
      }
      obj.push(template);
      return copy;
    });
  };

  const removeArrayItem = (path, index) => {
    setEditConfig(prev => {
      const copy = JSON.parse(JSON.stringify(prev));
      const keys = path.split(".");
      let obj = copy;
      for (let i = 0; i < keys.length - 1; i++) obj = obj[keys[i]];
      obj[keys[keys.length - 1]] = obj[keys[keys.length - 1]].filter((_, i) => i !== index);
      return copy;
    });
  };

  const updateArrayItem = (path, index, field, value) => {
    setEditConfig(prev => {
      const copy = JSON.parse(JSON.stringify(prev));
      const keys = path.split(".");
      let obj = copy;
      for (const k of keys) obj = obj[k];
      obj[index][field] = value;
      return copy;
    });
  };

  const startNewCountry = () => {
    setEditConfig({
      id: "",
      flag: "ðŸ³ï¸",
      currency: "USD",
      region: "APAC",
      sap: {system: "", controllingArea: "", companyCodes: [{code: "", name: ""}], businessAreas: [{code: "", name: ""}]},
      project: {format: "", countryCode: "", budgetClasses: [{code: "", name: ""}], recoveryIndicators: [{code: "", name: ""}]},
      funding: {stages: [{code: "", name: ""}]},
      tCodes: {createProject: {code: "CJ20N"}, addBudget: {code: ""}, checkStatus: {code: ""}},
      rules: [],
      tips: []
    });
    setIsEditing(true);
    setCountryTab("view");
  };

  const copyCurrentCountry = () => {
    setEditConfig({...JSON.parse(JSON.stringify(countryConfig)), id: "", flag: "ðŸ³ï¸"});
    setIsEditing(true);
    setCountryTab("view");
  };

  const loadCompare = async (cid) => {
    if (!cid) return;
    const r = await callAPI({action: "COMPARE_COUNTRIES", country1: selectedCountry?.id, country2: cid});
    if (r.success) setCompareResult(r);
  };

  // Get current config (edit or view)
  const config = isEditing ? editConfig : countryConfig;
  
  // Phase state: "handover" or "working"
  const [phase, setPhase] = useState("working");
  
  // Admin state
  const [adminTab, setAdminTab] = useState("countries");
  const [adminData, setAdminData] = useState({});
  const [editingRow, setEditingRow] = useState(null);
  const [newRow, setNewRow] = useState({});
  const [backendUrl, setBackendUrl] = useState(localStorage.getItem("sap_playbook_backend_url") || "");
  const [backendStatus, setBackendStatus] = useState("unknown"); // unknown, connected, disconnected
  
  // Wrapper function to call backend API with current URL
  const callBackend = async (data) => {
    return callBackendApi(data, backendUrl);
  };
  
  // Test backend connection
  const testBackendConnection = async (url) => {
    try {
      // Google Apps Script requires no-cors or special handling
      // We'll test with a POST request since GAS handles that better
      const response = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "text/plain", // GAS works better with text/plain
        },
        body: JSON.stringify({action: "GET_SIGNATURE_STATS"}),
      });
      
      const text = await response.text();
      try {
        const result = JSON.parse(text);
        if (result.success !== undefined) {
          setBackendStatus("connected");
          return true;
        }
      } catch (e) {
        // If we got any response, backend is reachable
        if (text.includes("success") || text.includes("SAP Playbook")) {
          setBackendStatus("connected");
          return true;
        }
      }
      
      setBackendStatus("disconnected");
      return false;
    } catch (error) {
      console.error("Connection test failed:", error);
      setBackendStatus("disconnected");
      return false;
    }
  };
  
  // Handover phase state
  const [handoverTab, setHandoverTab] = useState("upload");
  const [knowledgeItems, setKnowledgeItems] = useState([
    {id: 1, type: "process", title: "Project Creation Process", source: "Meeting Notes 2024-01", status: "verified", content: "Steps to create project in SAP..."},
    {id: 2, type: "rule", title: "Tax Review Threshold", source: "Finance Policy Doc", status: "verified", content: "Tax review required when Net > $3M AUD"},
    {id: 3, type: "contact", title: "FCCR Team Contact", source: "Handover Email", status: "pending", content: "fccr.team@company.com"}
  ]);
  const [uploadedDocs, setUploadedDocs] = useState([]);
  
  // New Handover Management
  const [handovers, setHandovers] = useState([
    {id: "HO-001", country: "Australia", status: "completed", progress: 100, createdAt: "2024-01-15", completedAt: "2024-01-20"},
  ]);
  const [activeHandover, setActiveHandover] = useState(null);
  const [showNewHandoverWizard, setShowNewHandoverWizard] = useState(false);
  const [newHandoverStep, setNewHandoverStep] = useState(1);
  const [newHandoverData, setNewHandoverData] = useState({
    country: "",
    flag: "",
    currency: "",
    region: "APAC",
    copyFrom: "",
    sapSystem: "ECC",
    companyCode: "",
    controllingArea: ""
  });
  const [extractedKnowledge, setExtractedKnowledge] = useState(null);
  
  // Config section state for Quick Setup
  const [configSection, setConfigSection] = useState(null); // null, 'country', 'workflows', 'prerequisites', 'contacts'
  const [configEditData, setConfigEditData] = useState({});

  // Handover modules
  const handoverModules = [
    {id: "upload", icon: "FileUp", label: "Upload Docs"},
    {id: "knowledge", icon: "Brain", label: "Knowledge Base"},
    {id: "review", icon: "CheckCircle", label: "Review"},
    {id: "config", icon: "Settings", label: "Configure"}
  ];
  
  // Working modules  
  const workingModules = [
    {id: "intake", icon: "Upload", label: "Smart Intake"},
    {id: "tasks", icon: "ClipboardList", label: "Tasks"},
    {id: "documents", icon: "FileText", label: "Document Tracking"},
    {id: "enhanced", icon: "Sparkles", label: "Enhanced"},
    {id: "support", icon: "HelpCircle", label: "Support KB"},
    {id: "lessons", icon: "Lightbulb", label: "Lessons Learned"},
    {id: "training", icon: "GraduationCap", label: "Training"},
    {id: "game", icon: "Gamepad2", label: "SAP Quest"},
    {id: "countries", icon: "Globe", label: "Countries"},
    {id: "analytics", icon: "BarChart3", label: "Analytics"},
    {id: "audit", icon: "FileText", label: "Audit Trail"},
    {id: "admin", icon: "Settings", label: "Admin"}
  ];

  // ========== LESSONS LEARNED STATE ==========
  const [lessonsLearned, setLessonsLearned] = useState([
    {id: "LL-001", title: "Always check settlement rule before TECO", category: "SETTLEMENT", severity: "high", module: "FI", 
     description: "When setting project to TECO status, always verify settlement rule exists first. Missing settlement rule causes errors during month-end close.",
     rootCause: "Settlement rule was not created during project setup", solution: "Added to project creation checklist", 
     createdBy: "John Smith", createdAt: "2024-01-15", tags: ["settlement", "teco", "month-end"], upvotes: 12},
    {id: "LL-002", title: "JV percentage must equal 100%", category: "PROJECT", severity: "medium", module: "FI",
     description: "JV partner percentages in CJ20N must always total exactly 100%. System allows saving with different totals but causes settlement errors.",
     rootCause: "Manual entry error", solution: "Request validation rule from SAP team",
     createdBy: "Sarah Lee", createdAt: "2024-01-18", tags: ["jv", "settlement", "validation"], upvotes: 8},
    {id: "LL-003", title: "GR before SES for service orders", category: "MM", severity: "high", module: "MM",
     description: "For service purchase orders, GR must be posted before SES can be approved. Attempting SES first causes workflow rejection.",
     rootCause: "Process documentation unclear", solution: "Updated SOP with correct sequence",
     createdBy: "Mike Chen", createdAt: "2024-01-20", tags: ["gr", "ses", "services"], upvotes: 15},
    {id: "LL-004", title: "Asset class determines depreciation method", category: "ASSET", severity: "low", module: "AA",
     description: "When creating asset master, the asset class automatically determines depreciation key. Changing depreciation method requires changing asset class.",
     rootCause: "Training gap", solution: "Added to new user onboarding",
     createdBy: "Lisa Wang", createdAt: "2024-01-22", tags: ["asset", "depreciation", "master data"], upvotes: 5}
  ]);
  const [showAddLesson, setShowAddLesson] = useState(false);
  const [lessonFilter, setLessonFilter] = useState({category: "all", severity: "all", module: "all"});
  const [newLesson, setNewLesson] = useState({title: "", category: "", severity: "medium", module: "FI", description: "", rootCause: "", solution: "", tags: ""});

  // ========== TIPS OF THE DAY STATE ==========
  const [tips] = useState([
    {id: 1, tip: "Use CJI3 to see line item details with original documents - much more detail than CJ30!", category: "FI", icon: "ðŸ’¡"},
    {id: 2, tip: "Ctrl+F5 in SAP GUI refreshes the screen and clears cached data.", category: "General", icon: "âŒ¨ï¸"},
    {id: 3, tip: "When creating settlement rules, use 'FUL' for full settlement to a single receiver.", category: "FI", icon: "ðŸ“‹"},
    {id: 4, tip: "ME2M shows all POs for a vendor - great for checking order history.", category: "MM", icon: "ðŸ”"},
    {id: 5, tip: "Always run KO88 in test mode first (checkbox) before actual settlement.", category: "FI", icon: "âš ï¸"},
    {id: 6, tip: "AS03 â†’ Environment â†’ Display changes shows complete asset history.", category: "AA", icon: "ðŸ“œ"},
    {id: 7, tip: "Use /nXXX to open transaction in same window, /oXXX to open in new window.", category: "General", icon: "ðŸ–¥ï¸"},
    {id: 8, tip: "FAGLL03 is the new GL line item report - replaces FBL3N in S/4HANA.", category: "FI", icon: "ðŸ“Š"},
    {id: 9, tip: "ME28 releases multiple blocked POs at once - saves time vs ME22N.", category: "MM", icon: "â±ï¸"},
    {id: 10, tip: "CJ30 shows commitments AND actuals - perfect for budget monitoring.", category: "FI", icon: "ðŸ’°"},
    {id: 11, tip: "When asset write-off rejected, check if asset has open depreciation runs.", category: "AA", icon: "ðŸ”§"},
    {id: 12, tip: "MIGO â†’ Other Goods Receipt for non-PO goods movements.", category: "MM", icon: "ðŸ“¦"}
  ]);
  const [currentTipIndex, setCurrentTipIndex] = useState(Math.floor(Math.random() * 12));
  const [showTipOfDay, setShowTipOfDay] = useState(true);

  // ========== DEADLINE REMINDERS STATE ==========
  const [deadlines, setDeadlines] = useState([
    {id: "DL-001", title: "Month-End Close", date: "2024-01-31", type: "recurring", priority: "critical", 
     description: "All settlements must be complete by 5 PM", module: "FI", recurring: "monthly", dayOfMonth: "last"},
    {id: "DL-002", title: "Budget Submission Q1", date: "2024-02-15", type: "one-time", priority: "high",
     description: "Submit Q1 budget amendments to FCCR", module: "FI", recurring: null},
    {id: "DL-003", title: "Asset Physical Count", date: "2024-03-01", type: "recurring", priority: "medium",
     description: "Annual physical asset verification", module: "AA", recurring: "yearly", dayOfMonth: "1"},
    {id: "DL-004", title: "GR/IR Clearing", date: "2024-01-25", type: "recurring", priority: "high",
     description: "Clear GR/IR differences before month-end", module: "MM", recurring: "monthly", dayOfMonth: "25"}
  ]);
  const [showAddDeadline, setShowAddDeadline] = useState(false);
  const [newDeadline, setNewDeadline] = useState({title: "", date: "", type: "one-time", priority: "medium", description: "", module: "FI"});
  
  // Knowledge Base state
  const [kbCategory, setKbCategory] = useState("all");
  const [kbSearch, setKbSearch] = useState("");
  const [kbSelectedArticle, setKbSelectedArticle] = useState(null);
  const [kbEditMode, setKbEditMode] = useState(false);
  const [kbEditArticle, setKbEditArticle] = useState(null);
  const [kbShowAddForm, setKbShowAddForm] = useState(false);

  // ========== ENHANCED ANALYTICS STATE ==========
  const [analyticsTab, setAnalyticsTab] = useState("overview");
  const [analyticsDateRange, setAnalyticsDateRange] = useState("30d");
  const [analyticsData, setAnalyticsData] = useState({
    tasksByDay: [
      {date: "Jan 1", completed: 5, created: 7},
      {date: "Jan 2", completed: 8, created: 4},
      {date: "Jan 3", completed: 3, created: 6},
      {date: "Jan 4", completed: 10, created: 8},
      {date: "Jan 5", completed: 7, created: 5},
      {date: "Jan 6", completed: 12, created: 9},
      {date: "Jan 7", completed: 6, created: 7}
    ],
    tasksByModule: {FI: 45, MM: 32, AA: 23},
    tasksByStatus: {completed: 78, inProgress: 15, pending: 7},
    avgCompletionTime: {FI: 25, MM: 18, AA: 32},
    userPerformance: [
      {name: "John Smith", tasks: 28, avgTime: 22, accuracy: 94},
      {name: "Sarah Lee", tasks: 35, avgTime: 18, accuracy: 89},
      {name: "Mike Chen", tasks: 42, avgTime: 15, accuracy: 96}
    ],
    handoverProgress: [
      {country: "AU", progress: 100, status: "completed"},
      {country: "NZ", progress: 75, status: "in-progress"},
      {country: "SG", progress: 45, status: "in-progress"},
      {country: "MY", progress: 20, status: "in-progress"},
      {country: "ID", progress: 0, status: "pending"}
    ],
    errorTrends: [
      {type: "Settlement Rule Missing", count: 12, trend: "down"},
      {type: "JV Percentage Mismatch", count: 8, trend: "stable"},
      {type: "Missing GR", count: 15, trend: "up"},
      {type: "Approval Level Error", count: 5, trend: "down"}
    ]
  });

  // ========== TRAINING MODE STATE ==========
  const [trainingModule, setTrainingModule] = useState(null);
  const [trainingStep, setTrainingStep] = useState(0);
  const [trainingCompleted, setTrainingCompleted] = useState([]);
  const [showTraining, setShowTraining] = useState(false);
  
  const trainingCourses = [
    {
      id: "TR001",
      title: "Project Creation Basics",
      description: "Learn how to create and configure projects in SAP",
      module: "FI",
      duration: "15 min",
      difficulty: "beginner",
      xpReward: 100,
      steps: [
        {title: "Access CJ20N", instruction: "Navigate to transaction CJ20N to access Project Builder", tip: "You can also use CJ01 for simple project creation", image: "ðŸ“Ÿ"},
        {title: "Enter Project Definition", instruction: "Enter the Project Definition number following format: P-XXXX-YYYY", tip: "Use the naming convention from your country's config", image: "ðŸ“"},
        {title: "Select Project Profile", instruction: "Choose the appropriate project profile from dropdown", tip: "Project profile determines default settings and behaviors", image: "âš™ï¸"},
        {title: "Enter Basic Data", instruction: "Fill in description, responsible person, and dates", tip: "Start date is required; end date can be estimated", image: "ðŸ“…"},
        {title: "Create WBS Elements", instruction: "Add WBS elements under the project definition", tip: "Follow the WBS hierarchy from the template", image: "ðŸ—ï¸"},
        {title: "Save Project", instruction: "Click Save or press Ctrl+S to save the project", tip: "Note down the project number for future reference", image: "ðŸ’¾"}
      ]
    },
    {
      id: "TR002",
      title: "Settlement Rule Configuration",
      description: "Master settlement rules for project costs",
      module: "FI",
      duration: "20 min",
      difficulty: "intermediate",
      xpReward: 150,
      steps: [
        {title: "Open Project in CJ20N", instruction: "Navigate to CJ20N and enter your project number", tip: "Ensure you have change authorization", image: "ðŸ“Ÿ"},
        {title: "Navigate to Settlement Rule", instruction: "Go to Extras â†’ Settlement Rule or double-click the WBS", tip: "Settlement rules can be at project or WBS level", image: "ðŸ”"},
        {title: "Select Settlement Type", instruction: "Choose Full Settlement or Periodic Settlement", tip: "Full settlement clears all costs; periodic allows partial", image: "ðŸ“Š"},
        {title: "Enter Receiver", instruction: "Specify the settlement receiver (cost center, asset, GL)", tip: "Receiver must be valid in the controlling area", image: "ðŸŽ¯"},
        {title: "Set Percentages", instruction: "Enter settlement percentage (usually 100%)", tip: "For JV, ensure all partner percentages sum to 100%", image: "ðŸ’¯"},
        {title: "Activate Rule", instruction: "Save and activate the settlement rule", tip: "Green light indicates active rule", image: "âœ…"}
      ]
    },
    {
      id: "TR003",
      title: "Purchase Order Processing",
      description: "Create and manage purchase orders in MM",
      module: "MM",
      duration: "18 min",
      difficulty: "beginner",
      xpReward: 100,
      steps: [
        {title: "Access ME21N", instruction: "Navigate to transaction ME21N for PO creation", tip: "ME22N for changes, ME23N for display", image: "ðŸ“Ÿ"},
        {title: "Enter Header Data", instruction: "Select vendor, purchasing org, and company code", tip: "Vendor must be released for the purchasing org", image: "ðŸ¢"},
        {title: "Add Line Items", instruction: "Enter material/service, quantity, and price", tip: "For services, use service master or free text", image: "ðŸ“¦"},
        {title: "Assign Account", instruction: "Enter account assignment (cost center, project, etc.)", tip: "Account assignment category determines required fields", image: "ðŸ’°"},
        {title: "Check & Save", instruction: "Use Check function, then save the PO", tip: "Note the PO number for goods receipt", image: "âœ…"},
        {title: "Release PO", instruction: "Release PO if required by approval workflow", tip: "ME28 for mass release, ME29N for individual", image: "ðŸ”“"}
      ]
    },
    {
      id: "TR004",
      title: "Asset Capitalization",
      description: "Convert AUC to final assets",
      module: "AA",
      duration: "25 min",
      difficulty: "advanced",
      xpReward: 200,
      steps: [
        {title: "Review AUC Balance", instruction: "Run AW01N to check AUC values and postings", tip: "Ensure all costs are posted before capitalization", image: "ðŸ“Š"},
        {title: "Create Target Asset", instruction: "Use AS01 to create the target fixed asset", tip: "Asset class determines depreciation parameters", image: "ðŸ—ï¸"},
        {title: "Access AIAB", instruction: "Navigate to AIAB for settlement to asset", tip: "AIBU for mass capitalization", image: "ðŸ“Ÿ"},
        {title: "Enter AUC and Target", instruction: "Enter source AUC and target asset numbers", tip: "You can split AUC to multiple assets", image: "âž¡ï¸"},
        {title: "Set Capitalization Date", instruction: "Enter the capitalization date for depreciation start", tip: "Usually first of month or period", image: "ðŸ“…"},
        {title: "Execute & Verify", instruction: "Execute capitalization and verify in AW01N", tip: "Check both AUC (cleared) and new asset (capitalized)", image: "âœ…"}
      ]
    },
    {
      id: "TR005",
      title: "Month-End Close Procedures",
      description: "Complete month-end closing activities",
      module: "FI",
      duration: "30 min",
      difficulty: "advanced",
      xpReward: 250,
      steps: [
        {title: "Run GR/IR Clearing", instruction: "Execute F.13 or MR11 for GR/IR reconciliation", tip: "Clear before settlement to ensure accurate costs", image: "ðŸ”„"},
        {title: "Execute Settlements", instruction: "Run KO88 for order settlement, CJ88 for projects", tip: "Run in test mode first to preview results", image: "ðŸ’¸"},
        {title: "Run Depreciation", instruction: "Execute AFAB for depreciation posting", tip: "Run planned depreciation before unplanned", image: "ðŸ“‰"},
        {title: "Reconcile Balances", instruction: "Run FAGLB03/FBL3N to reconcile accounts", tip: "Focus on clearing accounts and suspense items", image: "âš–ï¸"},
        {title: "Generate Reports", instruction: "Run S_ALR reports for management review", tip: "Compare to prior period for anomaly detection", image: "ðŸ“ˆ"},
        {title: "Close Period", instruction: "Close MM and FI periods after all postings", tip: "Keep backup period open for adjustments", image: "ðŸ”’"}
      ]
    }
  ];

  // ========== AUDIT TRAIL STATE ==========
  const [auditTrail, setAuditTrail] = useState([
    {id: "AUD001", timestamp: "2024-01-20 14:32:15", user: "john.smith", action: "CREATE", entity: "Task", entityId: "TSK-0047", details: "Created task: Review settlement rules for AU", module: "FI"},
    {id: "AUD002", timestamp: "2024-01-20 14:28:03", user: "sarah.lee", action: "UPDATE", entity: "Lesson", entityId: "LL-001", details: "Updated root cause analysis", module: "Lessons"},
    {id: "AUD003", timestamp: "2024-01-20 13:45:22", user: "admin", action: "CONFIG", entity: "Threshold", entityId: "TH-AU", details: "Changed tax review threshold from 50000 to 75000", module: "Admin"},
    {id: "AUD004", timestamp: "2024-01-20 12:15:00", user: "mike.chen", action: "DELETE", entity: "Deadline", entityId: "DL-005", details: "Removed obsolete deadline", module: "Admin"},
    {id: "AUD005", timestamp: "2024-01-20 11:30:45", user: "john.smith", action: "COMPLETE", entity: "Task", entityId: "TSK-0042", details: "Marked task as complete", module: "Tasks"},
    {id: "AUD006", timestamp: "2024-01-19 16:20:33", user: "sarah.lee", action: "CREATE", entity: "Quiz", entityId: "Q-015", details: "Created new quiz question: Settlement receivers", module: "Game"},
    {id: "AUD007", timestamp: "2024-01-19 15:00:00", user: "admin", action: "HANDOVER", entity: "Country", entityId: "AU", details: "Completed handover for Australia", module: "Handover"},
    {id: "AUD008", timestamp: "2024-01-19 10:45:12", user: "mike.chen", action: "CREATE", entity: "Article", entityId: "KB-013", details: "Added KB article: GR/IR Clearing Process", module: "KB"},
    {id: "AUD009", timestamp: "2024-01-18 14:22:00", user: "john.smith", action: "UPDATE", entity: "Country", entityId: "NZ", details: "Updated company code mapping", module: "Config"},
    {id: "AUD010", timestamp: "2024-01-18 09:15:30", user: "sarah.lee", action: "UPVOTE", entity: "Lesson", entityId: "LL-003", details: "Upvoted lesson: JV percentage must equal 100%", module: "Lessons"}
  ]);
  const [auditFilter, setAuditFilter] = useState({action: "all", module: "all", user: "all", dateRange: "7d"});
  const [showAuditDetail, setShowAuditDetail] = useState(null);

  // ========== REPORT GENERATION STATE ==========
  const [showReportModal, setShowReportModal] = useState(false);
  const [reportType, setReportType] = useState("handover");
  const [reportCountry, setReportCountry] = useState("AU");
  const [reportGenerating, setReportGenerating] = useState(false);

  // Generate PDF Report function
  const generatePDFReport = async () => {
    setReportGenerating(true);
    
    // Create a simple text-based report
    const reportDate = new Date().toLocaleDateString();
    const country = countries.find(c => c.id === reportCountry) || countries[0];
    
    let reportContent = "";
    
    if (reportType === "handover") {
      reportContent = `
================================================================================
                    HANDOVER STATUS REPORT
================================================================================
Generated: ${reportDate}
Country: ${country.flag} ${country.name} (${country.id})
================================================================================

EXECUTIVE SUMMARY
-----------------
This report provides a comprehensive overview of the SAP migration handover 
status for ${country.name}.

HANDOVER STATUS
---------------
Status: ${country.phase === "completed" ? "âœ… COMPLETED" : "ðŸ”„ IN PROGRESS"}
Start Date: ${country.startDate || "N/A"}
${country.phase === "completed" ? "Completion Date: " + (country.completedDate || "N/A") : "Expected Completion: TBD"}

CONFIGURATION SUMMARY
---------------------
Company Codes: ${DEFAULT_CONFIG.companyCodes?.length || 3} configured
Business Areas: ${DEFAULT_CONFIG.businessAreas?.length || 4} configured
JV Codes: ${DEFAULT_CONFIG.jvCodes?.length || 6} configured
Budget Classes: ${DEFAULT_CONFIG.budgetClasses?.length || 4} configured

TASK SUMMARY
------------
Total Tasks: 47
Completed: 42 (89%)
In Progress: 5 (11%)

KEY MILESTONES
--------------
â˜‘ Initial Setup Complete
â˜‘ Configuration Validated
â˜‘ User Training Complete
â˜ Go-Live Support

KNOWLEDGE BASE
--------------
Articles Created: ${kbArticles.length}
Lessons Learned: ${lessonsLearned.length}

================================================================================
                         END OF REPORT
================================================================================
      `;
    } else if (reportType === "analytics") {
      reportContent = `
================================================================================
                    ANALYTICS SUMMARY REPORT
================================================================================
Generated: ${reportDate}
Period: Last 30 Days
================================================================================

TASK ANALYTICS
--------------
Total Tasks: 100
Completed: 78 (78%)
In Progress: 15 (15%)
Pending: 7 (7%)

BY MODULE
---------
FI (Finance): 45 tasks (45%)
MM (Materials): 32 tasks (32%)
AA (Assets): 23 tasks (23%)

AVERAGE COMPLETION TIME
-----------------------
FI Module: 25 minutes
MM Module: 18 minutes
AA Module: 32 minutes
Overall Average: 21 minutes

TOP PERFORMERS
--------------
1. Mike Chen - 42 tasks (96% accuracy)
2. Sarah Lee - 35 tasks (89% accuracy)
3. John Smith - 28 tasks (94% accuracy)

COMMON ERRORS
-------------
1. Settlement Rule Missing: 12 occurrences (â†“ decreasing)
2. Missing GR: 15 occurrences (â†‘ increasing - needs attention)
3. JV Percentage Mismatch: 8 occurrences (â†’ stable)
4. Approval Level Error: 5 occurrences (â†“ decreasing)

================================================================================
                         END OF REPORT
================================================================================
      `;
    } else if (reportType === "audit") {
      const auditLines = auditTrail.slice(0, 10).map(a => 
        "[" + a.timestamp + "] " + a.user + " - " + a.action + " " + a.entity + " (" + a.entityId + ")"
      ).join("\n");
      
      reportContent = `
================================================================================
                    AUDIT TRAIL REPORT
================================================================================
Generated: ${reportDate}
Period: Last 7 Days
================================================================================

SUMMARY
-------
Total Actions: ${auditTrail.length}
Creates: ${auditTrail.filter(a => a.action === "CREATE").length}
Updates: ${auditTrail.filter(a => a.action === "UPDATE").length}
Deletes: ${auditTrail.filter(a => a.action === "DELETE").length}
Config Changes: ${auditTrail.filter(a => a.action === "CONFIG").length}

RECENT ACTIVITY
---------------
${auditLines}

================================================================================
                         END OF REPORT
================================================================================
      `;
    }
    
    // Create and download the report
    const blob = new Blob([reportContent], {type: "text/plain"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `${reportType}_report_${reportCountry}_${new Date().toISOString().split("T")[0]}.txt`;
    link.click();
    
    setTimeout(() => {
      setReportGenerating(false);
      setShowReportModal(false);
      alert("ðŸ“„ Report generated and downloaded successfully!");
    }, 1000);
  };

  // Function to log audit trail
  const logAudit = (action, entity, entityId, details, module) => {
    const newAudit = {
      id: "AUD" + String(auditTrail.length + 1).padStart(3, "0"),
      timestamp: new Date().toISOString().replace("T", " ").substring(0, 19),
      user: currentUser?.username || "system",
      action,
      entity,
      entityId,
      details,
      module
    };
    setAuditTrail([newAudit, ...auditTrail]);
  };

  // ========== GAMIFICATION & USER SYSTEM ==========
  const [currentUser, setCurrentUser] = useState(null);
  const [showLoginModal, setShowLoginModal] = useState(false);
  const [loginForm, setLoginForm] = useState({username: "", password: ""});
  const [users, setUsers] = useState([
    {id: "USR001", username: "admin", password: "admin123", displayName: "Admin User", role: "admin", 
     xp: 2500, level: 8, coins: 850, badges: ["early_adopter", "quiz_master", "contributor"], 
     quizzesPlayed: 45, quizzesCreated: 12, correctAnswers: 38, streak: 5, joinedAt: "2024-01-01",
     answeredQuestions: ["Q001", "Q002", "Q003"]},
    {id: "USR002", username: "john", password: "john123", displayName: "John Smith", role: "user",
     xp: 1200, level: 5, coins: 320, badges: ["first_quiz", "5_streak"],
     quizzesPlayed: 22, quizzesCreated: 3, correctAnswers: 18, streak: 2, joinedAt: "2024-01-10",
     answeredQuestions: ["Q001", "Q002"]},
    {id: "USR003", username: "sarah", password: "sarah123", displayName: "Sarah Lee", role: "user",
     xp: 800, level: 4, coins: 180, badges: ["contributor"],
     quizzesPlayed: 15, quizzesCreated: 8, correctAnswers: 12, streak: 0, joinedAt: "2024-01-15",
     answeredQuestions: []}
  ]);
  
  // Quiz System
  const [quizzes, setQuizzes] = useState([
    {id: "Q001", question: "What T-Code is used to create a new project in SAP?", 
     options: ["CJ20N", "ME21N", "VA01", "FB01"], correctAnswer: 0, 
     explanation: "CJ20N is the Project Builder transaction used to create and maintain project definitions and WBS elements. ME21N is for Purchase Orders, VA01 for Sales Orders, and FB01 for posting documents.",
     category: "FI", difficulty: "easy", createdBy: "USR001", xpReward: 10, coinReward: 5, plays: 34, correctRate: 82},
    {id: "Q002", question: "Which T-Code is used to run settlement?", 
     options: ["KO88", "CJ30", "ME23N", "AS03"], correctAnswer: 0,
     explanation: "KO88 is used to settle orders and projects. It transfers costs from the sender (project/order) to the receiver defined in the settlement rule. CJ30 is for project planning, ME23N displays POs, AS03 displays assets.",
     category: "FI", difficulty: "medium", createdBy: "USR001", xpReward: 20, coinReward: 10, plays: 28, correctRate: 65},
    {id: "Q003", question: "What must be created before setting a project to TECO status?", 
     options: ["Budget", "Settlement Rule", "Asset Master", "Purchase Order"], correctAnswer: 1,
     explanation: "A Settlement Rule must exist before TECO (Technically Complete) status. Without it, costs cannot be settled out of the project during month-end close, causing errors in financial reporting.",
     category: "FI", difficulty: "medium", createdBy: "USR002", xpReward: 20, coinReward: 10, plays: 22, correctRate: 58},
    {id: "Q004", question: "In MM module, what comes first: GR or SES for service orders?", 
     options: ["GR (Goods Receipt)", "SES (Service Entry Sheet)", "Either can come first", "Neither is required"], correctAnswer: 0,
     explanation: "For service orders, Goods Receipt (GR) must be posted BEFORE the Service Entry Sheet (SES). This is a key difference from regular PO processing and a common source of errors.",
     category: "MM", difficulty: "hard", createdBy: "USR003", xpReward: 30, coinReward: 15, plays: 18, correctRate: 44},
    {id: "Q005", question: "What T-Code shows asset transaction history?", 
     options: ["AS03", "AW01N", "ABST2", "S_ALR_87012054"], correctAnswer: 1,
     explanation: "AW01N (Asset Explorer) shows complete asset transaction history including acquisitions, depreciation, and transfers. AS03 only shows master data, ABST2 is for reconciliation, and S_ALR reports are for depreciation.",
     category: "AA", difficulty: "hard", createdBy: "USR001", xpReward: 30, coinReward: 15, plays: 15, correctRate: 40}
  ]);
  
  // Game state
  const [gameMode, setGameMode] = useState("menu"); // menu, playing, results, leaderboard, create, shop
  const [currentQuiz, setCurrentQuiz] = useState(null);
  const [quizAnswer, setQuizAnswer] = useState(null);
  const [quizResult, setQuizResult] = useState(null);
  const [quizFilter, setQuizFilter] = useState({category: "all", difficulty: "all"});
  const [showCreateQuiz, setShowCreateQuiz] = useState(false);
  const [newQuiz, setNewQuiz] = useState({question: "", options: ["", "", "", ""], correctAnswer: 0, category: "FI", difficulty: "easy"});
  
  // Rewards & Shop
  const [shopItems] = useState([
    {id: "BADGE_GOLD", name: "Gold Badge Frame", cost: 500, type: "cosmetic", icon: "ðŸ…", description: "Shiny gold frame for your profile"},
    {id: "TITLE_EXPERT", name: "SAP Expert Title", cost: 300, type: "title", icon: "ðŸŽ–ï¸", description: "Display 'SAP Expert' title"},
    {id: "STREAK_FREEZE", name: "Streak Freeze", cost: 100, type: "powerup", icon: "â„ï¸", description: "Protect your streak for 1 day"},
    {id: "XP_BOOST", name: "2x XP Boost", cost: 200, type: "powerup", icon: "âš¡", description: "Double XP for next 5 quizzes"},
    {id: "HINT_PACK", name: "Hint Pack (5)", cost: 150, type: "powerup", icon: "ðŸ’¡", description: "5 hints to eliminate wrong answers"}
  ]);
  const [purchasedItems, setPurchasedItems] = useState([]);

  // Level thresholds
  const levelThresholds = [0, 100, 250, 500, 800, 1200, 1800, 2500, 3500, 5000, 7000, 10000];
  const getLevelFromXP = (xp) => {
    for (let i = levelThresholds.length - 1; i >= 0; i--) {
      if (xp >= levelThresholds[i]) return i + 1;
    }
    return 1;
  };
  const getXPProgress = (xp) => {
    const level = getLevelFromXP(xp);
    const currentLevelXP = levelThresholds[level - 1] || 0;
    const nextLevelXP = levelThresholds[level] || levelThresholds[levelThresholds.length - 1];
    return ((xp - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;
  };

  // Badge definitions
  const badgeDefinitions = {
    early_adopter: {name: "Early Adopter", icon: "ðŸŒŸ", description: "Joined in the first month"},
    first_quiz: {name: "First Quiz", icon: "ðŸŽ¯", description: "Completed your first quiz"},
    quiz_master: {name: "Quiz Master", icon: "ðŸ§ ", description: "Answered 50+ quizzes correctly"},
    contributor: {name: "Contributor", icon: "âœï¸", description: "Created 5+ quizzes"},
    "5_streak": {name: "5 Day Streak", icon: "ðŸ”¥", description: "Maintained 5 day streak"},
    "10_streak": {name: "10 Day Streak", icon: "ðŸ’Ž", description: "Maintained 10 day streak"},
    perfectionist: {name: "Perfectionist", icon: "ðŸ’¯", description: "Got 10 quizzes correct in a row"}
  };

  return (
    <div className="h-screen flex">
      {/* Global Search Modal */}
      <GlobalSearch 
        isOpen={showGlobalSearch} 
        onClose={() => setShowGlobalSearch(false)}
        searchData={SEARCH_DATA}
        onNavigate={(item) => {
          // Navigate based on search result type
          if (item.type === "Workflow") setModule("tasks");
          else if (item.type === "Guide") setModule("support");
        }}
      />
      
      <input type="file" ref={fileInputRef} className="hidden" onChange={handleFile} accept="image/*,.pdf,.txt,text/plain,application/pdf" />

      {/* Sidebar */}
      <div className="sidebar flex flex-col items-center py-4 gap-2">
        {/* Logo */}
        <div className="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center mb-2">
          <Icon name="BookOpen" size={20} className="text-white" />
        </div>
        
        {/* Phase Toggle */}
        <div className="mb-4 flex flex-col gap-1">
          <div
            onClick={() => setPhase("handover")}
            className={`w-10 h-10 rounded-lg flex items-center justify-center cursor-pointer transition-all ${phase === "handover" ? 'bg-amber-500 text-white' : 'bg-white/10 text-white/60 hover:bg-white/20'}`}
            title="Handover Phase"
          >
            <Icon name="BookCopy" size={18} />
          </div>
          <div
            onClick={() => setPhase("working")}
            className={`w-10 h-10 rounded-lg flex items-center justify-center cursor-pointer transition-all ${phase === "working" ? 'bg-green-500 text-white' : 'bg-white/10 text-white/60 hover:bg-white/20'}`}
            title="Working Phase"
          >
            <Icon name="Play" size={18} />
          </div>
        </div>
        
        <div className="w-8 border-t border-white/20 mb-2"></div>
        
        {/* Phase-specific modules */}
        {(phase === "handover" ? handoverModules : workingModules).map(item => (
          <div
            key={item.id}
            onClick={() => setModule(item.id)}
            className={`sidebar-item ${module === item.id ? 'active' : ''}`}
            title={item.label}
          >
            <Icon name={item.icon} size={22} />
          </div>
        ))}
      </div>

      {/* Main Content */}
      <div className="flex-1 flex flex-col overflow-hidden">
        {/* Header */}
        <header className="h-14 bg-white border-b flex items-center px-6 justify-between">
          <div className="flex items-center gap-4">
            <h1 className="font-semibold">PtA Migration Playbook</h1>
            <span className={`px-3 py-1 rounded-full text-xs font-semibold ${phase === "handover" ? "bg-amber-100 text-amber-700" : "bg-green-100 text-green-700"}`}>
              {phase === "handover" ? "ðŸ“š Handover Phase" : "â–¶ï¸ Working Phase"}
            </span>
            <span className="badge badge-blue">{module}</span>
          </div>
          <div className="flex items-center gap-3">
            {/* Global Search Button */}
            <button 
              onClick={() => setShowGlobalSearch(true)}
              className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-lg text-sm text-slate-600 hover:bg-slate-200"
            >
              <Icon name="Search" size={16} />
              <span>Search...</span>
              <kbd className="text-xs bg-white px-1.5 py-0.5 rounded border ml-1">âŒ˜K</kbd>
            </button>
            {phase === "handover" && (
              <button 
                onClick={() => {
                  if (confirm(`Complete handover for ${selectedCountry.flag} ${selectedCountry.id}?\n\nThis will activate the country for the Working phase.`)) {
                    // Update handover status
                    setHandovers(handovers.map(ho => 
                      ho.country === selectedCountry.id 
                        ? {...ho, status: "completed", progress: 100, completedAt: new Date().toISOString().split("T")[0]}
                        : ho
                    ));
                    // Switch to working phase
                    setPhase("working");
                    setModule("intake");
                  }
                }} 
                className="btn btn-success btn-sm"
              >
                <Icon name="CheckCircle" size={14} className="mr-1" /> Complete Handover
              </button>
            )}
            {phase === "working" && (
              <select 
                className="input py-1 text-sm"
                value={selectedCountry.id}
                onChange={(e) => {
                  const country = countries.find(c => c.id === e.target.value);
                  if (country) setSelectedCountry(country);
                }}
              >
                {countries.map(c => (
                  <option key={c.id} value={c.id}>{c.flag} {c.id}</option>
                ))}
              </select>
            )}
            {/* User/Game Indicator */}
            {currentUser ? (
              <div 
                onClick={() => {setModule("game"); setGameMode("menu");}}
                className="flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-purple-100 to-indigo-100 rounded-lg cursor-pointer hover:from-purple-200 hover:to-indigo-200"
              >
                <span className="text-lg">ðŸŽ®</span>
                <div className="text-xs">
                  <p className="font-bold text-purple-700">{currentUser.displayName}</p>
                  <p className="text-purple-500">Lv.{getLevelFromXP(currentUser.xp)} â€¢ {currentUser.coins}ðŸª™</p>
                </div>
              </div>
            ) : (
              <button 
                onClick={() => setShowLoginModal(true)}
                className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200 flex items-center gap-1"
              >
                <Icon name="LogIn" size={14} /> Login
              </button>
            )}
            {currentUser && (
              <button 
                onClick={() => {
                  if (confirm("Log out?")) {
                    setCurrentUser(null);
                  }
                }}
                className="p-1.5 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded"
                title="Logout"
              >
                <Icon name="LogOut" size={16} />
              </button>
            )}
            <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-lg">
              <span>{selectedCountry.flag}</span>
              <span className="font-medium text-sm">{selectedCountry.id}</span>
            </div>
          </div>
        </header>

        <div className="flex-1 flex overflow-hidden">
          {/* Content */}
          <div className="flex-1 overflow-auto p-6">

            {/* ========== TIP OF THE DAY BANNER ========== */}
            {phase === "working" && showTipOfDay && (
              <div className="max-w-5xl mb-4 fade-in">
                <div className="bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 rounded-xl p-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">{tips[currentTipIndex]?.icon}</span>
                      <div>
                        <p className="text-xs text-amber-600 font-medium mb-0.5">ðŸ’¡ Tip of the Day</p>
                        <p className="text-slate-700">{tips[currentTipIndex]?.tip}</p>
                        <p className="text-xs text-amber-500 mt-1">Category: {tips[currentTipIndex]?.category}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      <button 
                        onClick={() => setCurrentTipIndex((currentTipIndex + 1) % tips.length)}
                        className="text-amber-500 hover:text-amber-700 p-1"
                        title="Next tip"
                      >
                        <Icon name="RefreshCw" size={18} />
                      </button>
                      <button 
                        onClick={() => setShowTipOfDay(false)}
                        className="text-slate-400 hover:text-slate-600 p-1"
                        title="Hide tip"
                      >
                        <Icon name="X" size={18} />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* ========== UPCOMING DEADLINES ALERT ========== */}
            {phase === "working" && (() => {
              const today = new Date();
              const upcoming = deadlines.filter(d => {
                const dDate = new Date(d.date);
                const diffDays = Math.ceil((dDate - today) / (1000 * 60 * 60 * 24));
                return diffDays >= 0 && diffDays <= 7;
              }).sort((a, b) => new Date(a.date) - new Date(b.date));
              
              if (upcoming.length === 0) return null;
              
              return (
                <div className="max-w-5xl mb-4 fade-in">
                  <div className="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl p-4">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <Icon name="Bell" size={20} className="text-red-500" />
                        <span className="font-semibold text-red-700">Upcoming Deadlines ({upcoming.length})</span>
                      </div>
                      <button 
                        onClick={() => setModule("admin")}
                        className="text-xs text-red-600 hover:text-red-800"
                      >
                        Manage Deadlines â†’
                      </button>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {upcoming.slice(0, 3).map(d => {
                        const dDate = new Date(d.date);
                        const diffDays = Math.ceil((dDate - today) / (1000 * 60 * 60 * 24));
                        return (
                          <div key={d.id} className={`px-3 py-1.5 rounded-lg text-sm ${
                            diffDays <= 2 ? "bg-red-100 text-red-700" : "bg-amber-100 text-amber-700"
                          }`}>
                            <span className="font-medium">{d.title}</span>
                            <span className="mx-1">â€¢</span>
                            <span>{diffDays === 0 ? "Today!" : diffDays === 1 ? "Tomorrow" : `${diffDays} days`}</span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* ========== HANDOVER PHASE MODULES ========== */}
            
            {/* UPLOAD DOCS MODULE (Handover) - Now includes Handover List */}
            {phase === "handover" && module === "upload" && (
              <div className="max-w-5xl fade-in">
                {/* Handover List Header */}
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h2 className="text-xl font-bold">ðŸ“‹ Handover Management</h2>
                    <p className="text-slate-500 text-sm">Manage country handovers and configurations</p>
                  </div>
                  <button 
                    onClick={() => {
                      setShowNewHandoverWizard(true);
                      setNewHandoverStep(1);
                      setNewHandoverData({
                        country: "",
                        flag: "",
                        currency: "",
                        region: "APAC",
                        copyFrom: "",
                        sapSystem: "ECC",
                        companyCode: "",
                        controllingArea: ""
                      });
                    }}
                    className="btn btn-primary"
                  >
                    <Icon name="Plus" size={16} className="mr-1" /> New Handover
                  </button>
                </div>

                {/* New Handover Wizard Modal */}
                {showNewHandoverWizard && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-auto m-4">
                      {/* Wizard Header */}
                      <div className="p-6 border-b bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-t-2xl">
                        <div className="flex items-center justify-between">
                          <div>
                            <h3 className="text-xl font-bold">New Handover Wizard</h3>
                            <p className="text-amber-100">Step {newHandoverStep} of 4</p>
                          </div>
                          <button onClick={() => setShowNewHandoverWizard(false)} className="text-white/80 hover:text-white">
                            <Icon name="X" size={24} />
                          </button>
                        </div>
                        {/* Progress */}
                        <div className="flex gap-2 mt-4">
                          {[1,2,3,4].map(step => (
                            <div key={step} className={`flex-1 h-2 rounded-full ${step <= newHandoverStep ? 'bg-white' : 'bg-white/30'}`} />
                          ))}
                        </div>
                      </div>

                      {/* Wizard Content */}
                      <div className="p-6">
                        {/* Step 1: Basic Info */}
                        {newHandoverStep === 1 && (
                          <div className="fade-in">
                            <h4 className="font-semibold text-lg mb-4">Country Information</h4>
                            <div className="grid md:grid-cols-2 gap-4">
                              <div>
                                <label className="label">Country Name *</label>
                                <input 
                                  className="input" 
                                  placeholder="e.g., Thailand"
                                  value={newHandoverData.country}
                                  onChange={e => setNewHandoverData({...newHandoverData, country: e.target.value})}
                                />
                              </div>
                              <div>
                                <label className="label">Flag Emoji *</label>
                                <input 
                                  className="input" 
                                  placeholder="e.g., ðŸ‡¹ðŸ‡­"
                                  value={newHandoverData.flag}
                                  onChange={e => setNewHandoverData({...newHandoverData, flag: e.target.value})}
                                />
                              </div>
                              <div>
                                <label className="label">Currency Code *</label>
                                <input 
                                  className="input" 
                                  placeholder="e.g., THB"
                                  value={newHandoverData.currency}
                                  onChange={e => setNewHandoverData({...newHandoverData, currency: e.target.value.toUpperCase()})}
                                />
                              </div>
                              <div>
                                <label className="label">Region</label>
                                <select 
                                  className="input"
                                  value={newHandoverData.region}
                                  onChange={e => setNewHandoverData({...newHandoverData, region: e.target.value})}
                                >
                                  <option value="APAC">APAC</option>
                                  <option value="EMEA">EMEA</option>
                                  <option value="AMER">Americas</option>
                                </select>
                              </div>
                            </div>
                            <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                              <label className="label text-blue-800">Copy Configuration From (Optional)</label>
                              <select 
                                className="input mt-1"
                                value={newHandoverData.copyFrom}
                                onChange={e => setNewHandoverData({...newHandoverData, copyFrom: e.target.value})}
                              >
                                <option value="">Start from scratch</option>
                                {countries.map(c => (
                                  <option key={c.id} value={c.id}>{c.flag} {c.id}</option>
                                ))}
                              </select>
                              <p className="text-xs text-blue-600 mt-1">Copying will pre-fill SAP codes, thresholds, and workflows</p>
                            </div>
                          </div>
                        )}

                        {/* Step 2: SAP Configuration */}
                        {newHandoverStep === 2 && (
                          <div className="fade-in">
                            <h4 className="font-semibold text-lg mb-4">SAP Configuration</h4>
                            <div className="grid md:grid-cols-2 gap-4">
                              <div>
                                <label className="label">SAP System</label>
                                <select 
                                  className="input"
                                  value={newHandoverData.sapSystem}
                                  onChange={e => setNewHandoverData({...newHandoverData, sapSystem: e.target.value})}
                                >
                                  <option value="ECC">SAP ECC</option>
                                  <option value="S4HANA">SAP S/4HANA</option>
                                </select>
                              </div>
                              <div>
                                <label className="label">SAP Client</label>
                                <input 
                                  className="input" 
                                  placeholder="e.g., 100"
                                  value={newHandoverData.sapClient || ""}
                                  onChange={e => setNewHandoverData({...newHandoverData, sapClient: e.target.value})}
                                />
                              </div>
                              <div>
                                <label className="label">Company Code *</label>
                                <input 
                                  className="input" 
                                  placeholder="e.g., 1234"
                                  value={newHandoverData.companyCode}
                                  onChange={e => setNewHandoverData({...newHandoverData, companyCode: e.target.value})}
                                />
                              </div>
                              <div>
                                <label className="label">Controlling Area</label>
                                <input 
                                  className="input" 
                                  placeholder="e.g., 1000"
                                  value={newHandoverData.controllingArea}
                                  onChange={e => setNewHandoverData({...newHandoverData, controllingArea: e.target.value})}
                                />
                              </div>
                              <div>
                                <label className="label">Project Number Prefix</label>
                                <input 
                                  className="input" 
                                  placeholder="e.g., 7"
                                  maxLength={1}
                                  value={newHandoverData.projectPrefix || ""}
                                  onChange={e => setNewHandoverData({...newHandoverData, projectPrefix: e.target.value})}
                                />
                                <p className="text-xs text-slate-500 mt-1">First digit of project numbers for this country</p>
                              </div>
                              <div>
                                <label className="label">Exchange Rate to USD</label>
                                <input 
                                  className="input" 
                                  type="number"
                                  step="0.01"
                                  placeholder="e.g., 35.50"
                                  value={newHandoverData.exchangeRate || ""}
                                  onChange={e => setNewHandoverData({...newHandoverData, exchangeRate: e.target.value})}
                                />
                              </div>
                            </div>
                          </div>
                        )}

                        {/* Step 3: Upload Documents */}
                        {newHandoverStep === 3 && (
                          <div className="fade-in">
                            <h4 className="font-semibold text-lg mb-4">Upload Handover Documents</h4>
                            <p className="text-slate-500 mb-4">Upload any relevant documents to help build the knowledge base</p>
                            
                            <div 
                              className="border-2 border-dashed border-amber-300 rounded-xl p-8 text-center cursor-pointer hover:bg-amber-50"
                              onClick={() => fileInputRef.current?.click()}
                            >
                              <Icon name="FileUp" size={48} className="mx-auto text-amber-400 mb-3" />
                              <p className="font-medium">Click to upload documents</p>
                              <p className="text-sm text-slate-500">Meeting notes, emails, process docs, screenshots</p>
                            </div>

                            {uploadedDocs.length > 0 && (
                              <div className="mt-4 space-y-2">
                                {uploadedDocs.map((doc, i) => (
                                  <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                    <div className="flex items-center gap-2">
                                      <Icon name="FileText" size={20} className="text-slate-400" />
                                      <span>{doc.name}</span>
                                    </div>
                                    <span className="badge badge-green">Uploaded</span>
                                  </div>
                                ))}
                              </div>
                            )}

                            <p className="text-sm text-slate-400 mt-4 text-center">
                              You can skip this step and upload documents later
                            </p>
                          </div>
                        )}

                        {/* Step 4: Review & Create */}
                        {newHandoverStep === 4 && (
                          <div className="fade-in">
                            <h4 className="font-semibold text-lg mb-4">Review & Create</h4>
                            
                            <div className="bg-slate-50 rounded-xl p-4 mb-4">
                              <div className="flex items-center gap-4 mb-4">
                                <span className="text-4xl">{newHandoverData.flag || "ðŸ³ï¸"}</span>
                                <div>
                                  <h5 className="font-bold text-lg">{newHandoverData.country || "New Country"}</h5>
                                  <p className="text-slate-500">{newHandoverData.currency} â€¢ {newHandoverData.region}</p>
                                </div>
                              </div>
                              
                              <div className="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                  <p className="text-slate-500">SAP System</p>
                                  <p className="font-medium">{newHandoverData.sapSystem}</p>
                                </div>
                                <div>
                                  <p className="text-slate-500">Company Code</p>
                                  <p className="font-medium">{newHandoverData.companyCode || "-"}</p>
                                </div>
                                <div>
                                  <p className="text-slate-500">Project Prefix</p>
                                  <p className="font-medium">{newHandoverData.projectPrefix || "-"}</p>
                                </div>
                                <div>
                                  <p className="text-slate-500">Exchange Rate</p>
                                  <p className="font-medium">{newHandoverData.exchangeRate || "-"} USD</p>
                                </div>
                                {newHandoverData.copyFrom && (
                                  <div className="md:col-span-2">
                                    <p className="text-slate-500">Configuration copied from</p>
                                    <p className="font-medium">{newHandoverData.copyFrom}</p>
                                  </div>
                                )}
                              </div>
                            </div>

                            <div className="p-4 bg-green-50 border border-green-200 rounded-xl">
                              <div className="flex items-start gap-3">
                                <Icon name="CheckCircle" size={24} className="text-green-600 mt-0.5" />
                                <div>
                                  <p className="font-medium text-green-800">What happens next?</p>
                                  <ul className="text-sm text-green-700 mt-1 space-y-1">
                                    <li>â€¢ Country configuration will be created in Google Sheets</li>
                                    <li>â€¢ You can continue adding knowledge in the handover phase</li>
                                    <li>â€¢ Once ready, click "Complete Handover" to activate for Working phase</li>
                                  </ul>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Wizard Footer */}
                      <div className="p-6 border-t bg-slate-50 rounded-b-2xl flex justify-between">
                        <button 
                          onClick={() => {
                            if (newHandoverStep === 1) {
                              setShowNewHandoverWizard(false);
                            } else {
                              setNewHandoverStep(newHandoverStep - 1);
                            }
                          }}
                          className="btn btn-secondary"
                        >
                          {newHandoverStep === 1 ? "Cancel" : "â† Back"}
                        </button>
                        
                        {newHandoverStep < 4 ? (
                          <button 
                            onClick={() => {
                              // Validate current step
                              if (newHandoverStep === 1 && (!newHandoverData.country || !newHandoverData.flag || !newHandoverData.currency)) {
                                alert("Please fill in Country, Flag, and Currency");
                                return;
                              }
                              setNewHandoverStep(newHandoverStep + 1);
                            }}
                            className="btn btn-primary"
                          >
                            Next â†’
                          </button>
                        ) : (
                          <button 
                            onClick={async () => {
                              setIsLoading(true);
                              // Create the country configuration
                              const newConfig = {
                                id: newHandoverData.country,
                                flag: newHandoverData.flag,
                                currency: newHandoverData.currency,
                                region: newHandoverData.region,
                                active: true,
                                sap: {
                                  system: newHandoverData.sapSystem,
                                  client: newHandoverData.sapClient || "100",
                                  controllingArea: newHandoverData.controllingArea || "1000",
                                  companyCodes: [{code: newHandoverData.companyCode, name: newHandoverData.country + " Main"}]
                                },
                                project: {
                                  countryCode: newHandoverData.projectPrefix || "7"
                                },
                                exchangeRate: {
                                  toUSD: parseFloat(newHandoverData.exchangeRate) || 1
                                }
                              };
                              
                              // Call API to save
                              const r = await callAPI({action: "SAVE_COUNTRY", config: newConfig});
                              
                              if (r.success) {
                                // Add to countries list
                                setCountries([...countries, {id: newHandoverData.country, flag: newHandoverData.flag, currency: newHandoverData.currency}]);
                                
                                // Add to handovers
                                setHandovers([...handovers, {
                                  id: "HO-" + String(handovers.length + 1).padStart(3, "0"),
                                  country: newHandoverData.country,
                                  status: "in_progress",
                                  progress: 25,
                                  createdAt: new Date().toISOString().split("T")[0]
                                }]);
                                
                                // Select the new country
                                setSelectedCountry({id: newHandoverData.country, flag: newHandoverData.flag});
                                
                                setShowNewHandoverWizard(false);
                                alert("Handover created! Continue adding knowledge or complete the handover when ready.");
                              } else {
                                alert("Error: " + (r.error || "Failed to create handover"));
                              }
                              setIsLoading(false);
                            }}
                            className="btn btn-primary"
                            disabled={isLoading}
                          >
                            {isLoading ? "Creating..." : "ðŸš€ Create Handover"}
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {/* Handover List */}
                <div className="grid md:grid-cols-2 gap-4 mb-6">
                  {handovers.map(ho => (
                    <div 
                      key={ho.id}
                      className={`card cursor-pointer hover:shadow-lg transition-all ${ho.status === "completed" ? "border-green-200 bg-green-50/30" : "border-amber-200 bg-amber-50/30"}`}
                      onClick={() => {
                        const country = countries.find(c => c.id === ho.country);
                        if (country) {
                          setSelectedCountry(country);
                          if (ho.status === "completed") {
                            setPhase("working");
                            setModule("intake");
                          }
                        }
                      }}
                    >
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <span className="text-2xl">{countries.find(c => c.id === ho.country)?.flag || "ðŸ³ï¸"}</span>
                          <div>
                            <h4 className="font-semibold">{ho.country}</h4>
                            <p className="text-xs text-slate-500">{ho.id}</p>
                          </div>
                        </div>
                        <span className={`badge ${ho.status === "completed" ? "badge-green" : "badge-amber"}`}>
                          {ho.status === "completed" ? "âœ… Completed" : "ðŸ”„ In Progress"}
                        </span>
                      </div>
                      
                      <div className="mb-2">
                        <div className="flex justify-between text-xs text-slate-500 mb-1">
                          <span>Progress</span>
                          <span>{ho.progress}%</span>
                        </div>
                        <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                          <div 
                            className={`h-full ${ho.status === "completed" ? "bg-green-500" : "bg-amber-500"}`}
                            style={{width: `${ho.progress}%`}}
                          />
                        </div>
                      </div>
                      
                      <div className="flex justify-between text-xs text-slate-500">
                        <span>Started: {ho.createdAt}</span>
                        {ho.completedAt && <span>Completed: {ho.completedAt}</span>}
                      </div>
                    </div>
                  ))}
                </div>

                {/* Active Handover - Document Upload */}
                {selectedCountry && (
                  <>
                    <h3 className="font-semibold text-lg mb-4">ðŸ“¤ Upload Documents for {selectedCountry.flag} {selectedCountry.id}</h3>
                    
                    <div 
                      className="card mb-6 border-2 border-dashed border-amber-200 bg-amber-50/50 cursor-pointer hover:bg-amber-50 text-center"
                      onClick={() => fileInputRef.current?.click()}
                    >
                      <Icon name="FileUp" size={40} className="mx-auto text-amber-400 mb-3" />
                      <p className="font-medium">Upload handover documents</p>
                      <p className="text-sm text-slate-500 mt-1">Meeting notes, emails, process docs, screenshots</p>
                    </div>

                    <div className="card">
                      <h3 className="font-semibold mb-4">Uploaded Documents ({uploadedDocs.length})</h3>
                      {uploadedDocs.length === 0 ? (
                        <p className="text-slate-400 text-center py-8">No documents uploaded yet</p>
                      ) : (
                        <div className="space-y-2">
                          {uploadedDocs.map((doc, i) => (
                        <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <Icon name="FileText" size={20} className="text-amber-500" />
                            <div>
                              <p className="font-medium">{doc.name}</p>
                              <p className="text-xs text-slate-400">{doc.size} â€¢ {doc.date}</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={`badge ${doc.processed ? "badge-green" : "badge-amber"}`}>
                              {doc.processed ? "Processed" : "Pending"}
                            </span>
                            <button className="btn btn-primary btn-sm">Extract Knowledge</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="card mt-4">
                  <h3 className="font-semibold mb-4">Quick Add Knowledge</h3>
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="text-sm text-slate-500">Knowledge Type</label>
                      <select className="input mt-1">
                        <option value="process">Process / Workflow</option>
                        <option value="rule">Business Rule</option>
                        <option value="contact">Contact / Team</option>
                        <option value="config">Configuration</option>
                        <option value="tip">Tip / Best Practice</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-sm text-slate-500">Source</label>
                      <input className="input mt-1" placeholder="e.g., Meeting with John, Email from Finance" />
                    </div>
                    <div className="md:col-span-2">
                      <label className="text-sm text-slate-500">Knowledge Content</label>
                      <textarea className="input mt-1" rows={3} placeholder="Describe the process, rule, or information..."></textarea>
                    </div>
                  </div>
                  <button className="btn btn-primary mt-4">
                    <Icon name="Plus" size={16} className="mr-1" /> Add to Knowledge Base
                  </button>
                </div>
                  </>
                )}
              </div>
            )}

            {/* KNOWLEDGE BASE MODULE (Handover) */}
            {phase === "handover" && module === "knowledge" && (
              <div className="max-w-5xl fade-in">
                <h2 className="text-xl font-bold mb-1">ðŸ§  Knowledge Base</h2>
                <p className="text-slate-500 mb-6">Extracted knowledge from handover documents</p>

                <div className="grid md:grid-cols-4 gap-4 mb-6">
                  <div className="card text-center">
                    <p className="text-3xl font-bold text-blue-600">{knowledgeItems.filter(k => k.type === "process").length}</p>
                    <p className="text-sm text-slate-500">Processes</p>
                  </div>
                  <div className="card text-center">
                    <p className="text-3xl font-bold text-amber-600">{knowledgeItems.filter(k => k.type === "rule").length}</p>
                    <p className="text-sm text-slate-500">Rules</p>
                  </div>
                  <div className="card text-center">
                    <p className="text-3xl font-bold text-green-600">{knowledgeItems.filter(k => k.type === "contact").length}</p>
                    <p className="text-sm text-slate-500">Contacts</p>
                  </div>
                  <div className="card text-center">
                    <p className="text-3xl font-bold text-purple-600">{knowledgeItems.filter(k => k.status === "verified").length}</p>
                    <p className="text-sm text-slate-500">Verified</p>
                  </div>
                </div>

                <div className="card">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="font-semibold">All Knowledge Items</h3>
                    <div className="flex gap-2">
                      <select className="input py-1 w-40">
                        <option value="">All Types</option>
                        <option value="process">Processes</option>
                        <option value="rule">Rules</option>
                        <option value="contact">Contacts</option>
                      </select>
                    </div>
                  </div>
                  <div className="space-y-3">
                    {knowledgeItems.map((item, i) => (
                      <div key={i} className="p-4 bg-slate-50 rounded-lg">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <span className={`badge ${item.type === "process" ? "badge-blue" : item.type === "rule" ? "badge-amber" : "badge-green"}`}>
                                {item.type}
                              </span>
                              <span className={`badge ${item.status === "verified" ? "badge-green" : "badge-amber"}`}>
                                {item.status}
                              </span>
                            </div>
                            <p className="font-semibold">{item.title}</p>
                            <p className="text-sm text-slate-500 mt-1">{item.content}</p>
                            <p className="text-xs text-slate-400 mt-2">Source: {item.source}</p>
                          </div>
                          <div className="flex gap-1">
                            <button className="p-2 text-green-600 hover:bg-green-50 rounded" title="Verify">
                              <Icon name="Check" size={16} />
                            </button>
                            <button className="p-2 text-blue-600 hover:bg-blue-50 rounded" title="Edit">
                              <Icon name="Edit" size={16} />
                            </button>
                            <button className="p-2 text-red-600 hover:bg-red-50 rounded" title="Delete">
                              <Icon name="Trash2" size={16} />
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* REVIEW MODULE (Handover) */}
            {phase === "handover" && module === "review" && (
              <div className="max-w-4xl fade-in">
                <h2 className="text-xl font-bold mb-1">âœ… Review & Validate</h2>
                <p className="text-slate-500 mb-6">Review extracted knowledge before completing handover</p>

                <div className="card mb-6 bg-gradient-to-r from-amber-50 to-orange-50 border-amber-200">
                  <h3 className="font-semibold mb-3">Handover Checklist</h3>
                  <div className="space-y-2">
                    {[
                      {label: "All processes documented", done: true},
                      {label: "Business rules captured", done: true},
                      {label: "Contact information added", done: false},
                      {label: "Configuration verified", done: false},
                      {label: "Test with sample task", done: false}
                    ].map((item, i) => (
                      <div key={i} className="flex items-center gap-3">
                        <input type="checkbox" checked={item.done} className="w-5 h-5" readOnly />
                        <span className={item.done ? "text-slate-600" : "text-slate-400"}>{item.label}</span>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="card">
                  <h3 className="font-semibold mb-4">Pending Verification ({knowledgeItems.filter(k => k.status === "pending").length})</h3>
                  {knowledgeItems.filter(k => k.status === "pending").map((item, i) => (
                    <div key={i} className="p-4 bg-amber-50 rounded-lg mb-3 border border-amber-200">
                      <div className="flex items-start justify-between">
                        <div>
                          <span className="badge badge-amber">{item.type}</span>
                          <p className="font-semibold mt-1">{item.title}</p>
                          <p className="text-sm text-slate-600 mt-1">{item.content}</p>
                        </div>
                        <div className="flex gap-2">
                          <button className="btn btn-success btn-sm">
                            <Icon name="Check" size={14} className="mr-1" /> Verify
                          </button>
                          <button className="btn btn-secondary btn-sm">Edit</button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* CONFIG MODULE (Handover) */}
            {phase === "handover" && module === "config" && (
              <div className="max-w-4xl fade-in">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h2 className="text-xl font-bold">âš™ï¸ Configure Playbook</h2>
                    <p className="text-slate-500">Set up country configuration for {selectedCountry.flag} {selectedCountry.id}</p>
                  </div>
                  {configSection && (
                    <button onClick={() => setConfigSection(null)} className="btn btn-secondary">
                      <Icon name="ArrowLeft" size={16} className="mr-1" /> Back to Menu
                    </button>
                  )}
                </div>

                {/* Quick Setup Menu */}
                {!configSection && (
                  <div className="card mb-4">
                    <h3 className="font-semibold mb-4">Quick Setup</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <button 
                        onClick={() => {
                          setConfigSection('country');
                          setConfigEditData({
                            ...countryConfig,
                            companyCode: countryConfig.sap?.companyCodes?.[0]?.code || '',
                            controllingArea: countryConfig.sap?.controllingArea || '',
                            exchangeRate: countryConfig.exchangeRate?.toUSD || 1
                          });
                        }}
                        className="p-4 border-2 border-dashed rounded-lg hover:bg-blue-50 hover:border-blue-300 text-left transition-all"
                      >
                        <Icon name="Globe" size={24} className="text-blue-500 mb-2" />
                        <p className="font-semibold">Configure Country</p>
                        <p className="text-sm text-slate-500">Set up SAP codes, thresholds, rules</p>
                      </button>
                      <button 
                        onClick={() => setConfigSection('thresholds')}
                        className="p-4 border-2 border-dashed rounded-lg hover:bg-green-50 hover:border-green-300 text-left transition-all"
                      >
                        <Icon name="DollarSign" size={24} className="text-green-500 mb-2" />
                        <p className="font-semibold">Set Thresholds</p>
                        <p className="text-sm text-slate-500">Tax review, JV approval limits</p>
                      </button>
                      <button 
                        onClick={() => setConfigSection('prerequisites')}
                        className="p-4 border-2 border-dashed rounded-lg hover:bg-amber-50 hover:border-amber-300 text-left transition-all"
                      >
                        <Icon name="Shield" size={24} className="text-amber-500 mb-2" />
                        <p className="font-semibold">Set Prerequisites</p>
                        <p className="text-sm text-slate-500">Define approval requirements</p>
                      </button>
                      <button 
                        onClick={() => setConfigSection('contacts')}
                        className="p-4 border-2 border-dashed rounded-lg hover:bg-purple-50 hover:border-purple-300 text-left transition-all"
                      >
                        <Icon name="Users" size={24} className="text-purple-500 mb-2" />
                        <p className="font-semibold">Add Contacts</p>
                        <p className="text-sm text-slate-500">Team contacts and escalation</p>
                      </button>
                    </div>
                  </div>
                )}

                {/* Configure Country Section */}
                {configSection === 'country' && (
                  <div className="card fade-in">
                    <h3 className="font-semibold mb-4">ðŸŒ Country Configuration</h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      <div>
                        <label className="label">Country Name</label>
                        <input className="input" value={configEditData.id || ''} onChange={e => setConfigEditData({...configEditData, id: e.target.value})} />
                      </div>
                      <div>
                        <label className="label">Flag Emoji</label>
                        <input className="input" value={configEditData.flag || ''} onChange={e => setConfigEditData({...configEditData, flag: e.target.value})} />
                      </div>
                      <div>
                        <label className="label">Currency</label>
                        <input className="input" value={configEditData.currency || ''} onChange={e => setConfigEditData({...configEditData, currency: e.target.value})} />
                      </div>
                      <div>
                        <label className="label">Region</label>
                        <select className="input" value={configEditData.region || ''} onChange={e => setConfigEditData({...configEditData, region: e.target.value})}>
                          <option value="APAC">APAC</option>
                          <option value="EMEA">EMEA</option>
                          <option value="AMER">Americas</option>
                        </select>
                      </div>
                      <div>
                        <label className="label">Company Code</label>
                        <input className="input" value={configEditData.companyCode || ''} onChange={e => setConfigEditData({...configEditData, companyCode: e.target.value})} />
                      </div>
                      <div>
                        <label className="label">Controlling Area</label>
                        <input className="input" value={configEditData.controllingArea || ''} onChange={e => setConfigEditData({...configEditData, controllingArea: e.target.value})} />
                      </div>
                      <div>
                        <label className="label">Project Number Prefix</label>
                        <input className="input" maxLength={1} value={configEditData.project?.countryCode || ''} onChange={e => setConfigEditData({...configEditData, project: {...configEditData.project, countryCode: e.target.value}})} />
                      </div>
                      <div>
                        <label className="label">Exchange Rate to USD</label>
                        <input className="input" type="number" step="0.01" value={configEditData.exchangeRate || ''} onChange={e => setConfigEditData({...configEditData, exchangeRate: e.target.value})} />
                      </div>
                    </div>
                    <div className="flex gap-2 mt-6">
                      <button onClick={() => setConfigSection(null)} className="btn btn-secondary">Cancel</button>
                      <button 
                        onClick={async () => {
                          setIsLoading(true);
                          const r = await callAPI({action: "SAVE_COUNTRY", config: configEditData});
                          if (r.success) {
                            setCountryConfig(configEditData);
                            alert("Country configuration saved!");
                            setConfigSection(null);
                          } else {
                            alert("Error: " + (r.error || "Failed to save"));
                          }
                          setIsLoading(false);
                        }}
                        className="btn btn-primary"
                        disabled={isLoading}
                      >
                        {isLoading ? "Saving..." : "Save Configuration"}
                      </button>
                    </div>
                  </div>
                )}

                {/* Set Thresholds Section */}
                {configSection === 'thresholds' && (
                  <div className="card fade-in">
                    <h3 className="font-semibold mb-4">ðŸ’° Threshold Configuration</h3>
                    <p className="text-slate-500 text-sm mb-4">Set approval thresholds for {selectedCountry.id}</p>
                    
                    <div className="space-y-4">
                      <div className="p-4 bg-slate-50 rounded-lg">
                        <label className="label">Tax Review Threshold ({countryConfig.currency})</label>
                        <p className="text-xs text-slate-500 mb-2">Projects above this amount require tax review</p>
                        <input 
                          className="input" 
                          type="number" 
                          value={countryConfig.localThresholds?.taxReview?.FF || 3000000}
                          onChange={e => setCountryConfig({
                            ...countryConfig, 
                            localThresholds: {
                              ...countryConfig.localThresholds,
                              taxReview: {...countryConfig.localThresholds?.taxReview, FF: parseInt(e.target.value)}
                            }
                          })}
                        />
                      </div>
                      
                      <div className="p-4 bg-slate-50 rounded-lg">
                        <label className="label">JV Approval Threshold ({countryConfig.currency})</label>
                        <p className="text-xs text-slate-500 mb-2">JV projects above this amount require additional approval</p>
                        <input 
                          className="input" 
                          type="number" 
                          value={countryConfig.localThresholds?.jvApproval?.FF || 5000000}
                          onChange={e => setCountryConfig({
                            ...countryConfig, 
                            localThresholds: {
                              ...countryConfig.localThresholds,
                              jvApproval: {...countryConfig.localThresholds?.jvApproval, FF: parseInt(e.target.value)}
                            }
                          })}
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-2 mt-6">
                      <button onClick={() => setConfigSection(null)} className="btn btn-secondary">Cancel</button>
                      <button 
                        onClick={async () => {
                          setIsLoading(true);
                          const r = await callAPI({
                            action: "UPDATE_LOCAL_THRESHOLD", 
                            countryId: selectedCountry.id,
                            thresholdType: "taxReview",
                            stage: "FF",
                            amount: countryConfig.localThresholds?.taxReview?.FF
                          });
                          setIsLoading(false);
                          if (r.success) {
                            alert("Thresholds saved!");
                            setConfigSection(null);
                          }
                        }}
                        className="btn btn-primary"
                        disabled={isLoading}
                      >
                        {isLoading ? "Saving..." : "Save Thresholds"}
                      </button>
                    </div>
                  </div>
                )}

                {/* Prerequisites Section */}
                {configSection === 'prerequisites' && (
                  <div className="card fade-in">
                    <h3 className="font-semibold mb-4">ðŸ›¡ï¸ Prerequisites Configuration</h3>
                    <p className="text-slate-500 text-sm mb-4">Define what approvals are needed before SAP entry</p>
                    
                    <div className="space-y-3">
                      {(countryConfig.prerequisites || [
                        {id: "AFE", name: "AFE Approved", required: true},
                        {id: "FCCR", name: "FCCR Approval", required: true},
                        {id: "TAX", name: "Tax Review", required: false, condition: "If > $3M"},
                        {id: "JV", name: "JV Approval", required: false, condition: "If JV project > $5M"}
                      ]).map((prereq, i) => (
                        <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <input 
                              type="checkbox" 
                              checked={prereq.required}
                              onChange={() => {}}
                              className="w-5 h-5 rounded"
                            />
                            <div>
                              <p className="font-medium">{prereq.name}</p>
                              {prereq.condition && <p className="text-xs text-slate-500">{prereq.condition}</p>}
                            </div>
                          </div>
                          <button className="text-slate-400 hover:text-blue-500">
                            <Icon name="Edit" size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                    
                    <button className="btn btn-secondary mt-4">
                      <Icon name="Plus" size={16} className="mr-1" /> Add Prerequisite
                    </button>
                    
                    <div className="flex gap-2 mt-6">
                      <button onClick={() => setConfigSection(null)} className="btn btn-secondary">Back</button>
                      <button className="btn btn-primary">Save Prerequisites</button>
                    </div>
                  </div>
                )}

                {/* Contacts Section */}
                {configSection === 'contacts' && (
                  <div className="card fade-in">
                    <h3 className="font-semibold mb-4">ðŸ‘¥ Team Contacts</h3>
                    <p className="text-slate-500 text-sm mb-4">Key contacts for {selectedCountry.id} operations</p>
                    
                    <div className="space-y-3">
                      {[
                        {role: "PtA Lead", name: "", email: "", icon: "User"},
                        {role: "Finance Contact", name: "", email: "", icon: "DollarSign"},
                        {role: "Tax Advisor", name: "", email: "", icon: "FileText"},
                        {role: "FCCR Team", name: "", email: "", icon: "Shield"}
                      ].map((contact, i) => (
                        <div key={i} className="p-4 bg-slate-50 rounded-lg">
                          <div className="flex items-center gap-2 mb-3">
                            <Icon name={contact.icon} size={18} className="text-slate-500" />
                            <span className="font-medium">{contact.role}</span>
                          </div>
                          <div className="grid md:grid-cols-2 gap-3">
                            <input className="input" placeholder="Name" value={contact.name} onChange={() => {}} />
                            <input className="input" placeholder="Email" value={contact.email} onChange={() => {}} />
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    <button className="btn btn-secondary mt-4">
                      <Icon name="Plus" size={16} className="mr-1" /> Add Contact
                    </button>
                    
                    <div className="flex gap-2 mt-6">
                      <button onClick={() => setConfigSection(null)} className="btn btn-secondary">Back</button>
                      <button className="btn btn-primary">Save Contacts</button>
                    </div>
                  </div>
                )}

                {/* Import from Knowledge - only show when no section selected */}
                {!configSection && (
                  <div className="card">
                    <h3 className="font-semibold mb-4">Import from Knowledge Base</h3>
                    <p className="text-sm text-slate-500 mb-4">Automatically configure based on extracted knowledge</p>
                    <button 
                      onClick={() => alert("This feature will analyze uploaded documents and auto-fill configuration based on extracted knowledge.")}
                      className="btn btn-primary"
                    >
                      <Icon name="Wand2" size={16} className="mr-2" /> Auto-Configure from Knowledge
                    </button>
                  </div>
                )}
              </div>
            )}

            {/* ========== WORKING PHASE MODULES ========== */}

            {/* INTAKE MODULE */}
            {phase === "working" && module === "intake" && (
              <div className="max-w-4xl fade-in">
                <h2 className="text-xl font-bold mb-1">ðŸŽ¯ Smart Intake</h2>
                <p className="text-slate-500 mb-6">Upload a document (image, PDF, or text) and I'll extract text and detect the activity</p>

                <div 
                  className="card mb-6 border-2 border-dashed border-green-200 bg-green-50/50 cursor-pointer hover:bg-green-50 text-center"
                  onClick={() => !isLoading && fileInputRef.current?.click()}
                >
                  {isLoading ? (
                    <div className="py-6">
                      <div className="w-16 h-16 mx-auto mb-4 relative">
                        <svg className="w-16 h-16 transform -rotate-90">
                          <circle cx="32" cy="32" r="28" stroke="#e2e8f0" strokeWidth="4" fill="none" />
                          <circle 
                            cx="32" cy="32" r="28" 
                            stroke="#22c55e" 
                            strokeWidth="4" 
                            fill="none"
                            strokeDasharray={`${ocrProgress * 1.76} 176`}
                            className="transition-all duration-300"
                          />
                        </svg>
                        <span className="absolute inset-0 flex items-center justify-center text-sm font-bold text-green-600">
                          {ocrProgress}%
                        </span>
                      </div>
                      <p className="text-green-600 font-medium">{ocrStatus || "Processing..."}</p>
                      <p className="text-sm text-slate-500 mt-1">
                        {ocrProgress < 30 ? "Initializing OCR engine..." :
                         ocrProgress < 90 ? "Extracting text from document..." :
                         "Analyzing content..."}
                      </p>
                    </div>
                  ) : (
                    <>
                      <Icon name="FileSearch" size={40} className="mx-auto text-green-400 mb-3" />
                      <p className="font-medium">Upload document to detect activity</p>
                      <p className="text-sm text-slate-500 mt-1">Supports: Images (JPG, PNG), PDF, Text files</p>
                      <p className="text-xs text-slate-400 mt-2">OCR supports English and Thai</p>
                    </>
                  )}
                </div>
                
                {/* Extracted Text Preview */}
                {extractedText && !isLoading && (
                  <div className="card mb-6">
                    <div className="flex items-center justify-between mb-3">
                      <h3 className="font-semibold flex items-center gap-2">
                        <Icon name="FileText" size={18} className="text-blue-500" />
                        Extracted Text (OCR)
                      </h3>
                      <button 
                        onClick={() => navigator.clipboard.writeText(extractedText)}
                        className="btn btn-secondary btn-sm"
                      >
                        <Icon name="Copy" size={14} className="mr-1" /> Copy
                      </button>
                    </div>
                    <div className="bg-slate-50 rounded-lg p-3 max-h-48 overflow-y-auto">
                      <pre className="text-xs text-slate-600 whitespace-pre-wrap font-mono">{extractedText.substring(0, 2000)}{extractedText.length > 2000 ? "..." : ""}</pre>
                    </div>
                    <p className="text-xs text-slate-400 mt-2">{extractedText.length} characters extracted</p>
                  </div>
                )}

                {intakeResult && (
                  <div className="space-y-4 fade-in">
                    {/* Detected Activity */}
                    <div className="card bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm opacity-80">Detected Activity</p>
                          <p className="text-xl font-bold">{
                            intakeResult.detected === "CREATE_PROJECT" ? "Create New Project" :
                            intakeResult.detected === "ADD_BUDGET" ? "Add Budget" :
                            intakeResult.detected === "CHECK_STATUS" ? "Check Status" :
                            intakeResult.summary
                          }</p>
                        </div>
                        <div className="text-right">
                          <p className="text-sm opacity-80">Confidence</p>
                          <p className="text-2xl font-bold">{intakeResult.confidence || 95}%</p>
                        </div>
                      </div>
                    </div>
                    
                    {intakeResult.warnings?.length > 0 && (
                      <div className="card border-l-4 border-amber-400 bg-amber-50">
                        {intakeResult.warnings.map((w, i) => <p key={i} className="text-amber-800 text-sm">âš ï¸ {w}</p>)}
                      </div>
                    )}
                    <div className="card">
                      <h3 className="font-semibold mb-4">Extracted Data</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        {Object.entries(intakeResult.extracted || {}).map(([k, v]) => (
                          <div key={k}>
                            <p className="text-xs text-slate-400">{k}</p>
                            <input 
                              className="input text-sm py-1" 
                              value={intakeInput[k] || ""} 
                              onChange={e => setIntakeInput(p => ({...p, [k]: e.target.value}))}
                            />
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className="card">
                      {intakeResult.suggestedTasks?.map((t, i) => (
                        <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                          <p className="font-medium">{t.workflowId === "CREATE_PROJECT" ? "Create Project" : "Add Budget"}</p>
                          <button onClick={() => createTask(t.workflowId)} className="btn btn-primary btn-sm">
                            Start Task
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {!intakeResult && (
                  <div className="space-y-6">
                    {/* FI Module - Project/Budget */}
                    <div className="card">
                      <div className="flex items-center gap-2 mb-4">
                        <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold">FI Module</span>
                        <h3 className="font-semibold">Project & Budget Management</h3>
                      </div>
                      <div className="grid md:grid-cols-3 gap-4">
                        {workflows.filter(w => w.module === "FI" || !w.module).map(w => (
                          <button
                            key={w.id}
                            onClick={() => {setSelectedWorkflow(w); setIntakeInput({});}}
                            className={`p-4 rounded-xl border-2 text-left ${selectedWorkflow?.id === w.id ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-blue-200'}`}
                          >
                            <Icon name={w.icon} size={24} className={`mb-2 ${selectedWorkflow?.id === w.id ? 'text-blue-600' : 'text-slate-400'}`} />
                            <p className="font-medium">{w.name}</p>
                            <p className="text-xs text-slate-500 mt-1">{w.description || "SAP FI transaction"}</p>
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* MM Module - Procurement/SES/GR */}
                    <div className="card">
                      <div className="flex items-center gap-2 mb-4">
                        <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold">MM Module</span>
                        <h3 className="font-semibold">Procurement & Goods/Services Receipt</h3>
                      </div>
                      <div className="grid md:grid-cols-3 gap-4">
                        {workflows.filter(w => w.module === "MM").map(w => (
                          <button
                            key={w.id}
                            onClick={() => {setSelectedWorkflow(w); setIntakeInput({});}}
                            className={`p-4 rounded-xl border-2 text-left ${selectedWorkflow?.id === w.id ? 'border-green-500 bg-green-50' : 'border-slate-200 hover:border-green-200'}`}
                          >
                            <Icon name={w.icon} size={24} className={`mb-2 ${selectedWorkflow?.id === w.id ? 'text-green-600' : 'text-slate-400'}`} />
                            <p className="font-medium">{w.name}</p>
                            <p className="text-xs text-slate-500 mt-1">{w.description || "SAP MM transaction"}</p>
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* AA Module - Asset Accounting */}
                    <div className="card">
                      <div className="flex items-center gap-2 mb-4">
                        <span className="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs font-semibold">AA Module</span>
                        <h3 className="font-semibold">Asset Accounting - Capitalization & Write-Off</h3>
                      </div>
                      <div className="grid md:grid-cols-2 gap-4">
                        {workflows.filter(w => w.module === "AA").map(w => (
                          <button
                            key={w.id}
                            onClick={() => {setSelectedWorkflow(w); setIntakeInput({});}}
                            className={`p-4 rounded-xl border-2 text-left ${selectedWorkflow?.id === w.id ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-amber-200'}`}
                          >
                            <Icon name={w.icon} size={24} className={`mb-2 ${selectedWorkflow?.id === w.id ? 'text-amber-600' : 'text-slate-400'}`} />
                            <p className="font-medium">{w.name}</p>
                            <p className="text-xs text-slate-500 mt-1">{w.description || "SAP AA transaction"}</p>
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {selectedWorkflow && (
                      <div className="card">
                        <div className="flex items-center gap-2 mb-4">
                          <span className={`px-2 py-1 rounded text-xs font-semibold ${
                            selectedWorkflow.module === "MM" ? "bg-green-100 text-green-700" : 
                            selectedWorkflow.module === "AA" ? "bg-amber-100 text-amber-700" : 
                            "bg-blue-100 text-blue-700"
                          }`}>
                            {selectedWorkflow.module || "FI"} Module
                          </span>
                          <h3 className="font-semibold">{selectedWorkflow.name}</h3>
                        </div>
                        
                        {/* Project category info (FI only) */}
                        {selectedWorkflow.id === "CREATE_PROJECT" && (
                          <div className="mb-4 p-3 bg-blue-50 rounded-lg text-sm">
                            <p><strong>Project Number Format:</strong> {countryConfig.project?.format}</p>
                            <p className="text-slate-600">First digit "{countryConfig.project?.countryCode}" is fixed for {countryConfig.id}</p>
                          </div>
                        )}
                        
                        {/* MM Module info */}
                        {selectedWorkflow.module === "MM" && (
                          <div className="mb-4 p-3 bg-green-50 rounded-lg text-sm">
                            <p><strong>T-Code:</strong> {
                              selectedWorkflow.id === "CREATE_SES" ? "ML81N" :
                              selectedWorkflow.id === "CREATE_GR" ? "MIGO" :
                              selectedWorkflow.id === "REVERSE_SES" ? "ML81N" :
                              selectedWorkflow.id === "REVERSE_GR" ? "MIGO" :
                              "ME23N"
                            }</p>
                            <p className="text-slate-600">{selectedWorkflow.description}</p>
                          </div>
                        )}
                        
                        {/* AA Module info */}
                        {selectedWorkflow.module === "AA" && (
                          <div className="mb-4 p-3 bg-amber-50 rounded-lg text-sm">
                            <p><strong>T-Code:</strong> {
                              selectedWorkflow.id === "EMDS_CAPITALIZE" ? "AS01 / KO88" :
                              selectedWorkflow.id === "PTRA_TRANSFER" ? "ABUMN / ABT1N" :
                              selectedWorkflow.id === "PTRA_RETIRE" ? "ABAON / ABAVN" :
                              "AW01N"
                            }</p>
                            <p className="text-slate-600">{selectedWorkflow.description}</p>
                          </div>
                        )}
                        
                        <div className="grid md:grid-cols-2 gap-4">
                          {selectedWorkflow.requiredInputs?.map(inp => {
                            // Handle project category
                            if (inp.id === "projectCategory") {
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} *</label>
                                  <select 
                                    className="input"
                                    value={intakeInput.projectCategory || ""}
                                    onChange={e => {
                                      const cat = e.target.value;
                                      setIntakeInput(p => ({
                                        ...p, 
                                        projectCategory: cat,
                                        budgetClass: cat === "Decommissioning" ? "XF" : ""
                                      }));
                                    }}
                                  >
                                    <option value="">Select category...</option>
                                    <option value="Capital">Capital (01, 02, 03)</option>
                                    <option value="Decommissioning">Decommissioning (XF)</option>
                                  </select>
                                </div>
                              );
                            }
                            
                            // Handle select with options (for MM module dropdowns)
                            if (inp.type === "select" && inp.options) {
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} {inp.required ? "*" : ""}</label>
                                  <select 
                                    className="input"
                                    value={intakeInput[inp.id] || ""}
                                    onChange={e => setIntakeInput(p => ({...p, [inp.id]: e.target.value}))}
                                  >
                                    <option value="">Select...</option>
                                    {inp.options.map(o => <option key={o} value={o}>{o}</option>)}
                                  </select>
                                </div>
                              );
                            }
                            
                            // Handle date fields
                            if (inp.type === "date") {
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} {inp.required ? "*" : ""}</label>
                                  <input 
                                    type="date"
                                    className="input"
                                    value={intakeInput[inp.id] || ""}
                                    onChange={e => setIntakeInput(p => ({...p, [inp.id]: e.target.value}))}
                                  />
                                </div>
                              );
                            }
                            
                            // Handle number fields
                            if (inp.type === "number") {
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} {inp.required ? "*" : ""}</label>
                                  <input 
                                    type="number"
                                    className="input"
                                    value={intakeInput[inp.id] || ""}
                                    onChange={e => setIntakeInput(p => ({...p, [inp.id]: e.target.value}))}
                                    placeholder={inp.placeholder || ""}
                                  />
                                </div>
                              );
                            }
                            
                            // Handle text fields (default for MM module)
                            if (inp.type === "text") {
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} {inp.required ? "*" : ""}</label>
                                  <input 
                                    type="text"
                                    className="input"
                                    value={intakeInput[inp.id] || ""}
                                    onChange={e => setIntakeInput(p => ({...p, [inp.id]: e.target.value}))}
                                    placeholder={inp.placeholder || ""}
                                  />
                                </div>
                              );
                            }
                            
                            // Handle budget class (depends on project category)
                            if (inp.id === "budgetClass") {
                              const category = intakeInput.projectCategory;
                              const budgetClasses = countryConfig.project?.budgetClasses?.filter(
                                bc => !category || bc.category === category
                              ) || [];
                              
                              // Auto-select XF for decommissioning
                              if (category === "Decommissioning") {
                                return (
                                  <div key={inp.id}>
                                    <label className="block text-sm font-medium mb-1">{inp.label}</label>
                                    <div className="input bg-slate-100">XF - Decommissioning</div>
                                    <p className="text-xs text-amber-600 mt-1">âš ï¸ Settlement rule to account 490000030 required</p>
                                  </div>
                                );
                              }
                              
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} *</label>
                                  <select 
                                    className="input"
                                    value={intakeInput.budgetClass || ""}
                                    onChange={e => setIntakeInput(p => ({...p, budgetClass: e.target.value}))}
                                    disabled={!category}
                                  >
                                    <option value="">{category ? "Select budget class..." : "Select category first"}</option>
                                    {budgetClasses.map(bc => (
                                      <option key={bc.code} value={bc.code}>{bc.code} - {bc.name}{bc.requiresRuling ? " âš ï¸" : ""}</option>
                                    ))}
                                  </select>
                                  {intakeInput.budgetClass === "03" && (
                                    <p className="text-xs text-amber-600 mt-1">âš ï¸ EMIT requires CAPEX/OPEX ruling from FCCR and Fund.IT</p>
                                  )}
                                </div>
                              );
                            }
                            
                            // Handle Project Stage
                            if (inp.id === "projectStage") {
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} *</label>
                                  <select 
                                    className="input"
                                    value={intakeInput.projectStage || ""}
                                    onChange={e => setIntakeInput(p => ({...p, projectStage: e.target.value}))}
                                  >
                                    <option value="">Select stage...</option>
                                    {(countryConfig.projectStages || []).map(s => (
                                      <option key={s.code} value={s.code}>{s.code} - {s.name}</option>
                                    ))}
                                  </select>
                                  {intakeInput.businessArea === "6602" && intakeInput.projectStage && (
                                    <p className="text-xs text-blue-600 mt-1">
                                      OBO Threshold: ${((countryConfig.localThresholds?.obo?.[intakeInput.projectStage] || 0) / 1000000).toFixed(1)}M AUD
                                    </p>
                                  )}
                                </div>
                              );
                            }
                            
                            // Handle Business Area (with auto-recovery for OBO)
                            if (inp.id === "businessArea") {
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} *</label>
                                  <select 
                                    className="input"
                                    value={intakeInput.businessArea || ""}
                                    onChange={e => {
                                      const ba = e.target.value;
                                      const autoRecovery = countryConfig.sap?.businessAreas?.find(b => b.code === ba)?.autoRecovery;
                                      setIntakeInput(p => ({
                                        ...p, 
                                        businessArea: ba,
                                        recoveryIndicator: autoRecovery || p.recoveryIndicator
                                      }));
                                    }}
                                  >
                                    <option value="">Select...</option>
                                    {(countryConfig.sap?.businessAreas || []).map(o => (
                                      <option key={o.code} value={o.code}>{o.code} - {o.name}</option>
                                    ))}
                                  </select>
                                  {intakeInput.companyCode && (
                                    <p className="text-xs text-green-600 mt-1">
                                      âœ“ Auto-selected based on Company Code {intakeInput.companyCode}
                                    </p>
                                  )}
                                  {intakeInput.businessArea === "6602" && (
                                    <p className="text-xs text-blue-600 mt-1">OBO: Recovery auto-selects NB</p>
                                  )}
                                </div>
                              );
                            }
                            
                            // Handle Recovery Indicator (auto-selected for OBO)
                            if (inp.id === "recoveryIndicator") {
                              const isOBO = intakeInput.businessArea === "6602";
                              if (isOBO) {
                                return (
                                  <div key={inp.id}>
                                    <label className="block text-sm font-medium mb-1">{inp.label}</label>
                                    <div className="input bg-slate-100">NB - Non-Billable (auto)</div>
                                  </div>
                                );
                              }
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} *</label>
                                  <select 
                                    className="input"
                                    value={intakeInput.recoveryIndicator || ""}
                                    onChange={e => setIntakeInput(p => ({...p, recoveryIndicator: e.target.value}))}
                                  >
                                    <option value="">Select...</option>
                                    {(countryConfig.project?.recoveryIndicators || []).map(o => (
                                      <option key={o.code} value={o.code}>{o.code} - {o.name}</option>
                                    ))}
                                  </select>
                                </div>
                              );
                            }
                            
                            // Handle JV Code (depends on Company Code)
                            if (inp.id === "jvCode") {
                              const companyCode = intakeInput.companyCode;
                              const jvCodes = countryConfig.jvCodes?.[companyCode] || [];
                              const selectedJV = jvCodes.find(jv => jv.code === intakeInput.jvCode);
                              
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} *</label>
                                  <select 
                                    className="input"
                                    value={intakeInput.jvCode || ""}
                                    onChange={e => setIntakeInput(p => ({...p, jvCode: e.target.value}))}
                                    disabled={!companyCode}
                                  >
                                    <option value="">{companyCode ? "Select JV Code..." : "Select Company Code first"}</option>
                                    {jvCodes.map(jv => (
                                      <option key={jv.code} value={jv.code}>{jv.code} - {jv.name} (EM {jv.emShare}%)</option>
                                    ))}
                                  </select>
                                  {selectedJV && (
                                    <p className="text-xs text-blue-600 mt-1">EM Share: {selectedJV.emShare}% | JV Share: {100 - selectedJV.emShare}%</p>
                                  )}
                                </div>
                              );
                            }
                            
                            // Handle Gross Budget with Net calculation
                            if (inp.id === "grossBudget") {
                              const grossBudget = parseFloat(intakeInput.grossBudget) || 0;
                              const selectedJV = countryConfig.jvCodes?.[intakeInput.companyCode]?.find(jv => jv.code === intakeInput.jvCode);
                              const emShare = selectedJV?.emShare || 100;
                              const netBudget = Math.round(grossBudget * (emShare / 100));
                              const jvShare = grossBudget - netBudget;
                              
                              return (
                                <div key={inp.id} className="md:col-span-2">
                                  <div className="p-3 bg-green-50 rounded-lg mb-3">
                                    <p className="text-sm font-medium text-green-800 mb-2">ðŸ’° Budget Section</p>
                                  </div>
                                  <label className="block text-sm font-medium mb-1">{inp.label} *</label>
                                  <input 
                                    className="input" 
                                    type="text"
                                    value={intakeInput.grossBudget || ""} 
                                    onChange={e => setIntakeInput(p => ({...p, grossBudget: e.target.value.replace(/[^0-9]/g, "")}))}
                                    placeholder="Enter gross budget amount"
                                  />
                                  {grossBudget > 0 && intakeInput.jvCode && (
                                    <div className="mt-3 p-3 bg-blue-50 rounded-lg">
                                      <p className="text-sm font-medium text-blue-800 mb-2">Budget Calculation (JV: {selectedJV?.name})</p>
                                      <div className="grid grid-cols-3 gap-2 text-sm">
                                        <div>
                                          <p className="text-slate-500">Gross (100%)</p>
                                          <p className="font-semibold">{grossBudget.toLocaleString()} AUD</p>
                                        </div>
                                        <div>
                                          <p className="text-slate-500">Net (EM {emShare}%)</p>
                                          <p className="font-semibold text-green-700">{netBudget.toLocaleString()} AUD</p>
                                        </div>
                                        <div>
                                          <p className="text-slate-500">JV Share ({100-emShare}%)</p>
                                          <p className="font-semibold text-blue-700">{jvShare.toLocaleString()} AUD</p>
                                        </div>
                                      </div>
                                      {grossBudget > 5000000 && (
                                        <p className="text-amber-700 text-xs mt-2">âš ï¸ Tax Review required (&gt;5M AUD)</p>
                                      )}
                                      {grossBudget > 3000000 && grossBudget <= 5000000 && (
                                        <p className="text-amber-700 text-xs mt-2">âš ï¸ JV Letter required (&gt;3M AUD)</p>
                                      )}
                                    </div>
                                  )}
                                  {!intakeInput.jvCode && grossBudget > 0 && (
                                    <p className="text-xs text-amber-600 mt-1">Select JV Code to calculate Net budget</p>
                                  )}
                                </div>
                              );
                            }
                            
                            // Handle Company Code (auto-selects Business Area, clears JV)
                            if (inp.id === "companyCode") {
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label} *</label>
                                  <select 
                                    className="input"
                                    value={intakeInput.companyCode || ""}
                                    onChange={e => {
                                      const cc = e.target.value;
                                      const selectedCompany = countryConfig.sap?.companyCodes?.find(c => c.code === cc);
                                      const defaultBA = selectedCompany?.defaultBusinessArea || "";
                                      const baInfo = countryConfig.sap?.businessAreas?.find(b => b.code === defaultBA);
                                      const autoRecovery = baInfo?.autoRecovery || "";
                                      setIntakeInput(p => ({
                                        ...p, 
                                        companyCode: cc, 
                                        jvCode: "",
                                        businessArea: defaultBA,
                                        recoveryIndicator: autoRecovery || p.recoveryIndicator
                                      }));
                                    }}
                                  >
                                    <option value="">Select...</option>
                                    {(countryConfig.sap?.companyCodes || []).map(o => (
                                      <option key={o.code} value={o.code}>{o.code} - {o.name}</option>
                                    ))}
                                  </select>
                                  {intakeInput.companyCode && (
                                    <p className="text-xs text-slate-500 mt-1">
                                      Available JV codes: {(countryConfig.jvCodes?.[intakeInput.companyCode] || []).map(jv => jv.code).join(", ")}
                                    </p>
                                  )}
                                </div>
                              );
                            }
                            
                            // Handle other select fields
                            if (inp.type === "select" && inp.source) {
                              let options = [];
                              if (inp.source === "businessAreas") options = countryConfig.sap?.businessAreas || [];
                              if (inp.source === "fundingStages") options = countryConfig.funding?.stages || [];
                              if (inp.source === "recoveryIndicators") options = countryConfig.project?.recoveryIndicators || [];
                              
                              return (
                                <div key={inp.id}>
                                  <label className="block text-sm font-medium mb-1">{inp.label}{inp.required ? " *" : ""}</label>
                                  <select 
                                    className="input"
                                    value={intakeInput[inp.id] || ""}
                                    onChange={e => setIntakeInput(p => ({...p, [inp.id]: e.target.value}))}
                                  >
                                    <option value="">Select...</option>
                                    {options.map(o => (
                                      <option key={o.code} value={o.code}>{o.code} - {o.name}</option>
                                    ))}
                                  </select>
                                </div>
                              );
                            }
                            
                            // Default text input
                            return (
                              <div key={inp.id}>
                                <label className="block text-sm font-medium mb-1">{inp.label}{inp.required ? " *" : ""}</label>
                                <input 
                                  className="input" 
                                  type={inp.type === "number" ? "text" : inp.type}
                                  value={intakeInput[inp.id] || ""} 
                                  onChange={e => setIntakeInput(p => ({...p, [inp.id]: e.target.value}))}
                                  placeholder={inp.placeholder}
                                />
                              </div>
                            );
                          })}
                        </div>
                        
                        {/* Decommissioning warning */}
                        {intakeInput.projectCategory === "Decommissioning" && (
                          <div className="mt-4 p-3 bg-amber-50 border-l-4 border-amber-400 rounded-r-lg">
                            <p className="font-medium text-amber-800">âš ï¸ Decommissioning Project Requirements</p>
                            <p className="text-sm text-amber-700 mt-1">You must add a settlement rule to reserve account <strong>490000030</strong> BEFORE changing the project status.</p>
                          </div>
                        )}
                        
                        <button onClick={() => createTask(selectedWorkflow.id)} className="btn btn-primary mt-4">
                          Create Task
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* TASKS MODULE */}
            {phase === "working" && module === "tasks" && (
              <div className="max-w-3xl fade-in">
                {currentTask ? (
                  <>
                    <div className="card mb-6 bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                      <h2 className="text-xl font-bold">{currentTask.title}</h2>
                      {currentTask.output?.projectNumber && (
                        <p className="mt-2">
                          Project: <span className="bg-white/20 px-2 py-0.5 rounded font-mono">{currentTask.output.projectNumber}</span>
                        </p>
                      )}
                    </div>

                    {currentTask.output && (
                      <div className="card mb-6">
                        <h3 className="font-semibold mb-3">Your Values</h3>
                        <div className="flex flex-wrap gap-3">
                          <div><p className="text-xs text-slate-400">Project</p><span className="value-pill">{currentTask.output.projectNumber}</span></div>
                          <div><p className="text-xs text-slate-400">WBS L1</p><span className="value-pill">{currentTask.output.wbsLevel1}</span></div>
                          <div><p className="text-xs text-slate-400">WBS L2</p><span className="value-pill">{currentTask.output.wbsLevel2}</span></div>
                          {currentTask.output.jvCode && (
                            <div><p className="text-xs text-slate-400">JV Code</p><span className="value-pill">{currentTask.output.jvCode}</span></div>
                          )}
                          {currentTask.output.isDecommissioning && (
                            <div><p className="text-xs text-slate-400">Settlement Acct</p><span className="value-pill bg-amber-100 text-amber-800">{currentTask.output.settlementAccount}</span></div>
                          )}
                        </div>
                        
                        {/* Budget Breakdown */}
                        {currentTask.output.grossBudget > 0 && (
                          <div className="mt-4 p-3 bg-green-50 rounded-lg">
                            <p className="text-sm font-medium text-green-800 mb-2">ðŸ’° Budget ({currentTask.output.jvName} - EM {currentTask.output.emShare}%)</p>
                            <div className="grid grid-cols-3 gap-3">
                              <div>
                                <p className="text-xs text-slate-500">Gross (100%)</p>
                                <p className="font-semibold">{currentTask.output.grossBudget?.toLocaleString()} AUD</p>
                              </div>
                              <div>
                                <p className="text-xs text-slate-500">Net (EM {currentTask.output.emShare}%)</p>
                                <p className="font-semibold text-green-700">{currentTask.output.netBudget?.toLocaleString()} AUD</p>
                              </div>
                              <div>
                                <p className="text-xs text-slate-500">JV Share ({100 - currentTask.output.emShare}%)</p>
                                <p className="font-semibold text-blue-700">{currentTask.output.jvShare?.toLocaleString()} AUD</p>
                              </div>
                            </div>
                          </div>
                        )}
                        
                        {currentTask.output.isDecommissioning && (
                          <div className="mt-3 p-2 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
                            âš ï¸ <strong>Decommissioning Project</strong> - Settlement rule required before status change
                          </div>
                        )}
                      </div>
                    )}

                    {currentTask.rules?.blocking?.length > 0 && (
                      <div className="card mb-6 border-l-4 border-red-500 bg-red-50">
                        <p className="font-medium text-red-800">âš ï¸ Required Actions</p>
                        {currentTask.rules.blocking.map((r, i) => <p key={i} className="text-sm text-red-700">â€¢ {r.name}</p>)}
                      </div>
                    )}

                    <div className="card">
                      <h3 className="font-semibold mb-4">Steps</h3>
                      <div className="space-y-3">
                        {currentTask.steps?.map((s, idx) => (
                          <div key={idx} className={`p-4 rounded-xl border-2 ${
                            completedSteps[idx] ? 'bg-green-50 border-green-200' : 
                            s.critical ? 'bg-amber-50 border-amber-400' : 
                            'border-slate-200'
                          }`}>
                            <div className="flex gap-4">
                              <div className={`step-dot ${
                                completedSteps[idx] ? 'step-done' : 
                                s.critical ? 'bg-amber-500 text-white' : 
                                'step-pending'
                              }`}>
                                {completedSteps[idx] ? <Icon name="Check" size={16} /> : s.critical ? "!" : idx + 1}
                              </div>
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                  <span className={`badge ${s.critical ? 'bg-amber-100 text-amber-800' : 'badge-blue'}`}>{s.phase}</span>
                                  <h4 className="font-medium">{s.title}</h4>
                                  {s.critical && <span className="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">CRITICAL</span>}
                                </div>
                                {s.content?.action && (
                                  <div className={`rounded-lg p-2 text-sm mb-2 ${
                                    s.critical ? 'bg-amber-100 border border-amber-300 text-amber-900' : 
                                    'bg-blue-50 border border-blue-200 text-blue-900'
                                  }`}>
                                    â†’ {s.content.action}
                                  </div>
                                )}
                                {s.content?.note && (
                                  <p className="text-sm text-slate-600 mb-2">â„¹ï¸ {s.content.note}</p>
                                )}
                                {s.content?.warning && (
                                  <p className="text-sm text-amber-700 mb-2">âš ï¸ {s.content.warning}</p>
                                )}
                                {s.content?.fields && (
                                  <div className="bg-slate-50 rounded-lg p-2 text-sm mb-2">
                                    {s.content.fields.map((f, i) => (
                                      <div key={i}><span className="text-slate-500">{f.n}:</span> <span className="value-pill">{f.v}</span></div>
                                    ))}
                                  </div>
                                )}
                                {s.content?.items && (
                                  <div className="space-y-1">
                                    {s.content.items.map((item, i) => (
                                      <label key={i} className="flex items-center gap-2 text-sm cursor-pointer">
                                        <input 
                                          type="checkbox" 
                                          checked={completedSteps[`${idx}_${i}`] || false}
                                          onChange={() => setCompletedSteps(p => ({...p, [`${idx}_${i}`]: !p[`${idx}_${i}`]}))}
                                        />
                                        {item}
                                      </label>
                                    ))}
                                  </div>
                                )}
                              </div>
                              <button 
                                onClick={() => setCompletedSteps(p => ({...p, [idx]: !p[idx]}))}
                                className={`text-xs px-3 py-1 rounded-lg h-fit ${completedSteps[idx] ? 'bg-green-500 text-white' : s.critical ? 'bg-amber-500 text-white' : 'bg-slate-100'}`}
                              >
                                {completedSteps[idx] ? 'âœ“ Done' : 'Mark'}
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </>
                ) : (
                  <div className="text-center py-12">
                    <Icon name="ClipboardList" size={48} className="mx-auto text-slate-300 mb-4" />
                    <p className="text-slate-500">No active task</p>
                    <button onClick={() => setModule("intake")} className="btn btn-primary mt-4">Start New Task</button>
                  </div>
                )}
              </div>
            )}

            {/* DOCUMENT TRACKING MODULE */}
            {phase === "working" && module === "documents" && (
              <div className="max-w-5xl fade-in">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h2 className="text-xl font-bold">ðŸ“„ Document Tracking</h2>
                    <p className="text-slate-500">Track approval status of forms and documents</p>
                  </div>
                  <div className="flex items-center gap-2">
                    <button 
                      onClick={() => setShowCreateFormModal(true)}
                      className="btn btn-primary btn-sm"
                    >
                      <Icon name="Plus" size={14} className="mr-1" /> Add Document
                    </button>
                  </div>
                </div>
                
                {/* Status Filter */}
                <div className="flex gap-2 mb-4 flex-wrap">
                  <button 
                    onClick={() => setDocFilter("all")}
                    className={`badge ${docFilter === "all" ? "badge-blue" : "badge-slate"} cursor-pointer`}
                  >
                    All ({formSignatures.length})
                  </button>
                  <button 
                    onClick={() => setDocFilter("pending")}
                    className={`badge ${docFilter === "pending" ? "badge-amber" : "badge-slate"} cursor-pointer`}
                  >
                    â³ Pending ({formSignatures.filter(f => f.status === "pending" || f.status === "pending_review").length})
                  </button>
                  <button 
                    onClick={() => setDocFilter("in_review")}
                    className={`badge ${docFilter === "in_review" ? "badge-blue" : "badge-slate"} cursor-pointer`}
                  >
                    ðŸ” In Review ({formSignatures.filter(f => f.status === "in_progress" || f.status === "in_review").length})
                  </button>
                  <button 
                    onClick={() => setDocFilter("approved")}
                    className={`badge ${docFilter === "approved" ? "badge-green" : "badge-slate"} cursor-pointer`}
                  >
                    âœ… Approved ({formSignatures.filter(f => f.status === "completed" || f.status === "approved").length})
                  </button>
                  <button 
                    onClick={() => setDocFilter("rejected")}
                    className={`badge ${docFilter === "rejected" ? "badge-red" : "badge-slate"} cursor-pointer`}
                  >
                    âŒ Rejected ({formSignatures.filter(f => f.status === "rejected").length})
                  </button>
                </div>

                {/* Summary Cards */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                  <div className="card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4">
                    <p className="text-blue-100 text-xs">Total Documents</p>
                    <p className="text-2xl font-bold">{formSignatures.length}</p>
                  </div>
                  <div className="card bg-gradient-to-br from-amber-500 to-amber-600 text-white p-4">
                    <p className="text-amber-100 text-xs">Pending</p>
                    <p className="text-2xl font-bold">{formSignatures.filter(f => f.status === "pending" || f.status === "pending_review").length}</p>
                  </div>
                  <div className="card bg-gradient-to-br from-green-500 to-green-600 text-white p-4">
                    <p className="text-green-100 text-xs">Approved</p>
                    <p className="text-2xl font-bold">{formSignatures.filter(f => f.status === "completed" || f.status === "approved").length}</p>
                  </div>
                  <div className="card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4">
                    <p className="text-purple-100 text-xs">Approval Rate</p>
                    <p className="text-2xl font-bold">
                      {formSignatures.length > 0
                        ? Math.round(formSignatures.filter(f => f.status === "completed" || f.status === "approved").length / formSignatures.length * 100)
                        : 0}%
                    </p>
                  </div>
                </div>
                
                {formSignatures.length === 0 ? (
                  <div className="card text-center py-12">
                    <div className="text-5xl mb-4">ðŸ“</div>
                    <h3 className="text-lg font-semibold mb-2">No Documents Yet</h3>
                    <p className="text-slate-500 mb-4">Add documents to track their approval status</p>
                    <button 
                      onClick={() => setShowCreateFormModal(true)}
                      className="btn btn-primary"
                    >
                      <Icon name="Plus" size={16} className="mr-2" /> Add First Document
                    </button>
                  </div>
                ) : (
                  /* Document List */
                  <div className="space-y-3">
                    {formSignatures
                      .filter(doc => {
                        if (docFilter === "all") return true;
                        if (docFilter === "pending") return doc.status === "pending" || doc.status === "pending_review";
                        if (docFilter === "in_review") return doc.status === "in_progress" || doc.status === "in_review";
                        if (docFilter === "approved") return doc.status === "completed" || doc.status === "approved";
                        if (docFilter === "rejected") return doc.status === "rejected";
                        return true;
                      })
                      .map(doc => (
                      <div 
                        key={doc.id || doc.formId} 
                        className="card p-4 hover:shadow-md transition-shadow cursor-pointer"
                        onClick={() => setSelectedForm(doc)}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                              doc.formType === "AFE" ? "bg-blue-100 text-blue-600" :
                              doc.formType === "FCCR" ? "bg-purple-100 text-purple-600" :
                              doc.formType === "PO" ? "bg-green-100 text-green-600" :
                              "bg-slate-100 text-slate-600"
                            }`}>
                              <Icon name={
                                doc.formType === "AFE" ? "FileText" :
                                doc.formType === "FCCR" ? "Shield" :
                                doc.formType === "PO" ? "ShoppingCart" :
                                "File"
                              } size={20} />
                            </div>
                            <div>
                              <p className="font-semibold">{doc.formId}</p>
                              <p className="text-sm text-slate-500">{doc.projectName || doc.description}</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-4">
                            <div className="text-right">
                              <p className="text-sm font-medium">{doc.totalBudget ? `$${Number(doc.totalBudget).toLocaleString()}` : "-"}</p>
                              <p className="text-xs text-slate-400">{doc.createdAt || doc.created}</p>
                            </div>
                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                              doc.status === "completed" || doc.status === "approved" ? "bg-green-100 text-green-700" :
                              doc.status === "in_progress" || doc.status === "in_review" ? "bg-blue-100 text-blue-700" :
                              doc.status === "rejected" ? "bg-red-100 text-red-700" :
                              "bg-amber-100 text-amber-700"
                            }`}>
                              {doc.status === "completed" || doc.status === "approved" ? "âœ… Approved" :
                               doc.status === "in_progress" || doc.status === "in_review" ? "ðŸ” In Review" :
                               doc.status === "rejected" ? "âŒ Rejected" :
                               "â³ Pending"}
                            </span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                
                {/* Document Detail Modal */}
                {selectedForm && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl w-full max-w-lg max-h-[80vh] overflow-y-auto">
                      <div className="p-6 border-b sticky top-0 bg-white">
                        <div className="flex items-center justify-between">
                          <h3 className="text-xl font-bold">{selectedForm.formId}</h3>
                          <button onClick={() => setSelectedForm(null)} className="text-slate-400 hover:text-slate-600">
                            <Icon name="X" size={24} />
                          </button>
                        </div>
                      </div>
                      
                      <div className="p-6 space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <p className="text-xs text-slate-500">Document Type</p>
                            <p className="font-medium">{selectedForm.formType}</p>
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Status</p>
                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                              selectedForm.status === "completed" || selectedForm.status === "approved" ? "bg-green-100 text-green-700" :
                              selectedForm.status === "in_progress" || selectedForm.status === "in_review" ? "bg-blue-100 text-blue-700" :
                              selectedForm.status === "rejected" ? "bg-red-100 text-red-700" :
                              "bg-amber-100 text-amber-700"
                            }`}>
                              {selectedForm.status === "completed" || selectedForm.status === "approved" ? "Approved" :
                               selectedForm.status === "in_progress" || selectedForm.status === "in_review" ? "In Review" :
                               selectedForm.status === "rejected" ? "Rejected" :
                               "Pending"}
                            </span>
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Project</p>
                            <p className="font-medium">{selectedForm.projectName || "-"}</p>
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Budget</p>
                            <p className="font-medium">{selectedForm.totalBudget ? `$${Number(selectedForm.totalBudget).toLocaleString()}` : "-"}</p>
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Created</p>
                            <p className="font-medium">{selectedForm.createdAt || selectedForm.created || "-"}</p>
                          </div>
                          <div>
                            <p className="text-xs text-slate-500">Country</p>
                            <p className="font-medium">{selectedForm.country || "Australia"}</p>
                          </div>
                        </div>
                        
                        {/* Notes */}
                        <div>
                          <p className="text-xs text-slate-500 mb-1">Notes</p>
                          <textarea 
                            className="input w-full text-sm" 
                            rows={2}
                            placeholder="Add notes..."
                            defaultValue={selectedForm.notes || ""}
                          />
                        </div>
                        
                        {/* Update Status */}
                        <div>
                          <p className="text-xs text-slate-500 mb-2">Update Status</p>
                          <div className="flex gap-2 flex-wrap">
                            {["pending", "in_review", "approved", "rejected"].map(status => (
                              <button
                                key={status}
                                onClick={() => {
                                  const updated = formSignatures.map(f => 
                                    (f.id || f.formId) === (selectedForm.id || selectedForm.formId) 
                                      ? {...f, status} 
                                      : f
                                  );
                                  setFormSignatures(updated);
                                  setSelectedForm({...selectedForm, status});
                                }}
                                className={`px-3 py-1 rounded-lg text-sm border transition-all ${
                                  selectedForm.status === status 
                                    ? "border-blue-500 bg-blue-50 text-blue-700" 
                                    : "border-slate-200 hover:border-slate-300"
                                }`}
                              >
                                {status === "pending" && "â³ Pending"}
                                {status === "in_review" && "ðŸ” In Review"}
                                {status === "approved" && "âœ… Approved"}
                                {status === "rejected" && "âŒ Rejected"}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>
                      
                      <div className="p-6 border-t bg-slate-50 flex justify-end gap-2">
                        <button 
                          onClick={() => setSelectedForm(null)}
                          className="btn btn-secondary"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Add Document Modal */}
                {showCreateFormModal && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl p-6 w-full max-w-md">
                      <h3 className="text-xl font-bold mb-4">ðŸ“„ Add Document</h3>
                      <p className="text-slate-600 mb-4">
                        Track a document's approval status
                      </p>
                      
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Document Type *</label>
                          <select 
                            className="input w-full"
                            value={newFormData.formType}
                            onChange={e => setNewFormData({...newFormData, formType: e.target.value})}
                          >
                            <option value="AFE">AFE - Authority for Expenditure</option>
                            <option value="FCCR">FCCR - Funding Capital Cost Request</option>
                            <option value="PO">PO - Purchase Order</option>
                            <option value="WO">WO - Work Order</option>
                            <option value="CR">CR - Change Request</option>
                            <option value="Other">Other</option>
                          </select>
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium mb-1">Document ID / Reference *</label>
                          <input 
                            className="input w-full"
                            placeholder="e.g., AFE-2026-001"
                            value={newFormData.formId || ""}
                            onChange={e => setNewFormData({...newFormData, formId: e.target.value})}
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium mb-1">Project / Description</label>
                          <input 
                            className="input w-full"
                            placeholder="Enter project name or description"
                            value={newFormData.projectName}
                            onChange={e => setNewFormData({...newFormData, projectName: e.target.value})}
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium mb-1">Budget Amount (USD)</label>
                          <input 
                            type="number"
                            className="input w-full"
                            placeholder="Optional"
                            value={newFormData.totalBudget}
                            onChange={e => setNewFormData({...newFormData, totalBudget: e.target.value})}
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium mb-1">Current Status</label>
                          <select 
                            className="input w-full"
                            value={newFormData.status || "pending"}
                            onChange={e => setNewFormData({...newFormData, status: e.target.value})}
                          >
                            <option value="pending">â³ Pending</option>
                            <option value="in_review">ðŸ” In Review</option>
                            <option value="approved">âœ… Approved</option>
                            <option value="rejected">âŒ Rejected</option>
                          </select>
                        </div>
                      </div>
                      
                      <div className="flex gap-3 mt-6">
                        <button 
                          onClick={() => {
                            setShowCreateFormModal(false);
                            setNewFormData({formType: "AFE", projectName: "", totalBudget: "", country: "Australia"});
                          }}
                          className="btn btn-secondary flex-1"
                        >
                          Cancel
                        </button>
                        <button 
                          onClick={() => {
                            const newDoc = {
                              id: "DOC" + String(formSignatures.length + 1).padStart(3, "0"),
                              formId: newFormData.formId || newFormData.formType + "-" + new Date().getFullYear() + "-" + String(formSignatures.length + 1).padStart(3, "0"),
                              formType: newFormData.formType,
                              projectName: newFormData.projectName,
                              totalBudget: newFormData.totalBudget,
                              status: newFormData.status || "pending",
                              country: newFormData.country || "Australia",
                              createdAt: new Date().toISOString().split("T")[0],
                              createdBy: currentUser?.displayName || "User"
                            };
                            setFormSignatures([...formSignatures, newDoc]);
                            setShowCreateFormModal(false);
                            setNewFormData({formType: "AFE", projectName: "", totalBudget: "", country: "Australia"});
                          }}
                          className="btn btn-primary flex-1"
                          disabled={!newFormData.formId && !newFormData.projectName}
                        >
                          <Icon name="Plus" size={16} className="mr-1" /> Add Document
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* SUPPORT KNOWLEDGE BASE MODULE */}
            {/* SUPPORT KNOWLEDGE BASE MODULE */}
            {phase === "working" && module === "support" && (
              <div className="max-w-5xl fade-in">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h2 className="text-xl font-bold">Support Knowledge Base</h2>
                    <p className="text-slate-500 text-sm">Common issues, troubleshooting guides, and ad-hoc support</p>
                  </div>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => setKbEditMode(!kbEditMode)}
                      className={`btn ${kbEditMode ? 'bg-amber-500 text-white' : 'btn-secondary'}`}
                    >
                      <Icon name={kbEditMode ? "Eye" : "Edit"} size={16} className="mr-1" />
                      {kbEditMode ? "View Mode" : "Edit Mode"}
                    </button>
                    {kbEditMode && (
                      <button 
                        onClick={() => {
                          setKbEditArticle({
                            id: "",
                            category: "PO",
                            title: "",
                            problem: "",
                            tCodes: [],
                            steps: [],
                            notes: [],
                            warnings: [],
                            relatedIssues: []
                          });
                          setKbShowAddForm(true);
                        }}
                        className="btn btn-primary"
                      >
                        <Icon name="Plus" size={16} className="mr-1" />
                        Add Article
                      </button>
                    )}
                  </div>
                </div>

                {/* Add/Edit Article Form */}
                {kbShowAddForm && kbEditArticle && (
                  <div className="card mb-6 border-2 border-blue-300 fade-in">
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="font-bold text-lg">{kbEditArticle.id ? "Edit Article" : "Add New Article"}</h3>
                      <button onClick={() => {setKbShowAddForm(false); setKbEditArticle(null);}} className="text-slate-400 hover:text-slate-600">
                        <Icon name="X" size={20} />
                      </button>
                    </div>
                    
                    <div className="grid md:grid-cols-2 gap-4 mb-4">
                      <div>
                        <label className="label">Article ID</label>
                        <input 
                          className="input" 
                          placeholder="e.g., PO_CLOSE"
                          value={kbEditArticle.id}
                          onChange={e => setKbEditArticle({...kbEditArticle, id: e.target.value})}
                        />
                      </div>
                      <div>
                        <label className="label">Category</label>
                        <select 
                          className="input"
                          value={kbEditArticle.category}
                          onChange={e => setKbEditArticle({...kbEditArticle, category: e.target.value})}
                        >
                          {countryConfig.knowledgeBase?.categories?.map(cat => (
                            <option key={cat.id} value={cat.id}>{cat.name}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                    
                    <div className="mb-4">
                      <label className="label">Title</label>
                      <input 
                        className="input" 
                        placeholder="e.g., How to Close a Purchase Order"
                        value={kbEditArticle.title}
                        onChange={e => setKbEditArticle({...kbEditArticle, title: e.target.value})}
                      />
                    </div>
                    
                    <div className="mb-4">
                      <label className="label">Problem Description</label>
                      <textarea 
                        className="input" 
                        rows={2}
                        placeholder="Describe the problem this article solves..."
                        value={kbEditArticle.problem}
                        onChange={e => setKbEditArticle({...kbEditArticle, problem: e.target.value})}
                      />
                    </div>
                    
                    <div className="mb-4">
                      <label className="label">T-Codes (comma separated)</label>
                      <input 
                        className="input font-mono" 
                        placeholder="ME22N, ME23N, MIGO"
                        value={(kbEditArticle.tCodes || []).join(", ")}
                        onChange={e => setKbEditArticle({...kbEditArticle, tCodes: e.target.value.split(",").map(s => s.trim()).filter(Boolean)})}
                      />
                    </div>
                    
                    <div className="mb-4">
                      <label className="label">Solution Steps (one per line)</label>
                      <textarea 
                        className="input" 
                        rows={5}
                        placeholder="1. Open ME22N&#10;2. Enter PO number&#10;3. Check 'Delivery Completed'&#10;4. Save"
                        value={(kbEditArticle.steps || []).join("\n")}
                        onChange={e => setKbEditArticle({...kbEditArticle, steps: e.target.value.split("\n").filter(Boolean)})}
                      />
                    </div>
                    
                    <div className="grid md:grid-cols-2 gap-4 mb-4">
                      <div>
                        <label className="label">Notes (one per line)</label>
                        <textarea 
                          className="input" 
                          rows={3}
                          placeholder="Important notes..."
                          value={(kbEditArticle.notes || []).join("\n")}
                          onChange={e => setKbEditArticle({...kbEditArticle, notes: e.target.value.split("\n").filter(Boolean)})}
                        />
                      </div>
                      <div>
                        <label className="label">Warnings (one per line)</label>
                        <textarea 
                          className="input" 
                          rows={3}
                          placeholder="Warnings..."
                          value={(kbEditArticle.warnings || []).join("\n")}
                          onChange={e => setKbEditArticle({...kbEditArticle, warnings: e.target.value.split("\n").filter(Boolean)})}
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-2 justify-end">
                      <button 
                        onClick={() => {setKbShowAddForm(false); setKbEditArticle(null);}}
                        className="btn btn-secondary"
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={async () => {
                          if (!kbEditArticle.title || !kbEditArticle.problem) {
                            alert("Title and Problem are required");
                            return;
                          }
                          setIsLoading(true);
                          const isNew = !countryConfig.knowledgeBase?.articles?.find(a => a.id === kbEditArticle.id);
                          const action = isNew ? "ADD_KB_ARTICLE" : "UPDATE_KB_ARTICLE";
                          const r = await callAPI({
                            action: action,
                            articleId: kbEditArticle.id,
                            article: kbEditArticle
                          });
                          if (r.success) {
                            // Update local state
                            const newArticles = isNew 
                              ? [...(countryConfig.knowledgeBase?.articles || []), {...kbEditArticle, id: r.articleId || kbEditArticle.id}]
                              : countryConfig.knowledgeBase.articles.map(a => a.id === kbEditArticle.id ? kbEditArticle : a);
                            setCountryConfig({
                              ...countryConfig,
                              knowledgeBase: {
                                ...countryConfig.knowledgeBase,
                                articles: newArticles
                              }
                            });
                            setKbShowAddForm(false);
                            setKbEditArticle(null);
                          } else {
                            alert("Error: " + (r.error || "Failed to save"));
                          }
                          setIsLoading(false);
                        }}
                        className="btn btn-primary"
                        disabled={isLoading}
                      >
                        {isLoading ? "Saving..." : "Save Article"}
                      </button>
                    </div>
                  </div>
                )}

                {/* Search and Filter */}
                <div className="card mb-6">
                  <div className="flex flex-wrap gap-4">
                    <div className="flex-1 min-w-64">
                      <div className="relative">
                        <Icon name="Search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                        <input 
                          className="input pl-10" 
                          placeholder="Search articles... (e.g., 'close PO', 'settlement error')"
                          value={kbSearch}
                          onChange={e => {setKbSearch(e.target.value); setKbSelectedArticle(null);}}
                        />
                      </div>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <button 
                        onClick={() => {setKbCategory("all"); setKbSelectedArticle(null);}}
                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${kbCategory === "all" ? 'bg-blue-500 text-white' : 'bg-slate-100 hover:bg-slate-200'}`}
                      >
                        All
                      </button>
                      {countryConfig.knowledgeBase?.categories?.map(cat => (
                        <button 
                          key={cat.id}
                          onClick={() => {setKbCategory(cat.id); setKbSelectedArticle(null);}}
                          className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all flex items-center gap-1 ${kbCategory === cat.id ? 'bg-blue-500 text-white' : 'bg-slate-100 hover:bg-slate-200'}`}
                        >
                          <Icon name={cat.icon} size={14} />
                          {cat.name}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Article Detail View */}
                {kbSelectedArticle && (
                  <div className="card mb-6 fade-in">
                    <div className="flex items-start justify-between mb-4">
                      <div>
                        <button 
                          onClick={() => setKbSelectedArticle(null)}
                          className="text-blue-500 text-sm mb-2 flex items-center gap-1 hover:underline"
                        >
                          <Icon name="ArrowLeft" size={14} /> Back to articles
                        </button>
                        <h3 className="text-lg font-bold">{kbSelectedArticle.title}</h3>
                        <span className="badge badge-blue mt-1">
                          {countryConfig.knowledgeBase?.categories?.find(c => c.id === kbSelectedArticle.category)?.name}
                        </span>
                      </div>
                      <div className="flex gap-2">
                        {kbSelectedArticle.tCodes?.map(tc => (
                          <span key={tc} className="px-2 py-1 bg-slate-800 text-white rounded text-xs font-mono">{tc}</span>
                        ))}
                      </div>
                    </div>
                    
                    {/* Problem */}
                    <div className="mb-4 p-3 bg-red-50 border-l-4 border-red-400 rounded-r-lg">
                      <p className="font-medium text-red-800">ðŸ”´ Problem</p>
                      <p className="text-red-700">{kbSelectedArticle.problem}</p>
                    </div>
                    
                    {/* Steps */}
                    <div className="mb-4">
                      <p className="font-medium text-green-800 mb-2">âœ… Solution Steps</p>
                      <div className="bg-green-50 rounded-lg p-4">
                        <ol className="space-y-2">
                          {kbSelectedArticle.steps?.map((step, i) => (
                            <li key={i} className={`${step.startsWith("  ") ? "ml-6 text-slate-600" : "font-medium"}`}>
                              {step.startsWith("  ") ? step : `${i + 1}. ${step}`}
                            </li>
                          ))}
                        </ol>
                      </div>
                    </div>
                    
                    {/* Notes */}
                    {kbSelectedArticle.notes?.length > 0 && (
                      <div className="mb-4">
                        <p className="font-medium text-blue-800 mb-2">ðŸ“ Notes</p>
                        <ul className="bg-blue-50 rounded-lg p-4 space-y-1">
                          {kbSelectedArticle.notes?.map((note, i) => (
                            <li key={i} className="text-blue-800">â€¢ {note}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {/* Warnings */}
                    {kbSelectedArticle.warnings?.length > 0 && (
                      <div className="mb-4">
                        <p className="font-medium text-amber-800 mb-2">âš ï¸ Warnings</p>
                        <ul className="bg-amber-50 rounded-lg p-4 space-y-1">
                          {kbSelectedArticle.warnings?.map((warn, i) => (
                            <li key={i} className="text-amber-800">â€¢ {warn}</li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {/* Related Issues */}
                    {kbSelectedArticle.relatedIssues?.length > 0 && (
                      <div>
                        <p className="font-medium text-slate-600 mb-2">ðŸ”— Related Articles</p>
                        <div className="flex gap-2 flex-wrap">
                          {kbSelectedArticle.relatedIssues.map(relId => {
                            const relArticle = countryConfig.knowledgeBase?.articles?.find(a => a.id === relId);
                            return relArticle ? (
                              <button 
                                key={relId}
                                onClick={() => setKbSelectedArticle(relArticle)}
                                className="px-3 py-1.5 bg-slate-100 rounded-lg text-sm hover:bg-slate-200 transition-all"
                              >
                                {relArticle.title}
                              </button>
                            ) : null;
                          })}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Articles List */}
                {!kbSelectedArticle && (
                  <div className="grid md:grid-cols-2 gap-4">
                    {countryConfig.knowledgeBase?.articles
                      ?.filter(article => {
                        const matchesCategory = kbCategory === "all" || article.category === kbCategory;
                        const matchesSearch = !kbSearch || 
                          article.title.toLowerCase().includes(kbSearch.toLowerCase()) ||
                          article.problem.toLowerCase().includes(kbSearch.toLowerCase()) ||
                          article.tCodes?.some(tc => tc.toLowerCase().includes(kbSearch.toLowerCase()));
                        return matchesCategory && matchesSearch;
                      })
                      .map(article => {
                        const category = countryConfig.knowledgeBase?.categories?.find(c => c.id === article.category);
                        return (
                          <div 
                            key={article.id}
                            onClick={() => !kbEditMode && setKbSelectedArticle(article)}
                            className={`card ${kbEditMode ? '' : 'cursor-pointer hover:shadow-lg hover:border-blue-200'} transition-all`}
                          >
                            <div className="flex items-start justify-between mb-2">
                              <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                article.category === "PO" ? "bg-green-100 text-green-700" :
                                article.category === "PROJECT" ? "bg-blue-100 text-blue-700" :
                                article.category === "COST" ? "bg-purple-100 text-purple-700" :
                                article.category === "SETTLEMENT" ? "bg-amber-100 text-amber-700" :
                                article.category === "ASSET" ? "bg-red-100 text-red-700" :
                                article.category === "BUDGET" ? "bg-cyan-100 text-cyan-700" :
                                "bg-slate-100 text-slate-700"
                              }`}>
                                <Icon name={category?.icon || "FileText"} size={12} className="inline mr-1" />
                                {category?.name}
                              </span>
                              <div className="flex gap-1">
                                {article.tCodes?.slice(0, 2).map(tc => (
                                  <span key={tc} className="px-1.5 py-0.5 bg-slate-800 text-white rounded text-xs font-mono">{tc}</span>
                                ))}
                                {article.tCodes?.length > 2 && (
                                  <span className="px-1.5 py-0.5 bg-slate-200 text-slate-600 rounded text-xs">+{article.tCodes.length - 2}</span>
                                )}
                              </div>
                            </div>
                            <h4 className="font-semibold mb-1">{article.title}</h4>
                            <p className="text-sm text-slate-500 line-clamp-2">{article.problem}</p>
                            
                            {/* Edit mode buttons */}
                            {kbEditMode && (
                              <div className="flex gap-2 mt-3 pt-3 border-t">
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setKbEditArticle({...article});
                                    setKbShowAddForm(true);
                                  }}
                                  className="flex-1 btn btn-secondary text-sm py-1"
                                >
                                  <Icon name="Edit" size={14} className="mr-1" /> Edit
                                </button>
                                <button
                                  onClick={async (e) => {
                                    e.stopPropagation();
                                    if (confirm(`Delete article "${article.title}"?`)) {
                                      setIsLoading(true);
                                      const r = await callAPI({action: "DELETE_KB_ARTICLE", articleId: article.id});
                                      if (r.success) {
                                        setCountryConfig({
                                          ...countryConfig,
                                          knowledgeBase: {
                                            ...countryConfig.knowledgeBase,
                                            articles: countryConfig.knowledgeBase.articles.filter(a => a.id !== article.id)
                                          }
                                        });
                                      } else {
                                        alert("Error: " + (r.error || "Failed to delete"));
                                      }
                                      setIsLoading(false);
                                    }
                                  }}
                                  className="btn bg-red-100 text-red-700 hover:bg-red-200 text-sm py-1"
                                >
                                  <Icon name="Trash2" size={14} />
                                </button>
                              </div>
                            )}
                          </div>
                        );
                      })}
                  </div>
                )}

                {/* Quick T-Code Reference */}
                <div className="card mt-6">
                  <h3 className="font-semibold mb-4">Quick T-Code Reference</h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    {[
                      {code: "CJ20N", desc: "Create/Change Project"},
                      {code: "CJ30", desc: "Budget vs Actual"},
                      {code: "CJI3", desc: "Cost Line Items"},
                      {code: "KO88", desc: "Settlement"},
                      {code: "KO02", desc: "Change Settlement Rule"},
                      {code: "ME23N", desc: "Display PO"},
                      {code: "ME22N", desc: "Change PO"},
                      {code: "MIGO", desc: "Goods Receipt"},
                      {code: "ML81N", desc: "Service Entry"},
                      {code: "MIRO", desc: "Invoice Entry"},
                      {code: "AW01N", desc: "Asset Explorer"},
                      {code: "KB61", desc: "Cost Transfer"}
                    ].map(tc => (
                      <div key={tc.code} className="p-2 bg-slate-50 rounded-lg text-center">
                        <p className="font-mono font-bold text-blue-600">{tc.code}</p>
                        <p className="text-xs text-slate-500">{tc.desc}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* COUNTRIES MODULE */}
            {phase === "working" && module === "countries" && (
              <div className="max-w-4xl fade-in">
                <div className="flex items-center justify-between mb-6">
                  <h2 className="text-xl font-bold">Knowledge Base</h2>
                  <div className="flex gap-1 bg-slate-100 p-1 rounded-lg">
                    <button className={`px-4 py-1.5 rounded-md text-sm font-medium ${countryTab === "view" ? 'bg-white shadow' : ''}`} onClick={() => setCountryTab("view")}>
                      {isEditing ? "Edit" : "View"}
                    </button>
                    <button className={`px-4 py-1.5 rounded-md text-sm font-medium ${countryTab === "add" ? 'bg-white shadow' : ''}`} onClick={() => setCountryTab("add")}>
                      + Add
                    </button>
                    <button className={`px-4 py-1.5 rounded-md text-sm font-medium ${countryTab === "compare" ? 'bg-white shadow' : ''}`} onClick={() => setCountryTab("compare")}>
                      Compare
                    </button>
                  </div>
                </div>

                {/* VIEW/EDIT TAB */}
                {countryTab === "view" && config && (
                  <div className="card">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-6 pb-4 border-b">
                      <div className="flex items-center gap-4">
                        {isEditing ? (
                          <input className="text-4xl w-16 text-center border rounded p-1" value={config.flag || ""} onChange={e => updateField("flag", e.target.value)} />
                        ) : (
                          <span className="text-4xl">{config.flag}</span>
                        )}
                        <div>
                          {isEditing ? (
                            <input className="input text-xl font-bold" value={config.id || ""} onChange={e => updateField("id", e.target.value)} placeholder="Country Name" />
                          ) : (
                            <h3 className="text-xl font-bold">{config.id}</h3>
                          )}
                          <div className="flex gap-2 mt-1">
                            {isEditing ? (
                              <>
                                <input className="input w-20 text-sm" value={config.currency || ""} onChange={e => updateField("currency", e.target.value)} placeholder="USD" />
                                <select className="input w-28 text-sm" value={config.region || ""} onChange={e => updateField("region", e.target.value)}>
                                  <option value="APAC">APAC</option>
                                  <option value="EMEA">EMEA</option>
                                  <option value="AMER">Americas</option>
                                </select>
                              </>
                            ) : (
                              <p className="text-slate-500">{config.currency} â€¢ {config.region}</p>
                            )}
                          </div>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        {isEditing ? (
                          <>
                            <button onClick={cancelEdit} className="btn btn-secondary">Cancel</button>
                            <button onClick={saveConfig} className="btn btn-success" disabled={isLoading}>
                              {isLoading ? "Saving..." : "Save"}
                            </button>
                          </>
                        ) : (
                          <button onClick={startEdit} className="btn btn-primary">
                            <Icon name="Edit" size={16} className="mr-1" /> Edit
                          </button>
                        )}
                      </div>
                    </div>

                    {/* SAP Configuration */}
                    <div className="section">
                      <h4 className="font-semibold mb-3 flex items-center gap-2">
                        <Icon name="Server" size={18} className="text-blue-500" /> SAP Configuration
                      </h4>
                      {isEditing ? (
                        <div className="space-y-4">
                          <div className="grid md:grid-cols-2 gap-4">
                            <div>
                              <label className="text-sm text-slate-500">SAP System</label>
                              <input className="input" value={config.sap?.system || ""} onChange={e => updateField("sap.system", e.target.value)} placeholder="G3P" />
                            </div>
                            <div>
                              <label className="text-sm text-slate-500">Controlling Area</label>
                              <input className="input" value={config.sap?.controllingArea || ""} onChange={e => updateField("sap.controllingArea", e.target.value)} placeholder="AU00" />
                            </div>
                          </div>
                          <div>
                            <label className="text-sm text-slate-500 mb-2 block">Company Codes</label>
                            {config.sap?.companyCodes?.map((cc, i) => (
                              <div key={i} className="flex gap-2 mb-2">
                                <input className="input w-24" placeholder="Code" value={cc.code || ""} onChange={e => updateArrayItem("sap.companyCodes", i, "code", e.target.value)} />
                                <input className="input flex-1" placeholder="Name" value={cc.name || ""} onChange={e => updateArrayItem("sap.companyCodes", i, "name", e.target.value)} />
                                <button onClick={() => removeArrayItem("sap.companyCodes", i)} className="p-2 text-red-500 hover:bg-red-50 rounded">
                                  <Icon name="Trash2" size={16} />
                                </button>
                              </div>
                            ))}
                            <button onClick={() => addArrayItem("sap.companyCodes", {code: "", name: ""})} className="btn btn-secondary btn-sm">
                              <Icon name="Plus" size={14} className="mr-1" /> Add
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="grid md:grid-cols-4 gap-4">
                          <div><p className="text-xs text-slate-400">System</p><p className="font-semibold">{config.sap?.system}</p></div>
                          <div><p className="text-xs text-slate-400">Ctrl Area</p><p className="font-semibold">{config.sap?.controllingArea}</p></div>
                          <div><p className="text-xs text-slate-400">Company Codes</p><p className="font-semibold">{config.sap?.companyCodes?.map(c => c.code).join(", ")}</p></div>
                          <div><p className="text-xs text-slate-400">Business Areas</p><p className="font-semibold">{config.sap?.businessAreas?.map(b => b.code).join(", ")}</p></div>
                        </div>
                      )}
                    </div>

                    {/* Project Configuration */}
                    <div className="section">
                      <h4 className="font-semibold mb-3 flex items-center gap-2">
                        <Icon name="FolderOpen" size={18} className="text-green-500" /> Project Configuration
                      </h4>
                      {isEditing ? (
                        <div className="space-y-4">
                          <div className="grid md:grid-cols-2 gap-4">
                            <div>
                              <label className="text-sm text-slate-500">Project Format</label>
                              <input className="input" value={config.project?.format || ""} onChange={e => updateField("project.format", e.target.value)} placeholder="6XX/YYNNN" />
                            </div>
                            <div>
                              <label className="text-sm text-slate-500">Country Code</label>
                              <input className="input" value={config.project?.countryCode || ""} onChange={e => updateField("project.countryCode", e.target.value)} placeholder="6" />
                            </div>
                          </div>
                          <div>
                            <label className="text-sm text-slate-500 mb-2 block">Budget Classes</label>
                            {config.project?.budgetClasses?.map((bc, i) => (
                              <div key={i} className="flex gap-2 mb-2">
                                <input className="input w-20" placeholder="Code" value={bc.code || ""} onChange={e => updateArrayItem("project.budgetClasses", i, "code", e.target.value)} />
                                <input className="input flex-1" placeholder="Name" value={bc.name || ""} onChange={e => updateArrayItem("project.budgetClasses", i, "name", e.target.value)} />
                                <button onClick={() => removeArrayItem("project.budgetClasses", i)} className="p-2 text-red-500 hover:bg-red-50 rounded">
                                  <Icon name="Trash2" size={16} />
                                </button>
                              </div>
                            ))}
                            <button onClick={() => addArrayItem("project.budgetClasses", {code: "", name: ""})} className="btn btn-secondary btn-sm">
                              <Icon name="Plus" size={14} className="mr-1" /> Add
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="grid md:grid-cols-4 gap-4">
                          <div><p className="text-xs text-slate-400">Format</p><p className="font-semibold">{config.project?.format}</p></div>
                          <div><p className="text-xs text-slate-400">Country Code</p><p className="font-semibold">{config.project?.countryCode}</p></div>
                          <div><p className="text-xs text-slate-400">Budget Classes</p><p className="font-semibold">{config.project?.budgetClasses?.map(b => b.code).join(", ")}</p></div>
                          <div><p className="text-xs text-slate-400">Recovery</p><p className="font-semibold">{config.project?.recoveryIndicators?.map(r => r.code).join(", ")}</p></div>
                        </div>
                      )}
                    </div>

                    {/* T-Codes */}
                    <div className="section">
                      <h4 className="font-semibold mb-3 flex items-center gap-2">
                        <Icon name="Terminal" size={18} className="text-purple-500" /> T-Codes
                      </h4>
                      {isEditing ? (
                        <div className="grid md:grid-cols-3 gap-4">
                          <div>
                            <label className="text-sm text-slate-500">Create Project</label>
                            <input className="input font-mono" value={config.tCodes?.createProject?.code || ""} onChange={e => updateField("tCodes.createProject.code", e.target.value)} />
                          </div>
                          <div>
                            <label className="text-sm text-slate-500">Add Budget</label>
                            <input className="input font-mono" value={config.tCodes?.addBudget?.code || ""} onChange={e => updateField("tCodes.addBudget.code", e.target.value)} />
                          </div>
                          <div>
                            <label className="text-sm text-slate-500">Check Status</label>
                            <input className="input font-mono" value={config.tCodes?.checkStatus?.code || ""} onChange={e => updateField("tCodes.checkStatus.code", e.target.value)} />
                          </div>
                        </div>
                      ) : (
                        <div className="grid md:grid-cols-3 gap-3">
                          <div className="bg-white p-3 rounded-lg border"><p className="text-xs text-slate-400">Create Project</p><p className="font-mono font-semibold">{config.tCodes?.createProject?.code}</p></div>
                          <div className="bg-white p-3 rounded-lg border"><p className="text-xs text-slate-400">Add Budget</p><p className="font-mono font-semibold">{config.tCodes?.addBudget?.code}</p></div>
                          <div className="bg-white p-3 rounded-lg border"><p className="text-xs text-slate-400">Check Status</p><p className="font-mono font-semibold">{config.tCodes?.checkStatus?.code}</p></div>
                        </div>
                      )}
                    </div>

                    {/* Rules */}
                    <div className="section">
                      <h4 className="font-semibold mb-3 flex items-center gap-2">
                        <Icon name="ShieldAlert" size={18} className="text-red-500" /> Business Rules
                      </h4>
                      {isEditing ? (
                        <div>
                          {config.rules?.map((rule, i) => (
                            <div key={i} className="bg-white rounded-lg p-3 mb-2 border">
                              <div className="grid grid-cols-2 gap-2 mb-2">
                                <input className="input" placeholder="Rule Name" value={rule.name || ""} onChange={e => updateArrayItem("rules", i, "name", e.target.value)} />
                                <input className="input" type="number" placeholder="Threshold" value={rule.threshold || ""} onChange={e => updateArrayItem("rules", i, "threshold", parseInt(e.target.value) || 0)} />
                              </div>
                              <div className="flex gap-2">
                                <input className="input flex-1" placeholder="Action" value={rule.action || ""} onChange={e => updateArrayItem("rules", i, "action", e.target.value)} />
                                <label className="flex items-center gap-1 text-sm whitespace-nowrap">
                                  <input type="checkbox" checked={rule.blocking !== false} onChange={e => updateArrayItem("rules", i, "blocking", e.target.checked)} />
                                  Blocking
                                </label>
                                <button onClick={() => removeArrayItem("rules", i)} className="p-2 text-red-500 hover:bg-red-50 rounded">
                                  <Icon name="Trash2" size={16} />
                                </button>
                              </div>
                            </div>
                          ))}
                          <button onClick={() => addArrayItem("rules", {id: "RULE_" + Date.now(), name: "", threshold: 0, action: "", blocking: true})} className="btn btn-secondary btn-sm">
                            <Icon name="Plus" size={14} className="mr-1" /> Add Rule
                          </button>
                        </div>
                      ) : (
                        <div className="space-y-2">
                          {config.rules?.map(r => (
                            <div key={r.id} className="p-3 bg-amber-50 border-l-4 border-amber-400 rounded-r-lg">
                              <span className="font-medium">{r.name}</span>
                              {r.threshold > 0 && <span className="text-slate-500 ml-2">â€” &gt;{(r.threshold / 1000000).toFixed(1)}M {config.currency}</span>}
                              <p className="text-sm text-slate-600 mt-1">{r.action}</p>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* Tips */}
                    <div className="section">
                      <h4 className="font-semibold mb-3 flex items-center gap-2">
                        <Icon name="Lightbulb" size={18} className="text-yellow-500" /> Tips
                      </h4>
                      {isEditing ? (
                        <div>
                          {config.tips?.map((tip, i) => (
                            <div key={i} className="flex gap-2 mb-2">
                              <input className="input flex-1" value={tip} onChange={e => {
                                const tips = [...config.tips];
                                tips[i] = e.target.value;
                                updateField("tips", tips);
                              }} />
                              <button onClick={() => updateField("tips", config.tips.filter((_, idx) => idx !== i))} className="p-2 text-red-500 hover:bg-red-50 rounded">
                                <Icon name="Trash2" size={16} />
                              </button>
                            </div>
                          ))}
                          <button onClick={() => updateField("tips", [...(config.tips || []), ""])} className="btn btn-secondary btn-sm">
                            <Icon name="Plus" size={14} className="mr-1" /> Add Tip
                          </button>
                        </div>
                      ) : (
                        <div>
                          {config.tips?.map((t, i) => <p key={i} className="text-sm text-slate-600 mb-1">ðŸ’¡ {t}</p>)}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* ADD TAB */}
                {countryTab === "add" && !isEditing && (
                  <div className="card">
                    <h3 className="font-semibold mb-4">Add New Country</h3>
                    <div className="grid md:grid-cols-3 gap-4">
                      <button onClick={copyCurrentCountry} className="p-6 border-2 border-slate-200 rounded-xl hover:bg-slate-50 text-center">
                        <Icon name="Copy" size={32} className="mx-auto text-slate-500 mb-3" />
                        <p className="font-semibold">Copy {selectedCountry.id}</p>
                        <p className="text-sm text-slate-500">Start from existing</p>
                      </button>
                      <button onClick={startNewCountry} className="p-6 border-2 border-slate-200 rounded-xl hover:bg-slate-50 text-center">
                        <Icon name="FilePlus" size={32} className="mx-auto text-slate-500 mb-3" />
                        <p className="font-semibold">Blank Template</p>
                        <p className="text-sm text-slate-500">Start from scratch</p>
                      </button>
                    </div>
                  </div>
                )}

                {/* COMPARE TAB */}
                {countryTab === "compare" && (
                  <div className="card">
                    <h3 className="font-semibold mb-4">Compare Countries</h3>
                    <div className="flex gap-4 mb-6">
                      <div className="flex-1">
                        <label className="text-sm text-slate-500">Country 1</label>
                        <div className="p-3 bg-blue-50 rounded-lg mt-1">
                          {selectedCountry.flag} {selectedCountry.id}
                        </div>
                      </div>
                      <div className="flex-1">
                        <label className="text-sm text-slate-500">Country 2</label>
                        <select className="input mt-1" onChange={e => loadCompare(e.target.value)}>
                          <option value="">Select country...</option>
                          <option value="Thailand">ðŸ‡¹ðŸ‡­ Thailand</option>
                          <option value="Malaysia">ðŸ‡²ðŸ‡¾ Malaysia</option>
                        </select>
                      </div>
                    </div>
                    {compareResult && (
                      <div>
                        <h4 className="font-semibold mb-3">Differences ({compareResult.differences?.length || 0})</h4>
                        {compareResult.differences?.length > 0 ? (
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="border-b">
                                <th className="text-left py-2">Field</th>
                                <th className="text-left py-2">{compareResult.country1?.flag} {compareResult.country1?.id}</th>
                                <th className="text-left py-2">{compareResult.country2?.flag} {compareResult.country2?.id}</th>
                              </tr>
                            </thead>
                            <tbody>
                              {compareResult.differences.map((d, i) => (
                                <tr key={i} className="border-b">
                                  <td className="py-2">{d.field}</td>
                                  <td className="py-2"><span className="value-pill">{d.country1}</span></td>
                                  <td className="py-2"><span className="value-pill">{d.country2}</span></td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        ) : (
                          <p className="text-green-600">âœ“ Configurations are identical</p>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            )}

            {/* ========== LESSONS LEARNED MODULE ========== */}
            {phase === "working" && module === "lessons" && (
              <div className="max-w-5xl fade-in">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h2 className="text-xl font-bold">ðŸ’¡ Lessons Learned</h2>
                    <p className="text-slate-500 text-sm">Capture and share knowledge from completed tasks</p>
                  </div>
                  <button onClick={() => setShowAddLesson(true)} className="btn btn-primary">
                    <Icon name="Plus" size={16} className="mr-1" /> Add Lesson
                  </button>
                </div>

                {/* Stats */}
                <div className="grid md:grid-cols-4 gap-4 mb-6">
                  <div className="card text-center">
                    <p className="text-3xl font-bold text-blue-600">{lessonsLearned.length}</p>
                    <p className="text-sm text-slate-500">Total Lessons</p>
                  </div>
                  <div className="card text-center">
                    <p className="text-3xl font-bold text-red-600">{lessonsLearned.filter(l => l.severity === "high").length}</p>
                    <p className="text-sm text-slate-500">High Priority</p>
                  </div>
                  <div className="card text-center">
                    <p className="text-3xl font-bold text-green-600">{lessonsLearned.reduce((sum, l) => sum + l.upvotes, 0)}</p>
                    <p className="text-sm text-slate-500">Total Upvotes</p>
                  </div>
                  <div className="card text-center">
                    <p className="text-3xl font-bold text-purple-600">{new Set(lessonsLearned.map(l => l.category)).size}</p>
                    <p className="text-sm text-slate-500">Categories</p>
                  </div>
                </div>

                {/* Filters */}
                <div className="card mb-4">
                  <div className="flex flex-wrap gap-3">
                    <select 
                      className="input py-1.5 w-40"
                      value={lessonFilter.category}
                      onChange={e => setLessonFilter({...lessonFilter, category: e.target.value})}
                    >
                      <option value="all">All Categories</option>
                      <option value="PROJECT">Project</option>
                      <option value="SETTLEMENT">Settlement</option>
                      <option value="BUDGET">Budget</option>
                      <option value="MM">MM / Procurement</option>
                      <option value="ASSET">Asset</option>
                    </select>
                    <select 
                      className="input py-1.5 w-36"
                      value={lessonFilter.severity}
                      onChange={e => setLessonFilter({...lessonFilter, severity: e.target.value})}
                    >
                      <option value="all">All Severity</option>
                      <option value="high">ðŸ”´ High</option>
                      <option value="medium">ðŸŸ¡ Medium</option>
                      <option value="low">ðŸŸ¢ Low</option>
                    </select>
                    <select 
                      className="input py-1.5 w-32"
                      value={lessonFilter.module}
                      onChange={e => setLessonFilter({...lessonFilter, module: e.target.value})}
                    >
                      <option value="all">All Modules</option>
                      <option value="FI">FI</option>
                      <option value="MM">MM</option>
                      <option value="AA">AA</option>
                    </select>
                  </div>
                </div>

                {/* Lessons List */}
                <div className="space-y-3">
                  {lessonsLearned
                    .filter(l => lessonFilter.category === "all" || l.category === lessonFilter.category)
                    .filter(l => lessonFilter.severity === "all" || l.severity === lessonFilter.severity)
                    .filter(l => lessonFilter.module === "all" || l.module === lessonFilter.module)
                    .sort((a, b) => b.upvotes - a.upvotes)
                    .map(lesson => (
                    <div key={lesson.id} className="card hover:shadow-md transition-all">
                      <div className="flex items-start gap-4">
                        {/* Upvote */}
                        <div className="flex flex-col items-center">
                          <button 
                            onClick={() => setLessonsLearned(lessonsLearned.map(l => 
                              l.id === lesson.id ? {...l, upvotes: l.upvotes + 1} : l
                            ))}
                            className="text-slate-400 hover:text-green-500 transition-colors"
                          >
                            <Icon name="ChevronUp" size={24} />
                          </button>
                          <span className="font-bold text-lg">{lesson.upvotes}</span>
                        </div>
                        
                        {/* Content */}
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className={`w-3 h-3 rounded-full ${
                              lesson.severity === "high" ? "bg-red-500" : 
                              lesson.severity === "medium" ? "bg-amber-500" : "bg-green-500"
                            }`} />
                            <h4 className="font-semibold">{lesson.title}</h4>
                            <span className="badge badge-blue">{lesson.module}</span>
                            <span className="badge badge-slate">{lesson.category}</span>
                          </div>
                          <p className="text-slate-600 text-sm mb-3">{lesson.description}</p>
                          
                          <div className="grid md:grid-cols-2 gap-3 mb-3">
                            <div className="bg-red-50 p-2 rounded">
                              <p className="text-xs text-red-600 font-medium">Root Cause</p>
                              <p className="text-sm">{lesson.rootCause}</p>
                            </div>
                            <div className="bg-green-50 p-2 rounded">
                              <p className="text-xs text-green-600 font-medium">Solution</p>
                              <p className="text-sm">{lesson.solution}</p>
                            </div>
                          </div>
                          
                          <div className="flex items-center justify-between text-xs text-slate-400">
                            <div className="flex items-center gap-2">
                              <span>By {lesson.createdBy}</span>
                              <span>â€¢</span>
                              <span>{lesson.createdAt}</span>
                            </div>
                            <div className="flex gap-1">
                              {lesson.tags.map((tag, i) => (
                                <span key={i} className="px-2 py-0.5 bg-slate-100 rounded text-slate-500">#{tag}</span>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* Add Lesson Modal */}
                {showAddLesson && (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-auto m-4">
                      <div className="p-6 border-b">
                        <div className="flex items-center justify-between">
                          <h3 className="text-lg font-bold">Add New Lesson Learned</h3>
                          <button onClick={() => setShowAddLesson(false)} className="text-slate-400 hover:text-slate-600">
                            <Icon name="X" size={24} />
                          </button>
                        </div>
                      </div>
                      <div className="p-6 space-y-4">
                        <div>
                          <label className="label">Title *</label>
                          <input 
                            className="input" 
                            placeholder="Brief description of the lesson"
                            value={newLesson.title}
                            onChange={e => setNewLesson({...newLesson, title: e.target.value})}
                          />
                        </div>
                        <div className="grid md:grid-cols-3 gap-4">
                          <div>
                            <label className="label">Category</label>
                            <select className="input" value={newLesson.category} onChange={e => setNewLesson({...newLesson, category: e.target.value})}>
                              <option value="">Select...</option>
                              <option value="PROJECT">Project</option>
                              <option value="SETTLEMENT">Settlement</option>
                              <option value="BUDGET">Budget</option>
                              <option value="MM">MM / Procurement</option>
                              <option value="ASSET">Asset</option>
                              <option value="INVOICE">Invoice</option>
                            </select>
                          </div>
                          <div>
                            <label className="label">Severity</label>
                            <select className="input" value={newLesson.severity} onChange={e => setNewLesson({...newLesson, severity: e.target.value})}>
                              <option value="high">ðŸ”´ High</option>
                              <option value="medium">ðŸŸ¡ Medium</option>
                              <option value="low">ðŸŸ¢ Low</option>
                            </select>
                          </div>
                          <div>
                            <label className="label">Module</label>
                            <select className="input" value={newLesson.module} onChange={e => setNewLesson({...newLesson, module: e.target.value})}>
                              <option value="FI">FI - Finance</option>
                              <option value="MM">MM - Materials</option>
                              <option value="AA">AA - Assets</option>
                            </select>
                          </div>
                        </div>
                        <div>
                          <label className="label">Description *</label>
                          <textarea 
                            className="input" 
                            rows={3}
                            placeholder="What happened? What was the impact?"
                            value={newLesson.description}
                            onChange={e => setNewLesson({...newLesson, description: e.target.value})}
                          />
                        </div>
                        <div className="grid md:grid-cols-2 gap-4">
                          <div>
                            <label className="label">Root Cause</label>
                            <textarea 
                              className="input" 
                              rows={2}
                              placeholder="Why did this happen?"
                              value={newLesson.rootCause}
                              onChange={e => setNewLesson({...newLesson, rootCause: e.target.value})}
                            />
                          </div>
                          <div>
                            <label className="label">Solution / Prevention</label>
                            <textarea 
                              className="input" 
                              rows={2}
                              placeholder="How to prevent this in future?"
                              value={newLesson.solution}
                              onChange={e => setNewLesson({...newLesson, solution: e.target.value})}
                            />
                          </div>
                        </div>
                        <div>
                          <label className="label">Tags (comma separated)</label>
                          <input 
                            className="input" 
                            placeholder="e.g., settlement, month-end, teco"
                            value={newLesson.tags}
                            onChange={e => setNewLesson({...newLesson, tags: e.target.value})}
                          />
                        </div>
                      </div>
                      <div className="p-6 border-t bg-slate-50 flex justify-end gap-2">
                        <button onClick={() => setShowAddLesson(false)} className="btn btn-secondary">Cancel</button>
                        <button 
                          onClick={() => {
                            if (!newLesson.title || !newLesson.description) {
                              alert("Please fill in title and description");
                              return;
                            }
                            setLessonsLearned([...lessonsLearned, {
                              ...newLesson,
                              id: "LL-" + String(lessonsLearned.length + 1).padStart(3, "0"),
                              tags: newLesson.tags.split(",").map(t => t.trim()).filter(t => t),
                              upvotes: 0,
                              createdBy: "Current User",
                              createdAt: new Date().toISOString().split("T")[0]
                            }]);
                            setNewLesson({title: "", category: "", severity: "medium", module: "FI", description: "", rootCause: "", solution: "", tags: ""});
                            setShowAddLesson(false);
                          }}
                          className="btn btn-primary"
                        >
                          <Icon name="Plus" size={16} className="mr-1" /> Add Lesson
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* ========== SAP QUEST GAME MODULE ========== */}
            {phase === "working" && module === "game" && (
              <div className="max-w-4xl fade-in">
                {/* Retro Game Header */}
                <div className="bg-gradient-to-r from-purple-900 via-indigo-900 to-purple-900 rounded-2xl p-6 mb-6 border-4 border-yellow-400 shadow-[0_0_20px_rgba(234,179,8,0.3)]">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-3xl font-bold text-yellow-400 tracking-wider" style={{fontFamily: "'Press Start 2P', monospace", textShadow: "3px 3px 0 #7c3aed"}}>
                        ðŸŽ® SAP QUEST
                      </h2>
                      <p className="text-purple-300 mt-2">Master SAP, Earn Rewards, Level Up!</p>
                    </div>
                    {currentUser ? (
                      <div className="flex items-center gap-4">
                        <div className="text-right">
                          <p className="text-yellow-400 font-bold">{currentUser.displayName}</p>
                          <p className="text-purple-300 text-sm">Level {getLevelFromXP(currentUser.xp)}</p>
                        </div>
                        <div className="w-16 h-16 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-2xl border-2 border-white shadow-lg">
                          ðŸ‘¤
                        </div>
                      </div>
                    ) : (
                      <button 
                        onClick={() => setShowLoginModal(true)}
                        className="px-6 py-3 bg-yellow-400 text-purple-900 font-bold rounded-lg hover:bg-yellow-300 transition-all border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1"
                      >
                        ðŸ”‘ LOGIN TO PLAY
                      </button>
                    )}
                  </div>
                  
                  {/* XP Bar */}
                  {currentUser && (
                    <div className="mt-4">
                      <div className="flex justify-between text-xs text-purple-300 mb-1">
                        <span>XP: {currentUser.xp}</span>
                        <span>Next Level: {levelThresholds[getLevelFromXP(currentUser.xp)] || "MAX"}</span>
                      </div>
                      <div className="h-4 bg-purple-800 rounded-full overflow-hidden border border-purple-600">
                        <div 
                          className="h-full bg-gradient-to-r from-yellow-400 via-yellow-300 to-yellow-400 transition-all duration-500"
                          style={{width: `${getXPProgress(currentUser.xp)}%`, backgroundSize: "20px 20px"}}
                        />
                      </div>
                    </div>
                  )}
                </div>

                {/* Stats Row */}
                {currentUser && (
                  <div className="grid grid-cols-4 gap-4 mb-6">
                    <div className="bg-gradient-to-br from-yellow-500 to-amber-600 rounded-xl p-4 text-center text-white border-2 border-yellow-300">
                      <p className="text-3xl font-bold">ðŸª™ {currentUser.coins}</p>
                      <p className="text-xs opacity-80">Coins</p>
                    </div>
                    <div className="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl p-4 text-center text-white border-2 border-purple-300">
                      <p className="text-3xl font-bold">â­ {getLevelFromXP(currentUser.xp)}</p>
                      <p className="text-xs opacity-80">Level</p>
                    </div>
                    <div className="bg-gradient-to-br from-orange-500 to-red-600 rounded-xl p-4 text-center text-white border-2 border-orange-300">
                      <p className="text-3xl font-bold">ðŸ”¥ {currentUser.streak}</p>
                      <p className="text-xs opacity-80">Streak</p>
                    </div>
                    <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-4 text-center text-white border-2 border-green-300">
                      <p className="text-3xl font-bold">âœ… {currentUser.correctAnswers}</p>
                      <p className="text-xs opacity-80">Correct</p>
                    </div>
                  </div>
                )}

                {/* Login Required Notice */}
                {!currentUser && (
                  <div className="bg-slate-800 rounded-xl p-8 text-center border-2 border-dashed border-slate-600">
                    <p className="text-6xl mb-4">ðŸŽ®</p>
                    <h3 className="text-xl font-bold text-white mb-2">Login to Start Playing!</h3>
                    <p className="text-slate-400 mb-4">Test your SAP knowledge, earn XP & coins, and compete on the leaderboard!</p>
                    <button 
                      onClick={() => setShowLoginModal(true)}
                      className="px-8 py-3 bg-yellow-400 text-purple-900 font-bold rounded-lg hover:bg-yellow-300"
                    >
                      ðŸ”‘ Login Now
                    </button>
                  </div>
                )}

                {/* Game Menu */}
                {currentUser && gameMode === "menu" && (
                  <div className="grid md:grid-cols-2 gap-4">
                    {/* Play Quiz */}
                    <button 
                      onClick={() => setGameMode("playing")}
                      className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 text-left text-white hover:scale-[1.02] transition-all border-4 border-green-400 shadow-lg"
                    >
                      <div className="text-4xl mb-2">ðŸŽ¯</div>
                      <h3 className="text-xl font-bold">Play Quiz</h3>
                      <p className="text-green-200 text-sm">Answer questions & earn rewards</p>
                      <p className="text-xs text-green-300 mt-2">{quizzes.length} quizzes available</p>
                    </button>
                    
                    {/* Create Quiz */}
                    <button 
                      onClick={() => setGameMode("create")}
                      className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 text-left text-white hover:scale-[1.02] transition-all border-4 border-blue-400 shadow-lg"
                    >
                      <div className="text-4xl mb-2">âœï¸</div>
                      <h3 className="text-xl font-bold">Create Quiz</h3>
                      <p className="text-blue-200 text-sm">Contribute questions & earn XP</p>
                      <p className="text-xs text-blue-300 mt-2">+50 XP per approved quiz</p>
                    </button>
                    
                    {/* Leaderboard */}
                    <button 
                      onClick={() => setGameMode("leaderboard")}
                      className="bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl p-6 text-left text-white hover:scale-[1.02] transition-all border-4 border-amber-400 shadow-lg"
                    >
                      <div className="text-4xl mb-2">ðŸ†</div>
                      <h3 className="text-xl font-bold">Leaderboard</h3>
                      <p className="text-amber-200 text-sm">See top players</p>
                      <p className="text-xs text-amber-300 mt-2">Compete for #1 spot!</p>
                    </button>
                    
                    {/* Shop */}
                    <button 
                      onClick={() => setGameMode("shop")}
                      className="bg-gradient-to-br from-pink-500 to-purple-600 rounded-xl p-6 text-left text-white hover:scale-[1.02] transition-all border-4 border-pink-400 shadow-lg"
                    >
                      <div className="text-4xl mb-2">ðŸ›’</div>
                      <h3 className="text-xl font-bold">Shop</h3>
                      <p className="text-pink-200 text-sm">Spend your coins</p>
                      <p className="text-xs text-pink-300 mt-2">Badges, titles, power-ups</p>
                    </button>
                  </div>
                )}

                {/* Badges Section */}
                {currentUser && gameMode === "menu" && (
                  <div className="mt-6 bg-slate-800 rounded-xl p-4 border-2 border-slate-600">
                    <h3 className="text-white font-bold mb-3">ðŸ… Your Badges</h3>
                    <div className="flex flex-wrap gap-2">
                      {currentUser.badges.map(badgeId => (
                        <div key={badgeId} className="px-3 py-2 bg-gradient-to-r from-yellow-500 to-amber-500 rounded-lg text-sm" title={badgeDefinitions[badgeId]?.description}>
                          <span className="mr-1">{badgeDefinitions[badgeId]?.icon}</span>
                          {badgeDefinitions[badgeId]?.name}
                        </div>
                      ))}
                      {currentUser.badges.length === 0 && (
                        <p className="text-slate-400 text-sm">No badges yet. Keep playing to earn them!</p>
                      )}
                    </div>
                  </div>
                )}

                {/* Playing Mode */}
                {currentUser && gameMode === "playing" && (
                  <div>
                    {/* Filters */}
                    <div className="flex gap-4 mb-4">
                      <select 
                        className="px-4 py-2 bg-slate-800 text-white rounded-lg border border-slate-600"
                        value={quizFilter.category}
                        onChange={e => setQuizFilter({...quizFilter, category: e.target.value})}
                      >
                        <option value="all">All Categories</option>
                        <option value="FI">FI - Finance</option>
                        <option value="MM">MM - Materials</option>
                        <option value="AA">AA - Assets</option>
                      </select>
                      <select 
                        className="px-4 py-2 bg-slate-800 text-white rounded-lg border border-slate-600"
                        value={quizFilter.difficulty}
                        onChange={e => setQuizFilter({...quizFilter, difficulty: e.target.value})}
                      >
                        <option value="all">All Difficulty</option>
                        <option value="easy">ðŸŸ¢ Easy</option>
                        <option value="medium">ðŸŸ¡ Medium</option>
                        <option value="hard">ðŸ”´ Hard</option>
                      </select>
                      <button onClick={() => setGameMode("menu")} className="ml-auto px-4 py-2 bg-slate-700 text-white rounded-lg">
                        â† Back
                      </button>
                    </div>

                    {!currentQuiz ? (
                      /* Quiz Selection */
                      <div className="space-y-3">
                        {quizzes
                          .filter(q => quizFilter.category === "all" || q.category === quizFilter.category)
                          .filter(q => quizFilter.difficulty === "all" || q.difficulty === quizFilter.difficulty)
                          .map(quiz => {
                            const alreadyAnswered = currentUser?.answeredQuestions?.includes(quiz.id);
                            return (
                          <div 
                            key={quiz.id}
                            onClick={() => {setCurrentQuiz(quiz); setQuizAnswer(null); setQuizResult(null);}}
                            className={`bg-slate-800 rounded-xl p-4 cursor-pointer hover:bg-slate-700 transition-all border-2 ${
                              alreadyAnswered ? "border-green-500/50 opacity-75" : "border-transparent hover:border-yellow-400"
                            }`}
                          >
                            <div className="flex items-center justify-between">
                              <div>
                                <div className="flex items-center gap-2">
                                  <p className="text-white font-medium">{quiz.question}</p>
                                  {alreadyAnswered && <span className="text-green-400 text-sm">âœ“ Answered</span>}
                                </div>
                                <div className="flex items-center gap-2 mt-2">
                                  <span className={`px-2 py-0.5 rounded text-xs ${
                                    quiz.difficulty === "easy" ? "bg-green-500/20 text-green-400" :
                                    quiz.difficulty === "medium" ? "bg-yellow-500/20 text-yellow-400" :
                                    "bg-red-500/20 text-red-400"
                                  }`}>
                                    {quiz.difficulty}
                                  </span>
                                  <span className="px-2 py-0.5 rounded text-xs bg-purple-500/20 text-purple-400">{quiz.category}</span>
                                  <span className="text-slate-500 text-xs">Played {quiz.plays}x</span>
                                </div>
                              </div>
                              <div className="text-right">
                                {alreadyAnswered ? (
                                  <p className="text-slate-500 text-sm">No rewards</p>
                                ) : (
                                  <>
                                    <p className="text-yellow-400 font-bold">+{quiz.xpReward} XP</p>
                                    <p className="text-amber-400 text-sm">+{quiz.coinReward} ðŸª™</p>
                                  </>
                                )}
                              </div>
                            </div>
                          </div>
                        );})}
                      </div>
                    ) : (
                      /* Active Quiz */
                      <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 border-4 border-purple-500">
                        {/* Question */}
                        <div className="mb-6">
                          <div className="flex items-center gap-2 mb-3">
                            <span className={`px-2 py-1 rounded text-xs ${
                              currentQuiz.difficulty === "easy" ? "bg-green-500 text-white" :
                              currentQuiz.difficulty === "medium" ? "bg-yellow-500 text-black" :
                              "bg-red-500 text-white"
                            }`}>
                              {currentQuiz.difficulty.toUpperCase()}
                            </span>
                            <span className="px-2 py-1 rounded text-xs bg-purple-500 text-white">{currentQuiz.category}</span>
                          </div>
                          <h3 className="text-xl text-white font-bold">{currentQuiz.question}</h3>
                        </div>

                        {/* Options */}
                        <div className="space-y-3 mb-6">
                          {currentQuiz.options.map((option, idx) => (
                            <button
                              key={idx}
                              onClick={() => !quizResult && setQuizAnswer(idx)}
                              disabled={!!quizResult}
                              className={`w-full p-4 rounded-xl text-left font-medium transition-all ${
                                quizResult ? (
                                  idx === currentQuiz.correctAnswer ? "bg-green-500 text-white border-4 border-green-300" :
                                  idx === quizAnswer && idx !== currentQuiz.correctAnswer ? "bg-red-500 text-white border-4 border-red-300" :
                                  "bg-slate-700 text-slate-400"
                                ) : (
                                  quizAnswer === idx ? "bg-yellow-400 text-purple-900 border-4 border-yellow-300" :
                                  "bg-slate-700 text-white hover:bg-slate-600 border-4 border-transparent"
                                )
                              }`}
                            >
                              <span className="mr-3 inline-block w-8 h-8 rounded-full bg-black/20 text-center leading-8">
                                {String.fromCharCode(65 + idx)}
                              </span>
                              {option}
                            </button>
                          ))}
                        </div>

                        {/* Submit / Result */}
                        {!quizResult ? (
                          <button
                            onClick={() => {
                              if (quizAnswer === null) return;
                              const isCorrect = quizAnswer === currentQuiz.correctAnswer;
                              const alreadyAnswered = currentUser.answeredQuestions?.includes(currentQuiz.id);
                              
                              // Only give rewards if not already answered
                              const earnedXP = (isCorrect && !alreadyAnswered) ? currentQuiz.xpReward : 0;
                              const earnedCoins = (isCorrect && !alreadyAnswered) ? currentQuiz.coinReward : 0;
                              
                              setQuizResult({
                                correct: isCorrect, 
                                xp: earnedXP, 
                                coins: earnedCoins,
                                alreadyAnswered: alreadyAnswered
                              });
                              
                              // Update user stats (only add to answeredQuestions if new)
                              if (isCorrect) {
                                setUsers(users.map(u => u.id === currentUser.id ? {
                                  ...u, 
                                  xp: u.xp + earnedXP,
                                  coins: u.coins + earnedCoins,
                                  correctAnswers: alreadyAnswered ? u.correctAnswers : u.correctAnswers + 1,
                                  quizzesPlayed: u.quizzesPlayed + 1,
                                  streak: u.streak + 1,
                                  level: getLevelFromXP(u.xp + earnedXP),
                                  answeredQuestions: alreadyAnswered ? u.answeredQuestions : [...(u.answeredQuestions || []), currentQuiz.id]
                                } : u));
                                setCurrentUser({
                                  ...currentUser,
                                  xp: currentUser.xp + earnedXP,
                                  coins: currentUser.coins + earnedCoins,
                                  correctAnswers: alreadyAnswered ? currentUser.correctAnswers : currentUser.correctAnswers + 1,
                                  quizzesPlayed: currentUser.quizzesPlayed + 1,
                                  streak: currentUser.streak + 1,
                                  answeredQuestions: alreadyAnswered ? currentUser.answeredQuestions : [...(currentUser.answeredQuestions || []), currentQuiz.id]
                                });
                              } else {
                                setUsers(users.map(u => u.id === currentUser.id ? {
                                  ...u, quizzesPlayed: u.quizzesPlayed + 1, streak: 0
                                } : u));
                                setCurrentUser({...currentUser, quizzesPlayed: currentUser.quizzesPlayed + 1, streak: 0});
                              }
                            }}
                            disabled={quizAnswer === null}
                            className={`w-full py-4 rounded-xl font-bold text-lg ${
                              quizAnswer === null ? "bg-slate-600 text-slate-400" : "bg-yellow-400 text-purple-900 hover:bg-yellow-300"
                            }`}
                          >
                            SUBMIT ANSWER
                          </button>
                        ) : (
                          <div className={`p-6 rounded-xl ${quizResult.correct ? "bg-green-500/20" : "bg-red-500/20"}`}>
                            <div className="text-center">
                              <p className="text-4xl mb-2">{quizResult.correct ? "ðŸŽ‰" : "ðŸ˜¢"}</p>
                              <p className={`text-2xl font-bold ${quizResult.correct ? "text-green-400" : "text-red-400"}`}>
                                {quizResult.correct ? "CORRECT!" : "WRONG!"}
                              </p>
                              {quizResult.correct && quizResult.xp > 0 && (
                                <p className="text-yellow-400 mt-2">+{quizResult.xp} XP | +{quizResult.coins} ðŸª™</p>
                              )}
                              {quizResult.correct && quizResult.alreadyAnswered && (
                                <p className="text-slate-400 mt-2 text-sm">Already answered - no points this time</p>
                              )}
                            </div>
                            
                            {/* Show explanation for wrong answers */}
                            {!quizResult.correct && (
                              <div className="mt-4 p-4 bg-slate-800 rounded-lg text-left border border-slate-600">
                                <div className="flex items-center gap-2 mb-2">
                                  <span className="text-green-400">âœ“</span>
                                  <p className="text-green-400 font-semibold">
                                    Correct Answer: {currentQuiz.options[currentQuiz.correctAnswer]}
                                  </p>
                                </div>
                                {currentQuiz.explanation && (
                                  <div className="mt-3 pt-3 border-t border-slate-600">
                                    <p className="text-amber-400 text-sm font-semibold mb-1">ðŸ’¡ Explanation:</p>
                                    <p className="text-slate-300 text-sm">{currentQuiz.explanation}</p>
                                  </div>
                                )}
                              </div>
                            )}
                            
                            {/* Show explanation for correct answers too (optional learning) */}
                            {quizResult.correct && currentQuiz.explanation && (
                              <div className="mt-4 p-4 bg-slate-800 rounded-lg text-left border border-slate-600">
                                <p className="text-blue-400 text-sm font-semibold mb-1">ðŸ“š Learn More:</p>
                                <p className="text-slate-300 text-sm">{currentQuiz.explanation}</p>
                              </div>
                            )}
                            
                            <button
                              onClick={() => {setCurrentQuiz(null); setQuizAnswer(null); setQuizResult(null);}}
                              className="mt-4 w-full px-6 py-2 bg-white/20 rounded-lg text-white hover:bg-white/30"
                            >
                              Next Question â†’
                            </button>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {/* Create Quiz Mode */}
                {currentUser && gameMode === "create" && (
                  <div className="bg-slate-800 rounded-xl p-6 border-2 border-blue-500">
                    <div className="flex items-center justify-between mb-6">
                      <h3 className="text-xl font-bold text-white">âœï¸ Create a Quiz</h3>
                      <button onClick={() => setGameMode("menu")} className="px-4 py-2 bg-slate-700 text-white rounded-lg">â† Back</button>
                    </div>
                    
                    <p className="text-blue-300 mb-4">Earn <span className="text-yellow-400 font-bold">+50 XP</span> and <span className="text-amber-400 font-bold">+25 ðŸª™</span> for each quiz you create!</p>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="text-white text-sm mb-1 block">Question *</label>
                        <textarea 
                          className="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600"
                          rows={2}
                          placeholder="Enter your SAP knowledge question..."
                          value={newQuiz.question}
                          onChange={e => setNewQuiz({...newQuiz, question: e.target.value})}
                        />
                      </div>
                      
                      <div className="grid grid-cols-2 gap-4">
                        {[0, 1, 2, 3].map(idx => (
                          <div key={idx}>
                            <label className="text-white text-sm mb-1 block flex items-center gap-2">
                              Option {String.fromCharCode(65 + idx)}
                              {newQuiz.correctAnswer === idx && <span className="text-green-400 text-xs">âœ“ Correct</span>}
                            </label>
                            <div className="flex gap-2">
                              <input 
                                className="flex-1 p-2 bg-slate-700 text-white rounded-lg border border-slate-600"
                                placeholder={`Option ${String.fromCharCode(65 + idx)}`}
                                value={newQuiz.options[idx]}
                                onChange={e => {
                                  const opts = [...newQuiz.options];
                                  opts[idx] = e.target.value;
                                  setNewQuiz({...newQuiz, options: opts});
                                }}
                              />
                              <button 
                                onClick={() => setNewQuiz({...newQuiz, correctAnswer: idx})}
                                className={`px-3 rounded-lg ${newQuiz.correctAnswer === idx ? "bg-green-500 text-white" : "bg-slate-600 text-slate-400"}`}
                              >
                                âœ“
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                      
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="text-white text-sm mb-1 block">Category</label>
                          <select 
                            className="w-full p-2 bg-slate-700 text-white rounded-lg border border-slate-600"
                            value={newQuiz.category}
                            onChange={e => setNewQuiz({...newQuiz, category: e.target.value})}
                          >
                            <option value="FI">FI - Finance</option>
                            <option value="MM">MM - Materials</option>
                            <option value="AA">AA - Assets</option>
                            <option value="General">General SAP</option>
                          </select>
                        </div>
                        <div>
                          <label className="text-white text-sm mb-1 block">Difficulty</label>
                          <select 
                            className="w-full p-2 bg-slate-700 text-white rounded-lg border border-slate-600"
                            value={newQuiz.difficulty}
                            onChange={e => setNewQuiz({...newQuiz, difficulty: e.target.value})}
                          >
                            <option value="easy">ðŸŸ¢ Easy (+10 XP)</option>
                            <option value="medium">ðŸŸ¡ Medium (+20 XP)</option>
                            <option value="hard">ðŸ”´ Hard (+30 XP)</option>
                          </select>
                        </div>
                      </div>
                      
                      <div>
                        <label className="text-white text-sm mb-1 block">Explanation (shown when answered incorrectly)</label>
                        <textarea 
                          className="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600"
                          rows={3}
                          placeholder="Explain why the correct answer is right and why other options are wrong..."
                          value={newQuiz.explanation || ""}
                          onChange={e => setNewQuiz({...newQuiz, explanation: e.target.value})}
                        />
                      </div>
                      
                      <button
                        onClick={() => {
                          if (!newQuiz.question || newQuiz.options.some(o => !o)) {
                            alert("Please fill in question and all 4 options");
                            return;
                          }
                          const xpReward = newQuiz.difficulty === "easy" ? 10 : newQuiz.difficulty === "medium" ? 20 : 30;
                          const coinReward = Math.round(xpReward / 2);
                          
                          setQuizzes([...quizzes, {
                            ...newQuiz,
                            id: "Q" + String(quizzes.length + 1).padStart(3, "0"),
                            createdBy: currentUser.id,
                            explanation: newQuiz.explanation || "",
                            xpReward,
                            coinReward,
                            plays: 0,
                            correctRate: 0
                          }]);
                          
                          // Reward the creator
                          setUsers(users.map(u => u.id === currentUser.id ? {
                            ...u, xp: u.xp + 50, coins: u.coins + 25, quizzesCreated: u.quizzesCreated + 1
                          } : u));
                          setCurrentUser({...currentUser, xp: currentUser.xp + 50, coins: currentUser.coins + 25, quizzesCreated: currentUser.quizzesCreated + 1});
                          
                          setNewQuiz({question: "", options: ["", "", "", ""], correctAnswer: 0, category: "FI", difficulty: "easy", explanation: ""});
                          alert("ðŸŽ‰ Quiz created! You earned +50 XP and +25 coins!");
                        }}
                        className="w-full py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-xl hover:from-blue-600 hover:to-indigo-700"
                      >
                        âœ¨ Submit Quiz (+50 XP, +25 ðŸª™)
                      </button>
                    </div>
                  </div>
                )}

                {/* Leaderboard */}
                {currentUser && gameMode === "leaderboard" && (
                  <div className="bg-slate-800 rounded-xl p-6 border-2 border-amber-500">
                    <div className="flex items-center justify-between mb-6">
                      <h3 className="text-xl font-bold text-white">ðŸ† Leaderboard</h3>
                      <button onClick={() => setGameMode("menu")} className="px-4 py-2 bg-slate-700 text-white rounded-lg">â† Back</button>
                    </div>
                    
                    <div className="space-y-3">
                      {[...users].sort((a, b) => b.xp - a.xp).map((user, idx) => (
                        <div 
                          key={user.id}
                          className={`flex items-center gap-4 p-4 rounded-xl ${
                            idx === 0 ? "bg-gradient-to-r from-yellow-500/20 to-amber-500/20 border-2 border-yellow-500" :
                            idx === 1 ? "bg-gradient-to-r from-slate-400/20 to-slate-300/20 border-2 border-slate-400" :
                            idx === 2 ? "bg-gradient-to-r from-orange-700/20 to-orange-600/20 border-2 border-orange-700" :
                            "bg-slate-700/50"
                          }`}
                        >
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl font-bold ${
                            idx === 0 ? "bg-yellow-500 text-yellow-900" :
                            idx === 1 ? "bg-slate-400 text-slate-900" :
                            idx === 2 ? "bg-orange-700 text-orange-100" :
                            "bg-slate-600 text-slate-300"
                          }`}>
                            {idx < 3 ? ["ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰"][idx] : idx + 1}
                          </div>
                          <div className="flex-1">
                            <p className="text-white font-bold">{user.displayName}</p>
                            <p className="text-slate-400 text-sm">Level {getLevelFromXP(user.xp)} â€¢ {user.correctAnswers} correct</p>
                          </div>
                          <div className="text-right">
                            <p className="text-yellow-400 font-bold text-xl">{user.xp} XP</p>
                            <p className="text-amber-400 text-sm">{user.coins} ðŸª™</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Shop */}
                {currentUser && gameMode === "shop" && (
                  <div className="bg-slate-800 rounded-xl p-6 border-2 border-pink-500">
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <h3 className="text-xl font-bold text-white">ðŸ›’ Shop</h3>
                        <p className="text-pink-300">Your balance: <span className="text-yellow-400 font-bold">{currentUser.coins} ðŸª™</span></p>
                      </div>
                      <button onClick={() => setGameMode("menu")} className="px-4 py-2 bg-slate-700 text-white rounded-lg">â† Back</button>
                    </div>
                    
                    <div className="grid md:grid-cols-2 gap-4">
                      {shopItems.map(item => {
                        const owned = purchasedItems.includes(item.id);
                        const canAfford = currentUser.coins >= item.cost;
                        return (
                          <div 
                            key={item.id}
                            className={`p-4 rounded-xl border-2 ${owned ? "bg-green-500/10 border-green-500" : "bg-slate-700 border-slate-600"}`}
                          >
                            <div className="flex items-start gap-3">
                              <span className="text-4xl">{item.icon}</span>
                              <div className="flex-1">
                                <h4 className="text-white font-bold">{item.name}</h4>
                                <p className="text-slate-400 text-sm">{item.description}</p>
                                <p className="text-xs text-slate-500 mt-1">Type: {item.type}</p>
                              </div>
                            </div>
                            <div className="flex items-center justify-between mt-3">
                              <span className="text-yellow-400 font-bold">{item.cost} ðŸª™</span>
                              {owned ? (
                                <span className="px-3 py-1 bg-green-500 text-white rounded-lg text-sm">âœ“ Owned</span>
                              ) : (
                                <button
                                  onClick={() => {
                                    if (!canAfford) return;
                                    setPurchasedItems([...purchasedItems, item.id]);
                                    setUsers(users.map(u => u.id === currentUser.id ? {...u, coins: u.coins - item.cost} : u));
                                    setCurrentUser({...currentUser, coins: currentUser.coins - item.cost});
                                  }}
                                  disabled={!canAfford}
                                  className={`px-3 py-1 rounded-lg text-sm font-bold ${
                                    canAfford ? "bg-pink-500 text-white hover:bg-pink-600" : "bg-slate-600 text-slate-400"
                                  }`}
                                >
                                  {canAfford ? "Buy" : "Can't afford"}
                                </button>
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Report Generation Modal */}
            {showReportModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div className="bg-white rounded-xl p-6 w-full max-w-lg shadow-2xl">
                  <div className="flex items-center justify-between mb-6">
                    <h3 className="text-xl font-bold">ðŸ“„ Generate Report</h3>
                    <button onClick={() => setShowReportModal(false)} className="text-slate-400 hover:text-slate-600">
                      <Icon name="X" size={24} />
                    </button>
                  </div>

                  <div className="space-y-4">
                    {/* Report Type */}
                    <div>
                      <label className="label">Report Type</label>
                      <div className="grid grid-cols-3 gap-3">
                        {[
                          {id: "handover", label: "Handover Status", icon: "ðŸŒ", desc: "Country migration status"},
                          {id: "analytics", label: "Analytics", icon: "ðŸ“Š", desc: "Performance metrics"},
                          {id: "audit", label: "Audit Trail", icon: "ðŸ“", desc: "Activity log"}
                        ].map(type => (
                          <button
                            key={type.id}
                            onClick={() => setReportType(type.id)}
                            className={`p-4 rounded-lg border-2 text-left transition-all ${
                              reportType === type.id 
                                ? "border-blue-500 bg-blue-50" 
                                : "border-slate-200 hover:border-slate-300"
                            }`}
                          >
                            <span className="text-2xl block mb-1">{type.icon}</span>
                            <p className="font-semibold text-sm">{type.label}</p>
                            <p className="text-xs text-slate-500">{type.desc}</p>
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Country Selection (for Handover report) */}
                    {reportType === "handover" && (
                      <div>
                        <label className="label">Select Country</label>
                        <select 
                          className="input"
                          value={reportCountry}
                          onChange={e => setReportCountry(e.target.value)}
                        >
                          {countries.map(c => (
                            <option key={c.id} value={c.id}>{c.flag} {c.name}</option>
                          ))}
                        </select>
                      </div>
                    )}

                    {/* Report Preview */}
                    <div className="bg-slate-50 rounded-lg p-4">
                      <h4 className="font-semibold mb-2">Report will include:</h4>
                      <ul className="text-sm text-slate-600 space-y-1">
                        {reportType === "handover" && (
                          <>
                            <li>âœ“ Handover status and progress</li>
                            <li>âœ“ Configuration summary</li>
                            <li>âœ“ Task completion metrics</li>
                            <li>âœ“ Key milestones</li>
                            <li>âœ“ Knowledge base statistics</li>
                          </>
                        )}
                        {reportType === "analytics" && (
                          <>
                            <li>âœ“ Task analytics by status</li>
                            <li>âœ“ Module breakdown</li>
                            <li>âœ“ Completion time analysis</li>
                            <li>âœ“ Top performer rankings</li>
                            <li>âœ“ Common error trends</li>
                          </>
                        )}
                        {reportType === "audit" && (
                          <>
                            <li>âœ“ Action summary counts</li>
                            <li>âœ“ Recent activity log</li>
                            <li>âœ“ User action breakdown</li>
                            <li>âœ“ Module change history</li>
                          </>
                        )}
                      </ul>
                    </div>

                    {/* Generate Button */}
                    <div className="flex gap-3">
                      <button 
                        onClick={() => setShowReportModal(false)}
                        className="btn btn-secondary flex-1"
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={generatePDFReport}
                        disabled={reportGenerating}
                        className="btn btn-primary flex-1"
                      >
                        {reportGenerating ? (
                          <>
                            <span className="animate-spin mr-2">â³</span> Generating...
                          </>
                        ) : (
                          <>
                            <Icon name="Download" size={16} className="mr-2" /> Generate & Download
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Login Modal */}
            {showLoginModal && (
              <div 
                className="fixed inset-0 bg-black/70 flex items-center justify-center z-50"
                onClick={(e) => {
                  if (e.target === e.currentTarget) setShowLoginModal(false);
                }}
                onKeyDown={(e) => {
                  if (e.key === "Escape") setShowLoginModal(false);
                }}
                tabIndex={0}
                ref={(el) => el && el.focus()}
              >
                <div className="relative bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 w-full max-w-md border border-slate-600 shadow-2xl">
                  {/* Close Button */}
                  <button 
                    onClick={() => setShowLoginModal(false)}
                    className="absolute top-4 right-4 text-slate-400 hover:text-white text-xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700"
                  >
                    âœ•
                  </button>
                  
                  <div className="text-center mb-6">
                    <h3 className="text-2xl font-bold text-white">ðŸ” Login to SAP Playbook</h3>
                    <p className="text-slate-400 text-sm mt-1">Access all features and track your progress</p>
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="text-slate-300 text-sm mb-1 block">Username</label>
                      <input 
                        className="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-400 outline-none"
                        placeholder="Enter username"
                        value={loginForm.username}
                        onChange={e => setLoginForm({...loginForm, username: e.target.value})}
                        onKeyDown={(e) => {
                          if (e.key === "Enter") {
                            const user = users.find(u => u.username === loginForm.username && u.password === loginForm.password);
                            if (user) {
                              setCurrentUser(user);
                              setShowLoginModal(false);
                              setLoginForm({username: "", password: ""});
                            }
                          }
                        }}
                      />
                    </div>
                    <div>
                      <label className="text-slate-300 text-sm mb-1 block">Password</label>
                      <input 
                        className="w-full p-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-400 outline-none"
                        type="password"
                        placeholder="Enter password"
                        value={loginForm.password}
                        onChange={e => setLoginForm({...loginForm, password: e.target.value})}
                        onKeyDown={(e) => {
                          if (e.key === "Enter") {
                            const user = users.find(u => u.username === loginForm.username && u.password === loginForm.password);
                            if (user) {
                              setCurrentUser(user);
                              setShowLoginModal(false);
                              setLoginForm({username: "", password: ""});
                            } else {
                              alert("Invalid username or password");
                            }
                          }
                        }}
                      />
                    </div>
                    
                    <button
                      onClick={() => {
                        const user = users.find(u => u.username === loginForm.username && u.password === loginForm.password);
                        if (user) {
                          setCurrentUser(user);
                          setShowLoginModal(false);
                          setLoginForm({username: "", password: ""});
                        } else {
                          alert("Invalid username or password. Try: admin/admin123");
                        }
                      }}
                      className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-500"
                    >
                      Login
                    </button>
                    
                    <div className="relative flex items-center py-2">
                      <div className="flex-grow border-t border-slate-600"></div>
                      <span className="px-3 text-slate-500 text-sm">or</span>
                      <div className="flex-grow border-t border-slate-600"></div>
                    </div>
                    
                    <button
                      onClick={() => {
                        if (!loginForm.username || !loginForm.password) {
                          alert("Please enter both username and password to create an account");
                          return;
                        }
                        if (loginForm.password.length < 4) {
                          alert("Password must be at least 4 characters");
                          return;
                        }
                        if (users.find(u => u.username === loginForm.username)) {
                          alert("Username already exists. Please choose another or login.");
                          return;
                        }
                        const newUser = {
                          id: "USR" + String(users.length + 1).padStart(3, "0"),
                          username: loginForm.username,
                          password: loginForm.password,
                          displayName: loginForm.username,
                          role: "user",
                          xp: 0, level: 1, coins: 50, badges: [],
                          quizzesPlayed: 0, quizzesCreated: 0, correctAnswers: 0, streak: 0,
                          joinedAt: new Date().toISOString().split("T")[0],
                          answeredQuestions: []
                        };
                        setUsers([...users, newUser]);
                        setCurrentUser(newUser);
                        setShowLoginModal(false);
                        setLoginForm({username: "", password: ""});
                        alert("ðŸŽ‰ Account created! Welcome to SAP Playbook!");
                      }}
                      className="w-full py-2 bg-transparent text-slate-300 hover:text-white border border-slate-500 rounded-lg hover:border-slate-400"
                    >
                      Create New Account
                    </button>
                  </div>
                  
                  <p className="text-center text-slate-500 text-xs mt-4">Demo: admin/admin123, john/john123, sarah/sarah123</p>
                  <p className="text-center text-slate-600 text-xs mt-1">Press ESC or click outside to close</p>
                </div>
              </div>
            )}

            {/* ANALYTICS MODULE */}
            {phase === "working" && module === "analytics" && (
              <div className="max-w-6xl fade-in">
                {/* Header */}
                <div className="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                  <div>
                    <h2 className="text-xl font-bold">ðŸ“Š Analytics Dashboard</h2>
                    <p className="text-slate-500">Track performance, trends, and insights</p>
                  </div>
                  <div className="flex items-center gap-2 flex-wrap">
                    <select 
                      className="input w-36"
                      value={analyticsDateRange}
                      onChange={e => setAnalyticsDateRange(e.target.value)}
                    >
                      <option value="7d">Last 7 days</option>
                      <option value="30d">Last 30 days</option>
                      <option value="90d">Last 90 days</option>
                      <option value="all">All time</option>
                    </select>
                    <button 
                      onClick={() => setShowReportModal(true)}
                      className="btn btn-primary btn-sm"
                    >
                      <Icon name="FileText" size={14} className="mr-1" /> Report
                    </button>
                  </div>
                </div>

                {/* Analytics Tabs */}
                <div className="flex gap-1 mb-6 border-b overflow-x-auto">
                  {[
                    {id: "overview", label: "Overview", icon: "LayoutDashboard"},
                    {id: "tasks", label: "Tasks", icon: "ClipboardList"},
                    {id: "handovers", label: "Handovers", icon: "ArrowRightLeft"},
                    {id: "users", label: "Users", icon: "Users"},
                    {id: "errors", label: "Errors", icon: "AlertTriangle"}
                  ].map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setAnalyticsTab(tab.id)}
                      className={`px-3 py-2 flex items-center gap-1 border-b-2 transition-all whitespace-nowrap text-sm ${
                        analyticsTab === tab.id 
                          ? "border-blue-600 text-blue-600" 
                          : "border-transparent text-slate-500 hover:text-slate-700"
                      }`}
                    >
                      <Icon name={tab.icon} size={14} />
                      {tab.label}
                    </button>
                  ))}
                </div>

                {/* Overview Tab */}
                {analyticsTab === "overview" && (
                  <div className="space-y-6">
                    {/* KPI Cards */}
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                      <div className="card bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-blue-100 text-xs">Total Tasks</p>
                            <p className="text-2xl font-bold">{analyticsData.tasksByStatus.completed + analyticsData.tasksByStatus.inProgress + analyticsData.tasksByStatus.pending}</p>
                          </div>
                          <Icon name="ClipboardList" size={24} className="text-blue-200" />
                        </div>
                        <p className="text-xs text-blue-100 mt-1">â†‘ 12% vs last period</p>
                      </div>
                      <div className="card bg-gradient-to-br from-green-500 to-green-600 text-white p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-green-100 text-xs">Completed</p>
                            <p className="text-2xl font-bold">{analyticsData.tasksByStatus.completed}</p>
                          </div>
                          <Icon name="CheckCircle" size={24} className="text-green-200" />
                        </div>
                        <p className="text-xs text-green-100 mt-1">{Math.round(analyticsData.tasksByStatus.completed / (analyticsData.tasksByStatus.completed + analyticsData.tasksByStatus.inProgress + analyticsData.tasksByStatus.pending) * 100)}% rate</p>
                      </div>
                      <div className="card bg-gradient-to-br from-amber-500 to-amber-600 text-white p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-amber-100 text-xs">Avg Time</p>
                            <p className="text-2xl font-bold">21<span className="text-sm">min</span></p>
                          </div>
                          <Icon name="Clock" size={24} className="text-amber-200" />
                        </div>
                        <p className="text-xs text-amber-100 mt-1">â†“ 3min improvement</p>
                      </div>
                      <div className="card bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-purple-100 text-xs">Active Users</p>
                            <p className="text-2xl font-bold">{users.length}</p>
                          </div>
                          <Icon name="Users" size={24} className="text-purple-200" />
                        </div>
                        <p className="text-xs text-purple-100 mt-1">{users.filter(u => u.streak > 0).length} on streak</p>
                      </div>
                    </div>

                    {/* Charts Row */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {/* Task Trend Chart */}
                      <div className="card">
                        <h3 className="font-semibold mb-4 text-sm">ðŸ“ˆ Task Completion Trend</h3>
                        <div className="h-48 flex items-end gap-1">
                          {analyticsData.tasksByDay.map((day, idx) => (
                            <div key={idx} className="flex-1 flex flex-col items-center">
                              <div className="w-full flex flex-col gap-0.5">
                                <div 
                                  className="w-full bg-green-500 rounded-t transition-all hover:bg-green-400" 
                                  style={{height: `${day.completed * 12}px`}}
                                  title={`Completed: ${day.completed}`}
                                />
                                <div 
                                  className="w-full bg-blue-500 rounded-b transition-all hover:bg-blue-400" 
                                  style={{height: `${day.created * 12}px`}}
                                  title={`Created: ${day.created}`}
                                />
                              </div>
                              <span className="text-xs text-slate-500 mt-1">{day.date.split(" ")[1]}</span>
                            </div>
                          ))}
                        </div>
                        <div className="flex justify-center gap-4 mt-3 text-xs">
                          <span className="flex items-center gap-1"><span className="w-2 h-2 bg-green-500 rounded" /> Completed</span>
                          <span className="flex items-center gap-1"><span className="w-2 h-2 bg-blue-500 rounded" /> Created</span>
                        </div>
                      </div>

                      {/* Module Distribution */}
                      <div className="card">
                        <h3 className="font-semibold mb-4 text-sm">ðŸ“Š Tasks by Module</h3>
                        <div className="space-y-3">
                          {Object.entries(analyticsData.tasksByModule).map(([module, count]) => {
                            const total = Object.values(analyticsData.tasksByModule).reduce((a, b) => a + b, 0);
                            const percent = Math.round(count / total * 100);
                            const colorClass = module === "FI" ? "bg-blue-500" : module === "MM" ? "bg-green-500" : "bg-amber-500";
                            return (
                              <div key={module}>
                                <div className="flex justify-between mb-1 text-sm">
                                  <span className="font-medium">{module}</span>
                                  <span className="text-slate-600">{count} ({percent}%)</span>
                                </div>
                                <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
                                  <div 
                                    className={`h-full ${colorClass} transition-all duration-500`}
                                    style={{width: `${percent}%`}}
                                  />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                        
                        {/* Pie Chart Visualization */}
                        <div className="mt-4 flex justify-center">
                          <div className="relative w-24 h-24">
                            <svg viewBox="0 0 100 100" className="transform -rotate-90">
                              {(() => {
                                const total = Object.values(analyticsData.tasksByModule).reduce((a, b) => a + b, 0);
                                let cumulative = 0;
                                const colors = ["#3b82f6", "#22c55e", "#f59e0b"];
                                return Object.entries(analyticsData.tasksByModule).map(([key, val], idx) => {
                                  const percent = val / total * 100;
                                  const offset = cumulative;
                                  cumulative += percent;
                                  return (
                                    <circle
                                      key={key}
                                      cx="50" cy="50" r="40"
                                      fill="transparent"
                                      stroke={colors[idx]}
                                      strokeWidth="20"
                                      strokeDasharray={`${percent * 2.51} ${251 - percent * 2.51}`}
                                      style={{strokeDashoffset: -offset * 2.51}}
                                    />
                                  );
                                });
                              })()}
                            </svg>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Handover Status */}
                    <div className="card">
                      <h3 className="font-semibold mb-4 text-sm">ðŸŒ Handover Progress by Country</h3>
                      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                        {analyticsData.handoverProgress.map(country => (
                          <div key={country.country} className="text-center">
                            <div className="relative w-16 h-16 mx-auto mb-2">
                              <svg viewBox="0 0 100 100" className="transform -rotate-90">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" strokeWidth="10" />
                                <circle 
                                  cx="50" cy="50" r="45" 
                                  fill="none" 
                                  stroke={country.status === "completed" ? "#22c55e" : country.status === "in-progress" ? "#3b82f6" : "#94a3b8"}
                                  strokeWidth="10"
                                  strokeDasharray={`${country.progress * 2.83} 283`}
                                  strokeLinecap="round"
                                />
                              </svg>
                              <span className="absolute inset-0 flex items-center justify-center font-bold text-sm">
                                {country.progress}%
                              </span>
                            </div>
                            <p className="font-medium text-sm">{country.country}</p>
                            <span className={`badge text-xs ${
                              country.status === "completed" ? "badge-green" :
                              country.status === "in-progress" ? "badge-blue" : "badge-slate"
                            }`}>{country.status}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* Tasks Tab */}
                {analyticsTab === "tasks" && (
                  <div className="space-y-6">
                    <div className="grid md:grid-cols-3 gap-4">
                      <div className="card">
                        <h4 className="text-sm text-slate-500 mb-2">By Status</h4>
                        <div className="space-y-3">
                          <div className="flex items-center justify-between">
                            <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-green-500" /> Completed</span>
                            <span className="font-bold">{analyticsData.tasksByStatus.completed}</span>
                          </div>
                          <div className="flex items-center justify-between">
                            <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-blue-500" /> In Progress</span>
                            <span className="font-bold">{analyticsData.tasksByStatus.inProgress}</span>
                          </div>
                          <div className="flex items-center justify-between">
                            <span className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-slate-400" /> Pending</span>
                            <span className="font-bold">{analyticsData.tasksByStatus.pending}</span>
                          </div>
                        </div>
                      </div>
                      <div className="card">
                        <h4 className="text-sm text-slate-500 mb-2">Avg Completion Time by Module</h4>
                        <div className="space-y-3">
                          {Object.entries(analyticsData.avgCompletionTime).map(([mod, time]) => (
                            <div key={mod} className="flex items-center justify-between">
                              <span>{mod}</span>
                              <span className="font-bold">{time} min</span>
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="card">
                        <h4 className="text-sm text-slate-500 mb-2">Quick Stats</h4>
                        <div className="space-y-3">
                          <div className="flex items-center justify-between">
                            <span>Tasks Today</span>
                            <span className="font-bold text-blue-600">8</span>
                          </div>
                          <div className="flex items-center justify-between">
                            <span>Overdue</span>
                            <span className="font-bold text-red-600">3</span>
                          </div>
                          <div className="flex items-center justify-between">
                            <span>Due This Week</span>
                            <span className="font-bold text-amber-600">12</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Handovers Tab */}
                {analyticsTab === "handovers" && (
                  <div className="space-y-6">
                    <div className="card">
                      <h3 className="font-semibold mb-4">Country Handover Details</h3>
                      <table className="w-full">
                        <thead>
                          <tr className="border-b">
                            <th className="text-left py-2">Country</th>
                            <th className="text-left py-2">Status</th>
                            <th className="text-left py-2">Progress</th>
                            <th className="text-left py-2">Tasks</th>
                            <th className="text-left py-2">Last Updated</th>
                          </tr>
                        </thead>
                        <tbody>
                          {analyticsData.handoverProgress.map(country => (
                            <tr key={country.country} className="border-b hover:bg-slate-50">
                              <td className="py-3 font-medium">{country.country}</td>
                              <td className="py-3">
                                <span className={`badge ${
                                  country.status === "completed" ? "badge-green" :
                                  country.status === "in-progress" ? "badge-blue" : "badge-slate"
                                }`}>{country.status}</span>
                              </td>
                              <td className="py-3">
                                <div className="flex items-center gap-2">
                                  <div className="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                                    <div 
                                      className={`h-full ${
                                        country.status === "completed" ? "bg-green-500" :
                                        country.status === "in-progress" ? "bg-blue-500" : "bg-slate-400"
                                      }`}
                                      style={{width: `${country.progress}%`}}
                                    />
                                  </div>
                                  <span className="text-sm">{country.progress}%</span>
                                </div>
                              </td>
                              <td className="py-3">{Math.round(country.progress / 10) + 5}</td>
                              <td className="py-3 text-slate-500">Jan {15 + Math.floor(Math.random() * 5)}, 2024</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Users Tab */}
                {analyticsTab === "users" && (
                  <div className="space-y-6">
                    <div className="card">
                      <h3 className="font-semibold mb-4">ðŸ‘¥ User Performance Leaderboard</h3>
                      <table className="w-full">
                        <thead>
                          <tr className="border-b">
                            <th className="text-left py-2">Rank</th>
                            <th className="text-left py-2">User</th>
                            <th className="text-left py-2">Tasks</th>
                            <th className="text-left py-2">Avg Time</th>
                            <th className="text-left py-2">Accuracy</th>
                            <th className="text-left py-2">Trend</th>
                          </tr>
                        </thead>
                        <tbody>
                          {analyticsData.userPerformance.sort((a, b) => b.tasks - a.tasks).map((user, idx) => (
                            <tr key={user.name} className="border-b hover:bg-slate-50">
                              <td className="py-3">
                                {idx === 0 ? "ðŸ¥‡" : idx === 1 ? "ðŸ¥ˆ" : idx === 2 ? "ðŸ¥‰" : idx + 1}
                              </td>
                              <td className="py-3 font-medium">{user.name}</td>
                              <td className="py-3">{user.tasks}</td>
                              <td className="py-3">{user.avgTime} min</td>
                              <td className="py-3">
                                <span className={`font-semibold ${user.accuracy >= 90 ? "text-green-600" : user.accuracy >= 80 ? "text-amber-600" : "text-red-600"}`}>
                                  {user.accuracy}%
                                </span>
                              </td>
                              <td className="py-3">
                                <span className="text-green-500">â†‘</span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Errors Tab */}
                {analyticsTab === "errors" && (
                  <div className="space-y-6">
                    <div className="card">
                      <h3 className="font-semibold mb-4">âš ï¸ Common Errors & Issues</h3>
                      <div className="space-y-3">
                        {analyticsData.errorTrends.map((error, idx) => (
                          <div key={idx} className="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                            <div className="flex items-center gap-4">
                              <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                                error.trend === "up" ? "bg-red-100 text-red-600" :
                                error.trend === "down" ? "bg-green-100 text-green-600" : "bg-amber-100 text-amber-600"
                              }`}>
                                {error.trend === "up" ? "ðŸ“ˆ" : error.trend === "down" ? "ðŸ“‰" : "âž¡ï¸"}
                              </div>
                              <div>
                                <p className="font-medium">{error.type}</p>
                                <p className="text-sm text-slate-500">
                                  {error.trend === "up" ? "Increasing - needs attention" :
                                   error.trend === "down" ? "Decreasing - improving" : "Stable"}
                                </p>
                              </div>
                            </div>
                            <div className="text-right">
                              <p className="text-2xl font-bold">{error.count}</p>
                              <p className="text-sm text-slate-500">occurrences</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* TRAINING MODULE */}
            {phase === "working" && module === "training" && (
              <div className="max-w-5xl fade-in">
                {!trainingModule ? (
                  /* Course Selection */
                  <div>
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <h2 className="text-xl font-bold">ðŸŽ“ Training Center</h2>
                        <p className="text-slate-500">Interactive SAP tutorials and courses</p>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="badge badge-green">{trainingCompleted.length} completed</span>
                        <span className="badge badge-blue">{trainingCourses.length} courses</span>
                      </div>
                    </div>

                    {/* Progress Overview */}
                    <div className="card mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200">
                      <div className="flex items-center justify-between">
                        <div>
                          <h3 className="font-semibold text-blue-900">Your Learning Progress</h3>
                          <p className="text-blue-700">Complete courses to earn XP and master SAP skills</p>
                        </div>
                        <div className="text-right">
                          <p className="text-3xl font-bold text-blue-600">{Math.round(trainingCompleted.length / trainingCourses.length * 100)}%</p>
                          <p className="text-sm text-blue-500">{trainingCompleted.length}/{trainingCourses.length} courses</p>
                        </div>
                      </div>
                      <div className="mt-4 h-3 bg-blue-200 rounded-full overflow-hidden">
                        <div 
                          className="h-full bg-blue-500 transition-all duration-500"
                          style={{width: `${trainingCompleted.length / trainingCourses.length * 100}%`}}
                        />
                      </div>
                    </div>

                    {/* Course Grid */}
                    <div className="grid md:grid-cols-2 gap-4">
                      {trainingCourses.map(course => {
                        const isCompleted = trainingCompleted.includes(course.id);
                        return (
                          <div 
                            key={course.id}
                            className={`card cursor-pointer hover:shadow-lg transition-all border-2 ${
                              isCompleted ? "border-green-300 bg-green-50" : "border-transparent hover:border-blue-300"
                            }`}
                            onClick={() => {setTrainingModule(course); setTrainingStep(0);}}
                          >
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex items-center gap-3">
                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-2xl ${
                                  course.module === "FI" ? "bg-blue-100" :
                                  course.module === "MM" ? "bg-green-100" : "bg-amber-100"
                                }`}>
                                  {isCompleted ? "âœ…" : course.module === "FI" ? "ðŸ’°" : course.module === "MM" ? "ðŸ“¦" : "ðŸ—ï¸"}
                                </div>
                                <div>
                                  <h3 className="font-semibold">{course.title}</h3>
                                  <p className="text-sm text-slate-500">{course.description}</p>
                                </div>
                              </div>
                            </div>
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <span className={`badge ${
                                  course.module === "FI" ? "badge-blue" :
                                  course.module === "MM" ? "badge-green" : "badge-amber"
                                }`}>{course.module}</span>
                                <span className={`badge ${
                                  course.difficulty === "beginner" ? "badge-green" :
                                  course.difficulty === "intermediate" ? "badge-amber" : "badge-red"
                                }`}>{course.difficulty}</span>
                                <span className="text-xs text-slate-500">â±ï¸ {course.duration}</span>
                              </div>
                              <span className="text-yellow-600 font-semibold">+{course.xpReward} XP</span>
                            </div>
                            {isCompleted && (
                              <div className="mt-3 pt-3 border-t border-green-200 text-green-700 text-sm font-medium">
                                âœ… Completed
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ) : (
                  /* Active Training */
                  <div>
                    {/* Training Header */}
                    <div className="flex items-center justify-between mb-6">
                      <div>
                        <button 
                          onClick={() => setTrainingModule(null)}
                          className="text-slate-500 hover:text-slate-700 mb-2 flex items-center gap-1"
                        >
                          <Icon name="ArrowLeft" size={16} /> Back to courses
                        </button>
                        <h2 className="text-xl font-bold">{trainingModule.title}</h2>
                        <p className="text-slate-500">Step {trainingStep + 1} of {trainingModule.steps.length}</p>
                      </div>
                      <span className={`badge ${
                        trainingModule.module === "FI" ? "badge-blue" :
                        trainingModule.module === "MM" ? "badge-green" : "badge-amber"
                      }`}>{trainingModule.module} Module</span>
                    </div>

                    {/* Progress Bar */}
                    <div className="mb-6">
                      <div className="flex justify-between text-sm text-slate-500 mb-2">
                        <span>Progress</span>
                        <span>{Math.round((trainingStep + 1) / trainingModule.steps.length * 100)}%</span>
                      </div>
                      <div className="h-3 bg-slate-200 rounded-full overflow-hidden">
                        <div 
                          className="h-full bg-blue-500 transition-all duration-300"
                          style={{width: `${(trainingStep + 1) / trainingModule.steps.length * 100}%`}}
                        />
                      </div>
                      <div className="flex justify-between mt-2">
                        {trainingModule.steps.map((_, idx) => (
                          <div 
                            key={idx}
                            className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium cursor-pointer ${
                              idx < trainingStep ? "bg-green-500 text-white" :
                              idx === trainingStep ? "bg-blue-500 text-white" : "bg-slate-200 text-slate-500"
                            }`}
                            onClick={() => setTrainingStep(idx)}
                          >
                            {idx < trainingStep ? "âœ“" : idx + 1}
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Current Step */}
                    <div className="card border-2 border-blue-200">
                      <div className="flex items-center gap-4 mb-6">
                        <div className="w-16 h-16 rounded-xl bg-blue-100 flex items-center justify-center text-3xl">
                          {trainingModule.steps[trainingStep].image}
                        </div>
                        <div>
                          <h3 className="text-lg font-bold">{trainingModule.steps[trainingStep].title}</h3>
                          <p className="text-slate-600">{trainingModule.steps[trainingStep].instruction}</p>
                        </div>
                      </div>

                      {/* Tip Box */}
                      <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                        <div className="flex items-start gap-3">
                          <span className="text-2xl">ðŸ’¡</span>
                          <div>
                            <p className="font-semibold text-amber-800">Pro Tip</p>
                            <p className="text-amber-700">{trainingModule.steps[trainingStep].tip}</p>
                          </div>
                        </div>
                      </div>

                      {/* Navigation */}
                      <div className="flex items-center justify-between">
                        <button
                          onClick={() => setTrainingStep(Math.max(0, trainingStep - 1))}
                          disabled={trainingStep === 0}
                          className={`btn ${trainingStep === 0 ? "btn-secondary opacity-50" : "btn-secondary"}`}
                        >
                          <Icon name="ChevronLeft" size={16} className="mr-1" /> Previous
                        </button>

                        {trainingStep === trainingModule.steps.length - 1 ? (
                          <button
                            onClick={() => {
                              if (!trainingCompleted.includes(trainingModule.id)) {
                                setTrainingCompleted([...trainingCompleted, trainingModule.id]);
                                if (currentUser) {
                                  setUsers(users.map(u => u.id === currentUser.id ? {
                                    ...u, xp: u.xp + trainingModule.xpReward
                                  } : u));
                                  setCurrentUser({...currentUser, xp: currentUser.xp + trainingModule.xpReward});
                                }
                                alert(`ðŸŽ‰ Course completed! You earned ${trainingModule.xpReward} XP!`);
                              }
                              setTrainingModule(null);
                            }}
                            className="btn btn-success"
                          >
                            <Icon name="CheckCircle" size={16} className="mr-1" /> Complete Course
                          </button>
                        ) : (
                          <button
                            onClick={() => setTrainingStep(trainingStep + 1)}
                            className="btn btn-primary"
                          >
                            Next <Icon name="ChevronRight" size={16} className="ml-1" />
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* AUDIT TRAIL MODULE */}
            {phase === "working" && module === "audit" && (
              <div className="max-w-6xl fade-in">
                <div className="flex items-center justify-between mb-6">
                  <div>
                    <h2 className="text-xl font-bold">ðŸ“ Audit Trail</h2>
                    <p className="text-slate-500">Track all system changes and user actions</p>
                  </div>
                  <button 
                    onClick={() => {
                      const csvContent = "Timestamp,User,Action,Entity,Entity ID,Details,Module\n" +
                        auditTrail.map(a => `"${a.timestamp}","${a.user}","${a.action}","${a.entity}","${a.entityId}","${a.details}","${a.module}"`).join("\n");
                      const blob = new Blob([csvContent], {type: "text/csv"});
                      const url = URL.createObjectURL(blob);
                      const link = document.createElement("a");
                      link.href = url;
                      link.download = "audit_trail_" + new Date().toISOString().split("T")[0] + ".csv";
                      link.click();
                    }}
                    className="btn btn-primary"
                  >
                    <Icon name="Download" size={16} className="mr-2" /> Export CSV
                  </button>
                </div>

                {/* Filters */}
                <div className="card mb-6">
                  <div className="flex flex-wrap gap-4">
                    <div>
                      <label className="label">Action Type</label>
                      <select 
                        className="input w-40"
                        value={auditFilter.action}
                        onChange={e => setAuditFilter({...auditFilter, action: e.target.value})}
                      >
                        <option value="all">All Actions</option>
                        <option value="CREATE">Create</option>
                        <option value="UPDATE">Update</option>
                        <option value="DELETE">Delete</option>
                        <option value="COMPLETE">Complete</option>
                        <option value="CONFIG">Config Change</option>
                        <option value="HANDOVER">Handover</option>
                      </select>
                    </div>
                    <div>
                      <label className="label">Module</label>
                      <select 
                        className="input w-40"
                        value={auditFilter.module}
                        onChange={e => setAuditFilter({...auditFilter, module: e.target.value})}
                      >
                        <option value="all">All Modules</option>
                        <option value="FI">FI</option>
                        <option value="MM">MM</option>
                        <option value="AA">AA</option>
                        <option value="Tasks">Tasks</option>
                        <option value="Lessons">Lessons</option>
                        <option value="KB">Knowledge Base</option>
                        <option value="Admin">Admin</option>
                        <option value="Game">Game</option>
                      </select>
                    </div>
                    <div>
                      <label className="label">Date Range</label>
                      <select 
                        className="input w-40"
                        value={auditFilter.dateRange}
                        onChange={e => setAuditFilter({...auditFilter, dateRange: e.target.value})}
                      >
                        <option value="1d">Last 24 hours</option>
                        <option value="7d">Last 7 days</option>
                        <option value="30d">Last 30 days</option>
                        <option value="all">All time</option>
                      </select>
                    </div>
                  </div>
                </div>

                {/* Stats */}
                <div className="grid md:grid-cols-4 gap-4 mb-6">
                  <div className="card bg-blue-50 border border-blue-200">
                    <p className="text-sm text-blue-600">Total Actions</p>
                    <p className="text-2xl font-bold text-blue-700">{auditTrail.length}</p>
                  </div>
                  <div className="card bg-green-50 border border-green-200">
                    <p className="text-sm text-green-600">Creates</p>
                    <p className="text-2xl font-bold text-green-700">{auditTrail.filter(a => a.action === "CREATE").length}</p>
                  </div>
                  <div className="card bg-amber-50 border border-amber-200">
                    <p className="text-sm text-amber-600">Updates</p>
                    <p className="text-2xl font-bold text-amber-700">{auditTrail.filter(a => a.action === "UPDATE").length}</p>
                  </div>
                  <div className="card bg-red-50 border border-red-200">
                    <p className="text-sm text-red-600">Deletes</p>
                    <p className="text-2xl font-bold text-red-700">{auditTrail.filter(a => a.action === "DELETE").length}</p>
                  </div>
                </div>

                {/* Audit Log Table */}
                <div className="card">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b">
                        <th className="text-left py-3 px-2">Timestamp</th>
                        <th className="text-left py-3 px-2">User</th>
                        <th className="text-left py-3 px-2">Action</th>
                        <th className="text-left py-3 px-2">Entity</th>
                        <th className="text-left py-3 px-2">Details</th>
                        <th className="text-left py-3 px-2">Module</th>
                      </tr>
                    </thead>
                    <tbody>
                      {auditTrail
                        .filter(a => auditFilter.action === "all" || a.action === auditFilter.action)
                        .filter(a => auditFilter.module === "all" || a.module === auditFilter.module)
                        .map(audit => (
                        <tr key={audit.id} className="border-b hover:bg-slate-50">
                          <td className="py-3 px-2 text-sm text-slate-600 font-mono">{audit.timestamp}</td>
                          <td className="py-3 px-2">
                            <span className="font-medium">{audit.user}</span>
                          </td>
                          <td className="py-3 px-2">
                            <span className={`badge ${
                              audit.action === "CREATE" ? "badge-green" :
                              audit.action === "UPDATE" ? "badge-blue" :
                              audit.action === "DELETE" ? "badge-red" :
                              audit.action === "COMPLETE" ? "badge-green" :
                              audit.action === "CONFIG" ? "badge-purple" :
                              "badge-amber"
                            }`}>{audit.action}</span>
                          </td>
                          <td className="py-3 px-2">
                            <span className="text-sm">{audit.entity}</span>
                            <span className="text-xs text-slate-400 ml-1">({audit.entityId})</span>
                          </td>
                          <td className="py-3 px-2 text-sm text-slate-600 max-w-xs truncate" title={audit.details}>
                            {audit.details}
                          </td>
                          <td className="py-3 px-2">
                            <span className="badge badge-slate">{audit.module}</span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* ENHANCED FEATURES MODULE */}
            {phase === "working" && module === "enhanced" && (
              <div className="max-w-6xl fade-in">
                {/* Header */}
                <div className="card mb-6 bg-gradient-to-r from-purple-600 to-indigo-600 text-white">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-xl font-bold flex items-center gap-2">
                        <Icon name="Sparkles" size={24} /> Enhanced Features
                      </h2>
                      <p className="text-purple-200 mt-1">Smart Checklists, AI Insights, Flowcharts, Compliance & more</p>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className="px-3 py-1 rounded-full text-xs bg-white/20 text-white">v2.4.0</span>
                    </div>
                  </div>
                </div>

                {/* Feature Tabs */}
                <div className="flex gap-1 mb-6 border-b bg-white rounded-t-lg px-2 pt-2">
                  {[
                    {id: "checklist", label: "Smart Checklist", icon: "CheckSquare"},
                    {id: "flowchart", label: "Process Flow", icon: "GitBranch"},
                    {id: "ai", label: "AI Insights", icon: "Sparkles"},
                    {id: "compliance", label: "Compliance", icon: "Shield"},
                    {id: "export", label: "Export", icon: "Download"},
                    {id: "history", label: "Version History", icon: "History"}
                  ].map(tab => (
                    <button 
                      key={tab.id}
                      onClick={() => setEnhancedTab(tab.id)}
                      className={`tab flex items-center gap-1 ${enhancedTab === tab.id ? 'active' : ''}`}
                    >
                      <Icon name={tab.icon} size={14} /> {tab.label}
                    </button>
                  ))}
                </div>

                {/* Smart Checklist Tab */}
                {enhancedTab === "checklist" && (
                  <div className="card">
                    <SmartChecklist 
                      items={CHECKLIST_ITEMS}
                      projectData={projectDataForFeatures || {
                        budgetClass: "01",
                        projectCategory: "Capital",
                        businessArea: "6601",
                        netBudgetAUD: 5000000,
                        emShare: 100
                      }}
                      onItemChange={(item) => console.log('Checklist item changed:', item)}
                    />
                    <FeedbackSystem 
                      itemId="checklist"
                      itemType="feature"
                      onSubmit={(feedback) => console.log('Feedback:', feedback)}
                    />
                  </div>
                )}

                {/* Process Flow Tab */}
                {enhancedTab === "flowchart" && (
                  <div className="space-y-6">
                    <div className="card">
                      <InteractiveFlowchart 
                        nodes={FLOW_NODES}
                        activeStep="prereq"
                        onNodeClick={(node) => alert(`Step: ${node.label}\n\nClick to see details for this step.`)}
                      />
                    </div>
                    
                    {/* Decision Tree */}
                    <div className="card">
                      <h4 className="font-semibold mb-4 flex items-center gap-2">
                        <Icon name="GitMerge" size={18} className="text-amber-600" /> Approval Decision Tree
                      </h4>
                      <div className="space-y-4">
                        <div className="p-4 bg-slate-50 rounded-lg">
                          <div className="flex items-center gap-3 mb-3">
                            <span className="w-8 h-8 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center font-bold">1</span>
                            <span className="font-medium">What is the Budget Class?</span>
                          </div>
                          <div className="ml-11 grid md:grid-cols-4 gap-2">
                            {DEFAULT_CONFIG.project.budgetClasses.map(bc => (
                              <div key={bc.code} className="p-3 rounded-lg border border-slate-200 hover:border-blue-500 cursor-pointer">
                                <span className="font-mono text-sm font-bold">{bc.code}</span>
                                <p className="text-xs text-slate-600">{bc.name}</p>
                                {bc.requiresRuling && <span className="text-xs text-amber-600">âš ï¸ Fund.IT</span>}
                              </div>
                            ))}
                          </div>
                        </div>
                        
                        <div className="p-4 bg-slate-50 rounded-lg">
                          <div className="flex items-center gap-3 mb-3">
                            <span className="w-8 h-8 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center font-bold">2</span>
                            <span className="font-medium">What is the Net Budget (AUD)?</span>
                          </div>
                          <div className="ml-11 space-y-2">
                            <div className="p-2 rounded border border-green-300 bg-green-50">
                              <span className="text-sm">â‰¤ $3M AUD â†’ <strong>No Tax Review needed</strong></span>
                            </div>
                            <div className="p-2 rounded border border-amber-300 bg-amber-50">
                              <span className="text-sm">&gt; $3M AUD â†’ <strong>Tax Review Required</strong></span>
                            </div>
                            <div className="p-2 rounded border border-red-300 bg-red-50">
                              <span className="text-sm">&gt; $5M AUD â†’ <strong>Tax Review + JV Approval Required</strong></span>
                            </div>
                          </div>
                        </div>
                        
                        <div className="p-4 bg-slate-50 rounded-lg">
                          <div className="flex items-center gap-3 mb-3">
                            <span className="w-8 h-8 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center font-bold">3</span>
                            <span className="font-medium">Approval Level (Net USD)</span>
                          </div>
                          <div className="ml-11 overflow-x-auto">
                            <table className="text-sm w-full">
                              <thead>
                                <tr className="border-b bg-slate-100">
                                  <th className="text-left p-2">Level</th>
                                  <th className="text-left p-2">AC/FF Limit</th>
                                  <th className="text-left p-2">SUP</th>
                                </tr>
                              </thead>
                              <tbody>
                                {[
                                  {level: "1-4", limit: "Unlimited", sup: "Unlimited (L1-3), $50M (L4)"},
                                  {level: "5", limit: "$50M", sup: "$20M"},
                                  {level: "6", limit: "$20M", sup: "Not Authorized"},
                                  {level: "7", limit: "$5M", sup: "Not Authorized"},
                                  {level: "8", limit: "$1M", sup: "Not Authorized"},
                                  {level: "9", limit: "$500K", sup: "Not Authorized"},
                                  {level: "10", limit: "$100K", sup: "Not Authorized"}
                                ].map((row, i) => (
                                  <tr key={i} className="border-b hover:bg-blue-50">
                                    <td className="p-2 font-medium">Level {row.level}</td>
                                    <td className="p-2">{row.limit}</td>
                                    <td className="p-2">{row.sup}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* AI Insights Tab */}
                {enhancedTab === "ai" && (
                  <div className="grid lg:grid-cols-2 gap-6">
                    <AIInsights 
                      projectData={projectDataForFeatures || {grossBudget: 8000000, budgetClass: "01", emShare: 50}}
                      onSuggestion={(s) => console.log('Suggestion:', s)}
                    />
                    <div className="card">
                      <h3 className="font-semibold mb-4 flex items-center gap-2">
                        <Icon name="Settings" size={18} className="text-slate-600" /> Configure Analysis
                      </h3>
                      <p className="text-sm text-slate-600 mb-4">Set project parameters for AI analysis:</p>
                      <div className="space-y-4">
                        <div>
                          <label className="label">Gross Budget (AUD)</label>
                          <input 
                            type="number" 
                            className="input"
                            placeholder="e.g. 5000000"
                            onChange={(e) => setProjectDataForFeatures(prev => ({...prev, grossBudget: parseFloat(e.target.value) || 0}))}
                          />
                        </div>
                        <div>
                          <label className="label">Budget Class</label>
                          <select 
                            className="input"
                            onChange={(e) => setProjectDataForFeatures(prev => ({...prev, budgetClass: e.target.value}))}
                          >
                            <option value="01">01 - Drilling</option>
                            <option value="02">02 - Facilities</option>
                            <option value="03">03 - EMIT</option>
                            <option value="XF">XF - Decommissioning</option>
                          </select>
                        </div>
                        <div>
                          <label className="label">EM Share %</label>
                          <input 
                            type="number" 
                            className="input"
                            placeholder="e.g. 50"
                            onChange={(e) => setProjectDataForFeatures(prev => ({...prev, emShare: parseFloat(e.target.value) || 100}))}
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Compliance Tab */}
                {enhancedTab === "compliance" && (
                  <div className="grid lg:grid-cols-2 gap-6">
                    <ComplianceAudit 
                      score={75}
                      rules={[
                        {name: "Budget Approval Level", passed: true},
                        {name: "Prerequisites Complete", passed: false},
                        {name: "FCCR Document Attached", passed: true},
                        {name: "Tax Review (if >$3M)", passed: false}
                      ]}
                      auditLog={[
                        {ts: new Date().toISOString(), action: "Project Created", user: "john@company.com", type: "create"},
                        {ts: new Date(Date.now() - 3600000).toISOString(), action: "Budget Updated", user: "jane@company.com", type: "change"},
                        {ts: new Date(Date.now() - 7200000).toISOString(), action: "Level 6 Approved", user: "manager@company.com", type: "approval"}
                      ]}
                    />
                    <div className="card">
                      <h3 className="font-semibold mb-4 flex items-center gap-2">
                        <Icon name="ClipboardCheck" size={18} className="text-green-600" /> Compliance Checklist
                      </h3>
                      <div className="space-y-3">
                        {[
                          {name: "FCCR Approval Obtained", status: "done", critical: true},
                          {name: "Budget Form Attached", status: "done"},
                          {name: "All Prerequisites Verified", status: "pending"},
                          {name: "Approver Signatures Complete", status: "pending"},
                          {name: "Settlement Rule Configured", status: "na"}
                        ].map((item, i) => (
                          <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <div className="flex items-center gap-2">
                              <Icon 
                                name={item.status === 'done' ? 'CheckCircle' : item.status === 'na' ? 'MinusCircle' : 'Circle'} 
                                size={18} 
                                className={item.status === 'done' ? 'text-green-600' : item.status === 'na' ? 'text-slate-400' : 'text-slate-400'} 
                              />
                              <span className={item.status === 'na' ? 'text-slate-400' : ''}>{item.name}</span>
                              {item.critical && <span className="badge badge-red">Critical</span>}
                            </div>
                            {item.status === 'pending' && <button className="btn btn-sm btn-primary">Mark Complete</button>}
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* Export Tab */}
                {enhancedTab === "export" && (
                  <div className="grid lg:grid-cols-2 gap-6">
                    <ExportManager 
                      data={{checklist: CHECKLIST_ITEMS}}
                      projectData={projectDataForFeatures}
                      onExport={(result) => console.log('Exported:', result)}
                    />
                    <div className="card">
                      <h3 className="font-semibold mb-4 flex items-center gap-2">
                        <Icon name="FileBarChart" size={18} className="text-purple-600" /> Recent Exports
                      </h3>
                      <div className="space-y-3">
                        {[
                          {name: "Project 601/25001 Report", format: "PDF", date: "Today", size: "245 KB"},
                          {name: "Q4 Compliance Summary", format: "CSV", date: "Jan 10, 2025", size: "1.2 MB"},
                          {name: "Audit Trail Export", format: "JSON", date: "Jan 5, 2025", size: "89 KB"}
                        ].map((exp, i) => (
                          <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <div className="flex items-center gap-3">
                              <Icon name={exp.format === 'PDF' ? 'FileText' : exp.format === 'CSV' ? 'Table' : 'Code'} size={20} className="text-slate-400" />
                              <div>
                                <p className="font-medium text-sm">{exp.name}</p>
                                <p className="text-xs text-slate-500">{exp.date} â€¢ {exp.size}</p>
                              </div>
                            </div>
                            <button className="btn btn-secondary btn-sm">
                              <Icon name="Download" size={14} />
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}

                {/* Version History Tab */}
                {enhancedTab === "history" && (
                  <div className="max-w-2xl">
                    <VersionHistory 
                      versions={VERSION_HISTORY}
                      currentVersion="2.4.0"
                      onRestore={(v) => {
                        if (confirm(`Restore to version ${v.version}?`)) {
                          alert(`Restored to v${v.version}`);
                        }
                      }}
                    />
                  </div>
                )}
              </div>
            )}

            {/* ADMIN MODULE */}
            {phase === "working" && module === "admin" && (
              <div className="max-w-6xl fade-in">
                {/* Header */}
                <div className="card mb-6 bg-gradient-to-r from-slate-800 to-slate-900 text-white">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-xl font-bold flex items-center gap-2">
                        <Icon name="Settings" size={24} /> Admin Configuration
                      </h2>
                      <p className="text-slate-300 mt-1">Manage system settings, countries, thresholds, and approval levels</p>
                    </div>
                    <div className="flex items-center gap-2">
                      <span className={`px-3 py-1 rounded-full text-xs ${backendUrl ? "bg-green-500/20 text-green-300" : "bg-amber-500/20 text-amber-300"}`}>
                        {backendUrl ? "â— Online" : "â—‹ Offline"}
                      </span>
                    </div>
                  </div>
                </div>

                {/* Admin Tabs - Grouped */}
                <div className="card mb-6">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {/* System Settings */}
                    <div>
                      <p className="text-xs text-slate-500 font-semibold uppercase mb-2">System</p>
                      <div className="flex flex-col gap-1">
                        {[
                          {id: "settings", label: "Settings", icon: "Settings"},
                          {id: "deadlines", label: "Deadlines", icon: "Clock"}
                        ].map(tab => (
                          <button
                            key={tab.id}
                            onClick={() => setAdminTab(tab.id)}
                            className={`px-3 py-2 rounded-lg flex items-center gap-2 text-left text-sm transition-all ${
                              adminTab === tab.id 
                                ? 'bg-blue-600 text-white shadow-md' 
                                : 'bg-slate-50 hover:bg-slate-100 text-slate-700'
                            }`}
                          >
                            <Icon name={tab.icon} size={16} />
                            {tab.label}
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* Organization */}
                    <div>
                      <p className="text-xs text-slate-500 font-semibold uppercase mb-2">Organization</p>
                      <div className="flex flex-col gap-1">
                        {[
                          {id: "countries", label: "Countries", icon: "Globe"},
                          {id: "companyCodes", label: "Company Codes", icon: "Building2"},
                          {id: "jvCodes", label: "JV Codes", icon: "Users"},
                          {id: "businessAreas", label: "Business Areas", icon: "Briefcase"}
                        ].map(tab => (
                          <button
                            key={tab.id}
                            onClick={() => setAdminTab(tab.id)}
                            className={`px-3 py-2 rounded-lg flex items-center gap-2 text-left text-sm transition-all ${
                              adminTab === tab.id 
                                ? 'bg-blue-600 text-white shadow-md' 
                                : 'bg-slate-50 hover:bg-slate-100 text-slate-700'
                            }`}
                          >
                            <Icon name={tab.icon} size={16} />
                            {tab.label}
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* Finance & Approvals */}
                    <div>
                      <p className="text-xs text-slate-500 font-semibold uppercase mb-2">Finance & Approvals</p>
                      <div className="flex flex-col gap-1">
                        {[
                          {id: "budgetClasses", label: "Budget Classes", icon: "Wallet"},
                          {id: "aucTypes", label: "AUC Types", icon: "Package"},
                          {id: "localThresholds", label: "Thresholds", icon: "AlertTriangle"},
                          {id: "levelApproval", label: "Approval Levels", icon: "Shield"},
                          {id: "approvers", label: "Approvers", icon: "UserCheck"},
                          {id: "prerequisites", label: "Prerequisites", icon: "CheckSquare"}
                        ].map(tab => (
                          <button
                            key={tab.id}
                            onClick={() => setAdminTab(tab.id)}
                            className={`px-3 py-2 rounded-lg flex items-center gap-2 text-left text-sm transition-all ${
                              adminTab === tab.id 
                                ? 'bg-blue-600 text-white shadow-md' 
                                : 'bg-slate-50 hover:bg-slate-100 text-slate-700'
                            }`}
                          >
                            <Icon name={tab.icon} size={16} />
                            {tab.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Settings Tab */}
                {adminTab === "settings" && (
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Backend API Configuration */}
                    <div className="card">
                      <div className="flex items-center gap-2 mb-4">
                        <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                          <Icon name="Cloud" size={20} className="text-blue-600" />
                        </div>
                        <div>
                          <h3 className="font-semibold">Backend Connection</h3>
                          <p className="text-xs text-slate-500">Google Apps Script API</p>
                        </div>
                      </div>
                      
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium mb-1">Deployment URL</label>
                          <input 
                            type="text"
                            className="input w-full text-sm"
                            placeholder="https://script.google.com/macros/s/.../exec"
                            value={backendUrl}
                            onChange={e => setBackendUrl(e.target.value)}
                          />
                        </div>
                        
                        <div className="flex gap-2">
                          <button 
                            onClick={async () => {
                              if (!backendUrl) {
                                alert("Please enter a URL first");
                                return;
                              }
                              localStorage.setItem("sap_playbook_backend_url", backendUrl);
                              setBackendStatus("connected");
                              alert("âœ… URL saved!");
                            }}
                            className="btn btn-primary btn-sm flex-1"
                          >
                            <Icon name="Save" size={14} className="mr-1" /> Save
                          </button>
                          <button 
                            onClick={async () => {
                              try {
                                const result = await callBackend({action: "GET_SIGNATURE_STATS"});
                                if (result.success) {
                                  setBackendStatus("connected");
                                  alert("âœ… Connected!");
                                } else {
                                  alert("âš ï¸ Error: " + result.error);
                                }
                              } catch (e) {
                                setBackendStatus("disconnected");
                                alert("âŒ Failed: " + e.message);
                              }
                            }}
                            className="btn btn-secondary btn-sm"
                            disabled={!backendUrl}
                          >
                            <Icon name="Wifi" size={14} className="mr-1" /> Test
                          </button>
                        </div>
                        
                        <div className={`flex items-center gap-2 p-3 rounded-lg ${
                          backendStatus === "connected" ? "bg-green-50 text-green-700" :
                          backendStatus === "disconnected" ? "bg-red-50 text-red-700" :
                          "bg-slate-50 text-slate-600"
                        }`}>
                          <div className={`w-2 h-2 rounded-full ${
                            backendStatus === "connected" ? "bg-green-500" :
                            backendStatus === "disconnected" ? "bg-red-500" :
                            "bg-slate-400"
                          }`} />
                          <span className="text-sm font-medium">
                            {backendStatus === "connected" ? "Connected" :
                             backendStatus === "disconnected" ? "Disconnected" :
                             "Not configured"}
                          </span>
                        </div>
                        
                        {backendUrl && (
                          <button 
                            onClick={() => {
                              setBackendUrl("");
                              localStorage.removeItem("sap_playbook_backend_url");
                              setBackendStatus("unknown");
                            }}
                            className="text-sm text-red-500 hover:text-red-700"
                          >
                            Clear URL
                          </button>
                        )}
                      </div>
                    </div>
                    
                    {/* Initialize Sheets */}
                    <div className="card">
                      <div className="flex items-center gap-2 mb-4">
                        <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                          <Icon name="Database" size={20} className="text-green-600" />
                        </div>
                        <div>
                          <h3 className="font-semibold">Initialize Database</h3>
                          <p className="text-xs text-slate-500">Create Google Sheets tables</p>
                        </div>
                      </div>
                      
                      <p className="text-sm text-slate-600 mb-4">
                        Run these commands once after deploying your backend to create the required sheets.
                      </p>
                      
                      <div className="space-y-2">
                        <button 
                          onClick={() => callBackend({action: "INIT_ALL_SHEETS"}).then(r => {
                            if (r.success) alert("âœ… All sheets created!");
                            else alert("Error: " + r.error);
                          }).catch(e => alert("Failed: " + e.message))}
                          className="btn btn-success w-full justify-center"
                          disabled={!backendUrl}
                        >
                          <Icon name="Database" size={16} className="mr-2" /> Initialize All Sheets
                        </button>
                        
                        <div className="grid grid-cols-2 gap-2">
                          <button 
                            onClick={() => callBackend({action: "INIT_CONFIG_SHEETS"}).then(r => {
                              if (r.success) alert("âœ… Config sheets created!");
                              else alert("Error: " + r.error);
                            }).catch(e => alert("Failed: " + e.message))}
                            className="btn btn-secondary btn-sm"
                            disabled={!backendUrl}
                          >
                            Config Only
                          </button>
                          <button 
                            onClick={() => callBackend({action: "INIT_SIGNATURE_SHEETS"}).then(r => {
                              if (r.success) alert("âœ… Signature sheets created!");
                              else alert("Error: " + r.error);
                            }).catch(e => alert("Failed: " + e.message))}
                            className="btn btn-secondary btn-sm"
                            disabled={!backendUrl}
                          >
                            Signatures Only
                          </button>
                        </div>
                      </div>
                      
                      {!backendUrl && (
                        <p className="text-amber-600 text-sm mt-4 flex items-center gap-1">
                          <Icon name="AlertCircle" size={14} /> Configure backend URL first
                        </p>
                      )}
                    </div>
                    
                    {/* App Info */}
                    <div className="card lg:col-span-2">
                      <div className="flex items-center gap-2 mb-4">
                        <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                          <Icon name="Info" size={20} className="text-purple-600" />
                        </div>
                        <div>
                          <h3 className="font-semibold">Application Info</h3>
                          <p className="text-xs text-slate-500">System status and details</p>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="p-3 bg-slate-50 rounded-lg">
                          <p className="text-xs text-slate-500">Version</p>
                          <p className="font-semibold">1.0.0</p>
                        </div>
                        <div className="p-3 bg-slate-50 rounded-lg">
                          <p className="text-xs text-slate-500">Mode</p>
                          <p className="font-semibold">{backendUrl ? "ðŸŸ¢ Online" : "ðŸ”´ Offline"}</p>
                        </div>
                        <div className="p-3 bg-slate-50 rounded-lg">
                          <p className="text-xs text-slate-500">Country</p>
                          <p className="font-semibold">{selectedCountry?.flag} {selectedCountry?.id || "Australia"}</p>
                        </div>
                        <div className="p-3 bg-slate-50 rounded-lg">
                          <p className="text-xs text-slate-500">User</p>
                          <p className="font-semibold">{currentUser?.displayName || "Guest"}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Deadlines Tab */}
                {adminTab === "deadlines" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">â° Deadline Reminders</h3>
                      <button className="btn btn-primary btn-sm" onClick={() => setShowAddDeadline(true)}>
                        <Icon name="Plus" size={14} className="mr-1" /> Add Deadline
                      </button>
                    </div>
                    
                    <div className="space-y-3">
                      {deadlines.sort((a, b) => new Date(a.date) - new Date(b.date)).map(deadline => {
                        const dDate = new Date(deadline.date);
                        const today = new Date();
                        const diffDays = Math.ceil((dDate - today) / (1000 * 60 * 60 * 24));
                        const isPast = diffDays < 0;
                        const isUrgent = diffDays >= 0 && diffDays <= 3;
                        
                        return (
                          <div key={deadline.id} className={`p-4 rounded-lg border ${
                            isPast ? "bg-slate-50 border-slate-200 opacity-60" :
                            isUrgent ? "bg-red-50 border-red-200" : "bg-white"
                          }`}>
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-3">
                                <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                                  deadline.priority === "critical" ? "bg-red-100 text-red-600" :
                                  deadline.priority === "high" ? "bg-amber-100 text-amber-600" :
                                  "bg-blue-100 text-blue-600"
                                }`}>
                                  <Icon name="Calendar" size={20} />
                                </div>
                                <div>
                                  <h4 className="font-semibold">{deadline.title}</h4>
                                  <p className="text-sm text-slate-500">{deadline.description}</p>
                                </div>
                              </div>
                              <div className="text-right">
                                <p className="font-medium">{deadline.date}</p>
                                <p className={`text-sm ${
                                  isPast ? "text-slate-400" :
                                  isUrgent ? "text-red-600 font-semibold" : "text-slate-500"
                                }`}>
                                  {isPast ? "Past" : diffDays === 0 ? "Today!" : diffDays === 1 ? "Tomorrow" : `${diffDays} days left`}
                                </p>
                              </div>
                            </div>
                            <div className="flex items-center justify-between mt-3 pt-3 border-t">
                              <div className="flex items-center gap-2">
                                <span className={`badge ${
                                  deadline.priority === "critical" ? "badge-red" :
                                  deadline.priority === "high" ? "badge-amber" : "badge-blue"
                                }`}>{deadline.priority}</span>
                                <span className="badge badge-slate">{deadline.module}</span>
                                {deadline.type === "recurring" && (
                                  <span className="badge badge-green">ðŸ” {deadline.recurring}</span>
                                )}
                              </div>
                              <button 
                                onClick={() => setDeadlines(deadlines.filter(d => d.id !== deadline.id))}
                                className="text-slate-400 hover:text-red-500"
                              >
                                <Icon name="Trash2" size={16} />
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>

                    {/* Add Deadline Modal */}
                    {showAddDeadline && (
                      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg m-4">
                          <div className="p-6 border-b">
                            <div className="flex items-center justify-between">
                              <h3 className="text-lg font-bold">Add Deadline Reminder</h3>
                              <button onClick={() => setShowAddDeadline(false)} className="text-slate-400 hover:text-slate-600">
                                <Icon name="X" size={24} />
                              </button>
                            </div>
                          </div>
                          <div className="p-6 space-y-4">
                            <div>
                              <label className="label">Title *</label>
                              <input 
                                className="input" 
                                placeholder="e.g., Month-End Close"
                                value={newDeadline.title}
                                onChange={e => setNewDeadline({...newDeadline, title: e.target.value})}
                              />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="label">Date *</label>
                                <input 
                                  className="input" 
                                  type="date"
                                  value={newDeadline.date}
                                  onChange={e => setNewDeadline({...newDeadline, date: e.target.value})}
                                />
                              </div>
                              <div>
                                <label className="label">Priority</label>
                                <select className="input" value={newDeadline.priority} onChange={e => setNewDeadline({...newDeadline, priority: e.target.value})}>
                                  <option value="critical">ðŸ”´ Critical</option>
                                  <option value="high">ðŸŸ¡ High</option>
                                  <option value="medium">ðŸ”µ Medium</option>
                                </select>
                              </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="label">Module</label>
                                <select className="input" value={newDeadline.module} onChange={e => setNewDeadline({...newDeadline, module: e.target.value})}>
                                  <option value="FI">FI - Finance</option>
                                  <option value="MM">MM - Materials</option>
                                  <option value="AA">AA - Assets</option>
                                  <option value="General">General</option>
                                </select>
                              </div>
                              <div>
                                <label className="label">Type</label>
                                <select className="input" value={newDeadline.type} onChange={e => setNewDeadline({...newDeadline, type: e.target.value})}>
                                  <option value="one-time">One-time</option>
                                  <option value="recurring">Recurring</option>
                                </select>
                              </div>
                            </div>
                            <div>
                              <label className="label">Description</label>
                              <textarea 
                                className="input" 
                                rows={2}
                                placeholder="Additional details..."
                                value={newDeadline.description}
                                onChange={e => setNewDeadline({...newDeadline, description: e.target.value})}
                              />
                            </div>
                          </div>
                          <div className="p-6 border-t bg-slate-50 flex justify-end gap-2">
                            <button onClick={() => setShowAddDeadline(false)} className="btn btn-secondary">Cancel</button>
                            <button 
                              onClick={() => {
                                if (!newDeadline.title || !newDeadline.date) {
                                  alert("Please fill in title and date");
                                  return;
                                }
                                setDeadlines([...deadlines, {
                                  ...newDeadline,
                                  id: "DL-" + String(deadlines.length + 1).padStart(3, "0")
                                }]);
                                setNewDeadline({title: "", date: "", type: "one-time", priority: "medium", description: "", module: "FI"});
                                setShowAddDeadline(false);
                              }}
                              className="btn btn-primary"
                            >
                              Add Deadline
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Countries Tab */}
                {adminTab === "countries" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">Countries Configuration</h3>
                      <button className="btn btn-primary btn-sm" onClick={() => setNewRow({active: true})}>
                        <Icon name="Plus" size={14} className="mr-1" /> Add Country
                      </button>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b bg-slate-50">
                            <th className="text-left p-3">Country</th>
                            <th className="text-left p-3">Region</th>
                            <th className="text-left p-3">Currency</th>
                            <th className="text-left p-3">SAP System</th>
                            <th className="text-left p-3">Exchange Rate (to USD)</th>
                            <th className="text-left p-3">Last Updated</th>
                            <th className="text-left p-3">Active</th>
                            <th className="text-left p-3">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr className="border-b hover:bg-slate-50">
                            <td className="p-3"><span className="mr-2">ðŸ‡¦ðŸ‡º</span> Australia</td>
                            <td className="p-3">APAC</td>
                            <td className="p-3">AUD</td>
                            <td className="p-3">G3P / 500</td>
                            <td className="p-3">
                              <input type="number" step="0.01" className="input w-24 py-1" defaultValue="1.59" />
                            </td>
                            <td className="p-3">2025-01-01</td>
                            <td className="p-3"><span className="badge badge-green">Active</span></td>
                            <td className="p-3">
                              <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icon name="Edit" size={16} /></button>
                              <button className="p-1 text-amber-600 hover:bg-amber-50 rounded ml-1"><Icon name="RefreshCw" size={16} /></button>
                            </td>
                          </tr>
                          {newRow.active !== undefined && (
                            <tr className="border-b bg-blue-50">
                              <td className="p-3">
                                <div className="flex gap-2">
                                  <input className="input py-1 w-12" placeholder="ðŸ³ï¸" />
                                  <input className="input py-1 flex-1" placeholder="Country Name" />
                                </div>
                              </td>
                              <td className="p-3"><input className="input py-1 w-20" placeholder="APAC" /></td>
                              <td className="p-3"><input className="input py-1 w-16" placeholder="USD" /></td>
                              <td className="p-3"><input className="input py-1 w-24" placeholder="G3P/500" /></td>
                              <td className="p-3"><input className="input py-1 w-20" type="number" placeholder="1.00" /></td>
                              <td className="p-3">-</td>
                              <td className="p-3"><input type="checkbox" defaultChecked /></td>
                              <td className="p-3">
                                <button className="btn btn-primary btn-sm mr-1">Save</button>
                                <button className="btn btn-secondary btn-sm" onClick={() => setNewRow({})}>Cancel</button>
                              </td>
                            </tr>
                          )}
                        </tbody>
                      </table>
                    </div>
                    <p className="text-xs text-slate-400 mt-4">ðŸ’¡ Exchange rate updates should be done on 1 Jan and 1 July (DOAG schedule)</p>
                  </div>
                )}

                {/* Company Codes Tab */}
                {adminTab === "companyCodes" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">Company Codes</h3>
                      <button className="btn btn-primary btn-sm"><Icon name="Plus" size={14} className="mr-1" /> Add Company Code</button>
                    </div>
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b bg-slate-50">
                          <th className="text-left p-3">Country</th>
                          <th className="text-left p-3">Company Code</th>
                          <th className="text-left p-3">Name</th>
                          <th className="text-left p-3">Description</th>
                          <th className="text-left p-3">Default</th>
                          <th className="text-left p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          {country: "Australia", code: "1230", name: "Main Entity (EMOP)", desc: "Primary operating entity", default: true},
                          {country: "Australia", code: "0495", name: "Secondary Entity", desc: "Secondary entity", default: false},
                          {country: "Australia", code: "4310", name: "OBO Entity", desc: "Operated by Others", default: false}
                        ].map((row, i) => (
                          <tr key={i} className="border-b hover:bg-slate-50">
                            <td className="p-3">ðŸ‡¦ðŸ‡º {row.country}</td>
                            <td className="p-3 font-mono">{row.code}</td>
                            <td className="p-3">{row.name}</td>
                            <td className="p-3 text-slate-500">{row.desc}</td>
                            <td className="p-3">{row.default ? <span className="badge badge-blue">Default</span> : ""}</td>
                            <td className="p-3">
                              <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icon name="Edit" size={16} /></button>
                              <button className="p-1 text-red-600 hover:bg-red-50 rounded ml-1"><Icon name="Trash2" size={16} /></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}

                {/* JV Codes Tab */}
                {adminTab === "jvCodes" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">JV Codes (Linked to Company Codes)</h3>
                      <button className="btn btn-primary btn-sm"><Icon name="Plus" size={14} className="mr-1" /> Add JV Code</button>
                    </div>
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b bg-slate-50">
                          <th className="text-left p-3">Country</th>
                          <th className="text-left p-3">Company Code</th>
                          <th className="text-left p-3">JV Code</th>
                          <th className="text-left p-3">JV Name</th>
                          <th className="text-left p-3">EM Share %</th>
                          <th className="text-left p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          {country: "Australia", companyCode: "1230", jvCode: "AU001", name: "JV Partner A", emShare: 50},
                          {country: "Australia", companyCode: "1230", jvCode: "AU002", name: "JV Partner B", emShare: 20},
                          {country: "Australia", companyCode: "1230", jvCode: "AU003", name: "EM Sole Risk", emShare: 100},
                          {country: "Australia", companyCode: "0495", jvCode: "AU004", name: "EM Sole Risk", emShare: 100},
                          {country: "Australia", companyCode: "4310", jvCode: "AU005", name: "OBO EM Sole Risk", emShare: 100}
                        ].map((row, i) => (
                          <tr key={i} className="border-b hover:bg-slate-50">
                            <td className="p-3">ðŸ‡¦ðŸ‡º {row.country}</td>
                            <td className="p-3 font-mono">{row.companyCode}</td>
                            <td className="p-3 font-mono font-semibold">{row.jvCode}</td>
                            <td className="p-3">{row.name}</td>
                            <td className="p-3">
                              <span className={`badge ${row.emShare === 100 ? 'badge-green' : row.emShare >= 50 ? 'badge-blue' : 'badge-amber'}`}>
                                {row.emShare}%
                              </span>
                            </td>
                            <td className="p-3">
                              <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icon name="Edit" size={16} /></button>
                              <button className="p-1 text-red-600 hover:bg-red-50 rounded ml-1"><Icon name="Trash2" size={16} /></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <p className="text-xs text-slate-400 mt-4">ðŸ’¡ JV Codes determine the EM Share % used for budget Net calculation</p>
                  </div>
                )}

                {/* Business Areas Tab */}
                {adminTab === "businessAreas" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">Business Areas</h3>
                      <button className="btn btn-primary btn-sm"><Icon name="Plus" size={14} className="mr-1" /> Add Business Area</button>
                    </div>
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b bg-slate-50">
                          <th className="text-left p-3">Country</th>
                          <th className="text-left p-3">Code</th>
                          <th className="text-left p-3">Name</th>
                          <th className="text-left p-3">Description</th>
                          <th className="text-left p-3">Auto Recovery</th>
                          <th className="text-left p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          {country: "Australia", code: "6601", name: "EMOP", desc: "Exploration & Major Offshore Projects", autoRecovery: ""},
                          {country: "Australia", code: "6602", name: "OBO", desc: "Operated by Others", autoRecovery: "NB"}
                        ].map((row, i) => (
                          <tr key={i} className="border-b hover:bg-slate-50">
                            <td className="p-3">ðŸ‡¦ðŸ‡º {row.country}</td>
                            <td className="p-3 font-mono">{row.code}</td>
                            <td className="p-3 font-semibold">{row.name}</td>
                            <td className="p-3 text-slate-500">{row.desc}</td>
                            <td className="p-3">
                              {row.autoRecovery ? <span className="badge badge-amber">{row.autoRecovery} (Auto)</span> : <span className="text-slate-400">-</span>}
                            </td>
                            <td className="p-3">
                              <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icon name="Edit" size={16} /></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <p className="text-xs text-slate-400 mt-4">ðŸ’¡ Auto Recovery: When selected, Recovery Indicator is automatically set (e.g., OBO â†’ NB)</p>
                  </div>
                )}

                {/* Budget Classes Tab */}
                {adminTab === "budgetClasses" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">Budget Classes</h3>
                      <button className="btn btn-primary btn-sm"><Icon name="Plus" size={14} className="mr-1" /> Add Budget Class</button>
                    </div>
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b bg-slate-50">
                          <th className="text-left p-3">Country</th>
                          <th className="text-left p-3">Code</th>
                          <th className="text-left p-3">Name</th>
                          <th className="text-left p-3">Category</th>
                          <th className="text-left p-3">Country Prefix</th>
                          <th className="text-left p-3">Requires Ruling</th>
                          <th className="text-left p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          {country: "Australia", code: "01", name: "Drilling", category: "Capital", prefix: "6", ruling: false},
                          {country: "Australia", code: "02", name: "Facilities", category: "Capital", prefix: "6", ruling: false},
                          {country: "Australia", code: "03", name: "EMIT", category: "Capital", prefix: "6", ruling: true},
                          {country: "Australia", code: "XF", name: "Decommissioning", category: "Decommissioning", prefix: "6", ruling: false}
                        ].map((row, i) => (
                          <tr key={i} className="border-b hover:bg-slate-50">
                            <td className="p-3">ðŸ‡¦ðŸ‡º {row.country}</td>
                            <td className="p-3 font-mono font-semibold">{row.code}</td>
                            <td className="p-3">{row.name}</td>
                            <td className="p-3">
                              <span className={`badge ${row.category === "Capital" ? "badge-blue" : "badge-amber"}`}>{row.category}</span>
                            </td>
                            <td className="p-3 font-mono">{row.prefix}</td>
                            <td className="p-3">
                              {row.ruling ? <span className="badge badge-red">Yes âš ï¸</span> : <span className="text-slate-400">No</span>}
                            </td>
                            <td className="p-3">
                              <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icon name="Edit" size={16} /></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <p className="text-xs text-slate-400 mt-4">ðŸ’¡ Requires Ruling: EMIT (03) needs CAPEX/OPEX ruling from Fund.IT before project creation</p>
                  </div>
                )}

                {/* AUC Types Tab */}
                {adminTab === "aucTypes" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">AUC Types (Asset Under Construction)</h3>
                      <button className="btn btn-primary btn-sm"><Icon name="Plus" size={14} className="mr-1" /> Add AUC Type</button>
                    </div>
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b bg-slate-50">
                          <th className="text-left p-3">Country</th>
                          <th className="text-left p-3">AUC Type</th>
                          <th className="text-left p-3">Budget Class</th>
                          <th className="text-left p-3">Project Stages</th>
                          <th className="text-left p-3">GL Account</th>
                          <th className="text-left p-3">Description</th>
                          <th className="text-left p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          {country: "Australia", code: "INTANG_WELL", name: "Intangible Wells", budgetClass: "01", stages: "PRE, APR", gl: "1400100", desc: "Exploration & appraisal wells"},
                          {country: "Australia", code: "TANG_WELL", name: "Tangible Wells", budgetClass: "01", stages: "DEV, PRD", gl: "1400200", desc: "Development & production wells"},
                          {country: "Australia", code: "INFRA", name: "Infrastructure", budgetClass: "02", stages: "DEV, PRD", gl: "1400300", desc: "Platforms, pipelines, facilities"},
                          {country: "Australia", code: "PPE", name: "PPE", budgetClass: "02", stages: "DEV, PRD", gl: "1400400", desc: "Plant, Property & Equipment"},
                          {country: "Australia", code: "SOFTWARE", name: "Software", budgetClass: "03", stages: "All", gl: "1400500", desc: "Software licenses and development"},
                          {country: "Australia", code: "COMPUTER", name: "Computer", budgetClass: "03", stages: "All", gl: "1400600", desc: "Hardware, servers, network"},
                          {country: "Australia", code: "VEHICLE", name: "Vehicles", budgetClass: "03", stages: "All", gl: "1400700", desc: "Transport and mobile equipment"},
                          {country: "Australia", code: "DECOM", name: "Decommissioning", budgetClass: "XF", stages: "All", gl: "1400800", desc: "Asset retirement obligations"}
                        ].map((row, i) => (
                          <tr key={i} className="border-b hover:bg-slate-50">
                            <td className="p-3">ðŸ‡¦ðŸ‡º {row.country}</td>
                            <td className="p-3">
                              <p className="font-semibold">{row.name}</p>
                              <p className="text-xs text-slate-400 font-mono">{row.code}</p>
                            </td>
                            <td className="p-3">
                              <span className={`badge ${row.budgetClass === "01" ? "badge-blue" : row.budgetClass === "02" ? "badge-green" : row.budgetClass === "03" ? "badge-purple" : "badge-amber"}`}>
                                {row.budgetClass}
                              </span>
                            </td>
                            <td className="p-3 text-sm">{row.stages}</td>
                            <td className="p-3 font-mono text-sm">{row.gl}</td>
                            <td className="p-3 text-sm text-slate-500">{row.desc}</td>
                            <td className="p-3">
                              <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icon name="Edit" size={16} /></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                      <h4 className="font-semibold text-blue-800 mb-2">ðŸ“‹ AUC Type Mapping Logic</h4>
                      <div className="grid md:grid-cols-2 gap-4 text-sm">
                        <div>
                          <p className="font-medium">Drilling (01):</p>
                          <ul className="text-slate-600 ml-4">
                            <li>â€¢ PRE/APR stages â†’ <strong>Intangible Wells</strong></li>
                            <li>â€¢ DEV/PRD stages â†’ <strong>Tangible Wells</strong></li>
                          </ul>
                        </div>
                        <div>
                          <p className="font-medium">Facilities (02):</p>
                          <ul className="text-slate-600 ml-4">
                            <li>â€¢ DEV/PRD stages â†’ <strong>Infrastructure</strong> or <strong>PPE</strong></li>
                          </ul>
                        </div>
                        <div>
                          <p className="font-medium">EMIT (03):</p>
                          <ul className="text-slate-600 ml-4">
                            <li>â€¢ Any stage â†’ <strong>Software</strong>, <strong>Computer</strong>, or <strong>Vehicles</strong></li>
                          </ul>
                        </div>
                        <div>
                          <p className="font-medium">Decommissioning (XF):</p>
                          <ul className="text-slate-600 ml-4">
                            <li>â€¢ Any stage â†’ <strong>Decommissioning</strong></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Local Thresholds Tab */}
                {adminTab === "localThresholds" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">Local Thresholds (Country-Specific, Local Currency)</h3>
                      <button className="btn btn-primary btn-sm"><Icon name="Plus" size={14} className="mr-1" /> Add Threshold</button>
                    </div>
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b bg-slate-50">
                          <th className="text-left p-3">Country</th>
                          <th className="text-left p-3">Type</th>
                          <th className="text-left p-3">Stage</th>
                          <th className="text-left p-3">Threshold</th>
                          <th className="text-left p-3">Currency</th>
                          <th className="text-left p-3">Approver</th>
                          <th className="text-left p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          {country: "Australia", type: "TAX_REVIEW", stage: "", threshold: 3000000, currency: "AUD", approver: "Tax Team"},
                          {country: "Australia", type: "JV_APPROVAL", stage: "", threshold: 5000000, currency: "AUD", approver: "JV Partners"},
                          {country: "Australia", type: "OBO_THRESHOLD", stage: "PRE", threshold: 2500000, currency: "AUD", approver: "JV/OBO Partners"},
                          {country: "Australia", type: "OBO_THRESHOLD", stage: "APR", threshold: 5000000, currency: "AUD", approver: "JV/OBO Partners"},
                          {country: "Australia", type: "OBO_THRESHOLD", stage: "DEV", threshold: 5000000, currency: "AUD", approver: "JV/OBO Partners"},
                          {country: "Australia", type: "OBO_THRESHOLD", stage: "PRD", threshold: 5000000, currency: "AUD", approver: "JV/OBO Partners"}
                        ].map((row, i) => (
                          <tr key={i} className="border-b hover:bg-slate-50">
                            <td className="p-3">ðŸ‡¦ðŸ‡º {row.country}</td>
                            <td className="p-3">
                              <span className={`badge ${row.type === "TAX_REVIEW" ? "badge-amber" : row.type === "JV_APPROVAL" ? "badge-blue" : "badge-purple"}`}>
                                {row.type.replace("_", " ")}
                              </span>
                            </td>
                            <td className="p-3">{row.stage || "-"}</td>
                            <td className="p-3">
                              <input type="number" className="input py-1 w-32 text-right" defaultValue={row.threshold} />
                            </td>
                            <td className="p-3">{row.currency}</td>
                            <td className="p-3">{row.approver}</td>
                            <td className="p-3">
                              <button className="p-1 text-green-600 hover:bg-green-50 rounded"><Icon name="Save" size={16} /></button>
                              <button className="p-1 text-red-600 hover:bg-red-50 rounded ml-1"><Icon name="Trash2" size={16} /></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <p className="text-xs text-slate-400 mt-4">ðŸ’¡ These thresholds are in LOCAL currency and apply to Net Budget (EM portion)</p>
                  </div>
                )}

                {/* Level Approval Tab */}
                {adminTab === "levelApproval" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">Level Approval Thresholds (Global - USD)</h3>
                    </div>
                    <div className="grid md:grid-cols-3 gap-6">
                      {/* AC/FF */}
                      <div>
                        <h4 className="font-semibold mb-3 text-blue-600">AC / FF (Advance Commitment / Full Funding)</h4>
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b bg-slate-50">
                              <th className="text-left p-2">Level</th>
                              <th className="text-left p-2">Max USD</th>
                              <th className="text-left p-2">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {[
                              {level: "1-4", max: "Unlimited", status: "unlimited"},
                              {level: "5", max: "$50,000,000", status: "authorized"},
                              {level: "6", max: "$20,000,000", status: "authorized"},
                              {level: "7", max: "$5,000,000", status: "authorized"},
                              {level: "8", max: "$1,000,000", status: "authorized"},
                              {level: "9", max: "$500,000", status: "authorized"},
                              {level: "10", max: "$100,000", status: "authorized"}
                            ].map((row, i) => (
                              <tr key={i} className="border-b">
                                <td className="p-2 font-semibold">Level {row.level}</td>
                                <td className="p-2">{row.max}</td>
                                <td className="p-2">
                                  <span className={`badge ${row.status === "unlimited" ? "badge-purple" : "badge-green"}`}>
                                    {row.status === "unlimited" ? "âˆž" : "âœ“"}
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      {/* SUP */}
                      <div>
                        <h4 className="font-semibold mb-3 text-amber-600">SUP (Supplement)</h4>
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="border-b bg-slate-50">
                              <th className="text-left p-2">Level</th>
                              <th className="text-left p-2">Max USD</th>
                              <th className="text-left p-2">Status</th>
                            </tr>
                          </thead>
                          <tbody>
                            {[
                              {level: "1-3", max: "Unlimited", status: "unlimited"},
                              {level: "4", max: "$50,000,000", status: "authorized"},
                              {level: "5", max: "$20,000,000", status: "authorized"},
                              {level: "6", max: "-", status: "notAuthorized"},
                              {level: "7", max: "-", status: "notAuthorized"},
                              {level: "8", max: "-", status: "notAuthorized"},
                              {level: "9", max: "-", status: "notAuthorized"},
                              {level: "10", max: "-", status: "notAuthorized"}
                            ].map((row, i) => (
                              <tr key={i} className="border-b">
                                <td className="p-2 font-semibold">Level {row.level}</td>
                                <td className="p-2">{row.max}</td>
                                <td className="p-2">
                                  <span className={`badge ${row.status === "unlimited" ? "badge-purple" : row.status === "authorized" ? "badge-green" : "badge-red"}`}>
                                    {row.status === "unlimited" ? "âˆž" : row.status === "authorized" ? "âœ“" : "âŒ"}
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      {/* Info */}
                      <div className="bg-blue-50 p-4 rounded-lg">
                        <h4 className="font-semibold mb-3">â„¹ï¸ How It Works</h4>
                        <ul className="text-sm space-y-2 text-slate-600">
                          <li>â€¢ Level 1 = Highest authority</li>
                          <li>â€¢ Level 10 = Lowest authority</li>
                          <li>â€¢ Thresholds are in <strong>USD</strong></li>
                          <li>â€¢ Applied to <strong>Net Budget</strong> (EM portion)</li>
                          <li>â€¢ Local currency converted to USD using exchange rate</li>
                          <li>â€¢ SUP Level 6-10 cannot approve supplements</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                )}

                {/* Approvers Tab */}
                {adminTab === "approvers" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">Approvers Directory</h3>
                      <div className="flex gap-2">
                        <select className="input py-1 w-32">
                          <option value="">All Levels</option>
                          {[1,2,3,4,5,6,7,8,9,10].map(l => <option key={l} value={l}>Level {l}</option>)}
                        </select>
                        <select className="input py-1 w-40">
                          <option value="">All Countries</option>
                          <option value="Australia">Australia</option>
                          <option value="Malaysia">Malaysia</option>
                          <option value="APAC">APAC</option>
                          <option value="Global">Global</option>
                        </select>
                        <button className="btn btn-primary btn-sm"><Icon name="Plus" size={14} className="mr-1" /> Add Approver</button>
                      </div>
                    </div>
                    
                    {/* Summary by Level */}
                    <div className="grid grid-cols-10 gap-2 mb-6">
                      {[1,2,3,4,5,6,7,8,9,10].map(level => (
                        <div key={level} className={`text-center p-2 rounded-lg ${level <= 4 ? 'bg-red-50' : level <= 7 ? 'bg-amber-50' : 'bg-green-50'}`}>
                          <p className="text-xs text-slate-500">L{level}</p>
                          <p className="font-bold text-lg">{5}</p>
                        </div>
                      ))}
                    </div>
                    
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b bg-slate-50">
                            <th className="text-left p-3">ID</th>
                            <th className="text-left p-3">Name</th>
                            <th className="text-left p-3">Email</th>
                            <th className="text-left p-3">Country</th>
                            <th className="text-left p-3">Level</th>
                            <th className="text-left p-3">Department</th>
                            <th className="text-left p-3">Title</th>
                            <th className="text-left p-3">Status</th>
                            <th className="text-left p-3">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {[
                            // Level 1
                            {id: "APR001", firstName: "James", lastName: "Mitchell", email: "james.mitchell@company.com", country: "Global", level: 1, dept: "Executive", title: "CEO", active: true},
                            {id: "APR002", firstName: "Sarah", lastName: "Williams", email: "sarah.williams@company.com", country: "Global", level: 1, dept: "Executive", title: "CFO", active: true},
                            // Level 2
                            {id: "APR006", firstName: "David", lastName: "Kim", email: "david.kim@company.com", country: "APAC", level: 2, dept: "Operations", title: "VP APAC", active: true},
                            // Level 3
                            {id: "APR011", firstName: "Andrew", lastName: "Johnson", email: "andrew.johnson@company.com", country: "Australia", level: 3, dept: "Operations", title: "Senior Director AU", active: true},
                            // Level 4
                            {id: "APR016", firstName: "Rachel", lastName: "Wilson", email: "rachel.wilson@company.com", country: "Australia", level: 4, dept: "Operations", title: "Director Operations AU", active: true},
                            {id: "APR017", firstName: "Kevin", lastName: "Moore", email: "kevin.moore@company.com", country: "Australia", level: 4, dept: "Finance", title: "Director Finance AU", active: true},
                            // Level 5
                            {id: "APR021", firstName: "Brandon", lastName: "Young", email: "brandon.young@company.com", country: "Australia", level: 5, dept: "Operations", title: "Senior Manager AU", active: true},
                            {id: "APR022", firstName: "Jessica", lastName: "King", email: "jessica.king@company.com", country: "Australia", level: 5, dept: "Finance", title: "Senior Manager Finance AU", active: true},
                            // Level 6
                            {id: "APR026", firstName: "Emily", lastName: "Adams", email: "emily.adams@company.com", country: "Australia", level: 6, dept: "Operations", title: "Manager Operations AU", active: true},
                            // Level 7
                            {id: "APR031", firstName: "Jacob", lastName: "Roberts", email: "jacob.roberts@company.com", country: "Australia", level: 7, dept: "Operations", title: "Senior Analyst AU", active: true},
                            // Level 8
                            {id: "APR036", firstName: "Hannah", lastName: "Evans", email: "hannah.evans@company.com", country: "Australia", level: 8, dept: "Operations", title: "Analyst AU", active: true},
                            // Level 9
                            {id: "APR041", firstName: "Dylan", lastName: "Morris", email: "dylan.morris@company.com", country: "Australia", level: 9, dept: "Operations", title: "Junior Analyst AU", active: true},
                            // Level 10
                            {id: "APR046", firstName: "Isabella", lastName: "Bell", email: "isabella.bell@company.com", country: "Australia", level: 10, dept: "Operations", title: "Associate AU", active: true},
                          ].map((row, i) => (
                            <tr key={i} className="border-b hover:bg-slate-50">
                              <td className="p-3 font-mono text-xs">{row.id}</td>
                              <td className="p-3 font-semibold">{row.firstName} {row.lastName}</td>
                              <td className="p-3 text-xs">{row.email}</td>
                              <td className="p-3">
                                <span className={`badge ${row.country === "Global" ? "badge-purple" : row.country === "APAC" ? "badge-blue" : "badge-green"}`}>
                                  {row.country}
                                </span>
                              </td>
                              <td className="p-3">
                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${row.level <= 4 ? 'bg-red-100 text-red-700' : row.level <= 7 ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}`}>
                                  L{row.level}
                                </span>
                              </td>
                              <td className="p-3 text-sm">{row.dept}</td>
                              <td className="p-3 text-sm">{row.title}</td>
                              <td className="p-3">
                                {row.active ? <span className="badge badge-green">Active</span> : <span className="badge badge-red">Inactive</span>}
                              </td>
                              <td className="p-3">
                                <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icon name="Edit" size={16} /></button>
                                <button className="p-1 text-slate-400 hover:bg-slate-50 rounded ml-1"><Icon name="UserMinus" size={16} /></button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                      <h4 className="font-semibold text-blue-800 mb-2">ðŸ“‹ Approval Level Guide</h4>
                      <div className="grid md:grid-cols-3 gap-4 text-sm">
                        <div>
                          <p className="font-medium text-red-700">Level 1-4 (Executive)</p>
                          <p className="text-slate-600">Unlimited approval authority for AC/FF/SUP</p>
                        </div>
                        <div>
                          <p className="font-medium text-amber-700">Level 5-7 (Management)</p>
                          <p className="text-slate-600">$50M to $5M USD (SUP restricted at L6-7)</p>
                        </div>
                        <div>
                          <p className="font-medium text-green-700">Level 8-10 (Staff)</p>
                          <p className="text-slate-600">$1M to $100K USD (SUP not authorized)</p>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Prerequisites Tab */}
                {adminTab === "prerequisites" && (
                  <div className="card">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold">Prerequisites (Must complete BEFORE SAP)</h3>
                      <button className="btn btn-primary btn-sm"><Icon name="Plus" size={14} className="mr-1" /> Add Prerequisite</button>
                    </div>
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="border-b bg-slate-50">
                          <th className="text-left p-3">Order</th>
                          <th className="text-left p-3">Country</th>
                          <th className="text-left p-3">Name</th>
                          <th className="text-left p-3">Condition</th>
                          <th className="text-left p-3">Approver</th>
                          <th className="text-left p-3">Critical</th>
                          <th className="text-left p-3">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {[
                          {order: 1, country: "Australia", name: "Fund.IT Ruling (EMIT Only)", condition: "Budget Class = 03 (EMIT)", approver: "Fund.IT", critical: true},
                          {order: 2, country: "Australia", name: "FCCR Approval", condition: "Always (ALL projects)", approver: "FCCR", critical: true},
                          {order: 3, country: "Australia", name: "Dataflex TC Code", condition: "Category = Capital", approver: "Financial Reporting", critical: false},
                          {order: 4, country: "Australia", name: "DOAG Approval", condition: "Always", approver: "DOAG", critical: false},
                          {order: 5, country: "Australia", name: "Tax Review", condition: "Net > $3M AUD", approver: "Tax Team", critical: true},
                          {order: 6, country: "Australia", name: "JV Approval", condition: "Net > $5M AUD", approver: "JV Partners", critical: true},
                          {order: 7, country: "Australia", name: "OBO Approval", condition: "Business Area = 6602", approver: "JV/OBO Partners", critical: true},
                          {order: 8, country: "Australia", name: "Level Approval", condition: "Always (based on Net USD)", approver: "Based on level", critical: true}
                        ].map((row, i) => (
                          <tr key={i} className="border-b hover:bg-slate-50">
                            <td className="p-3">
                              <span className="w-6 h-6 rounded-full bg-slate-200 inline-flex items-center justify-center text-xs font-semibold">{row.order}</span>
                            </td>
                            <td className="p-3">ðŸ‡¦ðŸ‡º {row.country}</td>
                            <td className="p-3 font-semibold">{row.name}</td>
                            <td className="p-3 text-slate-500 text-xs">{row.condition}</td>
                            <td className="p-3">{row.approver}</td>
                            <td className="p-3">
                              {row.critical ? <span className="badge badge-red">Critical âš ï¸</span> : <span className="text-slate-400">-</span>}
                            </td>
                            <td className="p-3">
                              <button className="p-1 text-blue-600 hover:bg-blue-50 rounded"><Icon name="Edit" size={16} /></button>
                              <button className="p-1 text-slate-400 hover:bg-slate-50 rounded ml-1"><Icon name="ArrowUp" size={16} /></button>
                              <button className="p-1 text-slate-400 hover:bg-slate-50 rounded"><Icon name="ArrowDown" size={16} /></button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    <p className="text-xs text-slate-400 mt-4">ðŸ’¡ FCCR approval is required for ALL projects including Decommissioning. Fund.IT ruling is only for EMIT (03).</p>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* AI Assistant Panel */}
          <div className="advisor-panel">
            <div className="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
              <h3 className="font-semibold flex items-center gap-2">
                <Icon name="MessageSquare" size={18} className="text-blue-600" /> PtA Assistant
              </h3>
              <p className="text-xs text-slate-500 mt-1">Ask anything or upload documents for analysis</p>
            </div>
            <div className="flex-1 overflow-auto p-4 space-y-3">
              {chatMessages.map((m, i) => (
                <div key={i} className={`chat-bubble ${m.role === "user" ? "chat-user" : "chat-ai"}`}>
                  {m.isButton ? (
                    <button 
                      onClick={m.buttonAction}
                      className="btn btn-primary btn-sm w-full"
                    >
                      <Icon name="ArrowRight" size={14} className="mr-1" /> Go to Tasks
                    </button>
                  ) : m.attachment ? (
                    <div className="flex items-center gap-2">
                      <Icon name="FileText" size={16} className="text-blue-500" />
                      <span>{m.content}</span>
                    </div>
                  ) : m.role === "user" ? m.content : (
                    <div 
                      style={{whiteSpace: "pre-wrap", lineHeight: "1.6"}}
                      dangerouslySetInnerHTML={{
                        __html: m.content
                          // Remove any ** markdown
                          .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                          // Remove any * markdown  
                          .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                          // Remove ## headers
                          .replace(/^#{1,3} /gm, '')
                          // Convert ``` code blocks
                          .replace(/```[\w]*\n?([\s\S]*?)```/g, '<pre style="background:#1e293b;color:#e2e8f0;padding:8px;border-radius:6px;margin:8px 0;font-size:12px;overflow-x:auto;">$1</pre>')
                          // Convert inline code
                          .replace(/`([^`]+)`/g, '<code style="background:#e2e8f0;padding:1px 4px;border-radius:3px;font-family:monospace;font-size:12px;">$1</code>')
                      }}
                    />
                  )}
                </div>
              ))}
              
              {/* Pending Action Buttons */}
              {pendingAction && (
                <div className="flex gap-2 mt-2">
                  <button 
                    onClick={() => handlePendingActionConfirm(true)}
                    className="btn btn-primary btn-sm flex-1"
                  >
                    <Icon name="Check" size={14} className="mr-1" /> Yes, proceed
                  </button>
                  <button 
                    onClick={() => handlePendingActionConfirm(false)}
                    className="btn btn-secondary btn-sm flex-1"
                  >
                    <Icon name="X" size={14} className="mr-1" /> No, cancel
                  </button>
                </div>
              )}
              
              {/* Upload Progress */}
              {chatUploadStatus && (
                <div className="bg-blue-50 rounded-lg p-3">
                  <div className="flex items-center gap-2 mb-2">
                    <div className="animate-spin">
                      <Icon name="Loader" size={16} className="text-blue-500" />
                    </div>
                    <span className="text-sm text-blue-700">{chatUploadStatus}</span>
                  </div>
                  {chatUploadProgress > 0 && (
                    <div className="h-1.5 bg-blue-200 rounded-full overflow-hidden">
                      <div 
                        className="h-full bg-blue-500 transition-all duration-300"
                        style={{width: `${chatUploadProgress}%`}}
                      />
                    </div>
                  )}
                </div>
              )}
              
              <div ref={chatEndRef} />
            </div>
            <div className="p-4 border-t">
              {/* File upload input (hidden) */}
              <input 
                type="file" 
                ref={chatFileInputRef} 
                className="hidden" 
                onChange={handleChatFileUpload}
                accept="image/*,.pdf,.txt,.csv,text/plain,application/pdf"
              />
              
              <div className="flex gap-2">
                <button 
                  onClick={() => chatFileInputRef.current?.click()}
                  className="btn btn-secondary px-3"
                  title="Upload document for analysis"
                  disabled={!!chatUploadStatus}
                >
                  <Icon name="Paperclip" size={18} />
                </button>
                <input 
                  className="input flex-1" 
                  placeholder={pendingAction ? "Type yes/no to confirm..." : "Ask anything..."} 
                  value={chatInput} 
                  onChange={e => setChatInput(e.target.value)}
                  onKeyDown={e => e.key === "Enter" && sendChat()}
                />
                <button onClick={sendChat} className="btn btn-primary px-3">
                  <Icon name="Send" size={18} />
                </button>
              </div>
              <p className="text-xs text-slate-400 mt-2 text-center">
                ðŸ“Ž Upload AFE, FCCR, DOAG, or any document
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
